<!DOCTYPE 
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>StoryBali - Mobile Chat</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2299.77">
  <script src="https://cdn.tailwindcss.com"></script>
<!-- GANTI SEMUA BLOK <style> LAMA ANDA DENGAN SATU BLOK INI -->

<style>
    /* ================================================================= */
    /* GAYA CSS BARU UNTUK TAMPILAN CHAT YANG NORMAL DAN UMUM        */
    /* ================================================================= */
    
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    * {
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;
    }

    :root {
      /* [UBAH] Variabel warna solid untuk tampilan yang lebih umum */
      --theme-header-bg: #005E54; /* Warna header seperti WhatsApp */
      --theme-user-bubble-bg: #E7FFDB; /* Warna gelembung chat pengguna */
      --theme-body-bg: #E5DDD5; /* Latar belakang body/wallpaper */
      --theme-app-bg: #F0F2F5; /* Latar belakang utama aplikasi */
      
      /* Ukuran font yang beradaptasi dengan layar (responsif) */
      font-size: clamp(0.9rem, 1.2vw + 0.5rem, 1rem); 
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--theme-body-bg) !important; /* Latar belakang solid */
        overflow-x: hidden;
        margin: 0;
        padding: 0;
    }
    
    .chat-container {
        min-height: 100vh;
        padding: 1rem; /* Jarak di layar besar/desktop */
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .chat-window {
        background: white;
        border: 1px solid #ddd;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        animation: slideInUp 0.5s ease-out;
        border-radius: 1rem; /* [UBAH] Sudut tidak terlalu melengkung */
        height: 95vh;
        max-height: 800px;
        width: 100%;
        max-width: 420px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* [UBAH TOTAL] Header dengan warna solid */
    .header-gradient {
        background: var(--theme-header-bg);
        padding: 0.75rem 1rem; /* Padding disesuaikan */
        color: white;
        flex-shrink: 0;
    }

    /* [UBAH TOTAL] Avatar AI tanpa animasi */
    .ai-avatar {
        background-color: #f0f0f0;
        border: 2px solid white;
        box-shadow: none; /* Hilangkan shadow */
        animation: none; /* Hilangkan animasi denyut */
    }

    /* Hilangkan efek-efek yang tidak perlu */
    .header-gradient::before, .ai-avatar::after {
        display: none;
    }

    .message-bubble {
        animation: messageSlide 0.5s ease-out;
        margin-bottom: 0.75rem;
    }
    
    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* [UBAH] Gelembung chat dengan gaya standar */
    .ai-message, .user-message {
      font-size: 0.9rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08); /* Shadow lebih lembut */
      border-radius: 0.75rem; /* Sudut lebih umum */
      padding: 0.6rem 0.9rem;
      max-width: 85%;
      position: relative;
    }

    .ai-message {
        background: #FFFFFF;
        color: #333;
        border-top-left-radius: 0.25rem;
    }
    
    .user-message {
        background: var(--theme-user-bubble-bg);
        color: #111;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        border-top-right-radius: 0.25rem;
    }
    
    .system-message {
        background-color: #e2e8f0;
        color: #4a5568;
        font-size: 0.75rem;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
    }
    
    .typing-indicator { display: none; margin-bottom: 1rem; }
    .typing-indicator.show { display: flex; animation: messageSlide 0.5s ease-out; }

    .dot {
        width: 8px; height: 8px;
        border-radius: 50%;
        background-color: #A0A0A0; /* Warna dot lebih netral */
        animation: typing 1.4s infinite ease-in-out;
        margin: 0 2px;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    .dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing { 0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; } 40% { transform: scale(1.2) translateY(-6px); opacity: 1; } }

    /* [UBAH] Area input yang lebih standar */
    .input-area {
        background: var(--theme-app-bg);
        border-top: 1px solid #ddd;
        padding: 0.75rem;
    }

    .input-field {
        border: 1px solid #ccc;
        border-radius: 9999px;
        padding: 0.75rem 1.25rem;
        font-size: 1rem; /* Tetap 1rem untuk mencegah zoom di iOS */
        background: white;
    }
    .input-field:focus { border-color: var(--theme-header-bg); box-shadow: 0 0 0 2px rgba(0, 94, 84, 0.2); }

    .send-button {
        background: var(--theme-header-bg);
        border-radius: 50%; /* Bulat sempurna */
        width: 3rem; height: 3rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    .send-button:hover { background-color: #004a42; }
    .send-button:active { transform: scale(0.9); }
    .send-button::before { display: none; } /* Hilangkan efek kilau */
    
    .quick-actions {
        background: var(--theme-app-bg);
        padding: 0.5rem 0.75rem 0.75rem 0.75rem;
        border-top: 1px solid #ddd;
    }
    .quick-action-btn {
        background: white;
        border: 1px solid #ccc;
        color: #333;
    }

    /* [UBAH] Modal dengan latar belakang solid */
    .modal-overlay {
        background: rgba(0, 0, 0, 0.5); /* Overlay lebih sederhana */
        backdrop-filter: none; /* Hilangkan blur */
    }
    .modal-content {
        background: white; /* Latar belakang putih solid */
        border: 1px solid #ccc;
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transform: scale(0.95);
        transition: transform 0.3s ease, opacity 0.3s ease;
    }
    #settingsModal .modal-content { background: #f7f8fc; padding: 0; }
    .modal-overlay.hidden { opacity: 0; pointer-events: none; }
    .modal-overlay:not(.hidden) .modal-content { opacity: 1; transform: scale(1); }
    
    /* [UBAH] Border avatar profil biasa */
    .profile-avatar-border {
        border: 3px solid var(--theme-header-bg);
        animation: none; /* Hilangkan animasi putar */
    }
    
    /* Semua kode dari file asli yang tidak diubah tetap dipertahankan di bawah ini */
    .settings-tab { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
    .settings-tab.active { color: #4f46e5; font-weight: 600; border-bottom-color: #4f46e5; }
    .settings-tab-content { display: none; animation: fadeIn 0.5s ease; }
    .settings-tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .settings-card { background: white; border-radius: 1rem; padding: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f1f5f9; }
    .settings-item:last-child { border-bottom: none; }
    .settings-icon { width: 1.25rem; height: 1.25rem; color: #6366f1; }
    .settings-input, .settings-select { border-radius: 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0; padding: 0.5rem 0.75rem; font-size: 0.875rem; width: 55%; }
    .settings-input:focus, .settings-select:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none; }
    .settings-btn-action { width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem; border-radius: 0.75rem; font-weight: 500; }
    .theme-option-new { border-radius: 0.75rem; padding: 0.5rem; border: 2px solid transparent; cursor: pointer; text-align: center; }
    .theme-option-new.active { border-color: #4f46e5; background-color: #eef2ff; }
    .theme-swatch { width: 100%; height: 1.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .toggle-new { appearance: none; width: 44px; height: 24px; border-radius: 12px; background-color: #cbd5e1; position: relative; cursor: pointer; }
    .toggle-new::before { content: ''; position: absolute; top: 3px; left: 3px; width: 18px; height: 18px; border-radius: 50%; background-color: white; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
    .toggle-new:checked { background-color: #6366f1; }
    .toggle-new:checked::before { transform: translateX(20px); }

    /* Responsif untuk Mobile */
    @media (max-width: 768px) {
        .chat-container {
            padding: 0;
        }
        .chat-window {
            border-radius: 0;
            height: 100vh;
            max-height: 100vh;
            max-width: 100vw;
            border: none;
        }
        .modal-content {
          width: 90%;
          border-radius: 0.75rem;
        }
    }
    
    /* Scrollbar */
    .chat-messages::-webkit-scrollbar { width: 6px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.2); border-radius: 10px; }
    .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.3); }

</style>

</head>
<body>
<div class="chat-container">
    <div class="chat-window flex flex-col">
        <!-- Header -->
        <div class="header-gradient p-4 text-white relative flex-shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="ai-avatar w-12 h-12 rounded-full flex items-center justify-center overflow-hidden relative cursor-pointer"
                         onclick="showProfileModal()">
                        <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali"
                             class="w-full h-full object-cover">
                        <div class="status-indicator"></div>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Wayan AI</h1>
                        <p class="text-blue-100 text-sm opacity-90">Klik untuk lihat profil</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleVoiceMode()"
                            class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                  d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </button>
                    <button onclick="toggleSettings()"
                            class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Quick Actions -->
        <div class="quick-actions flex-shrink-0">
            <button class="quick-action-btn" onclick="sendQuickMessage('Halo Wayan!')">Halo</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Apa kabar hari ini?')">Apa kabar?</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Ceritakan joke lucu dong!')">Joke</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Kasih tips produktif dong!')">Tips Produktif</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Rekomendasi film bagus dong!')">Film</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Ajarin coding dong!')">Coding</button>
        </div>
        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 chat-messages">
            <div class="message-bubble flex items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <div class="ai-message rounded-2xl rounded-tl-md p-4 max-w-xs relative">
                    <p class="text-gray-800 leading-relaxed text-sm">Halo! Gue Wayan nih, AI assistant yang siap bantu jawab pertanyaan kamu. Santai aja, tanya apa aja yang kamu mau tau ya!</p>
                    <div class="mt-3">
                        <!-- Suggestions will be generated here -->
                    </div>
                    <!-- Tombol Pembaca Jawaban AI & Copy -->
                    <button onclick="readAiResponse(this, 'SGFsbyEgR3VlIFdheWFuIG5paCwgQUkgYXNzaXN0YW50IHlhbmcgc2lhcCBiYW50dSBqYXdhYiBwZXJ0YW55YW4ga2FtdS4gU2FudGFpIGFqYSwgdGFueWEgYXBhIGFqYSB5YW4nZyBrYW11IG1hdSB0YXUgeWEh')" class="absolute bottom-2 right-2 w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 ease-in-out transform hover:scale-110 active:scale-90" title="Baca Jawaban">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <div class="ai-message rounded-2xl rounded-tl-md p-4">
                    <div class="flex space-x-1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>
            <!-- Image Processing Indicator -->
            <div id="imageProcessingIndicator" class="typing-indicator items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <div class="ai-message rounded-2xl rounded-tl-md p-4">
                    <div class="flex space-x-1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <span class="ml-2 text-gray-600 text-sm">Menganalisis gambar...</span>
                </div>
            </div>
        </div>
        <!-- Input Area -->
        <div class="input-area flex-shrink-0">
            <div class="flex space-x-3 items-end">
                <div class="flex-1 relative">
                    <input
                            type="text"
                            id="messageInput"
                            placeholder="Tanya kepada Wayan AI..."
                            class="input-field w-full focus:outline-none text-gray-800 placeholder-gray-500"
                            onkeypress="handleKeyPress(event)"
                    >
                    <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex items-center space-x-1">
                        <button onclick="triggerImageUpload()"
                                class="text-gray-400 hover:text-blue-500 transition-colors p-1 rounded-full transform hover:scale-110 active:scale-90"
                                title="Upload gambar">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                      d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;"
                           onchange="handleImageUpload(event)">
                </div>
                <button
                        onclick="sendMessage()"
                        class="send-button text-white flex items-center justify-center"
                >
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                    </svg>
                </button>
            </div>
            <!-- Voice Wave Animation -->
            <div id="voiceWave" class="voice-wave justify-center mt-3">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
        </div>
    </div>
    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content p-6 max-w-sm w-full"
             id="imagePreviewContent">
            <div class="text-center relative">
                <button onclick="hideImagePreview()"
                        class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="mb-4">
                    <img id="previewImage" src="" alt="Preview" class="w-full h-auto rounded-lg max-h-48 object-cover mx-auto shadow-md">
                    <p id="previewFileName" class="text-sm text-gray-600 mt-2"></p>
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-medium text-gray-700 mb-2">Tanya sesuatu tentang gambar
                        ini:</label>
                    <textarea
                            id="imageQuestionInput"
                            placeholder="Contoh: Apa yang ada di gambar ini? Jelaskan detail yang kamu lihat..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm settings-input"
                            rows="3"
                    ></textarea>
                </div>
                <div class="flex space-x-3">
                    <button onclick="hideImagePreview()"
                            class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn">
                        Batal
                    </button>
                    <button onclick="sendImageWithQuestion()"
                            class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn">
                        Kirim
                    </button>
                </div>
            </div>
            <div class="swipe-indicator"></div>
        </div>
    </div>
    <!-- Profile Modal -->
    <div id="profileModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content p-6 max-w-sm w-full"
             id="profileModalContent">
            <div class="text-center relative">
                <button onclick="hideProfileModal()"
                        class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="w-20 h-20 mx-auto mb-4 rounded-full overflow-hidden profile-avatar-border shadow-lg">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div> <!-- Corrected alt text -->
                <h2 class="text-xl font-bold text-gray-800 mb-2">Wayan AI</h2>
                <p class="text-purple-600 font-semibold mb-4 text-sm">AI Assistant Dari Storybali</p>
                <div class="text-gray-600 text-xs leading-relaxed mb-4 text-left bg-gray-50 p-3 rounded-xl">
                    <p class="mb-2"><strong>Halo! Gue Wayan!</strong></p>
                    <p class="mb-2">Gue adalah AI assistant yang dibuat khusus untuk membantu kamu dengan gaya bahasa yang santai dan friendly.</p>
                    <p>Santai aja, tanya apa aja yang kamu mau!</p>
 <p>kepoin wayan yuk di instagram atau chat wa pribadi wayan!</p>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <a href="https://www.instagram.com/sudiarsana_wayan?igsh=MXE4NHFvZzAyOXd6NQ%3D%3D&utm_source=qr" target="_blank"
                       class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-3 py-2 rounded-full settings-btn">
                        Instagram
                    </a>
                    <a href="https://wa.me/message/RNPBCG25N5V2A1" target="_blank"
                       class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-2 rounded-full settings-btn">
                        WhatsApp
                    </a>
                </div>
            </div>
            <div class="swipe-indicator"></div>
        </div>
    </div>
    
    <!-- ================================================================= -->
    <!-- START: UPDATED SETTINGS MODAL -->
    <!-- ================================================================= -->
    <div id="settingsModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content max-w-sm w-full max-h-[90vh] overflow-hidden flex flex-col" id="settingsModalContent">
            <!-- Modal Header -->
            <div class="p-4 flex items-center justify-between flex-shrink-0 bg-white border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800">Pengaturan</h3>
                <button onclick="toggleSettings()" class="w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>

            <!-- Tab Navigation -->
            <div class="flex-shrink-0 bg-white border-b border-gray-200">
                <nav class="flex justify-around text-sm text-gray-600">
                    <button onclick="switchSettingsTab('general')" class="settings-tab active flex-1 py-3 px-2 text-center">Umum</button>
                    <button onclick="switchSettingsTab('appearance')" class="settings-tab flex-1 py-3 px-2 text-center">Tampilan</button>
                    <button onclick="switchSettingsTab('advanced')" class="settings-tab flex-1 py-3 px-2 text-center">Lanjutan</button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- General Tab -->
                <div id="tab-general" class="settings-tab-content active space-y-4">
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Nama AI</label>
                            </div>
                            <input type="text" id="aiNameInput" value="Wayan AI" class="settings-input text-right">
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 0v2M3 19h18M5 15h14M9 11h6"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Bahasa</label>
                            </div>
                            <select id="languageSelect" class="settings-select text-right">
                                <option value="id">Indonesia</option>
                                <option value="en">English</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Gaya Bahasa</label>
                            </div>
                            <select id="personalitySelect" class="settings-select text-right">
                                <option value="santai" selected>Santai</option>
                                <option value="profesional">Profesional</option>
                                <option value="lucu">Humoris</option>
                            </select>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V21H9z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Mode Peran AI</label>
                            </div>
                            <select id="aiRoleSelect" class="settings-select text-right">
                                <option value="umum" selected>Asisten Umum</option>
                                <option value="guru_jepang">Guru B. Jepang</option>
                                <option value="guru_matematika">Guru Matematika</option>
                                <option value="dokter">Dokter Umum</option>
                                <option value="programmer">Programmer</option>
                                <option value="penerjemah">Penerjemah</option>
                                <option value="kustom">Kustom...</option>
                            </select>
                        </div>
                        <div id="customRoleContainer" class="hidden p-2 mt-2">
                            <label class="block text-xs text-gray-600 mb-1">Definisikan peran kustom AI:</label>
                            <textarea id="customRoleInput" placeholder="Contoh: Kamu adalah seorang ahli sejarah..." class="w-full settings-input text-sm" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <!-- Appearance Tab -->
                <div id="tab-appearance" class="settings-tab-content space-y-4">
                    <div class="settings-card">
                        <div class="p-2">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Tema Warna</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div onclick="changeTheme('blue')" id="themeBlue" class="theme-option-new active">
                                    <div class="theme-swatch bg-gradient-to-r from-blue-500 to-purple-500"></div>
                                    <span class="text-xs font-medium text-gray-600">Biru</span>
                                </div>
                                <div onclick="changeTheme('green')" id="themeGreen" class="theme-option-new">
                                    <div class="theme-swatch bg-gradient-to-r from-green-500 to-teal-500"></div>
                                    <span class="text-xs font-medium text-gray-600">Hijau</span>
                                </div>
                                <div onclick="changeTheme('pink')" id="themePink" class="theme-option-new">
                                    <div class="theme-swatch bg-gradient-to-r from-pink-500 to-red-500"></div>
                                    <span class="text-xs font-medium text-gray-600">Pink</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Ukuran Font</label>
                            </div>
                            <select id="fontSizeSelect" class="settings-select text-right w-auto">
                                <option value="sm">Kecil</option>
                                <option value="base" selected>Normal</option>
                                <option value="lg">Besar</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Efek Animasi</label>
                            </div>
                            <input type="checkbox" id="animationToggle" class="toggle-new" onchange="toggleAnimations()" checked>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Suara Notifikasi</label>
                            </div>
                            <input type="checkbox" id="soundToggle" class="toggle-new" onchange="toggleSound()" checked>
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Pembaca Jawaban</label>
                            </div>
                            <input type="checkbox" id="readAiResponseToggle" class="toggle-new" onchange="toggleReadAiResponse()" checked>
                        </div>
                        <!-- ================================================================= -->
                        <!-- START: PENAMBAHAN DROPDOWN SUARA -->
                        <!-- ================================================================= -->
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Jenis Suara</label>
                            </div>
                             <select id="voiceSelect" class="settings-select text-right">
                                <option value="">Memuat suara...</option>
                             </select>
                        </div>
                        <!-- ================================================================= -->
                        <!-- END: PENAMBAHAN DROPDOWN SUARA -->
                        <!-- ================================================================= -->
                    </div>
                </div>
                <!-- Advanced Tab -->
                <div id="tab-advanced" class="settings-tab-content space-y-4">
                     <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Simpan Riwayat</label>
                            </div>
                            <input type="checkbox" id="saveHistoryToggle" class="toggle-new" checked>
                        </div>
                        <div class="p-2 space-y-2">
                             <button onclick="exportChatHistory()" class="settings-btn-action bg-green-100 text-green-700 hover:bg-green-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                <span>Export Riwayat (.txt)</span>
                             </button>
                             <button onclick="clearChatHistory()" class="settings-btn-action bg-red-100 text-red-700 hover:bg-red-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <span>Hapus Riwayat Chat</span>
                             </button>
                        </div>
                    </div>
                    <div class="settings-card p-4">
                        <h4 class="text-sm font-semibold text-gray-800 mb-3">API Keys (Gemini)</h4>
                        <div class="space-y-2 text-sm">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 1 (Utama)</label>
                                <input type="password" id="apiKey1" placeholder="Masukkan API Key" class="settings-input w-full">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 2 (Cadangan)</label>
                                <input type="password" id="apiKey2" placeholder="Opsional" class="settings-input w-full">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 3 (Cadangan)</label>
                                <input type="password" id="apiKey3" placeholder="Opsional" class="settings-input w-full">
                            </div>
                             <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 4 (Cadangan)</label>
                                <input type="password" id="apiKey4" placeholder="Opsional" class="settings-input w-full">
                            </div>
                             <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 5 (Cadangan)</label>
                                <input type="password" id="apiKey5" placeholder="Opsional" class="settings-input w-full">
                            </div>
                            <button onclick="saveApiKeys()" class="w-full settings-btn-action bg-blue-600 text-white mt-4 hover:bg-blue-700">
                                Simpan API Keys
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-3 bg-white border-t border-gray-200 flex-shrink-0 text-center">
                <p class="text-xs text-gray-500">StoryBali v2.2 | © 2024</p>
            </div>
        </div>
    </div>
    <!-- ================================================================= -->
    <!-- END: UPDATED SETTINGS MODAL -->
    <!-- ================================================================= -->
</div>

<script>
    // Variabel Global
    let apiKeys = [];
    let conversationHistory = [];
    let isVoiceMode = false;
    let recognition = null;

    // --- START: PENGATURAN FITUR BATAS CHAT ---
    const CHAT_LIMIT = 4; // Batas jumlah chat
    const COOLDOWN_MINUTES =1; // Durasi cooldown dalam menit
    let currentUserIP = null;
    let countdownInterval = null;
    // --- END: PENGATURAN FITUR BATAS CHAT ---

    // Settings
    let settings = {
        theme: 'blue',
        soundEnabled: true,
        animationsEnabled: true,
        readAiResponseEnabled: true,
        personality: 'santai',
        aiRole: 'umum', // Properti baru untuk peran
        customAiRolePrompt: '', // Properti baru untuk menyimpan prompt kustom
        voiceURI: '' // Properti baru untuk menyimpan suara pilihan
    };

    // Variables for AI response reader
    let currentUtterance = null;
    let isReading = false;

    // ==================================================================================================================
    // TEMPAT UNTUK MENGISI API KEY ANDA
    // Ganti 'YOUR_GEMINI_API_KEY_X' dengan API Key Google Gemini Anda yang sebenarnya.
    // ==================================================================================================================
    const DEFAULT_API_KEY_1 = 'AIzaSyClcqSMaHiXMZI4qYlTySqC3I3hWWg8H9s'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_2 = 'AIzaSyB8OPwzNAAyO1nWd9g185rx4YK3WIJy_Fw'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_3 = 'AIzaSyAYzvB1mfVdjrBtXY2n4-UUzCH5juQt8rU'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_4 = 'AIzaSyCkkekhKcQzFUUjx8ZcuqEYyqRde1ZDJcU'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_5 = 'AIzaSyCV-88PX1_tKh5VBjki9VeyY8gAH5bpZ0o'; // Ganti dengan kunci asli Anda
    // ==================================================================================================================
    
    // --- START: FUNGSI BARU UNTUK BATAS CHAT ---

    // Fungsi untuk mendapatkan IP pengguna dari API eksternal
    async function getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) {
                throw new Error('Gagal mendapatkan IP');
            }
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Tidak bisa mendapatkan IP address:", error);
            // Fallback jika API gagal, menggunakan nilai default (kurang ideal, tapi mencegah error)
            return 'default_user';
        }
    }

    // Mendapatkan data limit chat dari localStorage
    function getChatLimitData() {
        const data = localStorage.getItem('wayanAiChatLimit');
        return data ? JSON.parse(data) : {};
    }

    // Menyimpan data limit chat ke localStorage
    function saveChatLimitData(data) {
        localStorage.setItem('wayanAiChatLimit', JSON.stringify(data));
    }

    // Memeriksa status pengguna saat ini (apakah di cooldown atau tidak)
    function checkUserStatus() {
        if (!currentUserIP) return;

        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP];

        if (userData && userData.cooldownUntil && new Date().getTime() < userData.cooldownUntil) {
            // Jika pengguna masih dalam masa cooldown
            startCooldown(userData.cooldownUntil);
        } else if (userData) {
            // Jika cooldown sudah berakhir, hapus data lama
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }
    }

    // Mengaktifkan atau menonaktifkan input area
    function setInputEnabled(enabled, message = "Tanya kepada Wayan AI...") {
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.querySelector('.send-button');
        const imageUploadButton = document.querySelector('button[onclick="triggerImageUpload()"]');

        messageInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        imageUploadButton.disabled = !enabled;
        
        messageInput.placeholder = message;

        if (!enabled) {
            sendButton.style.opacity = '0.5';
            sendButton.style.cursor = 'not-allowed';
            imageUploadButton.style.opacity = '0.5';
        } else {
            sendButton.style.opacity = '1';
            sendButton.style.cursor = 'pointer';
            imageUploadButton.style.opacity = '1';
        }
    }

    // Memulai periode cooldown
    function startCooldown(cooldownEndTime) {
        setInputEnabled(false, "Anda mencapai batas limit. Silakan tunggu...");

        const messageId = `cooldown-timer-${currentUserIP}`;
        
        // Hapus timer lama jika ada, untuk memastikan notifikasi baru muncul di bawah
        const oldTimerMessage = document.getElementById(messageId);
        if(oldTimerMessage) {
            oldTimerMessage.remove();
        }

        // Selalu buat elemen pesan baru untuk timer
        const chatMessages = document.getElementById('chatMessages');
        const timerMessageElement = document.createElement('div');
        timerMessageElement.className = 'system-message-bubble';
        timerMessageElement.id = messageId; // Beri ID agar bisa diupdate
        chatMessages.insertBefore(timerMessageElement, document.getElementById('typingIndicator'));
        
        // Panggil scroll sekali saat pesan dibuat, setelah itu jangan lagi
        scrollToBottom(); 

        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = cooldownEndTime - now;

            if (distance < 0) {
                endCooldown();
                return;
            }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            // Perbarui innerHTML tanpa memanggil scrollToBottom()
            timerMessageElement.innerHTML = `<div class="system-message">Anda mencapai batas limit mengirim chat. Kembali setelah ${minutes}m ${seconds}s lagi.</div>`;
        }, 1000);
    }
    
    // Mengakhiri periode cooldown
    function endCooldown() {
        clearInterval(countdownInterval);
        countdownInterval = null;
        
        const timerMessageElement = document.getElementById(`cooldown-timer-${currentUserIP}`);
        if (timerMessageElement) {
            timerMessageElement.innerHTML = `<div class="system-message">Anda sudah bisa mengobrol lagi!</div>`;
        }

        // Hapus data pengguna dari localStorage
        const allUserData = getChatLimitData();
        if (allUserData[currentUserIP]) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }

        setInputEnabled(true);
    }

    // --- END: FUNGSI BARU UNTUK BATAS CHAT ---


    // API Key Management
    function saveApiKeys() {
        const keysToSave = [];
        for (let i = 1; i <= 5; i++) {
            const key = document.getElementById(`apiKey${i}`).value.trim();
            keysToSave.push(key);
        }
        localStorage.setItem('storybaliApiKeys', JSON.stringify(keysToSave));
        alert('API Keys berhasil disimpan!');
        loadApiKeys();
        updateApiStatus();
    }

    function loadApiKeys() {
        const savedKeys = localStorage.getItem('storybaliApiKeys');
        if (savedKeys) {
            apiKeys = JSON.parse(savedKeys);
            for (let i = 0; i < apiKeys.length; i++) {
                const inputElement = document.getElementById(`apiKey${i + 1}`);
                if (inputElement) {
                    inputElement.value = apiKeys[i];
                }
            }
        } else {
            apiKeys = [
                DEFAULT_API_KEY_1,
                DEFAULT_API_KEY_2,
                DEFAULT_API_KEY_3,
                DEFAULT_API_KEY_4,
                DEFAULT_API_KEY_5
            ];
            for (let i = 0; i < apiKeys.length; i++) {
                const inputElement = document.getElementById(`apiKey${i + 1}`);
                if (inputElement) {
                    inputElement.value = apiKeys[i];
                }
            }
        }
    }

    function updateApiStatus() {
        const hasValidKey = apiKeys.some(key => key && !key.startsWith('YOUR_GEMINI_API_KEY_'));
    }

    function updateChatCount() {
        const totalChats = conversationHistory.filter(msg => msg.role === 'user').length;
    }

    // Export Chat History
    function exportChatHistory() {
        if (conversationHistory.length === 0) {
            alert('Belum ada riwayat chat untuk di-export!');
            return;
        }
        let exportText = '=== Wayan AI CHAT HISTORY ===\n\n';
        exportText += `Exported: ${new Date().toLocaleString('id-ID')}\n\n`;
        conversationHistory.forEach((msg) => {
            const role = msg.role === 'user' ? 'Kamu' : 'Wayan AI';
            const text = msg.parts[0].text;
            exportText += `${role}: ${text}\n\n`;
        });
        const blob = new Blob([exportText], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wayan-ai-chat-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Chat history berhasil di-export!');
    }

    // Animation Toggle
    function toggleAnimations() {
        settings.animationsEnabled = document.getElementById('animationToggle').checked;
        const style = document.createElement('style');
        if (!settings.animationsEnabled) {
            style.textContent = `
                *, *::before, *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            `;
        }
        style.id = 'animation-disable';
        const existingStyle = document.getElementById('animation-disable');
        if (existingStyle) {
            existingStyle.remove();
        }
        if (!settings.animationsEnabled) {
            document.head.appendChild(style);
        }
        saveSettings();
    }

    // =================================================================
    // START: PERUBAHAN - Penggunaan API Key Acak
    // =================================================================
    function getCurrentApiKey() {
        if (apiKeys.length === 0) {
            loadApiKeys();
        }
        // Filter hanya API key yang valid (bukan placeholder)
        const validApiKeys = apiKeys.filter(key => key && !key.startsWith('YOUR_GEMINI_API_KEY_'));
        
        if (validApiKeys.length === 0) {
            console.warn("Tidak ada API Key yang valid ditemukan. Pastikan Anda telah memasukkan API Key di pengaturan.");
            return null;
        }

        // Pilih satu API key secara acak dari daftar yang valid
        const randomIndex = Math.floor(Math.random() * validApiKeys.length);
        console.log(`Menggunakan API Key acak index: ${randomIndex}`);
        return validApiKeys[randomIndex];
    }
    
    // Fungsi switchToNextApiKey() sudah tidak relevan lagi karena pemilihan bersifat acak setiap saat.
    // Kita akan menangani error API dengan cara me-retry, yang secara otomatis akan memanggil getCurrentApiKey() lagi untuk mendapatkan kunci acak (bisa sama, bisa beda).
    // =================================================================
    // END: PERUBAHAN - Penggunaan API Key Acak
    // =================================================================


    function getApiUrl() {
        const apiKey = getCurrentApiKey();
        if (!apiKey) {
            return null; 
        }
        return `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    }

    // Conversation Memory
    function saveConversationHistory() {
        if (document.getElementById('saveHistoryToggle').checked) {
            localStorage.setItem('storybaliConversationHistory', JSON.stringify(conversationHistory));
        }
    }

    function loadConversationHistory() {
        const savedHistory = localStorage.getItem('storybaliConversationHistory');
        if (savedHistory) {
            conversationHistory = JSON.parse(savedHistory);
            conversationHistory.forEach(msg => {
                if (msg.role === 'user') {
                    addMessage(msg.parts[0].text, true);
                } else {
                    addMessage(msg.parts[0].text, false);
                }
            });
        }
    }
    
    function addToConversationHistory(role, message) {
        conversationHistory.push({
            role: role,
            parts: [{text: message}]
        });
        if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
        }
        saveConversationHistory();
        updateChatCount();
    }

    // Quick Messages
    function sendQuickMessage(message) {
        document.getElementById('messageInput').value = message;
        sendMessage();
    }

    // Voice Mode
    function toggleVoiceMode() {
        isVoiceMode = !isVoiceMode;
        const voiceWave = document.getElementById('voiceWave');
        if (isVoiceMode) {
            startVoiceRecognition();
            voiceWave.classList.add('active');
        } else {
            stopVoiceRecognition();
            voiceWave.classList.remove('active');
        }
    }

    function startVoiceRecognition() {
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'id-ID';
            recognition.onresult = function (event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                if (finalTranscript) {
                    document.getElementById('messageInput').value = finalTranscript;
                    sendMessage();
                    toggleVoiceMode();
                }
            };
            recognition.start();
        }
    }

    function stopVoiceRecognition() {
        if (recognition) {
            recognition.stop();
            recognition = null;
        }
    }

    // Font Size Toggle
    function changeFontSize() {
        const fontSize = document.getElementById('fontSizeSelect').value;
        const chatMessages = document.getElementById('chatMessages');
        let sizeClass;
        if (fontSize === 'sm') sizeClass = 'text-sm';
        else if (fontSize === 'lg') sizeClass = 'text-lg';
        else sizeClass = 'text-base';
        
        // This is a simplified approach. For full control, you'd adjust paragraph tags etc.
        chatMessages.querySelectorAll('.ai-message p, .user-message p').forEach(p => {
             p.style.fontSize = fontSize === 'sm' ? '0.8rem' : (fontSize === 'lg' ? '1.1rem' : '0.95rem');
        });
        
        settings.fontSize = fontSize;
        saveSettings();
    }


    // Theme Management
    function changeTheme(themeName) {
        settings.theme = themeName;
        document.querySelectorAll('.theme-option-new').forEach(btn => {
            btn.classList.remove('active');
        });
        const selectedBtn = document.getElementById(`theme${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }
        const themeColors = {
            blue: {from: '#667eea', to: '#764ba2'},
            green: {from: '#10b981', to: '#059669'},
            pink: {from: '#ec4899', to: '#dc2626'}
        };
        const colors = themeColors[themeName];
        const header = document.querySelector('.header-gradient');
        header.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        document.querySelectorAll('.send-button').forEach(btn => {
            btn.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        });
        document.querySelectorAll('.ai-avatar').forEach(avatar => {
            avatar.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        });
        const profileAvatarBorder = document.querySelector('.profile-avatar-border');
        if (profileAvatarBorder) {
            profileAvatarBorder.style.borderImage = `linear-gradient(135deg, ${colors.from}, ${colors.to}, #f093fb) 1`;
        }
        saveSettings();
    }

    // Settings Management
    function loadSettings() {
        const savedSettings = localStorage.getItem('storybaliSettings');
        if (savedSettings) {
            settings = { ...settings, ...JSON.parse(savedSettings) };
        }
        applySettings();
    }

    function saveSettings() {
        // Ambil nilai terbaru dari UI sebelum menyimpan
        settings.voiceURI = document.getElementById('voiceSelect').value;
        localStorage.setItem('storybaliSettings', JSON.stringify(settings));
    }

    function applySettings() {
        changeTheme(settings.theme);
        document.getElementById('soundToggle').checked = settings.soundEnabled;
        document.getElementById('animationToggle').checked = settings.animationsEnabled;
        document.getElementById('readAiResponseToggle').checked = settings.readAiResponseEnabled;
        document.getElementById('aiNameInput').value = settings.aiName || 'Wayan AI';
        document.getElementById('fontSizeSelect').value = settings.fontSize || 'base';
        document.getElementById('personalitySelect').value = settings.personality || 'santai';
        
        // Terapkan pengaturan suara setelah daftar suara dimuat
        const voiceSelect = document.getElementById('voiceSelect');
        if (settings.voiceURI && voiceSelect.options.length > 1) {
             voiceSelect.value = settings.voiceURI;
        }

        const currentRole = settings.aiRole || 'umum';
        const aiRoleSelect = document.getElementById('aiRoleSelect');
        const customRoleContainer = document.getElementById('customRoleContainer');
        const customRoleInput = document.getElementById('customRoleInput');

        aiRoleSelect.value = currentRole;
        if (currentRole === 'kustom') {
            customRoleContainer.classList.remove('hidden');
            customRoleInput.value = settings.customAiRolePrompt || '';
        } else {
            customRoleContainer.classList.add('hidden');
        }

        if (!settings.animationsEnabled) {
            toggleAnimations();
        }
    }

    function toggleSound() {
        settings.soundEnabled = document.getElementById('soundToggle').checked;
        saveSettings();
    }

    function toggleReadAiResponse() {
        settings.readAiResponseEnabled = document.getElementById('readAiResponseToggle').checked;
        saveSettings();
    }

    function clearChatHistory() {
        if (confirm('Yakin mau hapus semua riwayat chat? Tindakan ini tidak bisa dibatalkan.')) {
            conversationHistory = [];
            localStorage.removeItem('storybaliConversationHistory');
            const chatMessages = document.getElementById('chatMessages');
            
            const messages = chatMessages.querySelectorAll('.message-bubble, .system-message-bubble'); // also remove system messages
            for (let i = messages.length - 1; i > 0; i--) {
                messages[i].remove();
            }
            updateChatCount();
            alert('Riwayat chat telah dihapus!');
        }
    }
    
    // NEW: Function to switch settings tabs
    function switchSettingsTab(tabName) {
        document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.settings-tab[onclick="switchSettingsTab('${tabName}')"]`).classList.add('active');
        
        document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Modal Management
    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        const content = document.getElementById('settingsModalContent');
        if (modal.classList.contains('hidden')) {
            switchSettingsTab('general'); // Reset to general tab on open
            modal.classList.remove('hidden');
            setTimeout(() => content.style.transform = 'scale(1)', 10);
        } else {
            content.style.transform = 'scale(0.9)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }

    function showProfileModal() {
        const modal = document.getElementById('profileModal');
        const content = document.getElementById('profileModalContent');
        modal.classList.remove('hidden');
        setTimeout(() => content.style.transform = 'scale(1)', 10);
    }

    function hideProfileModal() {
        const modal = document.getElementById('profileModal');
        const content = document.getElementById('profileModalContent');
        content.style.transform = 'scale(0.9)';
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // Image Upload
    function triggerImageUpload() {
        document.getElementById('imageInput').click();
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                showImagePreview(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
        }
    }

    let currentPreviewImage = null;
    let currentPreviewFileName = null;

    function showImagePreview(base64Image, fileName) {
        currentPreviewImage = base64Image;
        currentPreviewFileName = fileName;
        document.getElementById('previewImage').src = base64Image;
        document.getElementById('previewFileName').textContent = `${fileName}`;
        document.getElementById('imageQuestionInput').value = '';
        const modal = document.getElementById('imagePreviewModal');
        const content = document.getElementById('imagePreviewContent');
        modal.classList.remove('hidden');
        setTimeout(() => content.style.transform = 'scale(1)', 10);
        setTimeout(() => document.getElementById('imageQuestionInput').focus(), 300);
    }

    function hideImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        const content = document.getElementById('imagePreviewContent');
        content.style.transform = 'scale(0.9)';
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('imageInput').value = '';
            currentPreviewImage = null;
            currentPreviewFileName = null;
        }, 300);
    }

    function sendImageWithQuestion() {
        const question = document.getElementById('imageQuestionInput').value.trim();
        if (!question) {
            alert('Tulis pertanyaan dulu ya!');
            document.getElementById('imageQuestionInput').focus();
            return;
        }

        // --- MODIFIKASI: Pengecekan limit sebelum kirim gambar ---
        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };
        if (userData.count >= CHAT_LIMIT) {
             alert('Anda telah mencapai batas pengiriman pesan. Silakan tunggu cooldown selesai.');
             hideImagePreview();
             return;
        }
        // --- AKHIR MODIFIKASI ---
        
        hideImagePreview();
        addImageMessageWithQuestion(currentPreviewImage, currentPreviewFileName, question, true);
        showImageProcessingIndicator();
        analyzeImageWithQuestion(currentPreviewImage, question);
    }

    function addImageMessageWithQuestion(imageSrc, fileName, question, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        if (isUser) {
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="user-message text-white rounded-2xl rounded-tr-md p-4 max-w-xs">
                    <img src="${imageSrc}" alt="${fileName}" class="w-full h-auto rounded-lg mb-2 max-h-32 object-cover shadow-sm">
                    <p class="text-xs mb-2 opacity-90">${fileName}</p>
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <p class="text-xs font-medium">${question}</p>
                    </div>
                </div>
            `;
             // --- MODIFIKASI: Perbarui hitungan setelah kirim gambar ---
            const allUserData = getChatLimitData();
            const userData = allUserData[currentUserIP] || { count: 0 };
            userData.count++;
            allUserData[currentUserIP] = userData;
            saveChatLimitData(allUserData);

            if (userData.count >= CHAT_LIMIT) {
                const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
                userData.cooldownUntil = cooldownEndTime;
                allUserData[currentUserIP] = userData;
                saveChatLimitData(allUserData);
                startCooldown(cooldownEndTime);
            }
            // --- AKHIR MODIFIKASI ---
        }
        const typingIndicator = document.getElementById('typingIndicator');
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }

    // Message Management
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    // =================================================================
    // START: PENAMBAHAN FUNGSI - Notifikasi Perubahan Mode AI
    // =================================================================
    function addSystemMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'system-message-bubble';
        messageDiv.innerHTML = `<div class="system-message">${message}</div>`;
        
        const typingIndicator = document.getElementById('typingIndicator');
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }
    // =================================================================
    // END: PENAMBAHAN FUNGSI - Notifikasi Perubahan Mode AI
    // =================================================================
    
    function addMessage(message, isUser = false, suggestions = []) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        if (isUser) {
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="user-message text-white rounded-2xl rounded-tr-md p-4 max-w-xs">
                    <p class="leading-relaxed text-sm">${message}</p>
                </div>
            `;
        } else {
            // --- PERBAIKAN DIMULAI DI SINI ---
            // Mengubah karakter baris baru (\n) menjadi tag <br> agar paragraf ditampilkan dengan benar.
            const formattedMessage = message.replace(/\n/g, '<br>');
            // --- AKHIR PERBAIKAN ---

            const encodedMessage = btoa(encodeURIComponent(message)); // Gunakan pesan asli untuk fitur suara
            messageDiv.innerHTML = `
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="Wayan AI" class="w-full h-full object-cover">
                </div>
                <div class="ai-message rounded-2xl rounded-tl-md p-4 max-w-xs relative group">
                    <p class="text-gray-800 leading-relaxed text-sm">${formattedMessage}</p> <!-- Menggunakan pesan yang sudah diformat -->
                    <div class="mt-3">
                        ${renderSuggestions(suggestions)}
                    </div>
                    <button onclick="readAiResponse(this, '${encodedMessage}')" class="absolute bottom-2 right-2 w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 ease-in-out transform hover:scale-110 active:scale-90" title="Baca Jawaban">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path>
                        </svg>
                    </button>
                </div>
            `;
            messageDiv.querySelector('.ai-message').innerHTML += `
                <button onclick="copyToClipboard(this.previousElementSibling.previousElementSibling.previousElementSibling.textContent, this)" class="copy-button absolute bottom-2 right-9 w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 ease-in-out transform hover:scale-110 active:scale-90 opacity-0 group-hover:opacity-100 transition-opacity" title="Salin Jawaban">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                </button>
            `;
        }
        const typingIndicator = document.getElementById('typingIndicator');
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }
    
    function renderSuggestions(suggestionsArray) {
        if (suggestionsArray && suggestionsArray.length > 0) {
            return `
                <div class="flex flex-wrap gap-2 mt-2">
                    ${suggestionsArray.map(suggestion =>
                        `<button onclick="sendQuickMessage('${suggestion.replace(/'/g, "\\'")}')" class="suggestion-btn px-3 py-1 text-xs">
                            ${suggestion}
                        </button>`
                    ).join('')}
                </div>
            `;
        } else {
            return generateDefaultSuggestions();
        }
    }

    function generateDefaultSuggestions() {
        const suggestions = [
            "Ceritakan lebih detail dong!",
            "Ada contoh lainnya?",
            "Apa tema undangan yang tersedia di StoryBali?",
            "Berapa harga undangan digital di StoryBali?",
            "Bagaimana cara memesan undangan untuk pernikahan?",
            "Apa keunggulan undangan StoryBali dibandingkan yang lain?"
        ];
        const randomSuggestions = suggestions.sort(() => 0.5 - Math.random()).slice(0, 2);
        return `
            <div class="flex flex-wrap gap-2 mt-2">
                ${randomSuggestions.map(suggestion =>
                    `<button onclick="sendQuickMessage('${suggestion}')" class="suggestion-btn px-3 py-1 text-xs">
                        ${suggestion}
                    </button>`
                ).join('')}
            </div>
        `;
    }

    function showTypingIndicator() {
        document.getElementById('typingIndicator').classList.add('show');
        scrollToBottom();
    }

    function hideTypingIndicator() {
        document.getElementById('typingIndicator').classList.remove('show');
    }

    function showImageProcessingIndicator() {
        document.getElementById('imageProcessingIndicator').classList.add('show');
        scrollToBottom();
    }

    function hideImageProcessingIndicator() {
        document.getElementById('imageProcessingIndicator').classList.remove('show');
    }

    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        setTimeout(() => {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }

    function playNotificationSound() {
        if (settings.soundEnabled) {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
    }

    // Copy to Clipboard
    function copyToClipboard(text, buttonElement) {
        navigator.clipboard.writeText(text).then(() => {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            `;
            buttonElement.title = 'Copied!';

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.title = 'Copy to Clipboard';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Gagal menyalin teks.');
        });
    }

    // =================================================================
    // START: FUNGSI BARU DAN MODIFIKASI UNTUK PEMILIHAN SUARA
    // =================================================================
    
    // Fungsi untuk mengisi dropdown dengan suara yang tersedia
    function populateVoiceList() {
        const voices = speechSynthesis.getVoices();
        const voiceSelect = document.getElementById('voiceSelect');
        const savedVoiceURI = settings.voiceURI; // Ambil URI yang tersimpan

        voiceSelect.innerHTML = ''; // Kosongkan pilihan lama

        // Tambahkan pilihan default
        const defaultOption = document.createElement('option');
        defaultOption.textContent = 'Default Browser';
        defaultOption.value = '';
        voiceSelect.appendChild(defaultOption);

        if (voices.length === 0) {
            voiceSelect.options[0].textContent = 'Tidak ada suara';
            return;
        }

        // Prioritaskan suara Indonesia
        const idVoices = voices.filter(voice => voice.lang === 'id-ID');
        const otherVoices = voices.filter(voice => voice.lang !== 'id-ID');

        // Buat grup untuk suara Indonesia
        if (idVoices.length > 0) {
            const idGroup = document.createElement('optgroup');
            idGroup.label = 'Bahasa Indonesia';
            idVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                idGroup.appendChild(option);
            });
            voiceSelect.appendChild(idGroup);
        }

        // Buat grup untuk suara lainnya
        if (otherVoices.length > 0) {
             const otherGroup = document.createElement('optgroup');
            otherGroup.label = 'Bahasa Lain';
            otherVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                otherGroup.appendChild(option);
            });
            voiceSelect.appendChild(otherGroup);
        }

        // Coba pilih kembali suara yang sudah disimpan
        if (savedVoiceURI) {
            voiceSelect.value = savedVoiceURI;
        }
    }

    // Fungsi pembaca respons AI yang sudah dimodifikasi
    function readAiResponse(buttonElement, encodedMessage) {
        if (!settings.readAiResponseEnabled) {
            alert('Fitur pembaca jawaban AI dinonaktifkan di pengaturan.');
            return;
        }

        const message = decodeURIComponent(atob(encodedMessage));

        if (isReading) {
            stopReading();
            buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            isReading = false;
            return;
        }

        if (currentUtterance) {
            speechSynthesis.cancel();
        }

        currentUtterance = new SpeechSynthesisUtterance(message);
        
        // --- LOGIKA BARU: Terapkan suara yang dipilih ---
        const selectedVoiceURI = settings.voiceURI;
        const voices = speechSynthesis.getVoices();
        const selectedVoice = voices.find(voice => voice.voiceURI === selectedVoiceURI);

        if (selectedVoice) {
            currentUtterance.voice = selectedVoice;
        } else {
            // Jika suara yang dipilih tidak ada, gunakan default untuk bahasa Indonesia
            const idVoiceDefault = voices.find(voice => voice.lang === 'id-ID');
            if(idVoiceDefault) {
               currentUtterance.voice = idVoiceDefault;
            }
        }
        // --- AKHIR LOGIKA BARU ---

        currentUtterance.rate = 1.0;
        currentUtterance.pitch = 1.0;

        buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>`;
        isReading = true;

        currentUtterance.onend = () => {
            buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            isReading = false;
            currentUtterance = null;
        };

        currentUtterance.onerror = (event) => {
            console.error('SpeechSynthesisUtterance.onerror', event);
            alert('Maaf, tidak dapat membaca teks. Error: ' + event.error);
            buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            isReading = false;
            currentUtterance = null;
        };

        speechSynthesis.speak(currentUtterance);
    }
    
    // =================================================================
    // END: FUNGSI BARU DAN MODIFIKASI UNTUK PEMILIHAN SUARA
    // =================================================================

    function stopReading() {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        }
    }

    function getSystemPrompt() {
        const aiName = settings.aiName || 'Wayan';
        const baseInstructions = `Selalu berikan jawabanmu terlebih dahulu. Setelah jawaban utama selesai, berikan 2 atau 3 saran pertanyaan lanjutan yang relevan. Format saran: pisahkan jawaban utama dan saran dengan '[SUGGESTIONS]', dan pisahkan setiap saran dengan tanda pipa '|'.`;
        
        const rolePrompts = {
            guru_jepang: `Kamu adalah seorang guru Bahasa Jepang profesional bernama Tanaka-sensei. Gaya bicaramu sabar, mendidik, dan ramah. Sapa pengguna dengan "Konnichiwa, gakusei-san!" (Halo, murid!). Gunakan huruf Jepang (Hiragana, Katakana, Kanji) beserta romaji dan artinya saat mengajarkan kosakata atau kalimat. Koreksi kesalahan pengguna dengan lembut dan berikan penjelasan tata bahasa yang jelas. Selalu berikan contoh kalimat untuk setiap konsep yang diajarkan. Kamu juga bisa menyisipkan fakta budaya Jepang yang relevan.`,
            guru_matematika: `Kamu adalah seorang guru Matematika yang handal dan bisa membuat konsep sulit menjadi mudah dimengerti. Gaya bicaramu logis, terstruktur, dan suportif. Jelaskan setiap langkah pemecahan masalah secara rinci. Gunakan analogi sederhana jika memungkinkan. Jangan hanya memberikan jawaban akhir, tapi pandu pengguna melalui proses berpikir untuk sampai ke jawaban tersebut.`,
            dokter: `Kamu adalah AI yang berperan sebagai Dokter Umum virtual yang informatif dan empatik. Mulai percakapan dengan sapaan yang menenangkan. Berikan informasi medis yang akurat dan berbasis bukti, namun SELALU awali dan akhiri jawabanmu dengan disclaimer penting: "Informasi ini bersifat edukatif dan tidak menggantikan konsultasi medis profesional. Segera kunjungi dokter atau fasilitas kesehatan terdekat untuk diagnosis dan penanganan yang tepat." Jangan pernah memberikan diagnosis atau resep. Fokus pada penjelasan kondisi medis, gejala umum, dan pilihan gaya hidup sehat.`,
            programmer: `Kamu adalah seorang senior programmer yang sangat berpengalaman dan suka membantu (coding buddy). Gaya bicaramu to-the-point, efisien, dan jelas. Saat pengguna memberikan kode, identifikasi bug, tawarkan optimisasi, dan jelaskan 'mengapa' perbaikanmu lebih baik. Berikan contoh kode yang bersih dan terdokumentasi dengan baik. Selalu tanyakan bahasa pemrograman apa yang digunakan jika tidak disebutkan.`,
            penerjemah: `Kamu adalah seorang penerjemah multibahasa yang sangat akurat. Fokus utamamu adalah menerjemahkan teks dari satu bahasa ke bahasa lain. Saat pengguna memberikan teks, deteksi bahasa aslinya dan tanyakan ke bahasa apa mereka ingin menerjemahkannya. Berikan terjemahan literal dan juga terjemahan kontekstual jika diperlukan, serta jelaskan nuansa budaya atau idiom yang mungkin hilang dalam terjemahan.`,
        };

        let roleInstruction = '';
        
        if (settings.aiRole === 'kustom' && settings.customAiRolePrompt) {
            roleInstruction = settings.customAiRolePrompt;
        } else if (rolePrompts[settings.aiRole]) {
            roleInstruction = rolePrompts[settings.aiRole];
        } else {
            switch (settings.personality) {
                case 'profesional':
                    roleInstruction = `Kamu adalah ${aiName}, asisten AI yang profesional, formal, dan terstruktur.`;
                    break;
                case 'lucu':
                    roleInstruction = `Kamu adalah ${aiName}, asisten AI yang humoris dan kreatif. Sisipkan lelucon jika relevan.`;
                    break;
                case 'santai':
                default:
                    roleInstruction = `Kamu adalah ${aiName}, asisten AI dari StoryBali yang santai, friendly, dan menggunakan bahasa sehari-hari.`;
                    break;
            }
        }

        return `${roleInstruction} ${baseInstructions}`;
    }

    // AI Communication
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        // --- START: MODIFIKASI UNTUK BATAS CHAT ---
        if (!currentUserIP) {
            alert("Harap tunggu sebentar, sedang mengidentifikasi sesi Anda.");
            return;
        }

        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };

        if (userData.count >= CHAT_LIMIT) {
            if (!userData.cooldownUntil) {
                 // Mulai cooldown jika belum ada
                const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
                userData.cooldownUntil = cooldownEndTime;
                allUserData[currentUserIP] = userData;
                saveChatLimitData(allUserData);
                startCooldown(cooldownEndTime);
            }
            return; // Hentikan pengiriman pesan jika limit tercapai
        }

        // Tingkatkan hitungan
        userData.count++;
        allUserData[currentUserIP] = userData;
        saveChatLimitData(allUserData);
        // --- END: MODIFIKASI UNTUK BATAS CHAT ---

        addMessage(message, true);
        addToConversationHistory('user', message);
        input.value = '';
        showTypingIndicator();
        
        // --- START: MODIFIKASI - Mulai cooldown jika pesan ke-5 dikirim ---
        if (userData.count >= CHAT_LIMIT) {
            const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
            userData.cooldownUntil = cooldownEndTime;
            allUserData[currentUserIP] = userData;
            saveChatLimitData(allUserData);
            
            // Tunda aktivasi cooldown sedikit agar AI sempat merespons
            setTimeout(() => startCooldown(cooldownEndTime), 1000);
        }
        // --- END: MODIFIKASI ---


        const apiUrl = getApiUrl();
        if (!apiUrl) {
            hideTypingIndicator();
            addMessage('Maaf, tidak ada API Key yang valid untuk digunakan. Silakan periksa pengaturan API Key Anda.');
            return;
        }

        try {
            const contents = [...conversationHistory];
            const systemPromptText = getSystemPrompt();
            const systemPrompt = {
                role: "user",
                parts: [{ text: systemPromptText }]
            };
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [systemPrompt, ...contents],
                    generationConfig: {
                        temperature: 0.9,
                        topK: 1,
                        topP: 1,
                        maxOutputTokens: 2048,
                    }
                })
            });
            hideTypingIndicator();

            if (!response.ok) {
                 let specificErrorMessage = 'Terjadi kesalahan yang tidak diketahui.';
                if (response.status === 400) {
                    specificErrorMessage = 'Permintaan tidak valid. Mungkin ada masalah dengan format pesan.';
                } else if (response.status === 401 || response.status === 403 || response.status === 429) {
                    specificErrorMessage = 'API Key bermasalah (limit atau tidak valid). Mencoba API Key acak lainnya...';
                    // Coba kirim lagi, fungsi getApiUrl akan mengambil kunci acak baru
                    setTimeout(() => sendMessage(), 1000); 
                    return;
                } else if (response.status >= 500) {
                    specificErrorMessage = 'Terjadi masalah di server AI. Coba lagi beberapa saat.';
                }
                throw new Error(`HTTP error! status: ${response.status}. ${specificErrorMessage}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                let aiResponseText = data.candidates[0].content.parts[0].text;
                
                let mainAnswer = aiResponseText;
                let dynamicSuggestions = [];
                
                if (aiResponseText.includes('[SUGGESTIONS]')) {
                    const parts = aiResponseText.split('[SUGGESTIONS]');
                    mainAnswer = parts[0].trim();
                    dynamicSuggestions = parts[1].split('|').map(s => s.trim()).filter(s => s);
                }
                
                addToConversationHistory('model', mainAnswer);
                addMessage(mainAnswer, false, dynamicSuggestions);
                playNotificationSound();
            } else {
                const defaultMessage = 'Maaf, Wayan tidak dapat memberikan respons untuk pertanyaan ini. Silakan coba pertanyaan lain.';
                addMessage(defaultMessage);
            }
        } catch (error) {
            hideTypingIndicator();
            let displayMessage = `Aduh, Wayan error nih: ${error.message}. Coba lagi ya!`;

            if (error.message.includes('HTTP error!')) {
                displayMessage = error.message.replace('HTTP error! status: ', 'Kesalahan API (Kode ');
                displayMessage = displayMessage.replace('. ', '). ');
            } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                displayMessage = 'Wayan tidak bisa terhubung ke internet. Coba periksa koneksi kamu ya!';
            }

            addMessage(displayMessage);
        }
    }

    async function analyzeImageWithQuestion(base64Image, userQuestion) {
        const apiUrl = getApiUrl();
        if (!apiUrl) {
            hideImageProcessingIndicator();
            addMessage('Maaf, tidak ada API Key yang valid untuk digunakan. Silakan periksa pengaturan API Key Anda.');
            return;
        }

        try {
            const imageData = base64Image.split(',')[1];
            const systemPromptText = getSystemPrompt();
            const promptText = `Ini adalah instruksi sistemmu: "${systemPromptText}". Sekarang, seorang user bertanya: "${userQuestion}". Jawab pertanyaan user tentang gambar ini berdasarkan instruksi sistemmu.`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: promptText },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: imageData
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.9,
                        topK: 32,
                        topP: 1,
                        maxOutputTokens: 2048,
                    }
                })
            });
            hideImageProcessingIndicator();

            if (!response.ok) {
                 let specificErrorMessage = 'Terjadi kesalahan yang tidak diketahui.';
                if (response.status === 400) {
                    specificErrorMessage = 'Permintaan tidak valid. Mungkin ada masalah dengan format gambar atau pertanyaan.';
                } else if (response.status === 401 || response.status === 403 || response.status === 429) {
                    specificErrorMessage = 'API Key bermasalah (limit atau tidak valid). Mencoba API Key acak lainnya...';
                    setTimeout(() => analyzeImageWithQuestion(base64Image, userQuestion), 1000);
                    return; 
                } else if (response.status >= 500) {
                    specificErrorMessage = 'Terjadi masalah di server AI. Coba lagi beberapa saat.';
                }
                throw new Error(`HTTP error! status: ${response.status}. ${specificErrorMessage}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                let aiResponseText = data.candidates[0].content.parts[0].text;
                
                let mainAnswer = aiResponseText;
                let dynamicSuggestions = [];
                
                if (aiResponseText.includes('[SUGGESTIONS]')) {
                    const parts = aiResponseText.split('[SUGGESTIONS]');
                    mainAnswer = parts[0].trim();
                    dynamicSuggestions = parts[1].split('|').map(s => s.trim()).filter(s => s);
                }
                
                addToConversationHistory('model', mainAnswer);
                addMessage(mainAnswer, false, dynamicSuggestions);
                playNotificationSound();
            } else {
                addMessage('Wah, gue ga bisa analisis gambar ini nih. Coba upload gambar lain ya!');
            }
        } catch (error) {
            hideImageProcessingIndicator();
            let displayMessage = `Aduh, Wayan error nih waktu analisis gambar: ${error.message}. Coba lagi ya!`;

            if (error.message.includes('HTTP error!')) {
                displayMessage = error.message.replace('HTTP error! status: ', 'Kesalahan API (Kode ');
                displayMessage = displayMessage.replace('. ', '). ');
            } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                displayMessage = 'Wayan tidak bisa terhubung ke internet. Coba periksa koneksi kamu ya!';
            }

            addMessage(displayMessage);
        }
    }

    // Initialize
    window.addEventListener('load', async () => { // --- MODIFIKASI: Menjadikan fungsi async ---
        loadApiKeys();
        loadSettings();
        updateApiStatus();
        
        // --- START: MODIFIKASI UNTUK FITUR BATAS CHAT ---
        currentUserIP = await getUserIP(); // Dapatkan IP saat memuat
        checkUserStatus(); // Cek status cooldown pengguna
        // --- END: MODIFIKASI ---

        // Panggil populateVoiceList setelah load dan juga pasang listener
        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        
        const chatMessages = document.getElementById('chatMessages');
        const messages = chatMessages.querySelectorAll('.message-bubble');
        for (let i = messages.length - 1; i > 0; i--) {
            messages[i].remove();
        }
        loadConversationHistory();
        updateChatCount();
        hideTypingIndicator();
        hideImageProcessingIndicator();
        
        document.getElementById('aiNameInput').addEventListener('change', (event) => {
            settings.aiName = event.target.value;
            saveSettings();
            document.querySelector('.header-gradient h1').textContent = settings.aiName;
        });

        document.getElementById('fontSizeSelect').addEventListener('change', changeFontSize);
        document.getElementById('saveHistoryToggle').addEventListener('change', saveSettings);
        
        document.getElementById('personalitySelect').addEventListener('change', (event) => {
            const selectedText = event.target.options[event.target.selectedIndex].text;
            settings.personality = event.target.value;
            saveSettings();
            addSystemMessage(`Gaya bahasa AI diubah menjadi: ${selectedText}`);
        });

        const aiRoleSelect = document.getElementById('aiRoleSelect');
        const customRoleContainer = document.getElementById('customRoleContainer');
        const customRoleInput = document.getElementById('customRoleInput');

        aiRoleSelect.addEventListener('change', (event) => {
            const selectedRole = event.target.value;
            const selectedText = event.target.options[event.target.selectedIndex].text;
            settings.aiRole = selectedRole;

            if (selectedRole === 'kustom') {
                customRoleContainer.classList.remove('hidden');
            } else {
                customRoleContainer.classList.add('hidden');
                addSystemMessage(`Mode peran AI diubah menjadi: ${selectedText}`);
            }
            saveSettings();
        });

        customRoleInput.addEventListener('change', (event) => {
            settings.customAiRolePrompt = event.target.value;
            saveSettings();
            addSystemMessage(`Mode peran kustom AI telah ditetapkan.`);
        });
        
        // Listener untuk dropdown suara baru
        document.getElementById('voiceSelect').addEventListener('change', (event) => {
            settings.voiceURI = event.target.value;
            saveSettings();
        });

    });

    // Close modals on outside click
    ['profileModal', 'imagePreviewModal', 'settingsModal'].forEach(modalId => {
        document.getElementById(modalId).addEventListener('click', (e) => {
            if (e.target.id === modalId) {
                if (modalId === 'profileModal') hideProfileModal();
                else if (modalId === 'imagePreviewModal') hideImagePreview();
                else if (modalId === 'settingsModal') toggleSettings();
            }
        });
    });

    // Prevent zoom on input focus (iOS)
    document.addEventListener('touchstart', function () {
    }, true);
</script>
</body>
</html>
