   <!DOCTYPE html>
<html lang="id">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title>Wayan AI - Storybali</title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2299.77">
  <!-- Viewport diubah untuk menangani safe area (home bar) di iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LANGKAH 1: Tambahkan Library Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    * {
        -webkit-tap-highlight-color: transparent;
    }

    html, body {
        background: #ffffff !important;
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: #f0f2f5 !important;
    }

    /* PERBAIKAN: Menggunakan variabel --vh untuk tinggi yang benar di mobile */
    .chat-container {
        background: #ffffff;
        height: calc(var(--vh, 1vh) * 100);
        width: 100vw;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .chat-window {
        background: white;
        border: none;
        box-shadow: none;
        animation: slideInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        height: 100%;
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        border-radius: 0;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        position: relative;
        overflow: hidden;
    }
    .header-gradient::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        animation: shimmer 3s infinite;
    }
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .ai-avatar {
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: avatarPulse 2s infinite; position: relative;
        border: 3px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
        border-radius: 9999px !important;
    }
    .ai-avatar::after {
        content: ''; position: absolute; inset: -2px;
        background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
        border-radius: inherit; z-index: -1;
        animation: rotate 4s linear infinite;
    }
    @keyframes avatarPulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .message-bubble {
        animation: messageSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-origin: bottom left; margin-bottom: 1rem;
    }
    .message-bubble.user { transform-origin: bottom right; }
    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(20px) scale(0.8); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .ai-message {
        background: #e2e8f0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        border: 1px solid rgba(102, 126, 234, 0.05);
        border-radius: 1.25rem; border-top-left-radius: 0.375rem;
        padding: 1rem; max-width: 85%; position: relative;
    }
    .user-message {
        background: linear-gradient(135deg, #10b981, #059669);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); color: white;
        border-radius: 1.25rem; border-top-right-radius: 0.375rem;
        padding: 1rem; max-width: 85%;
    }
    .system-message-bubble {
        display: flex; justify-content: center; margin: 0.5rem 0;
        animation: messageSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .system-message {
        background-color: #e2e8f0; color: #4a5568; font-size: 0.75rem;
        font-style: italic; padding: 0.25rem 0.75rem; border-radius: 9999px;
    }

    .typing-indicator { display: none; align-items: center; margin-bottom: 1rem; }
    .typing-indicator.show { display: flex; animation: fadeInBounce 0.5s ease-out; }
    @keyframes fadeInBounce {
        0% { opacity: 0; transform: translateY(10px) scale(0.8); }
        60% { opacity: 1; transform: translateY(-2px) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dot {
        width: 8px; height: 8px; border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: typing 1.4s infinite ease-in-out; margin: 0 2px;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    .dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8) translateY(0); opacity: 0.5; }
        40% { transform: scale(1.2) translateY(-8px); opacity: 1; }
    }

    /* --- PERUBAHAN STYLE UNTUK INPUT AREA BARU --- */
    .input-area {
        background: white;
        border-top: 1px solid #e2e8f0;
        padding: 0.75rem 1rem calc(0.75rem + env(safe-area-inset-bottom)) 1rem;
    }

    .input-box {
        display: flex;
        flex-direction: column;
        width: 100%;
        background-color: #f1f5f9;
        border-radius: 1.25rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid #e2e8f0;
    }

    .input-box input {
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        padding: 0.5rem;
        font-size: 16px;
        color: #1e293b;
    }

    .input-box input::placeholder {
        color: #64748b;
    }

    .action-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.5rem;
    }

    .action-buttons .left-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .action-btn {
        color: #475569;
        background: none;
        border: none;
        cursor: pointer;
        transition: color 0.2s ease;
        padding: 0.25rem;
    }
    .action-btn:hover {
        color: #4f46e5;
    }

    .action-btn span {
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .dynamic-icon-container {
        position: relative;
        width: 2.5rem;
        height: 2.5rem;
    }

    .dynamic-icon-btn {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #e2e8f0;
        border-radius: 9999px;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        border: none;
        cursor: pointer;
    }
    .dynamic-icon-btn.send-btn-active {
        background-color: #4f46e5;
        color: white;
    }
    .dynamic-icon-btn:active {
        transform: scale(0.9);
    }
    /* --- AKHIR PERUBAHAN STYLE --- */

    .voice-wave { display: none; align-items: center; gap: 4px; height: 24px; }
    .voice-wave.active { display: flex; }
    .wave-bar { width: 4px; height: 100%; background: #667eea; border-radius: 2px; animation: waveAnimation 1s infinite ease-in-out; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes waveAnimation {
        0%, 40%, 100% { transform: scaleY(0.4); }
        20% { transform: scaleY(1); }
    }

    .quick-actions {
        display: flex; gap: 0.5rem; padding: 0.75rem 1rem;
        background: white; border-top: 1px solid #e2e8f0;
        overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;
        box-shadow: inset 0 -2px 5px rgba(0, 0, 0, 0.03);
    }
    .quick-actions::-webkit-scrollbar { display: none; }
    .quick-action-btn {
        flex-shrink: 0; padding: 0.5rem 1rem; background: #e0e7ff;
        border: 1px solid #a7c0ff; border-radius: 9999px; font-size: 0.75rem;
        font-weight: 500; color: #4f46e5; transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .quick-action-btn:hover { background: #c7d2fe; border-color: #6366f1; transform: translateY(-1px); }
    .quick-action-btn:active { background: #a5b4fc; transform: scale(0.98); }

    .suggestion-btn {
        background: #f0f2f5; border: 1px solid #cbd5e1;
        border-radius: 9999px; font-size: 0.7rem; color: #4a5568;
        transition: all 0.2s ease-in-out; padding: 0.4rem 0.8rem;
    }
    .suggestion-btn:hover, .suggestion-btn:active {
        background: #e2e8f0; border-color: #a0aec0; transform: translateY(-1px);
    }

    .modal-overlay {
        background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
        transition: opacity 0.3s ease;
    }
    .modal-content {
        background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(25px);
        border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 1.5rem;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    }
    #settingsModal .modal-content {
        background: #f7f8fc; padding: 0; overflow: hidden;
    }
    .modal-overlay.hidden { opacity: 0; pointer-events: none; }
    .modal-overlay:not(.hidden) .modal-content { opacity: 1; transform: scale(1); }
    .modal-close-btn {
        background: #ef4444; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        transition: all 0.2s ease-in-out; border-radius: 9999px !important;
    }
    #settingsModal .modal-close-btn {
        background: #e2e8f0; box-shadow: none; color: #475569;
    }
    #settingsModal .modal-close-btn:hover { background: #cbd5e1; transform: scale(1.05); }
    .modal-close-btn:hover { background: #dc2626; transform: scale(1.05); }
    .modal-close-btn:active { transform: scale(0.95); }

    .profile-avatar-border {
        border: 4px solid;
        border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;
        animation: rotateBorder 4s linear infinite;
        border-radius: 9999px !important;
    }
    @keyframes rotateBorder {
        0% { border-image-source: linear-gradient(135deg, #667eea, #764ba2, #f093fb); }
        25% { border-image-source: linear-gradient(135deg, #764ba2, #f093fb, #667eea); }
        50% { border-image-source: linear-gradient(135deg, #f093fb, #667eea, #764ba2); }
        75% { border-image-source: linear-gradient(135deg, #667eea, #764ba2, #f093fb); }
        100% { border-image-source: linear-gradient(135deg, #764ba2, #f093fb, #667eea); }
    }
    
    .settings-tab { transition: all 0.3s ease; border-bottom: 2px solid transparent; }
    .settings-tab.active { color: #4f46e5; font-weight: 600; border-bottom-color: #4f46e5; }
    .settings-tab-content { display: none; animation: fadeIn 0.5s ease; }
    .settings-tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .settings-card {
        background: white; border-radius: 1rem; padding: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); transition: all 0.3s ease;
    }
    .settings-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08); }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid #f1f5f9; }
    .settings-item.flex-col {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-icon { width: 1.25rem; height: 1.25rem; color: #6366f1; }
    .settings-input, .settings-select, #customRoleInput {
        border-radius: 0.5rem; background: #f8fafc; border: 1px solid #e2e8f0;
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease-in-out; width: 55%;
        font-size: 16px !important; /* Mencegah zoom di iOS */
    }
    .settings-input:focus, .settings-select:focus, #customRoleInput:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none;
    }
    .settings-btn-action {
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        padding: 0.75rem; border-radius: 0.75rem; font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .settings-btn-action:hover { transform: translateY(-1px); }
    .settings-btn-action:active { transform: scale(0.98); }
    .theme-option-new {
        border-radius: 0.75rem; padding: 0.5rem; border: 2px solid transparent;
        transition: all 0.2s ease-in-out; cursor: pointer; text-align: center;
    }
    .theme-option-new.active { border-color: #4f46e5; background-color: #eef2ff; }
    .theme-swatch { width: 100%; height: 1.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .toggle-new {
        appearance: none; width: 44px; height: 24px; border-radius: 12px;
        background-color: #cbd5e1; position: relative; cursor: pointer; transition: background-color 0.3s ease;
    }
    .toggle-new::before {
        content: ''; position: absolute; top: 3px; left: 3px;
        width: 18px; height: 18px; border-radius: 50%; background-color: white;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-new:checked { background-color: #6366f1; }
    .toggle-new:checked::before { transform: translateX(20px); }

    /* PENAMBAHAN: Style untuk tombol pilihan baru */
    .choice-btn {
        width: 100%;
        padding: 0.5rem;
        background: #f1f5f9;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: #475569;
        transition: all 0.2s ease-in-out;
        text-align: center;
        cursor: pointer;
    }
    .choice-btn:hover {
        background: #e2e8f0;
        border-color: #cbd5e1;
    }
    .choice-btn.active {
        background: #eef2ff;
        border-color: #6366f1;
        color: #4f46e5;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
    }

    /* LANGKAH 2: Tambahkan CSS untuk Format Markdown */
    .markdown-content p:not(:last-child) {
        margin-bottom: 0.75rem;
    }
    .markdown-content ul, .markdown-content ol {
        list-style-position: inside;
        padding-left: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .markdown-content li {
        margin-bottom: 0.25rem;
    }
    .markdown-content code:not(pre > code) {
        background-color: #d1d5db;
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.85em;
        font-family: 'Courier New', Courier, monospace;
    }
    .markdown-content pre {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 0.75rem;
        font-size: 0.85em;
    }
    .markdown-content pre code {
        background: transparent;
        padding: 0;
    }
    .markdown-content blockquote {
        border-left: 4px solid #a5b4fc;
        padding-left: 1rem;
        margin-left: 0.25rem;
        font-style: italic;
        color: #475569;
    }
    .markdown-content strong {
      font-weight: 600;
    }


    @media (max-width: 768px) {
        .message-bubble { margin-bottom: 0.75rem; }
        .ai-message, .user-message { max-width: 90%; padding: 0.8rem 1.2rem; }
        .quick-actions { padding: 0.6rem 0.8rem; }
        .quick-action-btn { padding: 0.4rem 0.8rem; font-size: 0.7rem; }
        .modal-content { border-radius: 1rem; padding: 1.5rem; }
        #settingsModal .modal-content { padding: 0; }
        .settings-input, .settings-select, #customRoleInput {
            font-size: 16px !important;
        }
    }
    
    .chat-messages::-webkit-scrollbar { width: 8px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2); border-radius: 20px;
      border: 2px solid transparent; background-clip: content-box;
    }
    .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.3); }
  </style>
</head>
<body>
<!-- Konten HTML lainnya tetap sama -->
<div class="chat-container">
    <div class="chat-window flex flex-col">
        <!-- Header -->
        <div class="header-gradient p-4 text-white relative flex-shrink-0">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="ai-avatar w-12 h-12 flex items-center justify-center overflow-hidden relative cursor-pointer"
                         onclick="showProfileModal()">
                        <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali"
                             class="w-full h-full object-cover">
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">Wayan AI</h1>
                        <p class="text-blue-100 text-sm opacity-90">Klik untuk lihat profil</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <!-- PERUBAHAN: Tombol Mikrofon dihapus dari sini -->
                    <button onclick="toggleSettings()"
                            class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <!-- Quick Actions -->
        <div class="quick-actions flex-shrink-0">
            <button class="quick-action-btn" onclick="sendQuickMessage('Halo Wayan!')">Halo</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Apa kabar hari ini?')">Apa kabar?</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Ceritakan joke lucu dong!')">Joke</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Kasih tips produktif dong!')">Tips Produktif</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Rekomendasi film bagus dong!')">Film</button>
            <button class="quick-action-btn" onclick="sendQuickMessage('Ajarin coding dong!')">Coding</button>
        </div>
        <!-- Chat Messages -->
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 chat-messages">
            <div class="message-bubble flex items-start space-x-3">
                <div class="ai-avatar w-8 h-8 flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <div class="ai-message p-4 max-w-xs relative">
                    <div class="markdown-content text-gray-800 leading-relaxed text-sm"><p>Halo! Gue Wayan nih, AI assistant yang siap bantu jawab pertanyaan kamu. Santai aja, tanya apa aja yang kamu mau tau ya!</p></div>
                    <div class="mt-3">
                        <!-- Suggestions will be generated here -->
                    </div>
                    <!-- Tombol Pembaca Jawaban AI & Copy -->
                    <button onclick="readAiResponse(this, 'SGFsbyEgR3VlIFdheWFuIG5paCwgQUkgYXNzaXN0YW50IHlhbmcgc2lhcCBiYW50dSBqYXdhYiBwZXJ0YW55YW4ga2FtdS4gU2FudGFpIGFqYSwgdGFueWEgYXBhIGFqYSB5YW4nZyBrYW11IG1hdSB0YXUgeWEh')" class="absolute bottom-2 right-2 w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 ease-in-out transform hover:scale-110 active:scale-90" title="Baca Jawaban">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <!-- Typing Indicator -->
            <div id="typingIndicator" class="typing-indicator items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <div class="ai-message rounded-2xl rounded-tl-md p-4">
                    <div class="flex space-x-1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                </div>
            </div>
            <!-- Image Processing Indicator -->
            <div id="imageProcessingIndicator" class="typing-indicator items-start space-x-3">
                <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <div class="ai-message rounded-2xl rounded-tl-md p-4">
                    <div class="flex space-x-1">
                        <div class="dot"></div>
                        <div class="dot"></div>
                        <div class="dot"></div>
                    </div>
                    <span class="ml-2 text-gray-600 text-sm">Menganalisis gambar...</span>
                </div>
            </div>
        </div>
        
        <!-- ============================================== -->
        <!--        PERUBAHAN BESAR: INPUT AREA BARU        -->
        <!-- ============================================== -->
        <div class="input-area flex-shrink-0">
            <div class="input-box">
                <!-- Baris Atas: Kolom Input Teks -->
                <input
                    type="text"
                    id="messageInput"
                    placeholder="Minta Wayan AI..."
                    onkeypress="handleKeyPress(event)"
                    oninput="handleInputChange(event)"
                >
                <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                
                <!-- Baris Bawah: Tombol Aksi -->
                <div class="action-buttons">
                    <div class="left-actions">
                        <button onclick="triggerImageUpload()" class="action-btn" title="Upload Gambar">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </button>
                        <button onclick="videoNotAvailable()" class="action-btn" title="Fitur Video">
                            <span>Video</span>
                        </button>
                        <button onclick="openQuickSettings()" class="action-btn" title="Pengaturan Cepat">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                        </button>
                    </div>
                    
                    <!-- Tombol Dinamis: Mikrofon atau Kirim -->
                    <div class="dynamic-icon-container">
                        <button id="micBtn" onclick="toggleVoiceMode()" class="dynamic-icon-btn" title="Mode Suara">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                               <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                            </svg>
                        </button>
                        <button id="sendBtn" onclick="sendMessage()" class="dynamic-icon-btn send-btn-active" title="Kirim Pesan" style="opacity: 0; pointer-events: none;">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
             <!-- Voice Wave Animation -->
            <div id="voiceWave" class="voice-wave justify-center mt-2">
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
                <div class="wave-bar"></div>
            </div>
        </div>
        <!-- ============================================== -->
        <!--        AKHIR DARI INPUT AREA BARU              -->
        <!-- ============================================== -->
    </div>
    
    <!-- Modals (Profile, Settings, Image Preview) -->
    <!-- ... Konten modal tidak berubah ... -->
    <div id="imagePreviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content p-6 max-w-sm w-full"
             id="imagePreviewContent">
            <div class="text-center relative">
                <button onclick="hideImagePreview()"
                        class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="mb-4">
                    <img id="previewImage" src="" alt="Preview" class="w-full h-auto rounded-lg max-h-48 object-cover mx-auto shadow-md">
                    <p id="previewFileName" class="text-sm text-gray-600 mt-2"></p>
                </div>
                <div class="mb-4">
                    <label class="block text-left text-sm font-medium text-gray-700 mb-2">Tanya sesuatu tentang gambar
                        ini:</label>
                    <textarea
                            id="imageQuestionInput"
                            placeholder="Contoh: Apa yang ada di gambar ini? Jelaskan detail yang kamu lihat..."
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm settings-input"
                            rows="3"
                    ></textarea>
                </div>
                <div class="flex space-x-3">
                    <button onclick="hideImagePreview()"
                            class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn">
                        Batal
                    </button>
                    <button onclick="sendImageWithQuestion()"
                            class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn">
                        Kirim
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="profileModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content p-6 max-w-sm w-full"
             id="profileModalContent">
            <div class="text-center relative">
                <button onclick="hideProfileModal()"
                        class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                    <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
                <div class="w-20 h-20 mx-auto mb-4 overflow-hidden profile-avatar-border shadow-lg">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
                </div>
                <h2 class="text-xl font-bold text-gray-800 mb-2">Wayan AI</h2>
                <p class="text-purple-600 font-semibold mb-4 text-sm">AI Assistant Dari Storybali</p>
                <div class="text-gray-600 text-xs leading-relaxed mb-4 text-left bg-gray-50 p-3 rounded-xl">
                    <p class="mb-2"><strong>Halo! Gue Wayan!</strong></p>
                    <p class="mb-2">Gue adalah AI assistant yang dibuat khusus untuk membantu kamu dengan gaya bahasa yang santai dan friendly.</p>
                    <p>Santai aja, tanya apa aja yang kamu mau!</p>
 <p>kepoin wayan yuk di instagram atau chat wa pribadi wayan!</p>
                </div>
                <div class="grid grid-cols-2 gap-2 text-xs">
                    <a href="https://www.instagram.com/sudiarsana_wayan?igsh=MXE4NHFvZzAyOXd6NQ%3D%3D&utm_source=qr" target="_blank"
                       class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-3 py-2 rounded-full settings-btn">
                        Instagram
                    </a>
                    <a href="https://wa.me/message/RNPBCG25N5V2A1" target="_blank"
                       class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-2 rounded-full settings-btn">
                        WhatsApp
                    </a>
                </div>
            </div>
        </div>
    </div>
    <div id="settingsModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
        <div class="modal-content max-w-sm w-full max-h-[90vh] overflow-hidden flex flex-col" id="settingsModalContent">
            <div class="p-4 flex items-center justify-between flex-shrink-0 bg-white border-b border-gray-200">
                <h3 class="text-lg font-bold text-gray-800">Pengaturan</h3>
                <button onclick="toggleSettings()" class="w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="flex-shrink-0 bg-white border-b border-gray-200">
                <nav class="flex justify-around text-sm text-gray-600">
                    <button onclick="switchSettingsTab('general')" class="settings-tab active flex-1 py-3 px-2 text-center">Umum</button>
                    <button onclick="switchSettingsTab('appearance')" class="settings-tab flex-1 py-3 px-2 text-center">Tampilan</button>
                    <button onclick="switchSettingsTab('advanced')" class="settings-tab flex-1 py-3 px-2 text-center">Lanjutan</button>
                </nav>
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-4">
                <div id="tab-general" class="settings-tab-content active space-y-4">
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Nama AI</label>
                            </div>
                            <!-- PERUBAHAN: Input nama AI dibuat read-only -->
                            <input type="text" id="aiNameInput" value="Wayan" class="settings-input text-right" readonly style="background-color: #e9ecef; cursor: not-allowed;" title="Nama AI tidak dapat diubah.">
                        </div>
                        <div class="settings-item flex-col">
                            <div class="w-full flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 0v2M3 19h18M5 15h14M9 11h6"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Bahasa</label>
                            </div>
                            <div class="grid grid-cols-2 gap-2 w-full pt-2">
                                <button id="language-id" onclick="selectChoice('language', 'id', this)" class="choice-btn">Indonesia</button>
                                <button id="language-en" onclick="selectChoice('language', 'en', this)" class="choice-btn">English</button>
                            </div>
                        </div>
                        <div class="settings-item flex-col">
                            <div class="w-full flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Gaya Bahasa</label>
                            </div>
                            <div class="grid grid-cols-3 gap-2 w-full pt-2">
                                <button id="personality-santai" onclick="selectChoice('personality', 'santai', this)" class="choice-btn">Santai</button>
                                <button id="personality-profesional" onclick="selectChoice('personality', 'profesional', this)" class="choice-btn">Profesional</button>
                                <button id="personality-lucu" onclick="selectChoice('personality', 'lucu', this)" class="choice-btn">Humoris</button>
                            </div>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-item flex-col">
                             <div class="w-full flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V21H9z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Mode Peran AI</label>
                            </div>
                            <div class="grid grid-cols-3 gap-2 w-full pt-2">
                                <button id="aiRole-umum" onclick="selectChoice('aiRole', 'umum', this)" class="choice-btn">Umum</button>
                                <button id="aiRole-guru_jepang" onclick="selectChoice('aiRole', 'guru_jepang', this)" class="choice-btn">B. Jepang</button>
                                <button id="aiRole-guru_matematika" onclick="selectChoice('aiRole', 'guru_matematika', this)" class="choice-btn">Matematika</button>
                                <button id="aiRole-dokter" onclick="selectChoice('aiRole', 'dokter', this)" class="choice-btn">Dokter</button>
                                <button id="aiRole-programmer" onclick="selectChoice('aiRole', 'programmer', this)" class="choice-btn">Programmer</button>
                                <button id="aiRole-penerjemah" onclick="selectChoice('aiRole', 'penerjemah', this)" class="choice-btn">Penerjemah</button>
                                <button id="aiRole-kustom" onclick="selectChoice('aiRole', 'kustom', this)" class="choice-btn col-span-3">Kustom...</button>
                            </div>
                        </div>
                        <div id="customRoleContainer" class="hidden p-2 mt-2">
                            <label class="block text-xs text-gray-600 mb-1">Definisikan peran kustom AI:</label>
                            <textarea id="customRoleInput" placeholder="Contoh: Kamu adalah seorang ahli sejarah..." class="w-full settings-input text-sm" rows="3"></textarea>
                        </div>
                    </div>
                </div>
                <div id="tab-appearance" class="settings-tab-content space-y-4">
                    <div class="settings-card">
                        <div class="p-2">
                            <h4 class="text-sm font-medium text-gray-700 mb-3">Tema Warna</h4>
                            <div class="grid grid-cols-3 gap-3">
                                <div onclick="changeTheme('blue')" id="themeBlue" class="theme-option-new active">
                                    <div class="theme-swatch bg-gradient-to-r from-blue-500 to-purple-500"></div>
                                    <span class="text-xs font-medium text-gray-600">Biru</span>
                                </div>
                                <div onclick="changeTheme('green')" id="themeGreen" class="theme-option-new">
                                    <div class="theme-swatch bg-gradient-to-r from-green-500 to-teal-500"></div>
                                    <span class="text-xs font-medium text-gray-600">Hijau</span>
                                </div>
                                <div onclick="changeTheme('pink')" id="themePink" class="theme-option-new">
                                    <div class="theme-swatch bg-gradient-to-r from-pink-500 to-red-500"></div>
                                    <span class="text-xs font-medium text-gray-600">Pink</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Ukuran Font</label>
                            </div>
                            <select id="fontSizeSelect" class="settings-select text-right w-auto">
                                <option value="sm">Kecil</option>
                                <option value="base" selected>Normal</option>
                                <option value="lg">Besar</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Efek Animasi</label>
                            </div>
                            <input type="checkbox" id="animationToggle" class="toggle-new" checked>
                        </div>
                    </div>
                    <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Suara Notifikasi</label>
                            </div>
                            <input type="checkbox" id="soundToggle" class="toggle-new" checked>
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Pembaca Jawaban</label>
                            </div>
                            <input type="checkbox" id="readAiResponseToggle" class="toggle-new" checked>
                        </div>
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Jenis Suara</label>
                            </div>
                             <select id="voiceSelect" class="settings-select text-right">
                                <option value="">Memuat suara...</option>
                             </select>
                        </div>
                    </div>
                </div>
                <div id="tab-advanced" class="settings-tab-content space-y-4">
                     <div class="settings-card">
                        <div class="settings-item">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Simpan Riwayat</label>
                            </div>
                            <input type="checkbox" id="saveHistoryToggle" class="toggle-new" checked>
                        </div>
                        <div class="p-2 space-y-2">
                             <button onclick="exportChatHistory()" class="settings-btn-action bg-green-100 text-green-700 hover:bg-green-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                <span>Export Riwayat (.txt)</span>
                             </button>
                             <button onclick="clearChatHistory()" class="settings-btn-action bg-red-100 text-red-700 hover:bg-red-200">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                <span>Hapus Riwayat Chat</span>
                             </button>
                        </div>
                    </div>
                    <div class="settings-card p-4">
                        <h4 class="text-sm font-semibold text-gray-800 mb-3">API Keys (Gemini)</h4>
                        <div class="space-y-2 text-sm">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 1 (Utama)</label>
                                <input type="password" id="apiKey1" placeholder="Masukkan API Key" class="settings-input w-full">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 2 (Cadangan)</label>
                                <input type="password" id="apiKey2" placeholder="Opsional" class="settings-input w-full">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 3 (Cadangan)</label>
                                <input type="password" id="apiKey3" placeholder="Opsional" class="settings-input w-full">
                            </div>
                             <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 4 (Cadangan)</label>
                                <input type="password" id="apiKey4" placeholder="Opsional" class="settings-input w-full">
                            </div>
                             <div>
                                <label class="block text-xs text-gray-500 mb-1">API Key 5 (Cadangan)</label>
                                <input type="password" id="apiKey5" placeholder="Opsional" class="settings-input w-full">
                            </div>
                            <button onclick="saveApiKeys()" class="w-full settings-btn-action bg-blue-600 text-white mt-4 hover:bg-blue-700">
                                Simpan API Keys
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0">
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="resetAllSettings()" class="settings-btn-action bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm py-2">
                        <span>Reset</span>
                    </button>
                    <button onclick="saveAllSettings()" class="settings-btn-action bg-blue-600 text-white hover:bg-blue-700 text-sm py-2">
                        <span>Simpan & Tutup</span>
                    </button>
                </div>
            </div>
            <div class="p-3 bg-white border-t border-gray-200 flex-shrink-0 text-center">
                <p class="text-xs text-gray-500">StoryBali v2.4 | © 2024</p>
            </div>
        </div>
    </div>
</div>

<script>
    // PERBAIKAN: Fungsi untuk menyesuaikan tinggi layar pada mobile
    function adjustHeightForMobile() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    // Panggil fungsi saat halaman dimuat dan saat ukuran jendela berubah
    window.addEventListener('resize', adjustHeightForMobile);
    adjustHeightForMobile();

    // Variabel Global
    let apiKeys = [];
    let conversationHistory = [];
    let isVoiceMode = false;
    let recognition = null;

    // --- START: PENGATURAN FITUR BATAS CHAT ---
    const CHAT_LIMIT = 4; // Batas jumlah chat
    const COOLDOWN_MINUTES =1; // Durasi cooldown dalam menit
    let currentUserIP = null;
    let countdownInterval = null;
    // --- END: PENGATURAN FITUR BATAS CHAT ---

    // Objek Pengaturan Default
    const defaultSettings = {
        theme: 'blue',
        soundEnabled: true,
        animationsEnabled: true,
        readAiResponseEnabled: true,
        aiName: 'Wayan', // PERUBAHAN: Nama default diubah menjadi 'Wayan'
        language: 'id',
        personality: 'santai',
        aiRole: 'umum',
        customAiRolePrompt: '',
        fontSize: 'base',
        voiceURI: '',
        saveHistory: true
    };
    
    // Settings dimuat dari localStorage atau dari default
    let settings = { ...defaultSettings };

    // Variables for AI response reader
    let currentUtterance = null;
    let isReading = false;

    // ==================================================================================================================
    // TEMPAT UNTUK MENGISI API KEY ANDA
    // ==================================================================================================================
    const DEFAULT_API_KEY_1 = 'AIzaSyClcqSMaHiXMZI4qYlTySqC3I3hWWg8H9s'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_2 = 'AIzaSyB8OPwzNAAyO1nWd9g185rx4YK3WIJy_Fw'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_3 = 'AIzaSyAYzvB1mfVdjrBtXY2n4-UUzCH5juQt8rU'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_4 = 'AIzaSyCkkekhKcQzFUUjx8ZcuqEYyqRde1ZDJcU'; // Ganti dengan kunci asli Anda
    const DEFAULT_API_KEY_5 = 'AIzaSyCV-88PX1_tKh5VBjki9VeyY8gAH5bpZ0o'; // Ganti dengan kunci asli Anda
    // ==================================================================================================================
    
    // --- START: FUNGSI BARU UNTUK BATAS CHAT ---

    async function getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) {
                throw new Error('Gagal mendapatkan IP');
            }
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Tidak bisa mendapatkan IP address:", error);
            return 'default_user';
        }
    }

    function getChatLimitData() {
        const data = localStorage.getItem('wayanAiChatLimit');
        return data ? JSON.parse(data) : {};
    }

    function saveChatLimitData(data) {
        localStorage.setItem('wayanAiChatLimit', JSON.stringify(data));
    }

    function checkUserStatus() {
        if (!currentUserIP) return;

        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP];

        if (userData && userData.cooldownUntil && new Date().getTime() < userData.cooldownUntil) {
            startCooldown(userData.cooldownUntil);
        } else if (userData) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }
    }

    function setInputEnabled(enabled, message = "Minta Wayan AI...") {
        const messageInput = document.getElementById('messageInput');
        messageInput.disabled = !enabled;
        messageInput.placeholder = message;

        // Menonaktifkan semua tombol aksi jika input dinonaktifkan
        document.querySelectorAll('.action-btn, .dynamic-icon-btn').forEach(btn => {
            btn.disabled = !enabled;
            btn.style.opacity = enabled ? '1' : '0.5';
            btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
        });
    }

    function startCooldown(cooldownEndTime) {
        setInputEnabled(false, "Anda mencapai batas limit. Silakan tunggu...");

        const messageId = `cooldown-timer-${currentUserIP}`;
        
        const oldTimerMessage = document.getElementById(messageId);
        if(oldTimerMessage) {
            oldTimerMessage.remove();
        }

        const chatMessages = document.getElementById('chatMessages');
        const timerMessageElement = document.createElement('div');
        timerMessageElement.className = 'system-message-bubble';
        timerMessageElement.id = messageId; 
        chatMessages.insertBefore(timerMessageElement, document.getElementById('typingIndicator'));
        
        scrollToBottom(); 

        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        countdownInterval = setInterval(() => {
            const now = new Date().getTime();
            const distance = cooldownEndTime - now;

            if (distance < 0) {
                endCooldown();
                return;
            }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            timerMessageElement.innerHTML = `<div class="system-message">Anda mencapai batas limit mengirim chat. Kembali setelah ${minutes}m ${seconds}s lagi.</div>`;
        }, 1000);
    }
    
    function endCooldown() {
        clearInterval(countdownInterval);
        countdownInterval = null;
        
        const timerMessageElement = document.getElementById(`cooldown-timer-${currentUserIP}`);
        if (timerMessageElement) {
            timerMessageElement.innerHTML = `<div class="system-message">Anda sudah bisa mengobrol lagi!</div>`;
        }

        const allUserData = getChatLimitData();
        if (allUserData[currentUserIP]) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }

        setInputEnabled(true);
    }

    // --- END: FUNGSI BARU UNTUK BATAS CHAT ---

    // ===============================================
    //      PENAMBAHAN FUNGSI UNTUK INPUT BARU
    // ===============================================
    function handleInputChange(event) {
        const messageInput = event.target;
        const micBtn = document.getElementById('micBtn');
        const sendBtn = document.getElementById('sendBtn');

        if (messageInput.value.trim().length > 0) {
            // Ada teks, tampilkan tombol kirim
            micBtn.style.opacity = '0';
            micBtn.style.pointerEvents = 'none';
            sendBtn.style.opacity = '1';
            sendBtn.style.pointerEvents = 'auto';
        } else {
            // Tidak ada teks, tampilkan tombol mic
            micBtn.style.opacity = '1';
            micBtn.style.pointerEvents = 'auto';
            sendBtn.style.opacity = '0';
            sendBtn.style.pointerEvents = 'none';
        }
    }

    function videoNotAvailable() {
        alert('Fitur video belum tersedia untuk saat ini.');
    }

    function openQuickSettings() {
        const modal = document.getElementById('settingsModal');
        // Buka modal jika sedang tertutup
        if (modal.classList.contains('hidden')) {
            toggleSettings();
        }
        // Pastikan tab 'Umum' yang aktif karena di sana ada pengaturan peran & gaya bahasa
        switchSettingsTab('general');
    }
    // ===============================================

    // API Key Management
    function saveApiKeys() {
        const keysToSave = [];
        for (let i = 1; i <= 5; i++) {
            const key = document.getElementById(`apiKey${i}`).value.trim();
            keysToSave.push(key);
        }
        localStorage.setItem('storybaliApiKeys', JSON.stringify(keysToSave));
        alert('API Keys berhasil disimpan!');
        loadApiKeys();
        updateApiStatus();
    }

    function loadApiKeys() {
        const savedKeys = localStorage.getItem('storybaliApiKeys');
        if (savedKeys) {
            apiKeys = JSON.parse(savedKeys);
            for (let i = 0; i < apiKeys.length; i++) {
                const inputElement = document.getElementById(`apiKey${i + 1}`);
                if (inputElement) {
                    inputElement.value = apiKeys[i];
                }
            }
        } else {
            apiKeys = [
                DEFAULT_API_KEY_1,
                DEFAULT_API_KEY_2,
                DEFAULT_API_KEY_3,
                DEFAULT_API_KEY_4,
                DEFAULT_API_KEY_5
            ];
            for (let i = 0; i < apiKeys.length; i++) {
                const inputElement = document.getElementById(`apiKey${i + 1}`);
                if (inputElement) {
                    inputElement.value = apiKeys[i];
                }
            }
        }
    }

    function updateApiStatus() {
        const hasValidKey = apiKeys.some(key => key && !key.startsWith('YOUR_GEMINI_API_KEY_'));
    }

    function updateChatCount() {
        const totalChats = conversationHistory.filter(msg => msg.role === 'user').length;
    }

    // Export Chat History
    function exportChatHistory() {
        if (conversationHistory.length === 0) {
            alert('Belum ada riwayat chat untuk di-export!');
            return;
        }
        let exportText = '=== Wayan AI CHAT HISTORY ===\n\n';
        exportText += `Exported: ${new Date().toLocaleString('id-ID')}\n\n`;
        conversationHistory.forEach((msg) => {
            const role = msg.role === 'user' ? 'Kamu' : 'Wayan AI';
            const text = msg.parts[0].text;
            exportText += `${role}: ${text}\n\n`;
        });
        const blob = new Blob([exportText], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wayan-ai-chat-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Chat history berhasil di-export!');
    }

    // Animation Toggle
    function toggleAnimations() {
        const isEnabled = document.getElementById('animationToggle').checked;
        settings.animationsEnabled = isEnabled;
        const style = document.createElement('style');
        if (!isEnabled) {
            style.textContent = `
                *, *::before, *::after {
                    animation-duration: 0.01ms !important;
                    animation-iteration-count: 1 !important;
                    transition-duration: 0.01ms !important;
                }
            `;
        }
        style.id = 'animation-disable';
        const existingStyle = document.getElementById('animation-disable');
        if (existingStyle) {
            existingStyle.remove();
        }
        if (!isEnabled) {
            document.head.appendChild(style);
        }
    }

    function getCurrentApiKey() {
        if (apiKeys.length === 0) {
            loadApiKeys();
        }
        const validApiKeys = apiKeys.filter(key => key && !key.startsWith('YOUR_GEMINI_API_KEY_'));
        
        if (validApiKeys.length === 0) {
            console.warn("Tidak ada API Key yang valid ditemukan. Pastikan Anda telah memasukkan API Key di pengaturan.");
            return null;
        }

        const randomIndex = Math.floor(Math.random() * validApiKeys.length);
        console.log(`Menggunakan API Key acak index: ${randomIndex}`);
        return validApiKeys[randomIndex];
    }
    
    function getApiUrl() {
        const apiKey = getCurrentApiKey();
        if (!apiKey) {
            return null; 
        }
        return `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
    }

    // Conversation Memory
    function saveConversationHistory() {
        if (settings.saveHistory) {
            localStorage.setItem('storybaliConversationHistory', JSON.stringify(conversationHistory));
        }
    }

    function loadConversationHistory() {
        if (!settings.saveHistory) return;
        const savedHistory = localStorage.getItem('storybaliConversationHistory');
        if (savedHistory) {
            conversationHistory = JSON.parse(savedHistory);
            conversationHistory.forEach(msg => {
                if (msg.role === 'user') {
                    addMessage(msg.parts[0].text, true);
                } else {
                    addMessage(msg.parts[0].text, false);
                }
            });
        }
    }
    
    function addToConversationHistory(role, message) {
        conversationHistory.push({
            role: role,
            parts: [{text: message}]
        });
        if (conversationHistory.length > 20) {
            conversationHistory = conversationHistory.slice(-20);
        }
        saveConversationHistory();
        updateChatCount();
    }

    // Quick Messages
    function sendQuickMessage(message) {
        document.getElementById('messageInput').value = message;
        sendMessage();
    }

    // Voice Mode
    function toggleVoiceMode() {
        isVoiceMode = !isVoiceMode;
        const voiceWave = document.getElementById('voiceWave');
        if (isVoiceMode) {
            startVoiceRecognition();
            voiceWave.classList.add('active');
        } else {
            stopVoiceRecognition();
            voiceWave.classList.remove('active');
        }
    }

    function startVoiceRecognition() {
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = settings.language === 'id' ? 'id-ID' : 'en-US';
            recognition.onresult = function (event) {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    }
                }
                if (finalTranscript) {
                    document.getElementById('messageInput').value = finalTranscript;
                    sendMessage();
                    toggleVoiceMode();
                }
            };
            recognition.start();
        } else {
            alert('Maaf, browser Anda tidak mendukung fitur pengenalan suara.');
            isVoiceMode = false;
        }
    }

    function stopVoiceRecognition() {
        if (recognition) {
            recognition.stop();
            recognition = null;
        }
    }

    // Theme Management
    function changeTheme(themeName) {
        settings.theme = themeName;
        document.querySelectorAll('.theme-option-new').forEach(btn => {
            btn.classList.remove('active');
        });
        const selectedBtn = document.getElementById(`theme${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`);
        if (selectedBtn) {
            selectedBtn.classList.add('active');
        }
        const themeColors = {
            blue: {from: '#667eea', to: '#764ba2'},
            green: {from: '#10b981', to: '#059669'},
            pink: {from: '#ec4899', to: '#dc2626'}
        };
        const colors = themeColors[themeName];
        const header = document.querySelector('.header-gradient');
        header.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        
        // Menyesuaikan warna tombol kirim baru
        const sendBtn = document.getElementById('sendBtn');
        if (sendBtn) {
           sendBtn.style.backgroundColor = colors.from;
        }

        document.querySelectorAll('.ai-avatar').forEach(avatar => {
            avatar.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        });
        const profileAvatarBorder = document.querySelector('.profile-avatar-border');
        if (profileAvatarBorder) {
            profileAvatarBorder.style.borderImage = `linear-gradient(135deg, ${colors.from}, ${colors.to}, #f093fb) 1`;
        }
    }

    // Settings Management
    function loadSettings() {
        const savedSettings = localStorage.getItem('storybaliSettings');
        if (savedSettings) {
            // Gabungkan pengaturan default dengan yang disimpan, tapi pastikan nama AI selalu 'Wayan'
            settings = { ...defaultSettings, ...JSON.parse(savedSettings), aiName: 'Wayan' };
        } else {
            settings = { ...defaultSettings };
        }
        applySettings();
    }

    function saveSettings() {
        localStorage.setItem('storybaliSettings', JSON.stringify(settings));
    }
    
    function saveAllSettings() {
        // PERUBAHAN: Pengaturan nama AI tidak lagi diambil dari input, karena sudah readonly
        settings.customAiRolePrompt = document.getElementById('customRoleInput').value;
        settings.fontSize = document.getElementById('fontSizeSelect').value;
        settings.animationsEnabled = document.getElementById('animationToggle').checked;
        settings.soundEnabled = document.getElementById('soundToggle').checked;
        settings.readAiResponseEnabled = document.getElementById('readAiResponseToggle').checked;
        settings.voiceURI = document.getElementById('voiceSelect').value;
        settings.saveHistory = document.getElementById('saveHistoryToggle').checked;
        
        saveSettings();
        applySettings();
        
        alert('Pengaturan berhasil disimpan!');
        toggleSettings();
    }

    function resetAllSettings() {
        if (confirm('Yakin ingin mereset semua pengaturan? Riwayat chat dan API Key akan dihapus. Halaman akan dimuat ulang.')) {
            localStorage.removeItem('storybaliSettings');
            localStorage.removeItem('storybaliApiKeys');
            localStorage.removeItem('storybaliConversationHistory');
            
            alert('Pengaturan telah direset ke default. Halaman akan dimuat ulang.');
            window.location.reload();
        }
    }

    function applySettings() {
        // PERUBAHAN: Nama AI di header dan input di-hardcode
        document.querySelector('.header-gradient h1').textContent = 'Wayan AI';
        document.getElementById('aiNameInput').value = 'Wayan';
        settings.aiName = 'Wayan'; // Memastikan variabel settings juga konsisten

        changeTheme(settings.theme);

        document.getElementById('fontSizeSelect').value = settings.fontSize;
        document.getElementById('animationToggle').checked = settings.animationsEnabled;
        toggleAnimations();
        document.getElementById('soundToggle').checked = settings.soundEnabled;
        document.getElementById('readAiResponseToggle').checked = settings.readAiResponseEnabled;
        document.getElementById('saveHistoryToggle').checked = settings.saveHistory;

        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`language-${settings.language}`)?.classList.add('active');
        document.getElementById(`personality-${settings.personality}`)?.classList.add('active');
        document.getElementById(`aiRole-${settings.aiRole}`)?.classList.add('active');
        
        const customRoleContainer = document.getElementById('customRoleContainer');
        const customRoleInput = document.getElementById('customRoleInput');
        if (settings.aiRole === 'kustom') {
            customRoleContainer.classList.remove('hidden');
            customRoleInput.value = settings.customAiRolePrompt;
        } else {
            customRoleContainer.classList.add('hidden');
        }

        const voiceSelect = document.getElementById('voiceSelect');
        if (settings.voiceURI && voiceSelect.options.length > 1) {
             voiceSelect.value = settings.voiceURI;
        }
    }
    
    function selectChoice(settingName, value, element) {
        settings[settingName] = value;
        const parent = element.parentElement;
        Array.from(parent.children).forEach(child => child.classList.remove('active'));
        element.classList.add('active');

        if (settingName === 'aiRole') {
            const customRoleContainer = document.getElementById('customRoleContainer');
            customRoleContainer.classList.toggle('hidden', value !== 'kustom');
            
            const roleNames = {
                'umum': 'Asisten Umum', 'guru_jepang': 'Guru Bahasa Jepang', 'guru_matematika': 'Guru Matematika',
                'dokter': 'Dokter Virtual', 'programmer': 'Programmer Senior', 'penerjemah': 'Penerjemah',
                'kustom': 'Peran Kustom'
            };

            const friendlyRoleName = roleNames[value];
            if (friendlyRoleName) {
                 addSystemMessage(`Mode peran AI telah diubah menjadi: ${friendlyRoleName}.`);
            }
        }
    }

    function clearChatHistory() {
        if (confirm('Yakin mau hapus semua riwayat chat? Tindakan ini tidak bisa dibatalkan.')) {
            conversationHistory = [];
            localStorage.removeItem('storybaliConversationHistory');
            const chatMessages = document.getElementById('chatMessages');
            
            const messages = chatMessages.querySelectorAll('.message-bubble, .system-message-bubble');
            for (let i = messages.length - 1; i > 0; i--) {
                messages[i].remove();
            }
            updateChatCount();
            alert('Riwayat chat telah dihapus!');
        }
    }
    
    function switchSettingsTab(tabName) {
        document.querySelectorAll('.settings-tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector(`.settings-tab[onclick="switchSettingsTab('${tabName}')"]`).classList.add('active');
        
        document.querySelectorAll('.settings-tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // Modal Management
    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        const content = document.getElementById('settingsModalContent');
        if (modal.classList.contains('hidden')) {
            loadSettings();
            switchSettingsTab('general');
            modal.classList.remove('hidden');
            setTimeout(() => content.style.transform = 'scale(1)', 10);
        } else {
            content.style.transform = 'scale(0.9)';
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }

    function showProfileModal() {
        const modal = document.getElementById('profileModal');
        const content = document.getElementById('profileModalContent');
        modal.classList.remove('hidden');
        setTimeout(() => content.style.transform = 'scale(1)', 10);
    }

    function hideProfileModal() {
        const modal = document.getElementById('profileModal');
        const content = document.getElementById('profileModalContent');
        content.style.transform = 'scale(0.9)';
        setTimeout(() => modal.classList.add('hidden'), 300);
    }

    // Image Upload
    function triggerImageUpload() {
        document.getElementById('imageInput').click();
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                showImagePreview(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
        }
    }

    let currentPreviewImage = null;
    let currentPreviewFileName = null;

    function showImagePreview(base64Image, fileName) {
        currentPreviewImage = base64Image;
        currentPreviewFileName = fileName;
        document.getElementById('previewImage').src = base64Image;
        document.getElementById('previewFileName').textContent = `${fileName}`;
        document.getElementById('imageQuestionInput').value = '';
        const modal = document.getElementById('imagePreviewModal');
        const content = document.getElementById('imagePreviewContent');
        modal.classList.remove('hidden');
        setTimeout(() => content.style.transform = 'scale(1)', 10);
        setTimeout(() => document.getElementById('imageQuestionInput').focus(), 300);
    }

    function hideImagePreview() {
        const modal = document.getElementById('imagePreviewModal');
        const content = document.getElementById('imagePreviewContent');
        content.style.transform = 'scale(0.9)';
        setTimeout(() => {
            modal.classList.add('hidden');
            document.getElementById('imageInput').value = '';
            currentPreviewImage = null;
            currentPreviewFileName = null;
        }, 300);
    }

    function sendImageWithQuestion() {
        const question = document.getElementById('imageQuestionInput').value.trim();
        if (!question) {
            alert('Tulis pertanyaan dulu ya!');
            document.getElementById('imageQuestionInput').focus();
            return;
        }

        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };
        if (userData.count >= CHAT_LIMIT) {
             alert('Anda telah mencapai batas pengiriman pesan. Silakan tunggu cooldown selesai.');
             hideImagePreview();
             return;
        }
        
        hideImagePreview();
        addImageMessageWithQuestion(currentPreviewImage, currentPreviewFileName, question, true);
        showImageProcessingIndicator();
        analyzeImageWithQuestion(currentPreviewImage, question);
    }

    function addImageMessageWithQuestion(imageSrc, fileName, question, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        if (isUser) {
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="user-message text-white p-4 max-w-xs">
                    <img src="${imageSrc}" alt="${fileName}" class="w-full h-auto rounded-lg mb-2 max-h-32 object-cover shadow-sm">
                    <p class="text-xs mb-2 opacity-90">${fileName}</p>
                    <div class="bg-white bg-opacity-20 rounded-lg p-2">
                        <p class="text-xs font-medium">${question}</p>
                    </div>
                </div>
            `;
            const allUserData = getChatLimitData();
            const userData = allUserData[currentUserIP] || { count: 0 };
            userData.count++;
            allUserData[currentUserIP] = userData;
            saveChatLimitData(allUserData);

            if (userData.count >= CHAT_LIMIT) {
                const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
                userData.cooldownUntil = cooldownEndTime;
                allUserData[currentUserIP] = userData;
                saveChatLimitData(allUserData);
                startCooldown(cooldownEndTime);
            }
        }
        const typingIndicator = document.getElementById('typingIndicator');
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }

    // Message Management
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }

    function addSystemMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'system-message-bubble';
        messageDiv.innerHTML = `<div class="system-message">${message}</div>`;
        
        const typingIndicator = document.getElementById('typingIndicator');
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }
    
    // LANGKAH 3: Modifikasi Fungsi addMessage untuk Memproses Markdown
    function addMessage(message, isUser = false, suggestions = []) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        if (isUser) {
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="w-8 h-8 bg-gradient-to-r from-green-500 to-emerald-600 rounded-full flex items-center justify-center flex-shrink-0 shadow-lg">
                    <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"/>
                    </svg>
                </div>
                <div class="user-message text-white p-4 max-w-xs">
                    <p class="leading-relaxed text-sm">${message}</p>
                </div>
            `;
        } else {
            const formattedMessage = marked.parse(message); // Menggunakan marked.js di sini
            const encodedMessage = btoa(encodeURIComponent(message)); // Encode teks asli, bukan HTML
            messageDiv.innerHTML = `
                <div class="ai-avatar w-8 h-8 flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="Wayan AI" class="w-full h-full object-cover">
                </div>
                <div class="ai-message p-4 max-w-xs relative group">
                    <div class="markdown-content text-gray-800 leading-relaxed text-sm">${formattedMessage}</div>
                    <div class="mt-3">
                        ${renderSuggestions(suggestions)}
                    </div>
                    <button onclick="readAiResponse(this, '${encodedMessage}')" class="absolute bottom-2 right-2 w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 ease-in-out transform hover:scale-110 active:scale-90" title="Baca Jawaban">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path>
                        </svg>
                    </button>
                </div>
            `;
            messageDiv.querySelector('.ai-message').innerHTML += `
                <button onclick="copyToClipboard(this.parentElement.querySelector('.markdown-content').innerText, this)" class="copy-button absolute bottom-2 right-9 w-6 h-6 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 ease-in-out transform hover:scale-110 active:scale-90 opacity-0 group-hover:opacity-100 transition-opacity" title="Salin Jawaban">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                </button>
            `;
        }
        const typingIndicator = document.getElementById('typingIndicator');
        chatMessages.insertBefore(messageDiv, typingIndicator);
        scrollToBottom();
    }

    
    function renderSuggestions(suggestionsArray) {
        if (suggestionsArray && suggestionsArray.length > 0) {
            return `
                <div class="flex flex-wrap gap-2 mt-2">
                    ${suggestionsArray.map(suggestion =>
                        `<button onclick="sendQuickMessage('${suggestion.replace(/'/g, "\\'")}')" class="suggestion-btn px-3 py-1 text-xs">
                            ${suggestion}
                        </button>`
                    ).join('')}
                </div>
            `;
        } else {
            return generateDefaultSuggestions();
        }
    }

    function generateDefaultSuggestions() {
        const suggestions = [
            "Ceritakan lebih detail dong!",
            "Ada contoh lainnya?",
            "Apa tema undangan yang tersedia di StoryBali?",
            "Berapa harga undangan digital di StoryBali?",
            "Bagaimana cara memesan undangan untuk pernikahan?",
            "Apa keunggulan undangan StoryBali dibandingkan yang lain?"
        ];
        const randomSuggestions = suggestions.sort(() => 0.5 - Math.random()).slice(0, 2);
        return `
            <div class="flex flex-wrap gap-2 mt-2">
                ${randomSuggestions.map(suggestion =>
                    `<button onclick="sendQuickMessage('${suggestion}')" class="suggestion-btn px-3 py-1 text-xs">
                        ${suggestion}
                    </button>`
                ).join('')}
            </div>
        `;
    }

    function showTypingIndicator() {
        document.getElementById('typingIndicator').classList.add('show');
        scrollToBottom();
    }

    function hideTypingIndicator() {
        document.getElementById('typingIndicator').classList.remove('show');
    }

    function showImageProcessingIndicator() {
        document.getElementById('imageProcessingIndicator').classList.add('show');
        scrollToBottom();
    }

    function hideImageProcessingIndicator() {
        document.getElementById('imageProcessingIndicator').classList.remove('show');
    }

    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        setTimeout(() => {
            chatMessages.scrollTo({
                top: chatMessages.scrollHeight,
                behavior: 'smooth'
            });
        }, 100);
    }

    function playNotificationSound() {
        if (settings.soundEnabled) {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
    }

    function copyToClipboard(text, buttonElement) {
        navigator.clipboard.writeText(text).then(() => {
            const originalText = buttonElement.innerHTML;
            buttonElement.innerHTML = `
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            `;
            buttonElement.title = 'Copied!';

            setTimeout(() => {
                buttonElement.innerHTML = originalText;
                buttonElement.title = 'Copy to Clipboard';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy: ', err);
            alert('Gagal menyalin teks.');
        });
    }

    function populateVoiceList() {
        const voices = speechSynthesis.getVoices();
        const voiceSelect = document.getElementById('voiceSelect');
        const savedVoiceURI = settings.voiceURI; 

        voiceSelect.innerHTML = ''; 

        const defaultOption = document.createElement('option');
        defaultOption.textContent = 'Default Browser';
        defaultOption.value = '';
        voiceSelect.appendChild(defaultOption);

        if (voices.length === 0) {
            voiceSelect.options[0].textContent = 'Tidak ada suara';
            return;
        }

        const idVoices = voices.filter(voice => voice.lang === 'id-ID');
        const otherVoices = voices.filter(voice => voice.lang !== 'id-ID');

        if (idVoices.length > 0) {
            const idGroup = document.createElement('optgroup');
            idGroup.label = 'Bahasa Indonesia';
            idVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                idGroup.appendChild(option);
            });
            voiceSelect.appendChild(idGroup);
        }

        if (otherVoices.length > 0) {
             const otherGroup = document.createElement('optgroup');
            otherGroup.label = 'Bahasa Lain';
            otherVoices.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                otherGroup.appendChild(option);
            });
            voiceSelect.appendChild(otherGroup);
        }

        if (savedVoiceURI) {
            voiceSelect.value = savedVoiceURI;
        }
    }

    function readAiResponse(buttonElement, encodedMessage) {
        if (!settings.readAiResponseEnabled) {
            alert('Fitur pembaca jawaban AI dinonaktifkan di pengaturan.');
            return;
        }

        const message = decodeURIComponent(atob(encodedMessage));

        if (isReading) {
            stopReading();
            buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            isReading = false;
            return;
        }

        if (currentUtterance) {
            speechSynthesis.cancel();
        }

        currentUtterance = new SpeechSynthesisUtterance(message);
        
        const selectedVoiceURI = settings.voiceURI;
        const voices = speechSynthesis.getVoices();
        const selectedVoice = voices.find(voice => voice.voiceURI === selectedVoiceURI);

        if (selectedVoice) {
            currentUtterance.voice = selectedVoice;
        } else {
            const idVoiceDefault = voices.find(voice => voice.lang === 'id-ID' || voice.lang.startsWith('id'));
            if(idVoiceDefault) {
               currentUtterance.voice = idVoiceDefault;
            }
        }
        
        currentUtterance.lang = settings.language === 'id' ? 'id-ID' : 'en-US';
        currentUtterance.rate = 1.0;
        currentUtterance.pitch = 1.0;

        buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>`;
        isReading = true;

        currentUtterance.onend = () => {
            buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            isReading = false;
            currentUtterance = null;
        };

        currentUtterance.onerror = (event) => {
            console.error('SpeechSynthesisUtterance.onerror', event);
            alert('Maaf, tidak dapat membaca teks. Error: ' + event.error);
            buttonElement.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            isReading = false;
            currentUtterance = null;
        };

        speechSynthesis.speak(currentUtterance);
    }
    
    function stopReading() {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        }
    }

    // LANGKAH 4: Modifikasi getSystemPrompt untuk meminta Markdown
    function getSystemPrompt() {
        const aiName = 'Wayan'; 
        const baseInstructions = `Perkenalkan dirimu sebagai Wayan jika ditanya nama. Selalu berikan jawabanmu terlebih dahulu. Gunakan format Markdown untuk jawabanmu jika diperlukan, seperti untuk list, teks tebal, atau blok kode. Setelah jawaban utama selesai, berikan 2 atau 3 saran pertanyaan lanjutan yang relevan. Format saran: pisahkan jawaban utama dan saran dengan '[SUGGESTIONS]', dan pisahkan setiap saran dengan tanda pipa '|'.`;
        
        const rolePrompts = {
            guru_jepang: `Kamu adalah seorang guru Bahasa Jepang profesional bernama Wayan-sensei. Gaya bicaramu sabar, mendidik, dan ramah. Sapa pengguna dengan "Konnichiwa, gakusei-san!" (Halo, murid!). Gunakan huruf Jepang (Hiragana, Katakana, Kanji) beserta romaji dan artinya saat mengajarkan kosakata atau kalimat. Koreksi kesalahan pengguna dengan lembut dan berikan penjelasan tata bahasa yang jelas. Selalu berikan contoh kalimat untuk setiap konsep yang diajarkan. Kamu juga bisa menyisipkan fakta budaya Jepang yang relevan.`,
            guru_matematika: `Kamu adalah seorang guru Matematika yang handal bernama Pak Wayan. Kamu bisa membuat konsep sulit menjadi mudah dimengerti. Gaya bicaramu logis, terstruktur, dan suportif. Jelaskan setiap langkah pemecahan masalah secara rinci. Gunakan analogi sederhana jika memungkinkan. Jangan hanya memberikan jawaban akhir, tapi pandu pengguna melalui proses berpikir untuk sampai ke jawaban tersebut.`,
            dokter: `Kamu adalah AI yang berperan sebagai Dokter Wayan, seorang Dokter Umum virtual yang informatif dan empatik. Mulai percakapan dengan sapaan yang menenangkan. Berikan informasi medis yang akurat dan berbasis bukti, namun SELALU awali dan akhiri jawabanmu dengan disclaimer penting: "Informasi ini bersifat edukatif dan tidak menggantikan konsultasi medis profesional. Segera kunjungi dokter atau fasilitas kesehatan terdekat untuk diagnosis dan penanganan yang tepat." Jangan pernah memberikan diagnosis atau resep. Fokus pada penjelasan kondisi medis, gejala umum, dan pilihan gaya hidup sehat.`,
            programmer: `Kamu adalah seorang senior programmer bernama Wayan. Kamu sangat berpengalaman dan suka membantu (coding buddy). Gaya bicaramu to-the-point, efisien, dan jelas. Saat pengguna memberikan kode, identifikasi bug, tawarkan optimisasi, dan jelaskan 'mengapa' perbaikanmu lebih baik. Berikan contoh kode yang bersih dan terdokumentasi dengan baik dalam blok kode Markdown. Selalu tanyakan bahasa pemrograman apa yang digunakan jika tidak disebutkan.`,
            penerjemah: `Kamu adalah seorang penerjemah multibahasa bernama Wayan yang sangat akurat. Fokus utamamu adalah menerjemahkan teks dari satu bahasa ke bahasa lain. Saat pengguna memberikan teks, deteksi bahasa aslinya dan tanyakan ke bahasa apa mereka ingin menerjemahkannya. Berikan terjemahan literal dan juga terjemahan kontekstual jika diperlukan, serta jelaskan nuansa budaya atau idiom yang mungkin hilang dalam terjemahan.`,
        };

        let roleInstruction = '';
        
        if (settings.aiRole === 'kustom' && settings.customAiRolePrompt) {
            roleInstruction = settings.customAiRolePrompt;
        } else if (rolePrompts[settings.aiRole]) {
            roleInstruction = rolePrompts[settings.aiRole];
        } else {
            switch (settings.personality) {
                case 'profesional':
                    roleInstruction = `Kamu adalah ${aiName}, asisten AI yang profesional, formal, dan terstruktur.`;
                    break;
                case 'lucu':
                    roleInstruction = `Kamu adalah ${aiName}, asisten AI yang humoris dan kreatif. Sisipkan lelucon jika relevan.`;
                    break;
                case 'santai':
                default:
                    roleInstruction = `Kamu adalah ${aiName}, asisten AI dari StoryBali yang santai, friendly, dan menggunakan bahasa Indonesia sehari-hari.`;
                    break;
            }
        }
        
        if (settings.language === 'en') {
            roleInstruction += ' Please respond in English.';
        }

        return `${roleInstruction} ${baseInstructions}`;
    }

    // AI Communication
    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message) return;

        if (!currentUserIP) {
            alert("Harap tunggu sebentar, sedang mengidentifikasi sesi Anda.");
            return;
        }

        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };

        if (userData.count >= CHAT_LIMIT) {
            if (!userData.cooldownUntil) {
                const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
                userData.cooldownUntil = cooldownEndTime;
                allUserData[currentUserIP] = userData;
                saveChatLimitData(allUserData);
                startCooldown(cooldownEndTime);
            }
            return;
        }

        userData.count++;
        allUserData[currentUserIP] = userData;
        saveChatLimitData(allUserData);

        addMessage(message, true);
        addToConversationHistory('user', message);
        input.value = '';
        handleInputChange({ target: input }); // PERUBAHAN: Reset tombol mic/kirim setelah mengirim
        showTypingIndicator();
        
        if (userData.count >= CHAT_LIMIT) {
            const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
            userData.cooldownUntil = cooldownEndTime;
            allUserData[currentUserIP] = userData;
            saveChatLimitData(allUserData);
            
            setTimeout(() => startCooldown(cooldownEndTime), 1000);
        }

        const apiUrl = getApiUrl();
        if (!apiUrl) {
            hideTypingIndicator();
            addMessage('Maaf, tidak ada API Key yang valid untuk digunakan. Silakan periksa pengaturan API Key Anda.');
            return;
        }

        try {
            const contents = [...conversationHistory];
            const systemPromptText = getSystemPrompt();
            
            const requestBody = {
                contents: contents,
                systemInstruction: {
                    parts: [{ text: systemPromptText }]
                },
                generationConfig: {
                    temperature: 0.9, topK: 1, topP: 1, maxOutputTokens: 2048,
                }
            };

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify(requestBody)
            });
            hideTypingIndicator();

            if (!response.ok) {
                 let specificErrorMessage = 'Terjadi kesalahan yang tidak diketahui.';
                if (response.status === 400) {
                    specificErrorMessage = 'Permintaan tidak valid. Mungkin ada masalah dengan format pesan.';
                } else if (response.status === 401 || response.status === 403 || response.status === 429) {
                    specificErrorMessage = 'API Key bermasalah (limit atau tidak valid). Mencoba API Key acak lainnya...';
                    setTimeout(() => sendMessage(), 1000); 
                    return;
                } else if (response.status >= 500) {
                    specificErrorMessage = 'Terjadi masalah di server AI. Coba lagi beberapa saat.';
                }
                throw new Error(`HTTP error! status: ${response.status}. ${specificErrorMessage}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                let aiResponseText = data.candidates[0].content.parts[0].text;
                
                let mainAnswer = aiResponseText;
                let dynamicSuggestions = [];
                
                if (aiResponseText.includes('[SUGGESTIONS]')) {
                    const parts = aiResponseText.split('[SUGGESTIONS]');
                    mainAnswer = parts[0].trim();
                    dynamicSuggestions = parts[1].split('|').map(s => s.trim()).filter(s => s);
                }
                
                addToConversationHistory('model', mainAnswer);
                addMessage(mainAnswer, false, dynamicSuggestions);
                playNotificationSound();
            } else {
                const defaultMessage = 'Maaf, Wayan tidak dapat memberikan respons untuk pertanyaan ini. Silakan coba pertanyaan lain.';
                addMessage(defaultMessage);
            }
        } catch (error) {
            hideTypingIndicator();
            let displayMessage = `Aduh, Wayan error nih: ${error.message}. Coba lagi ya!`;

            if (error.message.includes('HTTP error!')) {
                displayMessage = error.message.replace('HTTP error! status: ', 'Kesalahan API (Kode ');
                displayMessage = displayMessage.replace('. ', '). ');
            } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                displayMessage = 'Wayan tidak bisa terhubung ke internet. Coba periksa koneksi kamu ya!';
            }

            addMessage(displayMessage);
        }
    }

    async function analyzeImageWithQuestion(base64Image, userQuestion) {
        const apiUrl = getApiUrl();
        if (!apiUrl) {
            hideImageProcessingIndicator();
            addMessage('Maaf, tidak ada API Key yang valid untuk digunakan. Silakan periksa pengaturan API Key Anda.');
            return;
        }

        try {
            const imageData = base64Image.split(',')[1];
            const systemPromptText = getSystemPrompt();
            const promptText = `Ini adalah instruksi sistemmu: "${systemPromptText}". Sekarang, seorang user bertanya: "${userQuestion}". Jawab pertanyaan user tentang gambar ini berdasarkan instruksi sistemmu.`;

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', },
                body: JSON.stringify({
                    contents: [{
                        parts: [ { text: promptText }, { inline_data: { mime_type: "image/jpeg", data: imageData } } ]
                    }],
                    generationConfig: {
                        temperature: 0.9, topK: 32, topP: 1, maxOutputTokens: 2048,
                    }
                })
            });
            hideImageProcessingIndicator();

            if (!response.ok) {
                 let specificErrorMessage = 'Terjadi kesalahan yang tidak diketahui.';
                if (response.status === 400) {
                    specificErrorMessage = 'Permintaan tidak valid. Mungkin ada masalah dengan format gambar atau pertanyaan.';
                } else if (response.status === 401 || response.status === 403 || response.status === 429) {
                    specificErrorMessage = 'API Key bermasalah (limit atau tidak valid). Mencoba API Key acak lainnya...';
                    setTimeout(() => analyzeImageWithQuestion(base64Image, userQuestion), 1000);
                    return; 
                } else if (response.status >= 500) {
                    specificErrorMessage = 'Terjadi masalah di server AI. Coba lagi beberapa saat.';
                }
                throw new Error(`HTTP error! status: ${response.status}. ${specificErrorMessage}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts) {
                let aiResponseText = data.candidates[0].content.parts[0].text;
                
                let mainAnswer = aiResponseText;
                let dynamicSuggestions = [];
                
                if (aiResponseText.includes('[SUGGESTIONS]')) {
                    const parts = aiResponseText.split('[SUGGESTIONS]');
                    mainAnswer = parts[0].trim();
                    dynamicSuggestions = parts[1].split('|').map(s => s.trim()).filter(s => s);
                }
                
                addToConversationHistory('model', mainAnswer);
                addMessage(mainAnswer, false, dynamicSuggestions);
                playNotificationSound();
            } else {
                addMessage('Wah, gue ga bisa analisis gambar ini nih. Coba upload gambar lain ya!');
            }
        } catch (error) {
            hideImageProcessingIndicator();
            let displayMessage = `Aduh, Wayan error nih waktu analisis gambar: ${error.message}. Coba lagi ya!`;

            if (error.message.includes('HTTP error!')) {
                displayMessage = error.message.replace('HTTP error! status: ', 'Kesalahan API (Kode ');
                displayMessage = displayMessage.replace('. ', '). ');
            } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                displayMessage = 'Wayan tidak bisa terhubung ke internet. Coba periksa koneksi kamu ya!';
            }

            addMessage(displayMessage);
        }
    }

    // Initialize
    window.addEventListener('load', async () => {
        loadApiKeys();
        loadSettings();
        updateApiStatus();
        
        currentUserIP = await getUserIP();
        checkUserStatus();

        populateVoiceList();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        
        const chatMessages = document.getElementById('chatMessages');
        const messages = chatMessages.querySelectorAll('.message-bubble');
        for (let i = messages.length - 1; i > 0; i--) {
            messages[i].remove();
        }
        loadConversationHistory();
        updateChatCount();
        hideTypingIndicator();
        hideImageProcessingIndicator();
        
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => settings.fontSize = e.target.value);
    });

    // Close modals on outside click
    ['profileModal', 'imagePreviewModal', 'settingsModal'].forEach(modalId => {
        document.getElementById(modalId).addEventListener('click', (e) => {
            if (e.target.id === modalId) {
                if (modalId === 'profileModal') hideProfileModal();
                else if (modalId === 'imagePreviewModal') hideImagePreview();
                else if (modalId === 'settingsModal') toggleSettings();
            }
        });
    });

    document.addEventListener('touchstart', function () {}, true);
</script>
<!-- Onboarding Modal -->
<div id="onboardingModal"
     class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center transition-all duration-300 hidden">
  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-0 overflow-hidden border border-gray-200 relative animate-fadein">
    <div id="onboardingSlides" class="w-full">
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:block">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f44b.png"
             alt="Hi" class="w-16 h-16 mb-3 mx-auto animate-bounce" />
        <h2 class="text-xl font-bold mb-2 text-blue-700">Selamat Datang di Wayan AI!</h2>
        <p class="text-gray-700 text-base mb-4">Aplikasi chat cerdas dengan AI berbahasa Indonesia yang ramah &amp; mudah digunakan.</p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4ac.png"
             alt="Chat" class="w-16 h-16 mb-3 mx-auto animate-pulse" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Mulai Bertanya!</h2>
        <p class="text-gray-700 text-base mb-4">
          Tulis pertanyaan atau pesan di kolom bawah,<br>lalu tekan <b>tombol kirim</b>.<br>
          <span class="text-xs text-gray-500">(Contoh: "Apa itu PWA?")</span>
        </p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f527.png"
             alt="Settings" class="w-16 h-16 mb-3 mx-auto animate-spin-slow" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Atur Gaya AI-mu</h2>
        <p class="text-gray-700 text-base mb-4">
          Pilih <b>peran</b> dan <b>gaya bahasa</b> AI melalui tombol <b>titik tiga (...)</b>.<br>
          Bisa jadi Guru, Dokter, Programmer, dsb!
        </p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4f7.png"
             alt="Image" class="w-16 h-16 mb-3 mx-auto animate-bounce" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Upload Gambar</h2>
        <p class="text-gray-700 text-base mb-4">
          Kamu juga bisa upload gambar &amp; bertanya tentang isi gambar tersebut.<br>
          Coba klik tombol <b>tambah (+)</b> di kolom chat!
        </p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f389.png"
             alt="Lets Go" class="w-16 h-16 mb-3 mx-auto animate-bounce" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Yuk Mulai Chatting!</h2>
        <p class="text-gray-700 text-base mb-4">
          Selamat menikmati Wayan AI.<br>
          Jangan ragu untuk bereksperimen dan bertanya apa saja!
        </p>
      </div>
    </div>
    <div class="flex items-center justify-between px-5 pb-4 pt-2 bg-gray-50 border-t border-gray-200">
      <button id="skipOnboardingBtn" class="text-xs text-gray-400 hover:text-blue-500 font-medium">Lewati</button>
      <div class="flex space-x-1" id="onboardingDots">
      </div>
      <button id="nextOnboardingBtn"
              class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-1.5 rounded-lg shadow transition-all duration-150">
        Selanjutnya
      </button>
    </div>
    <button id="closeOnboardingBtn" style="display:none"></button>
  </div>
</div>

<style>
@keyframes fadein {
  from { opacity: 0; transform: scale(0.98);}
  to { opacity: 1; transform: scale(1);}
}
.animate-fadein { animation: fadein 0.5s;}
@keyframes spin-slow {
  100% { transform: rotate(360deg);}
}
.animate-spin-slow {
  animation: spin-slow 2.5s linear infinite;
}
</style>

<script>
(function() {
  const slides = document.querySelectorAll('#onboardingSlides .onboarding-slide');
  const modal = document.getElementById('onboardingModal');
  const btnNext = document.getElementById('nextOnboardingBtn');
  const btnSkip = document.getElementById('skipOnboardingBtn');
  const dotsContainer = document.getElementById('onboardingDots');
  let currSlide = 0;

  function showModalIfFirstTime() {
    if (!localStorage.getItem('onboardingShown')) {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      showSlide(0);
      renderDots();
    }
  }

  function showSlide(idx) {
    slides.forEach((slide, i) => {
      slide.style.display = i === idx ? 'block' : 'none';
    });
    currSlide = idx;
    updateDots();
    btnNext.textContent = (currSlide === slides.length - 1) ? "Mulai Chatting" : "Selanjutnya";
  }

  function nextSlide() {
    if (currSlide < slides.length - 1) {
      showSlide(currSlide + 1);
    } else {
      closeModal();
    }
  }

  function skipModal() {
    closeModal();
  }

  function closeModal() {
    modal.classList.add('hidden');
    localStorage.setItem('onboardingShown', 'true');
    document.body.style.overflow = '';
  }

  function renderDots() {
    dotsContainer.innerHTML = '';
    for (let i = 0; i < slides.length; i++) {
      const dot = document.createElement('span');
      dot.className = "inline-block w-2.5 h-2.5 mx-0.5 rounded-full transition-all duration-200 " +
        (i === currSlide ? "bg-blue-600" : "bg-gray-300");
      dot.style.cursor = 'pointer';
      dot.onclick = () => showSlide(i);
      dotsContainer.appendChild(dot);
    }
  }

  function updateDots() {
    Array.from(dotsContainer.children).forEach((dot, i) => {
      dot.className = "inline-block w-2.5 h-2.5 mx-0.5 rounded-full transition-all duration-200 " +
        (i === currSlide ? "bg-blue-600" : "bg-gray-300");
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    showModalIfFirstTime();
    btnNext.onclick = nextSlide;
    btnSkip.onclick = skipModal;
    document.getElementById('closeOnboardingBtn').onclick = closeModal;
  });
})();
</script>
</body>
</html>
