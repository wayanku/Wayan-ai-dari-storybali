





<!DOCTYPE html>
<html lang="id">
<head>
  <title>Wayan AI - Asisten Cerdas dari Storybali</title>
  <meta name="google-site-verification" content="g8-s5Mbu3DeWRHtXBt80kARydxNiS1a_XnmNfdyePkI" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  
  <!-- ▼▼▼ Meta Tags untuk SEO (Search Engine Optimization) yang Dioptimalkan ▼▼▼ -->
<link rel="icon" type="image/webp" href="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" />
<link rel="icon" type="image/webp" href="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" />
<link rel="shortcut icon" href="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" />
<link rel="apple-touch-icon" href="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" />
<link rel="manifest" href="site.webmanifest" />
  <meta name="description" content="Wayan AI adalah asisten AI cerdas dari Storybali, siap membantu menjawab pertanyaanmu dengan gaya santai dan ramah. Ngobrol dengan chatbot AI berbahasa Indonesia tentang apa saja!">
  <meta name="keywords" content="Wayan AI, Storybali, Asisten AI, AI Indonesia, Chatbot Indonesia, AI Bali, Asisten Virtual, Kecerdasan Buatan">
  <link rel="canonical" href="https://wayanku.github.io/Wayan-ai-dari-storybali/" />

  <!-- Meta Tags untuk Social Media (Open Graph & Twitter) -->
  <meta property="og:title" content="Wayan AI - Asisten Cerdas dari Storybali">
  <meta property="og:description" content="Ngobrol dengan Wayan AI, asisten AI cerdas berbahasa Indonesia dari Storybali. Siap membantu menjawab pertanyaanmu dengan gaya santai dan ramah.">
  <meta property="og:image" content="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true">
  <meta property="og:url" content="https://wayan-sudiarsana.github.io/Wayan-ai-dari-storybali/">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="id_ID">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Wayan AI - Asisten Cerdas dari Storybali">
  <meta name="twitter:description" content="Ngobrol dengan Wayan AI, asisten AI cerdas berbahasa Indonesia dari Storybali. Siap membantu menjawab pertanyaanmu dengan gaya santai dan ramah.">
  <meta name="twitter:image" content="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true">
  <!-- ▲▲▲ AKHIR DARI META TAGS ▲▲▲ -->

  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2299.77">
  <!-- Viewport diubah untuk menangani safe area (home bar) di iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ▼▼▼ [OPTIMASI] Mengoptimalkan pemuatan Google Fonts ▼▼▼ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- ▲▲▲ AKHIR DARI OPTIMASI GOOGLE FONTS ▲▲▲ -->

  <!-- ▼▼▼ [OPTIMASI] Menambahkan 'defer' untuk mencegah pemblokiran render ▼▼▼ -->
  <!-- ▼▼▼ [OPTIMASI] Memuat semua skrip eksternal dengan 'defer' untuk mencegah pemblokiran render ▼▼▼ -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <!-- Library untuk memformat Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>

  <!-- ▼▼▼ [BARU] Firebase SDK ▼▼▼ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <!-- ▲▲▲ AKHIR DARI Firebase SDK ▲▲▲ -->

  <style>
    /* [PERMINTAAN PENGGUNA] Mengimpor font 'Inter' agar mirip font iPhone di semua perangkat */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    /* === CSS VARIABLES UNTUK DARK/LIGHT MODE === */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f1f5f9; /* [PERUBAHAN] Dibuat sedikit lebih gelap */
      --bg-tertiary: #f1f5f9;
      --bg-accent: #eef2ff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-light: #526072; /* [FIX] Dibuat lebih gelap untuk kontras */
      --border-color: #e2e8f0;
      --ai-message-bg: #e2e8f0;
      --modal-bg: rgba(255, 255, 255, 0.98);
      --settings-card-bg: #ffffff; /* [DIKEMBALIKAN] Kartu pengaturan kembali menjadi putih */
      --shadow-color: rgba(0, 0, 0, 0.05);
      --bg-primary-rgba: 255, 255, 255;
      --bg-secondary-rgba: 247, 248, 252;
      --text-primary-rgba: 30, 41, 59;
      --bg-tertiary-rgba: 241, 245, 249; /* [BARU] RGBA untuk efek kaca di input box */
      --custom-bg-url: none; /* [BARU] Variabel untuk URL latar belakang kustom */
    }

    html.dark {
      --bg-primary: #181818;        /* [DIUBAH] Sedikit lebih terang dari hitam pekat */
      --bg-secondary: #212121;      /* [DIUBAH] Disesuaikan */
      --bg-tertiary: #2c2c2c;      /* [DIUBAH] Disesuaikan */
      --bg-accent: #3d3d3d;        /* [DIUBAH] Disesuaikan */
      --text-primary: #f5f5f5;      /* Bright White for readability */
      --text-secondary: #a0a0a0;    /* Medium Gray */
      --text-light: #888888;        /* [FIX] Dibuat lebih terang untuk kontras */
      --border-color: #3a3a3a;
      --ai-message-bg: #2c2c2c;
      --modal-bg: rgba(20, 20, 20, 0.95);
      --settings-card-bg: #2a2a2a; /* [PERUBAHAN] Dibuat lebih cerah agar kontras di mode gelap */
      --shadow-color: rgba(0, 0, 0, 0.3);
      --bg-primary-rgba: 24, 24, 24; /* [DIUBAH] Disesuaikan dengan --bg-primary baru */
      --bg-secondary-rgba: 30, 30, 30;
      --text-primary-rgba: 245, 245, 245;
      --bg-tertiary-rgba: 42, 42, 42; /* [BARU] RGBA untuk efek kaca di input box */
      --custom-bg-url: none; /* [BARU] Variabel untuk URL latar belakang kustom */
    }
    /* === AKHIR DARI CSS VARIABLES === */
    
    /* [FIX] Membuat teks pengaturan lebih terang di mode gelap */
    html.dark .settings-card label,
    html.dark .settings-card h4,
    html.dark #settingsModal h3,
    html.dark .modal-content .text-gray-800,
    html.dark .modal-content .text-gray-700,
    html.dark .modal-content .text-gray-600,
    html.dark .modal-content .text-purple-600 {
        color: var(--text-primary) !important;
    }
    html.dark .modal-content .text-gray-500 {
        color: var(--text-secondary) !important;
    }

    /* [FIX] Membuat header/footer modal pengaturan menjadi gelap */
    html.dark #settingsModal .modal-content > div[class*="bg-white"],
    html.dark #settingsModal .modal-content > div[class*="bg-gray-50"] {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
    }
    
    /* [FIX] Membuat kotak teks profil menjadi gelap */
    html.dark #profileModal .bg-gray-50 {
        background-color: var(--bg-tertiary) !important;
    }

    /* ▼▼▼ [FIX BARU] Membuat tombol footer modal pengaturan menjadi gelap ▼▼▼ */
    html.dark #settingsModal .settings-btn-action.bg-gray-200,
    html.dark #confirmModal .settings-btn-action.bg-gray-200 {
        background-color: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
    }
    html.dark #settingsModal .settings-btn-action.bg-gray-200:hover,
    html.dark #confirmModal .settings-btn-action.bg-gray-200:hover {
        background-color: var(--bg-accent) !important;
    }
    html.dark #settingsModal .settings-btn-action.bg-blue-600:hover {
        background-color: #2563eb !important; /* Sedikit lebih terang untuk kontras */
    }
    /* ▲▲▲ AKHIR DARI FIX BARU ▲▲▲ */


    * {
        -webkit-tap-highlight-color: transparent;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden; /* Mencegah body memiliki scrollbar sendiri */
        /* [DIUBAH] Diterapkan ke html & body untuk mengunci viewport secara total di iOS (PWA) */
        overscroll-behavior: none;
    }

    body {
        /* [PERBAIKAN TAMPILAN IPHONE] Menggunakan font sistem untuk nuansa asli iOS */
        /* [PERMINTAAN PENGGUNA] Menggunakan font 'Inter' agar mirip font iPhone di semua perangkat */
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        background-color: var(--bg-secondary) !important;
    }
    
    #appContainer {
        display: flex;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100);
        width: 100vw;
        position: relative;
    }

    /* === SIDEBAR STYLES === */
    #sidebar {
        width: 260px;
        /* [PERMINTAAN PENGGUNA] Efek Kaca/Glassmorphism untuk Sidebar */
        background-color: rgba(var(--bg-secondary-rgba), 0.5); /* [PERMINTAAN PENGGUNA] Dibuat lebih transparan lagi */
        backdrop-filter: blur(6px); /* [PERMINTAAN PENGGUNA] Blur dikurangi lagi */
        -webkit-backdrop-filter: blur(6px);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease-in-out, min-width 0.3s ease-in-out, width 0.3s ease-in-out;
        flex-shrink: 0;
    }    
    html.dark #sidebar {
        background-color: rgba(var(--bg-secondary-rgba), 0.45); /* [PERMINTAAN PENGGUNA] Dibuat lebih transparan lagi */
    }
    #sidebar.collapsed {
        min-width: 0px;
        width: 0px;
        transform: translateX(-260px);
        padding: 0;
        border-right: none;
    }
    /* [PERMINTAAN PENGGUNA] Perbaikan padding atas sidebar untuk poni iPhone */
    /* [DIUBAH] Gaya untuk custom background, diterapkan ke area chat saja */
    /* [DIUBAH] Menggunakan pseudo-element untuk menerapkan blur tanpa mempengaruhi konten */
    .chat-container.custom-background {
        position: relative; /* Diperlukan untuk pseudo-element */
        background-image: none !important; /* Pindahkan gambar ke pseudo-element */
    }
    .chat-container.custom-background::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: var(--custom-bg-url);
        background-position: center;
        background-repeat: no-repeat;
        z-index: -1; /* Letakkan di belakang konten */
        transition: filter 0.3s ease-in-out;
    }
    /* [BARU] Opsi ukuran untuk latar belakang kustom */
    .chat-container.background-size-cover::before { background-size: cover; }
    .chat-container.background-size-contain::before { background-size: contain; }

    /* [BARU] Opsi blur untuk latar belakang kustom */
    .chat-container.background-blur-light::before { filter: blur(4px); }
    .chat-container.background-blur-strong::before { filter: blur(10px); }

    /* [FIX] Membuat area chat transparan saat ada background kustom agar pseudo-element terlihat */
    .chat-container.custom-background,
    .chat-container.custom-background .chat-window {
        background-color: transparent !important;
    }
    /* [BARU] Sedikit menggelapkan area chat saat blur aktif agar teks lebih terbaca */
    .chat-container.background-blur-light .chat-window,
    .chat-container.background-blur-strong .chat-window {
        /* Anda bisa menyesuaikan opasitas ini jika perlu */
        background-color: transparent !important;
    }

    #sidebar > .p-4 {
        padding-top: calc(1rem + env(safe-area-inset-top));
    }
    .new-chat-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
        background: var(--bg-primary);
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px var(--shadow-color);
    }
    .new-chat-btn:hover {
        border-color: #a5b4fc;
        color: #4f46e5;
    }
    html.dark .new-chat-btn:hover {
        border-color: #777;
        color: var(--text-primary);
    }

    #chatHistoryList {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .chat-history-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 1rem;
        margin: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
        transition: background-color 0.2s ease, color 0.2s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-history-item:hover {
        background-color: var(--bg-tertiary);
    }
    .chat-history-item.active {
        background-color: #4f46e5;
        color: white;
        font-weight: 500;
    }
    html.dark .chat-history-item.active {
        background-color: #f5f5f5;
        color: #121212;
    }

    .chat-history-item .title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-grow: 1;
        margin-right: 0.5rem;
    }
    .chat-history-item .actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .chat-history-item:hover .actions, .chat-history-item.active .actions {
        opacity: 1;
    }
    .chat-history-item .action-icon {
        padding: 2px;
        border-radius: 4px;
    }
    .chat-history-item .action-icon:hover {
        background-color: rgba(0,0,0,0.1);
    }
    .chat-history-item.active .action-icon:hover {
        background-color: rgba(255,255,255,0.3);
    }
    html.dark .chat-history-item.active .action-icon:hover {
        background-color: rgba(0,0,0,0.3);
    }
    
    /* === CSS UNTUK OVERLAY MOBILE === */
    #sidebarOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 99;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    #sidebarOverlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .chat-container {
        background: var(--bg-primary);
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 0;
    }

    .chat-window {
        background: var(--bg-primary);
        border: none;
        box-shadow: none;
        animation: slideInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        height: 100%;
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        border-radius: 0;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .header-gradient {
        /* ▼▼▼ [PERMINTAAN] Efek Kaca/Glassmorphism untuk Header ▼▼▼ */
        position: absolute; /* Diubah dari relative agar "melayang" */
        top: 0;
        left: 0;
        right: 0;
        z-index: 10;
        
        /* [DIUBAH] Efek kaca disamakan dengan area input untuk konsistensi */
        background-color: rgba(var(--bg-tertiary-rgba), 0.4);
        background-image: none; /* Menghapus gradien di tema terang */
        backdrop-filter: blur(32px); /* [DIUBAH] Blur ditingkatkan lagi */
        -webkit-backdrop-filter: blur(32px);
        border-bottom: 1px solid var(--border-color);

        /* [DIUBAH] Padding dipindahkan dari kelas p-4 ke sini untuk menangani safe area iPhone */
        padding-left: 1rem;
        padding-right: 1rem;
        padding-bottom: 1rem;
        padding-top: calc(1rem + env(safe-area-inset-top));
        /* ▲▲▲ AKHIR DARI PERUBAHAN HEADER ▲▲▲ */
    }
    html.dark .header-gradient {
        background-image: none; /* [DIUBAH] Hapus gradien di mode gelap */
        background-color: rgba(var(--bg-secondary-rgba), 0.6) !important; /* [DIUBAH] Dibuat lebih gelap lagi */
    }

    /* ▼▼▼ [PERBAIKAN] KODE UNTUK WARNA TEKS & IKON HEADER ▼▼▼ */
    .header-gradient h1,
    .header-gradient p,
    .header-gradient svg {
        color: var(--text-primary) !important; /* [PENYEMPURNAAN IOS] Pastikan warna teks header tidak terpengaruh oleh style lain */
        transition: color 0.3s ease; /* Transisi warna yang halus */
    }
    /* [PENYEMPURNAAN IOS] Membuat judul header lebih tebal seperti di iOS */
    .header-gradient h1 {
        font-weight: 600; /* Semibold */
    }
    /* ▲▲▲ AKHIR DARI KODE PERBAIKAN ▲▲▲ */

    .ai-avatar {
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: avatarPulse 2s infinite; position: relative;
        border: 3px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
        border-radius: 9999px !important;
    }
    html.dark .ai-avatar {
        background: #555 !important;
        border-color: #777;
        box-shadow: 0 0 0 0 rgba(150, 150, 150, 0.4);
        animation: avatarPulseDark 2s infinite;
    }

    .ai-avatar::after {
        content: ''; position: absolute; inset: -2px;
        background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
        border-radius: inherit; z-index: -1;
        animation: rotate 4s linear infinite;
    }
    html.dark .ai-avatar::after {
        background: linear-gradient(45deg, #eee, #888, #eee);
    }
    @keyframes avatarPulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
    }
    @keyframes avatarPulseDark {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(150, 150, 150, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(150, 150, 150, 0); }
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .message-bubble {
        animation: messageSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-origin: bottom left; margin-bottom: 1rem;
    }
    .message-bubble.user { transform-origin: bottom right; }
    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(20px) scale(0.8); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    /* [DIUBAH] Menghapus max-width agar pesan AI bisa menggunakan lebar penuh */
    .message-bubble.ai { max-width: 100%; }

    /* ▼▼▼ [PERBAIKAN TAMPILAN] Gaya gelembung AI diubah menjadi solid agar lebih terbaca (mirip ChatGPT/Gemini) ▼▼▼ */
    .ai-message {
        max-width: 48rem;
        position: relative;
        background-color: var(--bg-secondary); /* [DIUBAH] Warna solid untuk keterbacaan maksimal */
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        border: 1px solid var(--border-color);
        padding: 0.75rem 1rem;
        border-radius: 1.25rem;
        border-top-left-radius: 0.375rem;
    }
    html.dark .ai-message {
        background-color: var(--bg-secondary); /* [DIUBAH] Warna solid yang sedikit lebih terang dari latar */
    }
    /* ▲▲▲ AKHIR DARI PERBAIKAN TAMPILAN GELEMBUNG AI ▲▲▲ */
    /* [BARU] Gelembung khusus untuk indikator "mengetik" */
    .typing-bubble {
        background: var(--ai-message-bg);
        border-radius: 1.25rem;
        border-top-left-radius: 0.375rem;
        padding: 1rem;
    }

    .user-message {
        /* [PERMINTAAN PENGGUNA] Efek kaca untuk gelembung Pengguna */
        /* [DIUBAH] Menggunakan gradien biru yang lebih modern dan cerah */
        background: linear-gradient(135deg, #2563eb, #4f46e5); /* [DIUBAH] Gradien disempurnakan */
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 15px rgba(59, 130, 246, 0.2);
        color: white;
        border-radius: 1.25rem; border-top-right-radius: 0.375rem;
        padding: 1rem; max-width: 85%;
    }
    html.dark .user-message {
        /* [DIUBAH] Menggunakan warna biru solid yang lebih menonjol di mode gelap */
        background: #2563eb;
        backdrop-filter: none; /* Hapus backdrop filter di mode gelap untuk warna solid */
        -webkit-backdrop-filter: none;
        color: white;
        border: none; /* Hapus border untuk tampilan yang lebih bersih */
    }

    /* ▼▼▼ CSS UNTUK WAKTU CHAT ▼▼▼ */
    .chat-timestamp {
        font-size: 0.65rem;
        color: var(--text-secondary); /* [FIX] Menggunakan warna yang lebih kontras */
        margin-top: 0.5rem;
    }
    .user-message .chat-timestamp {
        color: rgba(255, 255, 255, 0.8);
    }
    html.dark .user-message .chat-timestamp {
        color: #a0a0a0;
    }
    /* ▲▲▲ AKHIR DARI CSS BARU ▲▲▲ */


    .system-message-bubble {
        display: flex; justify-content: center; margin: 0.5rem 0;
        animation: messageSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .system-message {
        background-color: var(--ai-message-bg);
        color: var(--text-secondary);
        font-size: 0.75rem;
        padding: 0.35rem 0.85rem; 
        border-radius: 9999px;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .system-message svg {
        width: 1rem;
        height: 1rem;
        flex-shrink: 0;
    }
    /* [BARU] Gaya untuk berbagai jenis notifikasi */
    .system-message.info {
        background-color: #e0e7ff; /* Light blue */
        color: #3730a3;
    }
    html.dark .system-message.info {
        background-color: #312e81;
        color: #c7d2fe;
    }
    .system-message.success {
        background-color: #dcfce7; /* Light green */
        color: #166534;
    }
    html.dark .system-message.success {
        background-color: #14532d;
        color: #bbf7d0;
    }
    .system-message.warning {
        background-color: #fef3c7; /* Light yellow */
        color: #92400e;
    }
    html.dark .system-message.warning {
        background-color: #78350f;
        color: #fde68a;
    }

    /* [BARU] Gaya untuk Timer Cooldown */
    .cooldown-timer-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background-color: var(--bg-tertiary);
        border-radius: 1rem;
        max-width: 280px;
        margin: 0 auto;
        border: 1px solid var(--border-color);
    }
    .cooldown-circle-container {
        position: relative;
        width: 80px;
        height: 80px;
    }
    .cooldown-circle-svg {
        transform: rotate(-90deg);
        width: 100%;
        height: 100%;
    }
    .cooldown-circle-bg { fill: none; stroke: var(--border-color); stroke-width: 8; }
    .cooldown-circle-progress {
        fill: none; stroke: #f59e0b; /* amber-500 */ stroke-width: 8;
        stroke-linecap: round; transition: stroke-dashoffset 0.2s linear;
    }
    html.dark .cooldown-circle-progress { stroke: #fcd34d; /* amber-300 */ }
    .cooldown-time-text {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        font-size: 1.125rem; font-weight: 600; color: var(--text-primary);
    }
    .cooldown-message-text { font-size: 0.875rem; color: var(--text-secondary); text-align: center; }

    /* [BARU] Tombol aksi di bawah pesan AI */
    .action-icon-ai {
        color: var(--text-light);
        background: none;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0.25rem;
        border-radius: 9999px;
    }
    .action-icon-ai:hover {
        color: var(--text-primary);
        background-color: rgba(var(--text-primary-rgba), 0.1); /* [FIX] Warna hover lebih konsisten */
    }
    /* [BARU] Gaya untuk tombol rating yang aktif */
    .action-icon-ai.rating-active {
        color: #4f46e5 !important; /* Warna biru/indigo saat aktif */
    }
    html.dark .action-icon-ai.rating-active {
        color: #a5b4fc; /* Warna biru lebih terang di mode gelap */
    }

    /* [FIX] Memindahkan footer pesan AI ke dalam gelembung agar terlihat dengan latar kustom */
    .ai-message-footer {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 0.75rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(var(--text-primary-rgba), 0.1);
    }
    .ai-message-footer .chat-timestamp {
        color: rgba(var(--text-primary-rgba), 0.6);
        margin-top: 0; /* Reset margin */
    }
    .ai-message-footer .action-icon-ai {
        color: rgba(var(--text-primary-rgba), 0.6);
    }
    .ai-message-footer .action-icon-ai:hover {
        color: var(--text-primary);
        background-color: rgba(var(--text-primary-rgba), 0.15); /* [FIX] Dibuat sedikit lebih terlihat */
    }
    html.dark .ai-message-footer .action-icon-ai:hover {
        background-color: rgba(var(--bg-primary-rgba), 0.2);
    }

    /* [BARU] CSS untuk Modal Pencarian Google */
    #searchModal .modal-content {
        width: 90%;
        height: 90%;
        max-width: 1200px;
        padding: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* [BARU] Memastikan iframe mengikuti sudut melengkung */
    }
    #searchModal iframe {
        flex-grow: 1;
        border: none;
    }
    #searchModalHeader {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background-color: var(--bg-tertiary);
        border-bottom: 1px solid var(--border-color);
        flex-shrink: 0;
    }
    /* [BARU] Menyesuaikan gaya tombol di header modal pencarian */
    #searchModal .modal-close-btn {
        background: var(--bg-tertiary);
        box-shadow: none;
        color: var(--text-secondary);
    }
    #searchModal .modal-close-btn:hover {
        background: #cbd5e1;
        transform: scale(1.05);
    }
    html.dark #searchModal .modal-close-btn:hover {
        background: #555;
    }

    .typing-indicator { display: none; align-items: center; margin-bottom: 1rem; }
    .typing-indicator.show { display: flex; animation: fadeInBounce 0.5s ease-out; }
    @keyframes fadeInBounce {
        0% { opacity: 0; transform: translateY(10px) scale(0.8); }
        60% { opacity: 1; transform: translateY(-2px) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dot {
        width: 8px; height: 8px; border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: typing 1.4s infinite ease-in-out; margin: 0 2px;
    }
    html.dark .dot {
        background: #888;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    .dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8) translateY(0); opacity: 0.5; }
        40% { transform: scale(1.2) translateY(-8px); opacity: 1; }
    }

    .input-area {
        /* [DIUBAH] Efek kaca dipindahkan ke .input-box, area ini menjadi transparan dan tanpa garis atas */
        background: transparent;
        padding: 0.75rem 1rem calc(0.75rem + env(safe-area-inset-bottom)) 1rem;
    }

    /* [BARU] CSS untuk membuat footer melayang di atas konten chat */
    .chat-footer {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        /* ▼▼▼ [PERBAIKAN ESTETIKA] Efek blur diterapkan ke seluruh footer ▼▼▼ */
        /* untuk mencakup area aman di bagian bawah (safe area). */
        background-color: rgba(var(--bg-primary-rgba), 0.65); /* [DIUBAH] Dibuat lebih transparan */
        backdrop-filter: blur(24px); /* [DIUBAH] Blur disesuaikan */
        -webkit-backdrop-filter: blur(24px);
        /* ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲ */
    }

    .input-box {
        display: flex;
        flex-direction: column;
        width: 100%;
        /* [PERBAIKAN ESTETIKA] Backdrop-filter dihapus dari sini karena sudah ditangani oleh .chat-footer */
        background-color: rgba(var(--bg-tertiary-rgba), 0.4);
        border-radius: 1.25rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        position: relative; /* [BARU] Diperlukan untuk UI Perekaman Suara */
    }

    .input-box input {
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        padding: 0.5rem;
        font-size: 16px;
        color: var(--text-primary);
    }

    .input-box input::placeholder { color: var(--text-light); }

    .action-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.5rem;
    }

    .action-buttons .left-actions {
        display: flex;
        align-items: center;
        /* [PERBAIKAN TAMPILAN] Tombol dibuat lebih rapat untuk estetika iOS */
        gap: 0.5rem; 
    }
    
    .action-btn {
        color: var(--text-secondary);
        background: none;
        /* [PENYEMPURNAAN IOS] Menghapus padding agar tombol lebih rapat dan minimalis */
        padding: 0; 
        border: none;
        cursor: pointer;
        transition: color 0.2s ease;
    }
    .action-btn:hover { color: #4f46e5; }
    html.dark .action-btn:hover { color: var(--text-primary); }
    .action-btn.active {
        color: #4f46e5;
        transform: scale(1.1);
    }
    html.dark .action-btn.active {
        color: #a5b4fc;
    }
    .action-btn span { font-size: 0.9rem; font-weight: 500; }
    
    .dynamic-icon-container {
        position: relative;
        width: 2.5rem;
        height: 2.5rem;
    }

    .dynamic-icon-btn {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-tertiary);
        border-radius: 9999px;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, background-color 0.3s ease;
        border: none;
        cursor: pointer;
        color: var(--text-secondary);
    }
    .dynamic-icon-btn.send-btn-active {
        background-color: #4f46e5;
        color: white;
    }
    html.dark .dynamic-icon-btn.send-btn-active {
        background-color: #f5f5f5 !important;
        color: #121212;
    }
    .dynamic-icon-btn:active { transform: scale(0.9); }
    
    /* === [BARU] STYLE UNTUK FITUR BARU === */
    .voice-wave { display: flex; align-items: center; gap: 4px; height: 24px; }
    .wave-bar { width: 4px; height: 100%; background: #667eea; border-radius: 2px; animation: waveAnimation 1s infinite ease-in-out; }
    html.dark .wave-bar { background: #888; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes waveAnimation {
        0%, 40%, 100% { transform: scaleY(0.4); }
        20% { transform: scaleY(1); }
    }
    
    #stopGeneratingContainer button {
      background-color: var(--bg-primary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 5px var(--shadow-color);
      transition: all 0.2s ease;
    }
    #stopGeneratingContainer button:hover {
      background-color: var(--bg-tertiary);
      transform: translateY(-1px);
    }
    /* === AKHIR DARI STYLE BARU === */


    .quick-actions {
        display: flex; gap: 0.5rem; padding: 0.75rem 1rem;
        /* [PERBAIKAN] Memastikan latar belakang benar-benar transparan */
        background: transparent;
        border-top: none;
        overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;
    }
    .quick-actions::-webkit-scrollbar { display: none; }
    .quick-action-btn {
        flex-shrink: 0; padding: 0.5rem 1rem;
        /* [DIUBAH] Efek Kaca/Glassmorphism untuk tombol saran */
        background: rgba(var(--bg-tertiary-rgba), 0.4);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        border: 1px solid rgba(var(--text-primary-rgba), 0.1);
        border-radius: 9999px; font-size: 0.75rem;
        font-weight: 500; color: var(--text-primary); transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 5px var(--shadow-color); /* Bayangan tetap ada */
    }
    .quick-action-btn:hover {
        background: rgba(var(--bg-tertiary-rgba), 0.7);
        border-color: rgba(var(--text-primary-rgba), 0.2);
        transform: translateY(-1px);
    }
    .quick-action-btn:active { transform: scale(0.98); }

    .suggestion-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 9999px; font-size: 0.7rem; color: var(--text-secondary);
        transition: all 0.2s ease-in-out; padding: 0.4rem 0.8rem;
    }
    .suggestion-btn:hover, .suggestion-btn:active {
        background: var(--bg-accent);
        border-color: #a0aec0; transform: translateY(-1px);
    }
    html.dark .suggestion-btn:hover, html.dark .suggestion-btn:active {
        border-color: #777;
    }

    .modal-overlay {
        background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
        transition: opacity 0.3s ease;
    }
    .modal-content {
        background: var(--modal-bg);
        border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 1.5rem;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    }
    html.dark .modal-content { border: 1px solid var(--border-color); }
    #settingsModal .modal-content {
        /* [DIUBAH] Mengubah modal pengaturan menjadi layar penuh */
        /* [PERUBAHAN] Latar belakang diubah menjadi warna solid */
        background-color: var(--bg-secondary); /* [PERUBAHAN] Latar belakang utama modal menjadi abu-abu */
        backdrop-filter: none;
        -webkit-backdrop-filter: none;
        padding: 0; overflow: hidden;
        border-radius: 0;
        box-shadow: none;
        transform: none !important; /* Menghapus animasi scale */
        max-width: 100%;
        max-height: 100%;
        transition: opacity 0.3s ease; /* Hanya animasi fade */
    }
    .modal-overlay.hidden { opacity: 0; pointer-events: none; }
    .modal-overlay:not(.hidden) .modal-content { opacity: 1; transform: scale(1); }
    /* [BARU] Memastikan animasi scale tidak berlaku untuk modal pengaturan */
    .modal-overlay:not(.hidden) #settingsModal .modal-content { transform: none !important; }

    /* [PERMINTAAN PENGGUNA] Efek Kaca/Glassmorphism untuk Modal Profil */
    #profileModal .modal-content {
        background-color: rgba(var(--bg-secondary-rgba), 0.85); /* [DIUBAH] Dibuat lebih pekat agar teks terbaca di mode terang */
        backdrop-filter: blur(8px); /* [DIUBAH] Blur sedikit ditingkatkan */
        -webkit-backdrop-filter: blur(8px);
    }
    html.dark #profileModal .modal-content {
        background-color: rgba(var(--bg-secondary-rgba), 0.5); /* [DIUBAH] Dibuat lebih pekat agar konsisten */
    }

    /* ▼▼▼ [BARU] Perbaikan Tampilan Modal Pengaturan di Desktop ▼▼▼ */
    @media (min-width: 769px) {
        #settingsModal .modal-content {
            width: auto;
            height: auto;
            max-width: 640px; /* Lebar modal di desktop */
            max-height: 90vh; /* Tinggi maksimal modal di desktop */
            border-radius: 1.5rem; /* Sudut melengkung */
            box-shadow: 0 15px 40px var(--shadow-color); /* Bayangan */
            transform: scale(0.95) !important; /* Animasi scale masuk */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
        }

        .modal-overlay:not(.hidden) #settingsModal .modal-content {
            transform: scale(1) !important; /* Animasi scale selesai */
        }
    }
    /* ▲▲▲ AKHIR DARI PERBAIKAN TAMPILAN DESKTOP ▲▲▲ */

    /* ▼▼▼ [BARU] Perbaikan untuk poni & home bar iPhone di modal pengaturan ▼▼▼ */
    #settingsModal .modal-content > div:first-child {
        padding-top: calc(1rem + env(safe-area-inset-top));
    }
    #settingsModal .modal-content > div:last-child {
        padding-bottom: calc(0.75rem + env(safe-area-inset-bottom));
    }
    /* ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲ */
    .modal-close-btn {
        background: #ef4444; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        transition: all 0.2s ease-in-out; border-radius: 9999px !important;
    }
    html.dark .modal-close-btn { background: #444; box-shadow: none; color: #fff; }
    
    #settingsModal .modal-close-btn {
        background: var(--bg-tertiary);
        box-shadow: none; color: var(--text-secondary);
    }
    #settingsModal .modal-close-btn:hover { background: #cbd5e1; transform: scale(1.05); }
    html.dark #settingsModal .modal-close-btn:hover { background: #555; }
    .modal-close-btn:hover { background: #dc2626; transform: scale(1.05); }
    .modal-close-btn:active { transform: scale(0.95); }
    
    /* [PENY-EMPURNAAN IOS] Menghilangkan latar belakang pada tombol kembali di pengaturan */
    #settingsBackBtn {
        background: none !important;
        box-shadow: none !important;
    }

    .profile-avatar-border {
        border: 4px solid;
        border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;
        animation: rotateBorder 4s linear infinite;
        border-radius: 9999px !important;
    }
    html.dark .profile-avatar-border {
        border-image: linear-gradient(135deg, #eee, #888, #eee) 1 !important;
    }

    @keyframes rotateBorder {
        0% { border-image-source: linear-gradient(135deg, #667eea, #764ba2, #f093fb); }
        25% { border-image-source: linear-gradient(135deg, #764ba2, #f093fb, #667eea); }
        50% { border-image-source: linear-gradient(135deg, #f093fb, #667eea, #764ba2); }
        75% { border-image-source: linear-gradient(135deg, #667eea, #764ba2, #f093fb); }
        100% { border-image-source: linear-gradient(135deg, #764ba2, #f093fb, #667eea); }
    }

    /* ▼▼▼ [BARU] Gaya untuk Navigasi Halaman Pengaturan ▼▼▼ */
    .settings-page {
        display: none; /* Sembunyikan semua halaman secara default */
        animation: slide-in-down 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; /* [DIUBAH] Animasi dari atas ke bawah */
    }
    .settings-page.active {
        display: block;
    }
    .settings-page.slide-out {
        animation: slide-out-up 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; /* [DIUBAH] Animasi dari bawah ke atas */
    }
    @keyframes slide-in-right {
        from { opacity: 0; transform: translateX(30px); }
        to { opacity: 1; transform: translateX(0); }
    }
    @keyframes slide-out-left {
        from { opacity: 1; transform: translateX(0); }
        to { opacity: 0; transform: translateX(-30px); }
    }
    /* [BARU] Keyframes untuk animasi vertikal */
    @keyframes slide-in-down {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slide-out-up {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(20px); }
    }
    .settings-item.nav-item { cursor: pointer; }
    .settings-item.nav-item:hover { background-color: var(--bg-tertiary); }
    /* ▲▲▲ AKHIR DARI GAYA NAVIGASI PENGATURAN ▲▲▲ */
    
    .settings-tab { transition: all 0.3s ease; border-bottom: 2px solid transparent; color: var(--text-secondary); }
    .settings-tab.active { color: #4f46e5; font-weight: 600; border-bottom-color: #4f46e5; }
    html.dark .settings-tab.active { color: var(--text-primary); border-bottom-color: var(--text-primary); }
    .settings-tab-content { display: none; animation: fadeIn 0.5s ease; }
    .settings-tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .settings-card {
        background: var(--settings-card-bg);
        border-radius: 1rem; padding: 1rem;
        margin-bottom: 1rem; /* [BARU] Menambahkan jarak bawah antar kartu */
        box-shadow: 0 4px 12px var(--shadow-color);
        transition: all 0.3s ease;
    }
    .settings-card:not(.nav-item):hover { transform: translateY(-2px); box-shadow: 0 6px 16px var(--shadow-color); }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
    .settings-item.flex-col {
        flex-direction: column; align-items: flex-start; gap: 0.5rem;
    }
    .settings-item:last-child { border-bottom: none; }
    /* [PERMINTAAN PENGGUNA] Memperbesar dan menebalkan teks pengaturan */
    .settings-item label, .settings-item span { font-size: 0.95rem; font-weight: 500; }
    .settings-icon { width: 1.25rem; height: 1.25rem; color: #6366f1; }
    html.dark .settings-icon { color: var(--text-primary); }
    /* ▼▼▼ [PENYEMPURNAAN] Gaya untuk Judul Seksi Pengaturan ▼▼▼ */
    .settings-section-header {
        padding: 1.25rem 1rem 0.5rem 1rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
    }
    .settings-section-header:first-of-type { padding-top: 0.75rem; }
    /* ▼▼▼ [BARU] Gaya untuk Latar Belakang Ikon Pengaturan ▼▼▼ */
    .settings-icon-bg {
        width: 2rem; /* 32px */
        height: 2rem; /* 32px */
        border-radius: 0.5rem; /* 8px */
        flex-shrink: 0; /* [PERBAIKAN] Mencegah ikon menyusut */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .settings-icon-bg svg {
        width: 1.25rem; /* 20px */
        height: 1.25rem; /* 20px */
    }
    /* [DIHAPUS] Aturan ini tidak lagi diperlukan karena sudah digabungkan di atas */
    /* .settings-item.nav-item .settings-icon-bg {
        flex-shrink: 0;
    } */

    .settings-input, .settings-select, #customRoleInput {
        border-radius: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color);
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease-in-out; width: 55%;
        font-size: 16px !important; color: var(--text-primary);
    }
    .settings-input:focus, .settings-select:focus, #customRoleInput:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none;
    }
     html.dark .settings-input:focus, html.dark .settings-select:focus, html.dark #customRoleInput:focus {
        border-color: #f5f5f5;
        box-shadow: 0 0 0 2px rgba(245, 245, 245, 0.2);
    }

    .settings-btn-action {
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        padding: 0.75rem; border-radius: 0.75rem; font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .settings-btn-action:hover { transform: translateY(-1px); }
    .settings-btn-action:active { transform: scale(0.98); }
    .theme-option-new {
        border-radius: 0.75rem; padding: 0.5rem; border: 2px solid transparent;
        transition: all 0.2s ease-in-out; cursor: pointer; text-align: center;
    }
    .theme-option-new.active { border-color: #4f46e5; background-color: var(--bg-accent); }
    html.dark .theme-option-new.active { border-color: #555; }
    .theme-swatch { width: 100%; height: 1.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .toggle-new {
        appearance: none; width: 44px; height: 24px; border-radius: 12px;
        background-color: var(--bg-tertiary);
        position: relative; cursor: pointer; transition: background-color 0.3s ease;
    }
    .toggle-new::before {
        content: ''; position: absolute; top: 3px; left: 3px;
        width: 18px; height: 18px; border-radius: 50%; background-color: white;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
        /* ▼▼▼ [PENYEMPURNAAN] Gaya Toggle Switch Baru (Gaya iOS) ▼▼▼ */
    .toggle-new, .toggle-radio {
        appearance: none; width: 48px; height: 28px; border-radius: 14px;
        background-color: #e5e7eb; /* Abu-abu untuk status 'off' (mode terang) */
        position: relative; cursor: pointer; transition: background-color 0.3s ease-in-out;
        border: 1px solid rgba(0,0,0,0.04);
    }
    html.dark .toggle-new, html.dark .toggle-radio {
        background-color: #39393d; /* Abu-abu gelap untuk status 'off' (mode gelap) */
    }
    .toggle-new::before, .toggle-radio::before {
        content: ''; position: absolute; top: 2px; left: 2px;
        width: 24px; height: 24px; border-radius: 50%; background-color: white;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 1px 3px rgba(0,0,0,0.15), 0 1px 2px rgba(0,0,0,0.1);
    }
    .toggle-new:checked, .toggle-radio:checked {
        background-color: #34C759; /* [DIUBAH] Warna hijau standar iOS */
    }
    .toggle-new:checked::before, .toggle-radio:checked::before {
        transform: translateX(20px);
    }
    /* [PERMINTAAN PENGGUNA] Membuat toggle tetap hijau di mode gelap */
    html.dark .toggle-new:checked, html.dark .toggle-radio:checked {
        background-color: #34C759; /* [DIUBAH] Warna hijau standar iOS */
    }
    /* ▲▲▲ AKHIR DARI GAYA TOGGLE SWITCH BARU ▲▲▲ */


    .choice-btn {
        width: 100%;
        padding: 0.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s ease-in-out;
        text-align: center;
        cursor: pointer;
    }
    .choice-btn:hover {
        background: var(--bg-accent);
        border-color: #cbd5e1;
    }
    html.dark .choice-btn:hover { border-color: #555; }
    .choice-btn.active {
        background: var(--bg-accent);
        border-color: #6366f1;
        color: #4f46e5;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
    }
    html.dark .choice-btn.active { 
        border-color: #f5f5f5;
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(245, 245, 245, 0.1);
    }

    /* ▼▼▼ [DIUBAH] Gaya untuk Pratinjau Latar Belakang Realistis ▼▼▼ */
    .preview-pane {
        position: relative;
        overflow: hidden;
        border: 4px solid var(--border-color);
        background-color: var(--bg-primary);
        transition: border-color 0.3s ease;
    }
    .preview-pane.mobile-view { width: 140px; aspect-ratio: 9 / 19.5; border-radius: 1.25rem; flex-shrink: 0; }
    .preview-pane.desktop-view { width: 100%; max-width: 240px; aspect-ratio: 16 / 10; border-radius: 0.75rem; }
    .preview-background { position: absolute; inset: 0; z-index: 1; transition: all 0.3s ease; }
    .preview-header, .preview-footer { position: absolute; left: 0; right: 0; z-index: 2; background-color: rgba(var(--bg-secondary-rgba), 0.45); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    .preview-header { top: 0; height: 12%; border-bottom: 1px solid rgba(var(--text-primary-rgba), 0.1); }
    .preview-footer { bottom: 0; height: 15%; border-top: 1px solid rgba(var(--text-primary-rgba), 0.1); }
    .preview-bubble { 
        position: absolute; 
        z-index: 2; 
        border-radius: 0.5rem; 
        padding: 5%; /* Padding untuk teks di dalam */
        display: flex;
        gap: 5%;
        align-items: flex-start;
        font-size: 0.4rem; /* Ukuran font sangat kecil untuk simulasi */
        line-height: 1.4;
        overflow: hidden;
    }
    .preview-bubble.ai { 
        top: 18%; left: 5%; width: 80%; /* Sedikit lebih lebar */
        background-color: rgba(var(--bg-tertiary-rgba), 0.8); 
        backdrop-filter: blur(10px); 
        -webkit-backdrop-filter: blur(10px); 
        border-top-left-radius: 0.2rem; 
        color: var(--text-primary);
    }
    .preview-bubble.user { 
        top: 40%; right: 5%; width: 50%; 
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.8), rgba(5, 150, 105, 0.8)); 
        backdrop-filter: blur(10px); 
        -webkit-backdrop-filter: blur(10px); 
        border-top-right-radius: 0.2rem;
        color: white;
        justify-content: flex-end;
    }
    .preview-avatar {
        width: 15%;
        aspect-ratio: 1 / 1;
        border-radius: 50%;
        background-image: url('https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg');
        background-size: cover;
        flex-shrink: 0;
    }
    .preview-text-content {
        flex-grow: 1;
    }
    .preview-name {
        font-weight: 600;
        margin-bottom: 2%;
    }
    /* ▲▲▲ AKHIR DARI GAYA PRATINJAU ▲▲▲ */
    
    /* ▼▼▼ [PERBAIKAN MARKDOWN] Gaya dirombak agar mirip ChatGPT ▼▼▼ */
    .markdown-content {
        color: var(--text-primary); 
        font-size: 1rem; /* Ukuran font standar */
        line-height: 1.7; /* Jarak antar baris lebih lega */
        overflow-wrap: break-word;
        word-wrap: break-word;
    }
    .markdown-content p, .markdown-content ul, .markdown-content ol, .markdown-content pre, .markdown-content blockquote {
        margin-bottom: 1rem; /* Jarak konsisten antar elemen */
    }
    .markdown-content p:last-child, .markdown-content ul:last-child, .markdown-content ol:last-child, .markdown-content pre:last-child, .markdown-content blockquote:last-child {
        margin-bottom: 0; /* Hapus jarak di elemen terakhir */
    }
    .markdown-content strong, .markdown-content b { font-weight: 600; }
    .markdown-content h1, .markdown-content h2, .markdown-content h3 {
        font-weight: 600;
        margin-bottom: 0.75rem;
        line-height: 1.3;
    }
    .markdown-content h1 { font-size: 1.5em; }
    .markdown-content h2 { font-size: 1.25em; }
    .markdown-content h3 { font-size: 1.1em; }

    .markdown-content ul, .markdown-content ol {
        padding-left: 1.25rem; /* [DIUBAH] Sedikit mengurangi padding dasar */
        margin-left: 0.25rem; /* [BARU] Menambah sedikit margin untuk konsistensi */
    }
    .markdown-content li { 
        margin-bottom: 0.5rem; /* Jarak antar item list */
        padding-left: 0.25rem; /* Sedikit padding untuk teks setelah bullet/nomor */
    }
    /* [BARU] Gaya untuk daftar bertingkat (multi-level list) */
    .markdown-content ul ul, .markdown-content ol ol, .markdown-content ul ol, .markdown-content ol ul {
        margin-top: 0.5rem; /* Jarak antara item induk dan daftar anak */
        margin-bottom: 0.5rem;
    }
    .markdown-content li::marker {
        color: var(--text-secondary);
        font-weight: 600;
    }
    .markdown-content code:not(pre > code) {
        background-color: rgba(var(--text-primary-rgba), 0.08);
        padding: 0.2rem 0.4rem;
        border-radius: 0.375rem;
        font-size: 0.85em;
        font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
    }
    .markdown-content pre {
        position: relative;
        background-color: #1e1e1e; /* Warna latar lebih gelap */
        color: #d4d4d4; /* Warna teks lebih terang */
        padding: 1rem;
        border-radius: 0.75rem; /* Sudut lebih melengkung */
        overflow-x: auto;
        font-size: 0.85em;
        border: 1px solid var(--border-color);
    }
    .copy-code-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background-color: rgba(255, 255, 255, 0.1);
        color: #d4d4d4;
        border: none;
        padding: 0.25rem 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.75rem;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s ease-in-out;
    }
    .markdown-content pre:hover .copy-code-btn {
        opacity: 1;
    }
    html.dark .markdown-content pre { background-color: #0c0c0c; }
    .markdown-content pre code {
        background: transparent;
        padding: 0;
    }
    html.dark .markdown-content pre { background-color: #1e1e1e; }
    .markdown-content blockquote {
        border-left: 3px solid var(--border-color);
        padding-left: 1rem;
        margin-left: 0.25rem;
        font-style: italic;
        color: var(--text-secondary);
    }
    /* ▲▲▲ AKHIR DARI PERBAIKAN MARKDOWN ▲▲▲ */

    /* ▼▼▼ [BARU] GAYA UNTUK LINK AGAR BERWARNA BIRU ▼▼▼ */
    .markdown-content a {
        color: #3b82f6; /* Warna biru */
        text-decoration: underline;
        font-weight: 500;
    }
    .markdown-content a:hover {
        color: #2563eb;
    }
    html.dark .markdown-content a {
        color: #60a5fa; /* Warna biru lebih terang untuk mode gelap */
    }
    html.dark .markdown-content a:hover {
        color: #93c5fd;
    }
    /* ▲▲▲ AKHIR DARI GAYA LINK ▲▲▲ */

    /* ▼▼▼ [BARU] Gaya untuk Pembaca Teks (TTS Player) ▼▼▼ */
    .tts-player {
        display: none; /* Sembunyikan secara default */
        align-items: center;
        justify-content: space-between;
        padding: 0.5rem 0.75rem;
        margin-top: 0.75rem;
        background-color: rgba(var(--bg-primary-rgba), 0.5);
        border-radius: 0.75rem;
        border: 1px solid rgba(var(--text-primary-rgba), 0.1);
        animation: fadeIn 0.3s ease;
    }
    .tts-player.active {
        display: flex;
    }
    .tts-player .tts-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 0; /* Mencegah teks mendorong tombol keluar */
    }
    .tts-player .tts-wave {
        display: flex;
        align-items: center;
        gap: 2px;
        height: 16px;
        width: 24px; /* Lebar tetap untuk wave */
        /* [BARU] Menambahkan perspektif untuk animasi 3D */
        perspective: 30px;
    }
    .tts-player .wave-bar {
        width: 3px;
        background: var(--text-secondary);
        /* [DIUBAH] Mengganti animasi lama dengan animasi spektrum baru */
        animation: tts-spectrum-animation 1.2s infinite ease-in-out;
    }
    .tts-player .tts-text {
        font-size: 0.8rem;
        color: var(--text-secondary);
        font-weight: 500;
    }
    .tts-player .stop-tts-btn {
        color: var(--text-primary);
        background: transparent;
        border: none;
        padding: 0.25rem;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .tts-player .stop-tts-btn:hover {
        background-color: rgba(var(--text-primary-rgba), 0.1);
    }
    /* [BARU] Animasi spektrum untuk TTS Player */
    @keyframes tts-spectrum-animation {
        0%, 100% { transform: scaleY(0.1) rotateX(0); }
        25% { transform: scaleY(1.0) rotateX(15deg); background-color: #6366f1; }
        50% { transform: scaleY(0.3) rotateX(0); }
        75% { transform: scaleY(0.8) rotateX(-15deg); background-color: #8b5cf6; }
    }
    /* [BARU] Menambahkan delay animasi untuk setiap bar agar terlihat dinamis */
    .tts-player .wave-bar:nth-child(1) { animation-delay: -0.4s; }
    .tts-player .wave-bar:nth-child(2) { animation-delay: -0.2s; }
    .tts-player .wave-bar:nth-child(3) { animation-delay: 0s; }
    .tts-player .wave-bar:nth-child(4) { animation-delay: -0.3s; }

    /* ▲▲▲ AKHIR DARI GAYA LINK ▲▲▲ */


    /* === CSS RESPONSIVE UNTUK MOBILE === */
    @media (max-width: 768px) {
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transform: translateX(-100%);
            border-right: 1px solid var(--border-color); /* [DIHAPUS] transisi sudah ada di #sidebar */
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 80vw;
            max-width: 280px;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        
        /* [PERMINTAAN PENGGUNA] Memanjangkan bubble AI ke kanan di mobile */
        .message-bubble.ai { max-width: 100%; } 
        .user-message { max-width: 85%; } /* [DIUBAH] Dibuat konsisten dengan desktop */
        .user-message { padding: 0.8rem 1.2rem; }
        .quick-actions { padding: 0.6rem 0.8rem; }
        .quick-action-btn { padding: 0.4rem 0.8rem; font-size: 0.7rem; }
        .modal-content { border-radius: 1rem; padding: 1.5rem; }
        #settingsModal .modal-content { padding: 0; }
        .settings-input, .settings-select, #customRoleInput {
            font-size: 16px !important;
        }
    }
    
    #chatMessages {
        /* [DIUBAH] Menambahkan padding atas & bawah agar chat tidak tertutup header/footer */
        padding-top: 8rem !important;
        padding-bottom: 9rem !important; /* [BARU] Padding bawah untuk footer transparan */
        /* [BARU] Mencegah scroll 'bocor' ke body di iOS (PWA) */
        overscroll-behavior-y: contain;
    }

    .chat-messages::-webkit-scrollbar { width: 8px; }
    .chat-messages { background-color: transparent; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2); border-radius: 20px;
      border: 2px solid transparent; background-clip: content-box;
    }
    html.dark .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
    }
    .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.3); }
    html.dark .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.3); }
    
    /* ▼▼▼ CSS BARU UNTUK FITUR PANGGILAN SUARA ▼▼▼ */
    #callModal {
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
    }
    .call-avatar-container {
        animation: call-pulse 2s infinite;
    }
    /* ▼▼▼ [PENYEMPURNAAN] Animasi Avatar Melayang ▼▼▼ */
    .call-avatar-container img {
        animation: call-avatar-float 4s ease-in-out infinite;
    }
    @keyframes call-avatar-float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    /* ▲▲▲ AKHIR DARI PENYEMPURNAAN ▲▲▲ */
    /* ▼▼▼ [PERBAIKAN] Gaya Baru untuk Modal Panggilan Suara ▼▼▼ */
    #callModal {
        background: radial-gradient(circle, #1a2a6c 0%, #000000 100%);
        animation: call-background-pan 15s linear infinite;
        background-size: 200% 200%;
    }
    @keyframes call-background-pan {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }
    .call-action-button {
        background-color: rgba(255, 255, 255, 0.15); /* Sedikit lebih terang */
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); /* Bayangan lebih kuat */
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Transisi lebih dinamis */
    }
    /* ▼▼▼ [PENYEMPURNAAN] Animasi Visualizer Suara Baru ▼▼▼ */
    @keyframes call-visualizer-pulse {
        0% { transform: scale(1.2); opacity: 0; border-color: #60a5fa; }
        50% { opacity: 1; border-color: #3b82f6; }
        100% { transform: scale(1.6); opacity: 0; border-color: #93c5fd; }
    }
    /* ▼▼▼ [PENYEMPURNAAN] Penyesuaian Tata Letak ▼▼▼ */
    #callModal {
        padding-bottom: calc(2rem + env(safe-area-inset-bottom)); /* Padding bawah untuk home bar iPhone */
        padding-top: calc(2rem + env(safe-area-inset-top)); /* Padding atas untuk poni iPhone */
    }
    #callStatusText { min-height: 28px; /* Mencegah lompatan layout */ }
    /* ▲▲▲ AKHIR DARI PENYEMPURNAAN ▲▲▲ */
    /* ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲ */
    @keyframes call-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
        70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }
    /* CSS untuk area transkrip di iPhone */
    #callTranscriptPreview {
      background-color: rgba(0, 0, 0, 0.2);
      backdrop-filter: blur(5px);
      max-height: 100px;
      overflow-y: auto;
    }
    /* ▼▼▼ [BARU] GAYA UNTUK NOTIFIKASI ERROR DEBUG ▼▼▼ */
    #errorToastContainer {
        position: fixed;
        bottom: 1rem;
        left: 1rem;
        right: 1rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
        pointer-events: none;
    }
    .error-toast {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        background-color: #ef4444; /* red-500 */
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        max-width: 500px;
        width: 100%;
        pointer-events: auto;
        animation: toast-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .error-toast code { font-size: 0.75rem; line-height: 1.2; }
    @keyframes toast-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    /* ▲▲▲ AKHIR DARI GAYA NOTIFIKASI ERROR DEBUG ▲▲▲ */
    /* ▼▼▼ [BARU] GAYA UNTUK FITUR STORY ▼▼▼ */
    #storiesList { scrollbar-width: none; -ms-overflow-style: none; }
    #storiesList::-webkit-scrollbar { display: none; }

    .story-item, .add-story-btn {
        /* [DIKEMBALIKAN] Tata letak kembali ke vertikal */
        flex-shrink: 0;
        width: 60px; /* [DIKEMBALIKAN] Lebar tetap */
        text-align: center;
        cursor: pointer;
    }
    .story-avatar-wrapper {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        padding: 2px;
        background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
        margin: 0 auto 4px;
        transition: transform 0.2s ease; 
        flex-shrink: 0; /* [BARU] Mencegah ikon menyusut */
    }
    .story-item:hover .story-avatar-wrapper { transform: scale(1.05); }
    .story-avatar-wrapper img {
        width: 100%; height: 100%; object-fit: cover; border-radius: 50%; border: 2px solid var(--bg-primary);
    }
    /* [PERBAIKAN] Membuat teks story lebih terang di mode gelap */
    html.dark .story-item .story-username,
    html.dark .add-story-btn .story-username {
        color: var(--text-secondary);
    }
    /* [DIKEMBALIKAN] Margin bawah untuk avatar */
    .story-item .story-avatar-wrapper { margin: 0 auto 4px; }
    .add-story-btn .story-avatar-wrapper { margin: 0 auto 4px; }

    .story-item .story-username { 
        font-size: 0.7rem; 
        color: var(--text-secondary); 
        line-height: 1.2; 
        overflow: hidden; 
        text-overflow: ellipsis; 
        white-space: nowrap;
    }
    /* [DIKEMBALIKAN & DIPERBAIKI] Ukuran avatar kembali normal dan teks diatur agar tidak membuat container lebih tinggi */
    .add-story-btn .story-username { font-size: 0.7rem; color: var(--text-secondary); line-height: 1.2; }
    .add-story-btn .story-avatar-wrapper { background: var(--bg-tertiary); border: 2px dashed var(--border-color); padding: 0; display: flex; align-items: center; justify-content: center; }
    .add-story-btn .story-avatar-wrapper svg { color: var(--text-secondary); }
    /* ▲▲▲ AKHIR DARI GAYA STORY ▲▲▲ */
    /* ▼▼▼ [BARU] GAYA UNTUK PRATINJAU FILE DI INPUT AREA ▼▼▼ */
    #filePreviewContainer {
        display: none; /* Sembunyikan secara default */
        flex-wrap: wrap;
        gap: 0.5rem; /* 8px */
        padding: 0.5rem; /* 8px */
        margin-bottom: 0.5rem; /* 8px */
        border: 1px solid var(--border-color);
        border-radius: 0.75rem; /* 12px */
        background-color: var(--bg-secondary);
        animation: fadeIn 0.3s ease;
    }
    .file-preview-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem; /* 8px */
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 9999px;
        padding: 0.25rem 0.25rem 0.25rem 0.75rem; /* 4px 4px 4px 12px */
        font-size: 0.875rem; /* 14px */
        font-weight: 500;
        color: var(--text-primary);
        box-shadow: 0 1px 2px var(--shadow-color);
    }
    .file-preview-chip .remove-file-btn {
        background-color: var(--bg-tertiary);
    }
    /* [BARU] Gaya khusus untuk pratinjau gambar */
    .image-preview-chip img {
        width: 2.5rem; /* 40px */
        height: 2.5rem; /* 40px */
        object-fit: cover;
        border-radius: 0.5rem; /* 8px */
        border: 1px solid var(--border-color);
    }
    /* ▲▲▲ AKHIR DARI GAYA PRATINJAU FILE ▲▲▲ */
    /* ▲▲▲ AKHIR DARI CSS PANGGILAN SUARA ▲▲▲ */

    /* ▼▼▼ [BARU] GAYA UNTUK PENAMPIL STORY (STORY VIEWER) ▼▼▼ */
    #storyViewerModal {
        /* [DIKEMBALIKAN] Latar belakang kembali menjadi warna solid acak, dengan transisi warna */
        background-color: var(--story-bg-color, '#73B193'); /* Warna default jika variabel tidak diset */
        transition: background-color 0.5s ease, opacity 0.3s ease, transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-family: 'Inter', sans-serif;
    }
    #storyViewerModal.hidden {
        opacity: 0;
        transform: scale(1.05); /* Animasi zoom-out saat ditutup */
        pointer-events: none;
    }
    .story-viewer-header {
        padding-top: calc(0.75rem + env(safe-area-inset-top));
    }
    .story-viewer-content {
        font-size: 1.75rem; /* 28px */
        line-height: 2.25rem; /* 36px */
        font-weight: 700; /* bold */
    }
    .story-viewer-footer {
        padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        /* [DIUBAH] Flexbox untuk menata semua item di footer */
        display: flex;
    }
    .story-progress-container {
        display: flex;
        gap: 4px;
        width: 100%;
    }
    .story-progress-bar {
        flex-grow: 1;
        height: 3px;
        background-color: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
        overflow: hidden; /* [BARU] Diperlukan untuk progress fill */
    }
    /* [BARU] Gaya untuk progress fill yang aktif */
    .story-progress-fill {
        width: 0%;
        height: 100%;
        background-color: white;
        overflow: hidden;
    }
    /* [BARU] Gaya untuk tombol hapus story */
    #deleteStoryBtn {
        background-color: rgba(0, 0, 0, 0.2);
        transition: background-color 0.2s ease;
        backdrop-filter: blur(5px);
    }
    /* ▼▼▼ [BARU] GAYA UNTUK MODAL BUAT STORY YANG DIROMBAK ▼▼▼ */
    #createStoryModal .modal-content {
        /* [DIUBAH] Latar belakang gradien yang menarik */
        background: linear-gradient(145deg, #6a82fb, #fc5c7d);
        border: none;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        /* [DIUBAH] Dibuat lebih tinggi untuk tampilan yang lebih imersif */
        height: 70vh;
        max-height: 500px;
        display: flex;
        flex-direction: column;
        padding: 1rem; /* Padding dasar */
    }
    #storyContentInput {
        /* [DIUBAH] Menghapus semua gaya default input */
        background: transparent;
        border: none;
        outline: none;
        box-shadow: none;
        /* [DIUBAH] Teks besar dan di tengah seperti WhatsApp Status */
        font-size: 1.75rem; /* 28px */
        font-weight: 700;
        color: white;
        text-align: center;
        flex-grow: 1; /* Mengisi ruang yang tersedia */
        resize: none; /* Mencegah user mengubah ukuran */
        padding: 1rem;
    }
    #storyContentInput::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }
    /* ▲▲▲ AKHIR DARI GAYA MODAL BUAT STORY ▲▲▲ */
    /* ▲▲▲ AKHIR DARI GAYA PENAMPIL STORY ▲▲▲ */
  </style>
</head>
<body>
<!-- ... (Isi dari <body> Anda tetap sama) ... -->
<div id="appContainer">
    <div id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div id="sidebar">
        <div class="p-4 flex flex-col h-full">
            <div class="mb-4 flex-shrink-0">
                <button onclick="startNewChat()" class="new-chat-btn group" data-translate-title="newChatTitle">
                    <span data-translate-key="newChat">Mulai Chat Baru</span>
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
            </div>

            <!-- ▼▼▼ [DIUBAH] Kontainer bawah untuk Riwayat Chat dan Profil ▼▼▼ -->
            <div class="flex-grow flex flex-col min-h-0">
                <!-- ▼▼▼ [BARU] Bagian Atas: Story Pengguna ▼▼▼ -->
                <!-- [DIUBAH] Dihapus kelas 'hidden' agar selalu terlihat -->
                <div id="storiesContainer" class="py-2 border-b border-t flex-shrink-0" style="border-color: var(--border-color);">
                    <div class="px-4 text-xs font-semibold text-gray-500 mb-2" data-translate-key="storiesTitle">Stories</div>
                    <div id="storiesList" class="flex items-center gap-3 overflow-x-auto px-4 pb-2">
                        <!-- Tombol "Tambah Story" dan story pengguna lain akan muncul di sini -->
                    </div>
                </div>

                <!-- ▼▼▼ [DIUBAH] Bagian Bawah: Riwayat Chat (dibuat bisa scroll) ▼▼▼ -->
                <div class="flex-grow overflow-y-auto min-h-0">
                    <div class="px-4 pt-4 pb-2 text-xs font-semibold text-gray-500" data-translate-key="historyTitle">
                        Riwayat Chat
                    </div>
                    <div class="pr-2"> <!-- Wrapper untuk padding kanan agar tidak memotong scrollbar -->
                        <ul id="chatHistoryList">
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- ▼▼▼ [BARU] Area Profil Pengguna & Tombol Login/Logout ▼▼▼ -->
        <!-- [DIUBAH] Dipindahkan ke luar dari kontainer scroll -->
        <div id="userProfile" class="p-4 border-t flex-shrink-0" style="border-color: var(--border-color); margin-top: auto;">
            <!-- [DIUBAH] Tombol Login dengan gaya baru -->
            <div id="loginContainer" class="flex items-center justify-center">
                <button id="loginBtn" class="w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-200 font-semibold py-2 px-4 rounded-lg flex items-center justify-center gap-3 transition-all hover:bg-gray-100 dark:hover:bg-gray-700 shadow-sm">
                    <svg class="w-5 h-5" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"></path>
                        <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"></path>
                        <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"></path>
                        <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"></path>
                        <path d="M1 1h22v22H1z" fill="none"></path>
                    </svg>
                    <span class="text-sm">Login dengan Google</span>
                </button>
            </div>
            <div id="userInfoContainer" class="hidden items-center space-x-3">
                <img id="userAvatar" class="w-10 h-10 rounded-full" src="" alt="User Avatar">
                <div class="flex-grow min-w-0">
                    <p id="userName" class="font-semibold text-sm truncate" style="color: var(--text-primary);"></p>
                    <button id="logoutBtn" class="text-xs text-red-500 hover:text-red-600 font-medium">Logout</button>
                </div>
            </div>
        </div>
        <!-- ▲▲▲ AKHIR DARI Area Profil Pengguna ▲▲▲ -->
    </div>

    <div class="chat-container">
        <div class="chat-window flex flex-col">
            <div class="header-gradient flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleSidebar()" 
                                class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 active:bg-opacity-40 transition-all duration-200 ease-in-out" aria-label="Tampilkan/Sembunyikan Riwayat Obrolan"
                                data-translate-title="sidebarToggleTitle">
                             <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        </button>
                        <div class="flex items-center space-x-3">
                            <div class="ai-avatar w-12 h-12 flex-shrink-0 flex items-center justify-center overflow-hidden relative cursor-pointer" onclick="showProfileModal()">
                                <img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="StoryBali"
                                     class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h1 class="text-xl font-bold" data-translate-key="aiName">Wayan AI</h1>
                                <p class="text-sm opacity-90" data-translate-key="profileHint">Klik untuk lihat profil</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="toggleSettings()"
                                class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 active:bg-opacity-40 transition-all duration-200 ease-in-out" aria-label="Buka Pengaturan"
                                data-translate-title="settingsTitle">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 chat-messages">
                 <!-- Typing Indicator will be added here by JS -->
                 <div id="typingIndicator" class="typing-indicator items-start space-x-3">
                    <div onclick="showProfileModal()" class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden cursor-pointer"><img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="StoryBali" class="w-full h-full object-cover"></div>
                    <div class="typing-bubble"><div class="flex space-x-1"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
                </div>
                <!-- Image Processing Indicator -->
                <div id="imageProcessingIndicator" class="typing-indicator items-start space-x-3">
                    <div onclick="showProfileModal()" class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden cursor-pointer"><img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="StoryBali" class="w-full h-full object-cover"></div>
                    <div class="typing-bubble flex items-center">
                        <div class="flex space-x-1"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <span class="ml-2 text-sm" style="color: var(--text-secondary);" data-translate-key="imageProcessing">Menganalisis gambar...</span>
                    </div>
                </div>
            </div>
            
            <div id="stopGeneratingContainer" class="text-center p-2" style="display: none;">
                <button id="stopBtn" class="py-2 px-4 border rounded-full text-sm font-medium flex items-center gap-2 mx-auto">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    <span data-translate-key="stopGenerating">Hentikan</span>
                </button>
            </div>
            
            <!-- [BARU] Wrapper untuk footer yang melayang agar efek transparan berfungsi -->
            <div class="chat-footer">
                <!-- ▼▼▼ [BARU] Notifikasi Pesan Baru untuk Smart Scrolling ▼▼▼ -->
                <div id="newMessageNotification" class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 hidden">
                    <button onclick="forceScrollToBottom()" class="bg-blue-500 hover:bg-blue-600 text-white text-xs font-semibold py-1.5 px-4 rounded-full shadow-lg flex items-center gap-2 transition-all duration-300 transform hover:-translate-y-1">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>
                        <span data-translate-key="newMessages">Pesan Baru</span>
                    </button>
                </div>
                <!-- ▲▲▲ AKHIR DARI NOTIFIKASI PESAN BARU ▲▲▲ -->

                <!-- Tombol saran cepat -->
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="sendQuickMessage('Halo Wayan!')" data-translate-key="quickHello">Halo</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Apa kabar hari ini?')" data-translate-key="quickHowAreYou">Apa kabar?</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Ceritakan joke lucu dong!')" data-translate-key="quickJoke">Joke</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Kasih tips produktif dong!')" data-translate-key="quickProductive">Tips Produktif</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Rekomendasi film bagus dong!')" data-translate-key="quickMovie">Film</button>
                    <button class="quick-action-btn" onclick="sendQuickMessage('Ajarin coding dong!')" data-translate-key="quickCoding">Coding</button>
                </div>

                <div class="input-area">
                    <div class="input-box">
                        <!-- ▼▼▼ [BARU] KONTainer UNTUK PRATINJAU FILE ▼▼▼ -->
                        <div id="filePreviewContainer">
                            <!-- Pratinjau file akan muncul di sini melalui JS -->
                            <!-- Contoh:
                            <div class="file-preview-chip">
                                <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <span class="truncate max-w-[150px]">nama_file_yang_panjang.txt</span>
                                <button onclick="removeAttachedFile(this)" class="w-5 h-5 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 remove-file-btn">&times;</button>
                            </div>
                            <div class="file-preview-chip image-preview-chip">
                                <img src="path/to/image.jpg" alt="Preview">
                                <span class="truncate max-w-[150px]">nama_gambar.jpg</span>
                                <button onclick="removeAttachedFile(this)" class="w-5 h-5 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 remove-file-btn">&times;</button>
                            </div>
                            -->
                        </div>
                        <!-- ▲▲▲ AKHIR DARI KONTainer PRATINJAU FILE ▲▲▲ -->

                        <input
                            type="text"
                        id="messageInput"
                        data-translate-placeholder="inputPlaceholder"
                        onkeypress="handleKeyPress(event)"
                        oninput="handleInputChange(event)"
                    >

                    <!-- [REFINED] UI Perekaman Suara -->
                    <div id="voiceRecordingUI" class="absolute inset-0 items-center justify-start px-4 hidden" style="background-color: var(--bg-tertiary); border-radius: 1.25rem;">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="voice-wave">
                                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                            </div>
                            <span id="voiceStatusText" class="text-sm text-gray-500 dark:text-gray-400 truncate" data-translate-key="listening">Mendengarkan...</span>
                        </div>
                    </div>
                    <!-- Akhir UI Perekaman Suara -->
                    
                    <!-- [DIUBAH] Input file dipisahkan untuk gambar dan file lain -->
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleFileUpload(event, 'image')">
                    <input type="file" id="fileInput" accept=".txt,.pdf,.csv,.md,.json,.html,.js,.css" style="display: none;" onchange="handleFileUpload(event, 'file')">
                    
                    <div class="action-buttons">
                        <div class="left-actions">
                            <button onclick="triggerImageUpload()" class="action-btn" aria-label="Unggah Gambar" data-translate-title="uploadImageTitle">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            </button>
                            <!-- [BARU] Tombol untuk unggah file -->
                            <button onclick="triggerFileUpload()" class="action-btn" aria-label="Unggah File" data-translate-title="uploadFileTitle">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M18.375 12.739l-7.693 7.693a4.5 4.5 0 01-6.364-6.364l10.94-10.94A3 3 0 1119.5 7.372L8.552 18.32m.009-.01l-.01.01m5.699-9.941l-7.81 7.81a1.5 1.5 0 002.122 2.122l7.81-7.81"></path></svg>
                            </button>
                            <!-- [DIPINDAHKAN] Tombol Panggilan Suara -->
                            <button id="startCallBtn" onclick="startCall()" class="action-btn" aria-label="Mulai Panggilan Suara" data-translate-title="voiceCallTitle">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            </button>
                            <!-- Tombol Video dihapus dan diganti dengan Tombol Pencarian Internet -->
                            <button id="toggleSearchModeBtn" onclick="toggleSearchMode()" class="action-btn" aria-label="Mode Pencarian Internet" data-translate-title="searchModeTitle">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="2" y1="12" x2="22" y2="12"></line>
                                    <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                                </svg>
                            </button>
                            <button onclick="openQuickSettings()" class="action-btn" aria-label="Pengaturan Cepat" data-translate-title="quickSettingsTitle">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                            </button>
                        </div>
                        
                        <div class="dynamic-icon-container">
                            <button id="micBtn" onclick="toggleVoiceMode()" class="dynamic-icon-btn" aria-label="Mode Suara" data-translate-title="voiceModeTitle">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                            <button id="sendBtn" onclick="sendMessage()" class="dynamic-icon-btn send-btn-active" aria-label="Kirim Pesan" data-translate-title="sendTitle" style="opacity: 0; pointer-events: none;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
</div>
    
<!-- ▼▼▼ MODAL PANGGILAN SUARA YANG DIROMBAK TOTAL ▼▼▼ -->
<div id="callModal" class="fixed inset-0 z-50 flex-col items-center justify-between hidden p-8" style="background-color: rgba(0,0,0,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
    <!-- Area Konten Atas -->
    <div class="w-full text-center text-white">
        <div class="relative inline-block">
            <div class="call-avatar-container w-32 h-32 rounded-full p-1 mx-auto mb-4" style="border: 3px solid rgba(255,255,255,0.5);">
                <img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="Wayan AI Avatar" class="w-full h-full object-cover rounded-full">
            </div>
            <!-- [BARU] Visualizer Suara -->
            <div id="callVisualizer" class="absolute inset-0 rounded-full border-2 border-blue-400 opacity-0 transition-all duration-500" style="animation: call-visualizer-pulse 2s infinite ease-out;"></div>
        </div>
        <h2 class="text-2xl font-bold" data-translate-key="aiName">Wayan AI</h2>
        <p id="callStatusText" class="text-lg mt-1 text-gray-300 transition-all duration-300" data-translate-key="callConnecting">Menghubungkan...</p>
    </div>

    <!-- Area Transkrip (di tengah) -->
    <div id="callTranscriptPreview" class="w-full max-w-sm mx-auto my-4 p-3 rounded-lg text-sm text-white text-center" style="display: none; background-color: rgba(0,0,0,0.25); backdrop-filter: blur(5px);">
        <!-- Transkrip akan muncul di sini -->
    </div>

    <!-- Wrapper untuk tombol di bagian bawah (posisi disesuaikan) -->
    <div class="w-full flex items-center justify-center space-x-8">
        <!-- Tombol Aksi Utama (Mikrofon/Kirim) -->
        <button id="callActionBtn" class="w-16 h-16 call-action-button bg-blue-600 rounded-full flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform active:scale-95" data-translate-title="callStartSpeaking" style="display: none;">
            <!-- Ikon akan diubah oleh JavaScript -->
        </button>

        <!-- Tombol Akhiri Panggilan -->
        <button id="endCallBtn" onclick="endCall()" class="w-16 h-16 call-action-button bg-red-600 rounded-full flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform" data-translate-title="callEnd">
            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l-8 8m0-8l8 8"></path></svg>
        </button>
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI MODAL PANGGILAN SUARA ▲▲▲ -->

<!-- ▼▼▼ [BARU] MODAL UNTUK MEMBUAT STORY BARU ▼▼▼ -->
<div id="createStoryModal" class="fixed inset-0 modal-overlay z-[110] flex items-center justify-center hidden p-4"> <!-- [FIX] z-index dinaikkan -->
    <!-- [DIUBAH] Konten modal dirombak total -->
    <div class="modal-content max-w-sm w-full">
        <!-- Tombol Tutup di Pojok Kanan Atas -->
        <button onclick="hideCreateStoryModal()" class="absolute top-3 right-3 w-8 h-8 rounded-full flex items-center justify-center bg-black/20 hover:bg-black/40 transition-colors text-white z-10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>

        <!-- Area Konten Utama -->
        <textarea id="storyContentInput" data-translate-placeholder="storyPlaceholder" maxlength="150" placeholder="Apa yang kamu pikirkan?"></textarea>

        <!-- Footer dengan Counter dan Tombol Posting -->
        <div class="flex-shrink-0 mt-auto">
            <p id="storyCharCounter" class="text-xs text-right text-white/80 mb-3">0 / 150</p>
            <button id="postStoryBtn" onclick="postStory()" class="w-full bg-white text-blue-600 font-bold py-3 rounded-full text-base transition-transform transform hover:scale-105 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed">
                <span data-translate-key="buttonPost">Posting</span>
            </button>
        </div>
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI MODAL STORY ▲▲▲ -->

<!-- ▼▼▼ [BARU] MODAL UNTUK MELIHAT STORY (STORY VIEWER) ▼▼▼ -->
<div id="storyViewerModal" class="fixed inset-0 z-[110] flex flex-col justify-between p-4 text-white hidden transition-opacity duration-300"> <!-- [FIX] Menghapus duplikasi dan memastikan z-index benar -->
    <!-- Header: Progress Bar, Info Pengguna, Tombol Tutup -->
    <div class="story-viewer-header">
        <div class="story-progress-container mb-3">
            <!-- Progress bar akan diisi oleh JS -->
        </div>
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <img id="storyViewerAvatar" src="" alt="User Avatar" class="w-10 h-10 rounded-full border-2 border-white/80">
                <div>
                    <p id="storyViewerUsername" class="font-semibold"></p>
                    <p id="storyViewerTimestamp" class="text-xs opacity-80"></p>
                </div>
            </div>
            <button onclick="hideStoryViewer()" class="w-8 h-8 rounded-full flex items-center justify-center bg-black/30 hover:bg-black/50 transition-colors"> <!-- [FIX] Menghapus duplikasi -->
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
    </div>

    <!-- Konten Utama: Teks Story -->
    <div id="storyViewerContent" class="flex-grow flex items-center justify-center text-center px-4"></div>

    <!-- [BARU] Area Navigasi Klik (Kiri & Kanan) -->
    <div class="absolute inset-0 flex justify-between items-center">
        <div class="w-1/4 h-full" onclick="previousStory()"></div>
        <!-- [DIUBAH] Area tengah untuk jeda/lanjut -->
        <div class="w-1/2 h-full" onclick="toggleStoryPause()"></div>
        <div class="w-1/4 h-full" onclick="nextStory()"></div>
    </div>
    <!-- Footer: Tombol Hapus (hanya muncul untuk pemilik story) -->
    <!-- [DIUBAH] Footer sekarang berisi input komentar dan tombol "Dilihat oleh" -->
    <div class="story-viewer-footer justify-between items-center w-full pointer-events-auto gap-3">
        <!-- [DIUBAH] Input Komentar (untuk penonton) -->
        <div id="storyCommentView" class="relative flex-grow hidden">
            <input id="storyCommentInput" type="text" placeholder="Kirim komentar..." class="w-full bg-black/20 border border-white/30 rounded-full py-2.5 pl-4 pr-12 text-white placeholder-white/70 focus:outline-none focus:ring-2 focus:ring-white/50">
            <button onclick="sendStoryComment()" class="absolute right-1 top-1/2 -translate-y-1/2 bg-white/90 text-black rounded-full w-8 h-8 flex items-center justify-center hover:bg-white transition-transform transform active:scale-90">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </div>

        <!-- [BARU] Input Komentar Palsu (untuk pengguna yang belum login) -->
        <div id="storyLoginPromptView" onclick="signInWithGoogle()" class="relative flex-grow hidden cursor-pointer">
            <div class="w-full bg-black/20 border border-white/30 rounded-full py-2.5 px-4 text-white/70">
                Login untuk mengirim komentar...
            </div>
        </div>

        <!-- [DIUBAH] Tombol Aksi (untuk pemilik story) -->
        <div id="storyOwnerView" class="flex-grow hidden justify-between items-center">
             <button onclick="showStoryViews()" class="flex items-center gap-2 text-white text-sm font-semibold px-4 py-2 rounded-full bg-black/20 hover:bg-black/40 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                <span id="storyViewCount">Dilihat oleh 0</span>
            </button>
             <button id="deleteStoryBtn" onclick="confirmDeleteStory()" class="flex items-center gap-2 px-4 py-2 rounded-full text-white text-sm font-semibold bg-black/20 hover:bg-black/40 transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                <span>Hapus</span>
            </button>
        </div>

        <!-- [DIHAPUS] Tombol lihat penonton untuk penonton biasa, karena sudah digabung dengan daftar komentar -->
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI MODAL STORY VIEWER ▲▲▲ -->

<!-- ▼▼▼ [BARU] MODAL UNTUK MELIHAT PENONTON STORY ▼▼▼ -->
<div id="storyViewsModal" class="fixed inset-0 modal-overlay z-[120] flex items-center justify-center hidden p-4">
    <div class="modal-content p-0 max-w-sm w-full max-h-[60vh] flex flex-col">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
            <h3 class="font-bold text-center" style="color: var(--text-primary);">Penonton & Komentar</h3>
        </div>
        <div id="storyViewsList" class="flex-grow overflow-y-auto p-4 space-y-3">
            <!-- Daftar penonton akan muncul di sini -->
        </div>
        <div class="p-2 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
             <button onclick="hideStoryViewsModal()" class="w-full settings-btn-action bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm py-2">
                Tutup
            </button>
        </div>
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI MODAL PENONTON STORY ▲▲▲ -->


<!-- [DIPINDAHKAN & DIPERBAIKI] Area untuk menampilkan komentar dipindahkan ke luar modal -->
<div id="storyCommentsContainer" class="fixed bottom-20 left-4 right-4 max-h-[30vh] overflow-y-auto space-y-2 pointer-events-auto z-[111] hidden">
    <!-- Komentar akan di-render di sini oleh JavaScript -->
</div>


<!-- [BARU] Gaya untuk area komentar story -->
<style>
    .story-comment-item {
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
    }
</style>

<!-- ▼▼▼ [BARU] CONTAINER UNTUK NOTIFIKASI ERROR ▼▼▼ -->
<div id="errorToastContainer"></div>

<!-- ▼▼▼ [BARU] MODAL UNTUK PENCARIAN GOOGLE ▼▼▼ -->
<div id="searchModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
    <div class="modal-content">
        <div id="searchModalHeader">
            <span id="searchModalTitle" class="text-sm font-semibold" style="color: var(--text-primary);" data-translate-key="searchResultTitle">Hasil Pencarian</span>
            <div class="flex items-center space-x-2">
                <button onclick="openSearchInNewTab()" class="w-8 h-8 rounded-full flex items-center justify-center modal-close-btn" aria-label="Buka di Tab Baru" data-translate-title="searchOpenInNewTabTitle">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                </button>
                <button onclick="hideSearchModal()" class="w-8 h-8 rounded-full flex items-center justify-center modal-close-btn" aria-label="Tutup Pencarian" data-translate-title="searchCloseTitle">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </div>
        <iframe id="searchFrame" src="about:blank" sandbox="allow-forms allow-scripts allow-popups allow-popups-to-escape-sandbox"></iframe>
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI MODAL PENCARIAN GOOGLE ▲▲▲ -->

<!-- Semua Modal Lainnya (tidak diubah, hanya ditambah title) -->
<div id="imagePreviewModal" class="fixed inset-0 modal-overlay z-[110] flex items-center justify-center hidden p-4"> <!-- [FIX] z-index dinaikkan -->
    <div class="modal-content p-6 max-w-sm w-full" id="imagePreviewContent">
        <div class="text-center relative">
            <button onclick="hideImagePreview()" class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn" aria-label="Tutup Pratinjau Gambar" data-translate-title="imagePreviewCloseTitle">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div class="mb-4">
                <img id="previewImage" src="" alt="Preview" class="w-full h-auto rounded-lg max-h-48 object-cover mx-auto shadow-md">
                <p id="previewFileName" class="text-sm text-gray-600 mt-2"></p>
            </div>
            <div class="mb-4">
                <label class="block text-left text-sm font-medium text-gray-700 mb-2" data-translate-key="imagePreviewLabel">Tanya sesuatu tentang gambar ini:</label>
                <textarea id="imageQuestionInput" data-translate-placeholder="imagePreviewPlaceholder" class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm settings-input" rows="3"></textarea>
            </div>
            <div class="flex space-x-3">
                <button onclick="hideImagePreview()" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn" data-translate-key="buttonCancel">Batal</button>
                <button onclick="sendImageWithQuestion()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn" data-translate-key="buttonSend">Kirim</button>
            </div>
        </div>
    </div>
</div>
<div id="profileModal" class="fixed inset-0 modal-overlay z-[110] flex items-center justify-center hidden p-4"> <!-- [FIX] z-index dinaikkan -->
    <!-- [DIUBAH] Tampilan modal profil dirombak total untuk estetika yang lebih baik -->
    <div class="modal-content p-8 max-w-sm w-full" id="profileModalContent">
        <div class="text-center relative">
            <button onclick="hideProfileModal()" class="absolute -top-3 -right-3 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn" aria-label="Tutup Profil" data-translate-title="profileCloseTitle">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            
            <!-- Avatar -->
            <div class="w-24 h-24 mx-auto mb-4 overflow-hidden profile-avatar-border shadow-lg">
                <img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="StoryBali" class="w-full h-full object-cover">
            </div>
            
            <!-- Name & Title -->
            <h2 class="text-2xl font-bold mb-1" style="color: var(--text-primary);" data-translate-key="aiName">Wayan AI</h2>
            <p class="font-medium mb-4 text-sm" style="color: var(--text-secondary);" data-translate-key="profileTitle">AI Assistant Dari Storybali</p>
            
            <!-- Description -->
            <div class="text-sm leading-relaxed mb-6 text-center" style="color: var(--text-secondary);">
                <p data-translate-key="profileDesc1">Gue adalah AI assistant yang dibuat khusus untuk membantu kamu dengan gaya bahasa yang santai dan friendly.</p>
                <p class="mt-2" data-translate-key="profileDesc3">Kepoin Wayan yuk di Instagram atau chat WA pribadi Wayan!</p>
            </div>

            <!-- Action Buttons -->
            <div class="space-y-3">
                <!-- Instagram Button -->
                <a href="https://www.instagram.com/sudiarsana_wayan?igsh=MXE4NHFvZzAyOXd6NQ%3D%3D&utm_source=qr" target="_blank" 
                   class="flex items-center justify-center w-full px-4 py-3 rounded-xl font-semibold text-sm text-white transition-all duration-200 ease-in-out transform hover:scale-105" 
                   style="background: linear-gradient(135deg, #833ab4, #fd1d1d, #fcb045);"
                   data-translate-key="profileInstagram">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M7.8,2H16.2C19.4,2 22,4.6 22,7.8V16.2C22,19.4 19.4,22 16.2,22H7.8C4.6,22 2,19.4 2,16.2V7.8C2,4.6 4.6,2 7.8,2M7.6,4A3.6,3.6 0 0,0 4,7.6V16.4C4,18.39 5.61,20 7.6,20H16.4C18.39,20 20,18.39 20,16.4V7.6C20,5.61 18.39,4 16.4,4H7.6M17.25,5.5A1.25,1.25 0 0,1 18.5,6.75A1.25,1.25 0 0,1 17.25,8A1.25,1.25 0 0,1 16,6.75A1.25,1.25 0 0,1 17.25,5.5M12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9Z" /></svg>
                    Instagram
                </a>
                <!-- WhatsApp Button -->
                <a href="https://wa.me/message/RNPBCG25N5V2A1" target="_blank" 
                   class="flex items-center justify-center w-full px-4 py-3 rounded-xl font-semibold text-sm text-white bg-[#25D366] hover:bg-[#128C7E] transition-all duration-200 ease-in-out transform hover:scale-105"
                   data-translate-key="profileWhatsapp">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.05 22L7.31 20.62C8.75 21.41 10.36 21.85 12.04 21.85C17.5 21.85 21.95 17.4 21.95 11.94C21.95 6.48 17.5 2 12.04 2M12.04 3.67C16.56 3.67 20.28 7.38 20.28 11.93C20.28 16.48 16.56 20.19 12.04 20.19C10.46 20.19 8.96 19.78 7.65 19.05L7.28 18.83L4.93 19.58L5.7 17.26L5.47 16.89C4.68 15.53 4.26 13.96 4.26 12.3C4.26 7.75 7.97 4.04 12.42 4.04H12.04M16.54 14.8C16.34 15.25 15.53 15.68 15.15 15.78C14.77 15.87 14.22 15.96 12.63 15.33C10.73 14.58 9.25 12.8 9.06 12.55C8.86 12.3 7.96 11.04 7.96 10.14C7.96 9.24 8.55 8.68 8.75 8.48C8.94 8.29 9.24 8.24 9.41 8.24C9.58 8.24 9.71 8.24 9.84 8.24C9.98 8.24 10.13 8.26 10.31 8.64C10.51 9 11.03 10.19 11.13 10.34C11.23 10.49 11.28 10.69 11.18 10.89C11.08 11.09 11.03 11.19 10.88 11.36C10.73 11.54 10.58 11.66 10.46 11.79C10.33 11.91 10.19 12.06 10.34 12.31C10.49 12.56 11.01 13.34 11.71 13.96C12.54 14.73 13.26 15.01 13.51 15.13C13.76 15.26 13.91 15.23 14.06 15.08C14.24 14.91 14.51 14.51 14.78 14.16C15 13.86 15.28 13.78 15.58 13.88C15.88 13.98 16.91 14.53 17.11 14.73C17.31 14.93 17.31 15.03 17.21 15.13C17.11 15.23 16.74 14.35 16.54 14.8Z" /></svg>
                    WhatsApp
                </a>
            </div>
        </div>
    </div>
</div>
<!-- [DIUBAH] Menghapus padding (p-4) dan mengubah ukuran modal pengaturan menjadi layar penuh -->
<div id="settingsModal" class="fixed inset-0 modal-overlay z-[110] flex items-center justify-center hidden"> <!-- [FIX] z-index dinaikkan -->
    <div class="modal-content w-full h-full overflow-hidden flex flex-col" id="settingsModalContent">
        <!-- [DIUBAH] Header Modal Pengaturan dengan Tombol Kembali Dinamis -->
        <div class="p-4 flex items-center justify-between flex-shrink-0 bg-white border-b border-gray-200">
            <div class="w-10 h-10 flex items-center justify-start">
                <button id="settingsBackBtn" onclick="navigateToSettingsPage('main')" class="w-8 h-8 rounded-full flex items-center justify-center modal-close-btn hidden text-blue-500">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
            </div>
            <h3 id="settingsModalTitle" class="text-lg font-bold text-gray-800 text-center flex-grow" data-translate-key="settingsHeader">Pengaturan</h3>
            <div class="w-10 h-10 flex items-center justify-end">
                <button onclick="toggleSettings()" class="w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn" aria-label="Tutup Pengaturan" data-translate-title="settingsCloseTitle">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>
        </div>
        
        <!-- [PENYEMPURNAAN] Kontainer scroll utama dengan padding yang lebih rapi -->
        <div class="flex-1 overflow-y-auto p-4">
            <!-- [DIUBAH] Halaman Utama Pengaturan -->
            <div id="settings-page-main" class="settings-page active">
                <!-- Seksi Umum -->
                <h3 class="settings-section-header" data-translate-key="tabGeneral">Umum</h3>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-purple-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingAIName">Nama AI</label>
                        </div>
                        <input type="text" id="aiNameInput" value="Wayan" class="settings-input text-right" readonly style="cursor: not-allowed;">
                    </div>
                    <!-- [DIUBAH] Item menjadi tombol navigasi -->
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('language')">
                        <div class="flex items-center space-x-4">
                             <div class="settings-icon-bg bg-sky-500 flex items-center justify-center">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h7.5"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingLanguage">Bahasa</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="currentLanguage" class="text-sm text-gray-500 dark:text-gray-400"></span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('personality')">
                        <div class="w-full flex items-center space-x-4">
                            <div class="settings-icon-bg bg-emerald-500 flex items-center justify-center">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingPersonality">Gaya Bahasa</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="currentPersonality" class="text-sm text-gray-500 dark:text-gray-400">Santai</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>

                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('aiRole')">
                         <div class="w-full flex items-center space-x-4">
                            <div class="settings-icon-bg bg-indigo-500 flex items-center justify-center">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V21H9z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingAIRole">Mode Peran AI</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="currentAiRole" class="text-sm text-gray-500 dark:text-gray-400">Umum</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>
                </div>

                <!-- Seksi Tampilan -->
                <h3 class="settings-section-header" data-translate-key="tabAppearance">Tampilan</h3>
                <div class="settings-card">
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('appearance')">
                        <div class="flex items-center space-x-4" style="pointer-events: none;">
                            <div class="settings-icon-bg bg-sky-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingFontSize">Ukuran Font</label>
                        </div>
                        <select id="fontSizeSelect" class="settings-select text-right w-auto">
                        </select>
                    </div>
                    <div class="settings-item"> 
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-amber-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingAnimations">Efek Animasi</label>
                        </div>
                        <input type="checkbox" id="animationToggle" class="toggle-new" checked>
                    </div>
                    <div class="settings-item">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-gray-700">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingDarkMode">Mode Gelap</label>
                        </div>
                        <input type="checkbox" id="darkModeToggle" class="toggle-new" onchange="handleDarkModeToggle()">
                    </div>
                    <!-- [BARU] Item Gambar Latar dipindahkan ke dalam kartu Tampilan -->
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('background')">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-rose-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
                            </div>
                            <label for="backgroundFileInput" class="text-sm font-medium text-gray-700" data-translate-key="settingBackground">Gambar Latar</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="currentBackground" class="text-sm text-gray-500 dark:text-gray-400">Default</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>
                </div>
                <!-- [BARU] Judul seksi untuk Suara & Notifikasi -->
                <h3 class="settings-section-header" data-translate-key="tabSound">Suara & Notifikasi</h3>
                <div class="settings-card"> <!-- Pengaturan suara dikelompokkan di sini -->
                    <div class="settings-item">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-teal-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingSound">Suara Notifikasi</label>
                        </div>
                        <input type="checkbox" id="soundToggle" class="toggle-new" checked>
                    </div>
                    <div class="settings-item">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-violet-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingVoiceReader">Pembaca Jawaban</label>
                        </div>
                        <input type="checkbox" id="readAiResponseToggle" class="toggle-new" checked>
                    </div>

                    <!-- ▼▼▼ [PERBAIKAN] Pengaturan Sumber Audio Baru ▼▼▼ -->
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('audio')">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-cyan-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingAudioSource">Sumber Audio</label>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="currentAudioSource" class="text-sm text-gray-500 dark:text-gray-400">Bawaan Browser</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-orange-400">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingVoiceType">Jenis Suara (Bawaan)</label>
                        </div>
                         <select id="voiceSelect" class="settings-select text-right">
                            <option value="">Memuat suara...</option>
                         </select>
                    </div>
                    
                    <div class="settings-item flex-col items-start" id="elevenLabsVoiceSettings">
                    </div>
                </div>

                <!-- Seksi Lanjutan -->
                <h3 class="settings-section-header" data-translate-key="tabAdvanced">Lanjutan</h3>
                <div class="settings-card">
                    <!-- Simpan Riwayat -->
                    <div class="settings-item">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-blue-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingSaveHistory">Simpan Riwayat</label>
                        </div>
                        <input type="checkbox" id="saveHistoryToggle" class="toggle-new" checked>
                    </div>
                    <!-- Beri Masukan -->
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('feedback')">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-green-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            </div>
                            <h4 class="text-sm font-medium text-gray-700" data-translate-key="feedbackTitle">Beri Masukan</h4>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                    <!-- API Keys -->
                    <div class="settings-item nav-item" onclick="navigateToSettingsPage('apiKeys')">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-slate-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.623 5.912M15.364 15.364A5 5 0 1119 12c0 .426-.055.84-.16 1.232m-5.84-3.072a3 3 0 00-4.243 4.243M8 12a4 4 0 118 0 4 4 0 01-8 0z"></path></svg>
                            </div>
                            <h4 class="text-sm font-medium text-gray-700" data-translate-key="apiKeysTitle">API Keys</h4>
                        </div>
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </div>
                    <!-- Tombol Aksi Riwayat -->
                    <div class="p-2 space-y-2 mt-2 border-t border-gray-200 dark:border-gray-700">
                         <button onclick="exportChatHistory()" class="settings-btn-action bg-green-100 text-green-700 hover:bg-green-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span data-translate-key="exportHistory">Export Riwayat Chat Ini</span>
                         </button>
                         <button onclick="clearAllChatHistory()" class="settings-btn-action bg-red-100 text-red-700 hover:bg-red-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            <span data-translate-key="clearAllHistory">Hapus SEMUA Percakapan</span>
                         </button>
                    </div>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan Bahasa -->
            <div id="settings-page-language" class="settings-page">
                <div class="settings-card">
                    <!-- [DIUBAH] Setiap bahasa memiliki toggle switch sendiri -->
                    <div class="settings-item nav-item" onclick="selectChoice('language', 'id', this.querySelector('input'))">
                        <div class="flex items-center space-x-4">
                            <img src="https://flagcdn.com/w40/id.png" alt="Indonesia Flag" class="w-6 h-auto rounded-sm">
                            <span class="text-sm font-medium text-gray-700" data-translate-key="langIndonesian">Indonesia</span>
                        </div>
                        <input type="radio" name="languageToggle" id="language-id" class="toggle-radio" value="id" onchange="selectChoice('language', this.value, this)" checked>
                    </div>
                    <div class="settings-item nav-item" onclick="selectChoice('language', 'en', this.querySelector('input'))">
                        <div class="flex items-center space-x-4">
                            <img src="https://flagcdn.com/w40/gb.png" alt="UK Flag" class="w-6 h-auto rounded-sm">
                            <span class="text-sm font-medium text-gray-700" data-translate-key="langEnglish">English</span>
                        </div>
                        <input type="radio" name="languageToggle" id="language-en" class="toggle-radio" value="en" onchange="selectChoice('language', this.value, this)" >
                    </div>
                    <div class="settings-item nav-item" onclick="selectChoice('language', 'ja', this.querySelector('input'))">
                        <div class="flex items-center space-x-4">
                            <img src="https://flagcdn.com/w40/jp.png" alt="Japan Flag" class="w-6 h-auto rounded-sm">
                            <span class="text-sm font-medium text-gray-700" data-translate-key="langJapanese">日本語</span>
                        </div>
                        <input type="radio" name="languageToggle" id="language-ja" class="toggle-radio" value="ja" onchange="selectChoice('language', this.value, this)" >
                    </div>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan Gaya Bahasa -->
            <div id="settings-page-personality" class="settings-page">
                <div class="settings-card">
                    <!-- [DIUBAH] Setiap gaya bahasa memiliki toggle switch sendiri -->
                    <div class="settings-item" onclick="selectChoice('personality', 'santai', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-blue-500"><svg class="text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.293 5.707a1 1 0 01-1.414-1.414 3 3 0 00-4.242 0 1 1 0 01-1.415 1.414 5 5 0 017.072 0z" clip-rule="evenodd"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="personalityCasual">Santai</span>
                        </div>
                        <input type="radio" name="personalityToggle" id="personality-santai" class="toggle-radio" value="santai" onchange="selectChoice('personality', this.value, this)" checked>
                    </div>
                    <div class="settings-item" onclick="selectChoice('personality', 'profesional', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-gray-700"><svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 17.25v-.228a4.5 4.5 0 00-.12-1.03l-2.268-9.64a3.375 3.375 0 00-3.285-2.802H9.12a3.375 3.375 0 00-3.285 2.802l-2.268 9.64a4.5 4.5 0 00-.12 1.03v.228m19.5 0a3 3 0 01-3 3H5.25a3 3 0 01-3-3m19.5 0a3 3 0 00-3-3H5.25a3 3 0 00-3 3m16.5 0h.008v.008h-.008v-.008zm-3 0h.008v.008h-.008v-.008z"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="personalityProfessional">Profesional</span>
                        </div>
                        <input type="radio" name="personalityToggle" id="personality-profesional" class="toggle-radio" value="profesional" onchange="selectChoice('personality', this.value, this)" >
                    </div>
                    <div class="settings-item" onclick="selectChoice('personality', 'lucu', this.querySelector('input'))" style="border-bottom: none;">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-amber-500"><svg class="text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-7.536 4.47a.75.75 0 011.072.018 3.5 3.5 0 004.928 0 .75.75 0 011.072-.018 5 5 0 01-7.072 0z" clip-rule="evenodd"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="personalityHumorous">Humoris</span>
                        </div>
                        <input type="radio" name="personalityToggle" id="personality-lucu" class="toggle-radio" value="lucu" onchange="selectChoice('personality', this.value, this)" >
                    </div>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan Mode Peran AI -->
            <div id="settings-page-aiRole" class="settings-page">
                <div class="settings-card">
                    <!-- [DIUBAH] Setiap peran memiliki toggle switch sendiri -->
                    <div class="settings-item" onclick="selectChoice('aiRole', 'umum', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-gray-500"><svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" /></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleGeneral">Umum</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-umum" class="toggle-radio" value="umum" onchange="selectChoice('aiRole', this.value, this)" checked>
                    </div>
                    <div class="settings-item" onclick="selectChoice('aiRole', 'guru_jepang', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-red-500"><span class="text-white font-bold text-sm">JP</span></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleJapaneseTeacher">Guru B. Jepang</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-guru_jepang" class="toggle-radio" value="guru_jepang" onchange="selectChoice('aiRole', this.value, this)" >
                    </div>
                    <div class="settings-item" onclick="selectChoice('aiRole', 'guru_matematika', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-cyan-500"><svg class="text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm1 2h1.5v1.5a.5.5 0 01-1 0V4H5a.5.5 0 01-.5-.5V4zm1.5 3.5v-1.5h1.5v1.5H5.5zm0 1.5h1.5v1.5H5.5V9zm1.5-1.5v-1.5h1.5v1.5H7zm0 1.5h1.5v1.5H7V9zm1.5-1.5v-1.5h1.5v1.5H8.5zm0 1.5h1.5v1.5H8.5V9zm1.5-1.5v-1.5h1.5v1.5H10zm0 1.5h1.5v1.5H10V9zm1.5-1.5v-1.5h1.5v1.5H11.5zm0 1.5h1.5v1.5H11.5V9zm1.5-1.5v-1.5h1.5v1.5H13zm0 1.5h1.5v1.5H13V9zm1.5-1.5v-1.5H15a.5.5 0 01.5.5V7h-1.5zM4.5 6H4V5.5a.5.5 0 01.5-.5H5v1.5H4.5zM4 8.5V10h1.5V8.5H4zm1.5 3H4v-1.5h1.5V11.5zm0 1.5v1.5H4V13h1.5zm1.5 3H5.5v-1.5h1.5V16zm1.5-1.5v-1.5h-1.5v1.5H8.5zm0-1.5H7v-1.5h1.5V13zm1.5 1.5v1.5h-1.5v-1.5H10zm0-1.5H8.5v-1.5H10V13zm1.5 1.5v1.5h-1.5v-1.5H11.5zm0-1.5H10v-1.5h1.5V13zm1.5 1.5v1.5h-1.5v-1.5H13zm0-1.5H11.5v-1.5H13V13zm1.5 3h-1.5V16H15a.5.5 0 01.5.5V16h-1.5zM16 11.5V10h-1.5v1.5H16zm-1.5-3H16V7h-1.5v1.5z"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleMathTeacher">Guru Matematika</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-guru_matematika" class="toggle-radio" value="guru_matematika" onchange="selectChoice('aiRole', this.value, this)" >
                    </div>
                    <div class="settings-item" onclick="selectChoice('aiRole', 'dokter', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-rose-500"><svg class="text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10 3.5a5.5 5.5 0 00-5.5 5.5c0 1.258.423 2.434 1.145 3.416l-1.03 1.03a.5.5 0 000 .707l2.121 2.122a.5.5 0 00.707 0l1.03-1.03A5.483 5.483 0 0010 14.5a5.5 5.5 0 005.5-5.5V3.5h-1V9a4.5 4.5 0 01-4.5 4.5A4.5 4.5 0 015.5 9V3.5H10z"></path><path d="M12.5 5.5a.5.5 0 00-1 0V7h-1V5.5a.5.5 0 00-1 0V7h-1V5.5a.5.5 0 00-1 0V9h4.5a.5.5 0 00.5-.5V5.5z"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleDoctor">Dokter</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-dokter" class="toggle-radio" value="dokter" onchange="selectChoice('aiRole', this.value, this)" >
                    </div>
                    <div class="settings-item" onclick="selectChoice('aiRole', 'programmer', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-indigo-500"><svg class="text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6.672 1.903a1 1 0 011.656 0l4.472 3.253a1 1 0 01.328 1.13l-1.6 4.8a1 1 0 01-1.13 1.13l-4.8-1.6a1 1 0 01-1.13-.328L.747 6.533a1 1 0 011.13-1.656l4.795-1.974zM13 12a1 1 0 100 2h5a1 1 0 100-2h-5z" clip-rule="evenodd"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleProgrammer">Programmer</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-programmer" class="toggle-radio" value="programmer" onchange="selectChoice('aiRole', this.value, this)" >
                    </div>
                    <div class="settings-item" onclick="selectChoice('aiRole', 'penerjemah', this.querySelector('input'))" style="border-bottom: 1px solid var(--border-color);">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-teal-500"><svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 21l5.25-11.25L21 21m-9-3h7.5M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h7.5"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleTranslator">Penerjemah</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-penerjemah" class="toggle-radio" value="penerjemah" onchange="selectChoice('aiRole', this.value, this)" >
                    </div>
                    <div class="settings-item" onclick="selectChoice('aiRole', 'kustom', this.querySelector('input'))" style="border-bottom: none;">
                        <div class="flex items-center space-x-4">
                            <div class="settings-icon-bg bg-slate-400"><svg class="text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path></svg></div>
                            <span class="text-sm font-medium text-gray-700" data-translate-key="roleCustom">Kustom...</span>
                        </div>
                        <input type="radio" name="aiRoleToggle" id="aiRole-kustom" class="toggle-radio" value="kustom" onchange="selectChoice('aiRole', this.value, this)" >
                    </div>
                    <div id="customRoleContainer" class="hidden p-2 mt-2">
                        <label class="block text-xs text-gray-600 mb-1" data-translate-key="customRoleLabel">Definisikan peran kustom AI:</label>
                        <textarea id="customRoleInput" data-translate-placeholder="customRolePlaceholder" class="w-full settings-input text-sm" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan Latar Belakang -->
            <div id="settings-page-background" class="settings-page">
                <div class="settings-card">
                    <div class="w-full pt-2 space-y-2">
                        <input type="file" id="backgroundFileInput" onchange="handleBackgroundUpload(event)" class="hidden" accept="image/*">
                        <label for="backgroundFileInput" class="settings-btn-action bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm py-2 cursor-pointer">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span data-translate-key="uploadBackground">Unggah Latar Belakang Chat</span>
                        </label>
                        <p id="backgroundFileName" class="text-xs text-gray-500 pl-1 truncate text-center"></p>
                        <div id="backgroundPreviewWrapper" class="mt-3 p-2 border-t border-dashed hidden" style="border-color: var(--border-color);">
                            <div class="flex justify-center items-end gap-4 w-full">
                                <div class="flex flex-col items-center">
                                    <div class="preview-pane mobile-view">
                                        <div class="preview-background"></div><div class="preview-header"></div>
                                        <div class="preview-bubble ai"><div class="preview-avatar"></div><div class="preview-text-content"><div class="preview-name">Wayan AI</div><p>Halo! Gue Wayan nih, AI assistant yang siap bantu...</p></div></div>
                                        <div class="preview-bubble user"><div class="preview-text-content"><p>Apa kabar?</p></div></div>
                                        <div class="preview-footer"></div>
                                    </div>
                                    <p class="text-xs mt-2" style="color: var(--text-secondary);" data-translate-key="previewMobile">Tampilan Handphone</p>
                                </div>
                                <div class="flex flex-col items-center flex-grow min-w-0">
                                    <div class="preview-pane desktop-view">
                                        <div class="preview-background"></div><div class="preview-header"></div>
                                        <div class="preview-bubble ai"><div class="preview-avatar"></div><div class="preview-text-content"><div class="preview-name">Wayan AI</div><p>Halo! Gue Wayan nih, AI assistant yang siap bantu...</p></div></div>
                                        <div class="preview-bubble user"><div class="preview-text-content"><p>Apa kabar?</p></div></div>
                                        <div class="preview-footer"></div>
                                    </div>
                                    <p class="text-xs mt-2" style="color: var(--text-secondary);" data-translate-key="previewDesktop">Tampilan Desktop</p>
                                </div>
                            </div>
                            <div class="w-full max-w-xs mx-auto space-y-3 mt-4">
                                <div>
                                    <label class="text-xs font-medium" style="color: var(--text-secondary);" data-translate-key="previewEffectLabel">Efek Blur</label>
                                    <div class="grid grid-cols-3 gap-2 mt-1" id="blurOptions">
                                        <button id="blurBtnNone" onclick="setPreviewBlur('none')" class="choice-btn" data-translate-key="previewEffectNone">Mati</button>
                                        <button id="blurBtnLight" onclick="setPreviewBlur('light')" class="choice-btn active" data-translate-key="previewEffectLight">Ringan</button>
                                        <button id="blurBtnStrong" onclick="setPreviewBlur('strong')" class="choice-btn" data-translate-key="previewEffectStrong">Kuat</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="text-xs font-medium" style="color: var(--text-secondary);" data-translate-key="previewSizeLabel">Ukuran Gambar</label>
                                    <div class="grid grid-cols-2 gap-2 mt-1">
                                        <button id="sizeBtnCover" onclick="setPreviewSize('cover')" class="choice-btn" data-translate-key="previewSizeCover">Penuh</button>
                                        <button id="sizeBtnContain" onclick="setPreviewSize('contain')" class="choice-btn active" data-translate-key="previewSizeContain">Utuh</button>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs text-center mt-4" style="color: var(--text-secondary);" data-translate-key="previewHeader">Pratinjau Latar</p>
                        </div>
                        <button onclick="removeCustomBackground()" class="settings-btn-action bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm py-2 mt-2">
                            <span data-translate-key="removeBackground">Hapus Latar</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan Audio -->
            <div id="settings-page-audio" class="settings-page">
                <div class="settings-card">
                    <div class="settings-item flex-col">
                        <div class="w-full flex items-center space-x-4">
                            <div class="settings-icon-bg bg-cyan-500">
                                <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            </div>
                            <label class="text-sm font-medium text-gray-700" data-translate-key="settingAudioSource">Sumber Audio</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2 w-full pt-2">
                            <button id="audioSource-browser" onclick="selectChoice('audioSource', 'browser', this)" class="choice-btn active" data-translate-key="audioSourceBrowser">Bawaan Browser</button>
                            <button id="audioSource-elevenlabs" onclick="selectChoice('audioSource', 'elevenlabs', this)" class="choice-btn" data-translate-key="audioSourceElevenLabs">ElevenLabs</button>
                        </div>
                    </div>
                </div>
                <div class="settings-card">
                    <div class="settings-item flex-col items-start" id="elevenLabsVoiceSettings">
                        <div class="flex items-center space-x-4 w-full justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="settings-icon-bg bg-rose-500">
                                    <svg class="text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                                </div>
                                <label class="text-sm font-medium text-gray-700" data-translate-key="settingElevenLabsVoice">Suara ElevenLabs</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="elevenLabsVoiceSelect" class="settings-select text-right w-auto max-w-[120px]">
                                    <option value="" data-translate-key="elevenLabsNeedKey">Masukkan API Key dulu</option>
                                </select>
                                <button id="previewElevenLabsVoiceBtn" data-translate-title="elevenLabsPreviewTitle" class="w-8 h-8 flex items-center justify-center rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 px-1" data-translate-key="elevenLabsHint">Pilih "ElevenLabs" sebagai Sumber Audio dan simpan API Key di tab "Lanjutan" untuk menggunakan fitur ini.</p>
                    </div>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan Masukan -->
            <div id="settings-page-feedback" class="settings-page">
                <div class="settings-card">
                    <p class="text-xs text-gray-500 mb-3" data-translate-key="feedbackSubtitle">Punya ide atau saran? Beri tahu kami!</p>
                    <textarea id="settingsFeedbackInput" data-translate-placeholder="feedbackPlaceholder" class="w-full settings-input text-sm mb-3" rows="5"></textarea>
                    <button id="sendSettingsFeedbackBtn" onclick="sendGeneralFeedback()" class="w-full settings-btn-action bg-green-600 text-white hover:bg-green-700">
                        <span data-translate-key="feedbackSendButton">Kirim Masukan</span>
                    </button>
                </div>
            </div>

            <!-- [BARU] Halaman Pengaturan API Keys -->
            <div id="settings-page-apiKeys" class="settings-page">
                <div class="settings-card">
                    <div class="space-y-2 text-sm">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 1 (Utama)</label>
                            <input type="password" id="apiKey1" placeholder="Masukkan API Key" class="settings-input w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 2 (Cadangan)</label>
                            <input type="password" id="apiKey2" placeholder="Opsional" class="settings-input w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 3 (Cadangan)</label>
                            <input type="password" id="apiKey3" placeholder="Opsional" class="settings-input w-full">
                        </div>
                         <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 4 (Cadangan)</label>
                            <input type="password" id="apiKey4" placeholder="Opsional" class="settings-input w-full">
                        </div>
                         <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 5 (Cadangan)</label>
                            <input type="password" id="apiKey5" placeholder="Opsional" class="settings-input w-full">
                        </div>
                         <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 6 (Cadangan)</label>
                            <input type="password" id="apiKey6" placeholder="Opsional" class="settings-input w-full">
                        </div>
                        <div class="pt-2 border-t border-gray-200 dark:border-gray-700 mt-4">
                            <label class="block text-xs text-gray-500 mb-1">API Key ElevenLabs (Untuk Suara)</label>
                            <input type="password" id="elevenLabsApiKey" placeholder="masukkan api elevenlabs" class="settings-input w-full">
                        </div>
                        <button onclick="saveApiKeys()" class="w-full settings-btn-action bg-blue-600 text-white mt-4 hover:bg-blue-700" data-translate-key="saveApiKeysButton">
                            Simpan API Keys
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0">
            <div class="space-y-3">
                <button onclick="saveAllSettings()" class="settings-btn-action bg-blue-500 text-white hover:bg-blue-600 text-sm py-2.5 rounded-lg font-semibold">
                    <span data-translate-key="saveAndClose">Simpan & Tutup</span>
                </button>
                <button onclick="resetAllSettings()" class="settings-btn-action bg-gray-200 text-blue-500 hover:bg-gray-300 text-sm py-2.5 rounded-lg font-semibold">
                    <span data-translate-key="resetSettings">Reset</span>
                </button>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-gray-200 flex-shrink-0 text-center">
            <p class="text-xs text-gray-500" data-translate-key="footerText">StoryBali v2.6.2 | © 2024</p>
        </div>
    </div>
</div>

<!-- ▼▼▼ [BARU] MODAL KONFIRMASI KUSTOM ▼▼▼ -->
<div id="confirmModal" class="fixed inset-0 modal-overlay z-[120] flex items-center justify-center hidden p-4"> <!-- [FIX] z-index dinaikkan (paling tinggi) -->
    <div class="modal-content p-6 max-w-sm w-full">
        <div class="text-center">
            <h3 id="confirmModalTitle" class="text-lg font-bold text-gray-800 mb-2" style="color: var(--text-primary);">Konfirmasi</h3>
            <p id="confirmModalMessage" class="text-sm text-gray-600 mb-6" style="color: var(--text-secondary);">Apakah Anda yakin?</p>
            <div class="grid grid-cols-2 gap-3">
                <button id="confirmModalCancelBtn" onclick="handleConfirm(false)" class="settings-btn-action bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm py-2">Batal</button>
                <button id="confirmModalConfirmBtn" onclick="handleConfirm(true)" class="settings-btn-action bg-red-600 text-white hover:bg-red-700 text-sm py-2">Konfirmasi</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ===================================================================================
    // KODE SCRIPT UTAMA (VERSI GABUNGAN DENGAN PERBAIKAN FINAL)
    // ===================================================================================

    // ▼▼▼ [BARU] Inisialisasi Firebase & Logika Otentikasi ▼▼▼
    // [DIUBAH] Menggunakan konfigurasi Firebase dari pengguna
    const firebaseConfig = {
      apiKey: "AIzaSyDIRmhod4j-WfVEw0MfN7f0UhaOX-XpJuc",
      authDomain: "storybali.firebaseapp.com",
      databaseURL: "https://storybali-default-rtdb.firebaseio.com",
      projectId: "storybali",
      storageBucket: "storybali.appspot.com", // [FIX] Menghapus .firebasestorage dari nama bucket
      messagingSenderId: "928239695333",
      appId: "1:928239695333:web:7b4f6581c392614c51eb0c",
      measurementId: "G-MTYGDZW92D"
    };

    // Inisialisasi Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore(); // [BARU] Inisialisasi Firestore
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    // ▼▼▼ TAMBAHKAN BARIS DI BAWAH INI ▼▼▼
    auth.tenantId = null; // Pastikan tidak ada tenant ID yang mengganggu
    auth.languageCode = 'id'; // Opsional, tapi bagus untuk konsistensi
    auth.useDeviceLanguage();

    // INI ADALAH BARIS KUNCINYA:
    // Memberitahu Firebase untuk menggunakan domain utama kita sebagai domain otentikasi.
    // Ini mencegah masalah "bounce tracking" yang disebabkan oleh redirect ke domain firebaseapp.com.
    if (!auth.authDomain) {
      auth.authDomain = 'wayanku.github.io';
    }
    // ▲▲▲ AKHIR DARI KODE YANG DITAMBAHKAN ▲▲▲

    // ▼▼▼ TAMBAHKAN BLOK KODE DI BAWAH INI ▼▼▼
    // Memaksa Firebase untuk menggunakan penyimpanan lokal yang lebih persisten.
    // Ini membantu melawan fitur pembersihan data otomatis oleh browser.
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
      .then(() => {
        console.log("Persistence berhasil diatur ke LOCAL.");
      })
      .catch((error) => {
        console.error("Gagal mengatur persistence:", error);
      });
    // ▲▲▲ AKHIR DARI KODE YANG DITAMBAHKAN ▲▲▲


    let currentUser = null; // ▼▼▼ GUNAKAN KODE INI SEBAGAI PENGGANTI ▼▼▼

    // Listener untuk status otentikasi & penanganan hasil redirect
    auth.onAuthStateChanged(user => {
      // Jika 'user' sudah ada, berarti login berhasil (baik dari sesi sebelumnya atau redirect)
      if (user) {
        currentUser = user;
        console.log("onAuthStateChanged: Pengguna terdeteksi, login berhasil!", user.displayName);
        updateUIForAuthState();
      } else {
        // Jika tidak ada user, cek apakah kita baru saja kembali dari redirect
        auth.getRedirectResult().then(result => {
          if (result && result.user) {
            // Ini terjadi tepat setelah pengguna login via redirect
            currentUser = result.user;
            console.log("getRedirectResult: Berhasil mendapatkan hasil redirect login!", result.user.displayName);
            updateUIForAuthState();
          } else {
            // Pengguna memang belum login dan tidak ada hasil redirect
            console.log("onAuthStateChanged: Tidak ada pengguna yang login.");
            currentUser = null;
            updateUIForAuthState();
          }
        }).catch(error => {
          console.error("Error saat getRedirectResult:", error);
          alert("Terjadi error saat memproses login: " + error.message);
          currentUser = null;
          updateUIForAuthState();
        });
      }
    });

     // Fungsi untuk logout
     function signOut() {
       auth.signOut().catch(error => {
         console.error("Error saat logout:", error);
       });
     }
    // ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲
    // ▼▼▼ [PERBAIKAN] Fungsi dipindahkan ke luar agar bisa diakses secara global ▼▼▼
    // Fungsi untuk login
    async function signInWithGoogle() {      
        // [PERMINTAAN PENGGUNA] Selalu coba login dengan popup terlebih dahulu untuk pengalaman "in-app".
        console.log("Mencoba login dengan popup...");
        try {
            await auth.signInWithPopup(googleProvider);
            console.log("Login dengan popup berhasil.");
        } catch (error) {
            console.warn("Login dengan popup gagal:", error.code, error.message);
            // Jika popup gagal (misalnya diblokir di PWA iOS), gunakan redirect sebagai cadangan.
            if (error.code === 'auth/popup-blocked' || error.code === 'auth/operation-not-supported-in-this-environment') {
                console.log("Popup diblokir. Beralih ke metode redirect...");
                try {
                    await auth.signInWithRedirect(googleProvider);
                } catch (redirectError) {
                    console.error("Error saat signInWithRedirect:", redirectError);
                    alert("Gagal memulai proses login: " + redirectError.message);
                }
            } else {
                // Tangani error popup lainnya
                alert("Gagal login: " + error.message);
            }
        }
    }


    // ▼▼▼ [BARU] Sistem Internasionalisasi (i18n) ▼▼▼
    // Tambahkan terjemahan baru
    const translations = {
        id: {
            storiesTitle: "Stories", historyTitle: "Riwayat Chat", createStoryTitle: "Buat Story Baru", createStoryDesc: "Story akan hilang setelah 1 jam.", storyPlaceholder: "Apa yang kamu pikirkan?", buttonPost: "Posting", addStory: "Story",
            newChat: "Mulai Chat Baru", newChatTitle: "Mulai Obrolan Baru", sidebarToggleTitle: "Tampilkan/Sembunyikan Riwayat Obrolan",
            aiName: "Wayan AI", profileHint: "Klik untuk lihat profil", voiceCallTitle: "Mulai Panggilan Suara", settingsTitle: "Buka Pengaturan",
            quickHello: "Halo", quickHowAreYou: "Apa kabar?", quickJoke: "Joke", quickProductive: "Tips Produktif", quickMovie: "Film", quickCoding: "Coding",
            inputPlaceholder: "Minta Wayan AI...", imageProcessing: "Menganalisis gambar...", stopGenerating: "Hentikan",
            voiceModeTitle: "Mode Suara", sendTitle: "Kirim Pesan", searchModeTitle: "Mode Pencarian Internet", quickSettingsTitle: "Pengaturan Cepat", uploadFileTitle: "Unggah File",
            uploadImageTitle: "Upload Gambar", listening: "Mendengarkan...",
            callConnecting: "Menghubungkan...", callStartSpeaking: "Mulai Bicara", callEnd: "Akhiri Panggilan",
            searchResultTitle: "Hasil Pencarian", searchCloseTitle: "Tutup Pencarian", searchOpenInNewTabTitle: "Buka di Tab Baru",
            imagePreviewCloseTitle: "Tutup Pratinjau Gambar", imagePreviewLabel: "Tanya sesuatu tentang gambar ini:", imagePreviewPlaceholder: "Contoh: Apa yang ada di gambar ini?...",
            buttonCancel: "Batal", buttonSend: "Kirim",
            profileCloseTitle: "Tutup Profil",
            settingsHeader: "Pengaturan", settingsCloseTitle: "Tutup Pengaturan", tabGeneral: "Umum", tabAppearance: "Tampilan", tabAdvanced: "Lanjutan",
            settingAIName: "Nama AI", settingLanguage: "Bahasa", langIndonesian: "Indonesia", langEnglish: "English", langJapanese: "日本語",
            settingPersonality: "Gaya Bahasa", personalityCasual: "Santai", personalityProfessional: "Profesional", personalityHumorous: "Humoris",
            settingAIRole: "Mode Peran AI",
            roleGeneral: "Umum", roleJapaneseTeacher: "B. Jepang", roleMathTeacher: "Matematika", roleDoctor: "Dokter", roleProgrammer: "Programmer", roleTranslator: "Penerjemah", roleCustom: "Kustom...",
            customRoleLabel: "Definisikan peran kustom AI:", customRolePlaceholder: "Contoh: Kamu adalah seorang ahli sejarah...",
            settingTheme: "Tema Warna", themeDisabled: "Ubah tema hanya tersedia di mode terang.",
            settingFontSize: "Ukuran Font", fontSmall: "Kecil", fontNormal: "Normal", fontLarge: "Besar",
            settingBackground: "Gambar Latar", removeBackground: "Hapus Latar",
            uploadBackground: "Unggah Latar Belakang Chat",
            // [BARU] Terjemahan untuk kontrol pratinjau baru
            previewEffectLabel: "Efek Blur", previewEffectNone: "Mati", previewEffectLight: "Ringan", previewEffectStrong: "Kuat",
            previewSizeLabel: "Ukuran Gambar", previewSizeCover: "Penuh", previewSizeContain: "Utuh",
            previewHeader: "Pratinjau Latar", previewMobile: "Tampilan Handphone", previewDesktop: "Tampilan Desktop",
            settingAnimations: "Efek Animasi", settingDarkMode: "Mode Gelap", tabSound: "Suara & Notifikasi", settingSound: "Suara Notifikasi", settingVoiceReader: "Pembaca Jawaban",
            settingAudioSource: "Sumber Audio", audioSourceBrowser: "Bawaan Browser", audioSourceElevenLabs: "ElevenLabs",
            settingVoiceType: "Jenis Suara (Bawaan)", settingElevenLabsVoice: "Suara ElevenLabs", elevenLabsNeedKey: "Masukkan API Key dulu", elevenLabsPreviewTitle: "Dengarkan Pratinjau Suara",
            elevenLabsHint: `Pilih "ElevenLabs" sebagai Sumber Audio dan simpan API Key di tab "Lanjutan" untuk menggunakan fitur ini.`,
            settingSaveHistory: "Simpan Riwayat", exportHistory: "Export Riwayat Chat Ini", clearAllHistory: "Hapus SEMUA Percakapan",
            feedbackTitle: "Beri Masukan", feedbackSubtitle: "Punya ide atau saran? Beri tahu kami!", feedbackPlaceholder: "Tulis masukan Anda di sini...", feedbackSendButton: "Kirim Masukan",
            apiKeysTitle: "API Keys", saveApiKeysButton: "Simpan API Keys",
            backgroundFileSet: "Latar belakang kustom telah diatur.",
            resetSettings: "Reset", saveAndClose: "Simpan & Tutup", footerText: "StoryBali v2.6.2 | © 2024",
            newConversation: "Percakapan Baru",
            voiceDefault: "Bawaan Browser", voicePrimaryLang: "Bahasa Utama", voiceOtherLang: "Bahasa Lain",
            copyAnswer: "Salin Jawaban", readAnswer: "Baca Jawaban", searchOnGoogle: "Cari di Google",
            likeResponse: "Suka jawaban ini", dislikeResponse: "Tidak suka jawaban ini", regenerateResponse: "Buat ulang jawaban", shareResponse: "Bagikan jawaban",
            profileTitle: "AI Assistant Dari Storybali", profileGreeting: "Halo! Gue Wayan!", profileDesc1: "Gue adalah AI assistant yang dibuat khusus untuk membantu kamu dengan gaya bahasa yang santai dan friendly.", profileDesc2: "Santai aja, tanya apa aja yang kamu mau!", profileDesc3: "Kepoin Wayan yuk di Instagram atau chat WA pribadi Wayan!", profileInstagram: "Instagram", profileWhatsapp: "WhatsApp",
            initialGreeting: "Halo! Gue Wayan nih, AI assistant yang siap bantu jawab pertanyaan kamu. Santai aja, tanya apa aja yang kamu mau tau ya!",
            copyCode: "Salin", copied: "Disalin!",
            readingText: "Membacakan...",
            systemRoleChanged: "Mode peran AI telah diubah menjadi: {roleName}.",
            systemPersonalityChanged: "Gaya bahasa AI telah diubah menjadi: {personalityName}.",
            systemSearchModeOn: "Mode pencarian internet diaktifkan.", systemSearchModeOff: "Mode pencarian internet dinonaktifkan.",
            systemNewChat: "Memulai percakapan baru.", systemResponseStopped: "Pembuatan respons dihentikan.", systemImageAnalysisStopped: "Analisis gambar dihentikan.",
            confirmDeleteSingleTitle: "Hapus Percakapan?", confirmDeleteSingleMsg: "Tindakan ini tidak dapat dibatalkan.", confirmDeleteSingleBtn: "Hapus",
            confirmDeleteAllTitle: "Hapus Semua Riwayat?", confirmResetTitle: "Reset Pengaturan?", confirmResetBtn: "Ya, Reset",
            errorVoiceRecognition: "Maaf, browser Anda tidak mendukung fitur pengenalan suara.", errorSpeechRecog: "Error pengenalan suara: {error}", errorStartSpeechRecog: "Tidak dapat memulai pengenalan suara.",
            alertSettingsSaved: "Pengaturan berhasil disimpan!", alertResetConfirm: "Yakin ingin mereset semua pengaturan? SEMUA riwayat chat dan API Key akan dihapus. Halaman akan dimuat ulang.", alertResetSuccess: "Pengaturan telah direset ke default. Halaman akan dimuat ulang.",
            alertExportEmpty: "Belum ada riwayat chat di sesi ini untuk di-export!", alertExportSuccess: "Riwayat chat sesi ini berhasil di-export!",
            alertClearHistoryConfirm: "Yakin mau hapus SEMUA riwayat percakapan? Tindakan ini tidak bisa dibatalkan.", alertClearHistorySuccess: "Semua riwayat percakapan telah dihapus!",
            alertApiKeysSaved: "API Keys berhasil disimpan!", alertImageInvalid: "File tidak valid. Silakan pilih file gambar (JPEG, PNG, WEBP, GIF).", alertImageNoQuestion: "Tulis pertanyaan dulu ya!", alertImageNoData: "Terjadi kesalahan, gambar tidak ditemukan. Coba pilih lagi.", alertLimitReached: "Anda telah mencapai batas. Tunggu cooldown selesai.",
            errorApiResponseInvalid: "Respons API tidak valid:", errorGeneric: "Maaf, Wayan tidak dapat memberikan respons. Coba lagi.", errorImageAnalysis: "Wah, Wayan nggak bisa analisis gambar ini. Coba gambar lain ya.", errorApiGeneral: "Aduh, Wayan error: {error}. Coba lagi nanti ya!", errorImageAnalysisGeneral: "Aduh, Wayan error saat analisis gambar: {error}. Coba lagi ya!",
            promptRenameChat: "Masukkan nama baru untuk percakapan ini:",
            statusCooldown: "Anda mencapai batas limit. Silakan tunggu...", statusCooldownMessage: "Waktu Jeda...<br>Wayan lagi istirahat sebentar ya!", statusCooldownDone: "Waktunya ngobrol lagi! Wayan sudah siap.",
            statusElevenLabsLoading: "Memuat suara...", errorElevenLabsFetch: "Gagal ambil suara. Periksa API Key.", errorElevenLabsPreview: "Gagal memutar pratinjau. Periksa API Key atau koneksi Anda.",
            alertReaderDisabled: "Fitur pembaca jawaban dinonaktifkan.", errorElevenLabsPlayback: "Gagal memutar suara ElevenLabs. Memeriksa API Key atau beralih ke suara Bawaan Browser di Pengaturan.",
            shareNotSupported: "Browser Anda tidak mendukung fitur berbagi. Jawaban telah disalin ke clipboard.", feedbackMessageSent: "Terima kasih atas masukan Anda!",
            callErrorBrowserSupport: "Maaf, browser Anda tidak mendukung fitur ini.", callStatusSpeaking: "Wayan AI sedang berbicara...", callStatusThinking: "Wayan sedang berpikir...", callErrorGeneric: "Maaf, ada gangguan. Bisa ulangi lagi?", callErrorTechnical: "Aduh, ada masalah teknis. Kita ulangi ya.", callInitialGreeting: "Halo, ini Wayan. Ada yang bisa dibantu?", callTranscriptTitle: "[TRANSKRIP PANGGILAN SUARA]\n", callUserPrefix: "Anda: ", callAiPrefix: "Wayan: ",
            onboardingWelcomeTitle: "Selamat Datang di Wayan AI!", onboardingWelcomeDesc: "Aplikasi chat cerdas dengan AI berbahasa Indonesia yang ramah dan mudah digunakan.", onboardingAskTitle: "Mulai Bertanya!", onboardingAskDesc: "Tulis pertanyaan di kolom bawah, lalu tekan <b>tombol kirim</b>.", onboardingHistoryTitle: "Simpan Percakapan", onboardingHistoryDesc: "Setiap percakapan akan otomatis tersimpan. Klik tombol <b>menu (garis tiga)</b> di pojok kiri atas untuk melihat riwayat chat Anda.", onboardingSettingsTitle: "Atur Gaya AI-mu", onboardingSettingsDesc: "Pilih <b>peran</b> dan <b>gaya bahasa</b> AI melalui tombol <b>pengaturan (roda gigi)</b>.", onboardingReadyTitle: "Yuk Mulai Chatting!", onboardingReadyDesc: "Selamat menikmati Wayan AI. Jangan ragu untuk bereksperimen!", onboardingSkip: "Lewati", onboardingNext: "Selanjutnya", onboardingStart: "Mulai Chatting",
            ratingTitle: "Beri Nilai untuk Wayan AI", ratingDesc: "Masukan Anda sangat berarti untuk pengembangan kami.", ratingPlaceholder: "Tulis masukan Anda di sini (opsional)...", ratingLater: "Nanti Saja", ratingSubmit: "Kirim Nilai", ratingAlertNoStars: "Mohon pilih setidaknya 1 bintang.", ratingStatusSending: "Mengirim...", ratingAlertSuccess: "Terima kasih atas penilaian Anda!", ratingAlertError: "Maaf, terjadi kesalahan.",
            feedbackAlertEmpty: "Mohon tulis masukan Anda terlebih dahulu.", feedbackStatusSending: "Mengirim...", feedbackAlertSuccess: "Terima kasih! Masukan Anda telah terkirim.", feedbackAlertError: "Maaf, terjadi kesalahan.",
            inactiveNotification: "Mau udahan ngobrol sama Wayan?",
            welcomeBackNotification: "Wayan kangen nih! Mau lanjut ngobrol lagi?",
        },
        // ... tambahkan terjemahan baru ke bahasa lain jika perlu
        en: {
            newChat: "New Chat", newChatTitle: "Start a New Conversation", sidebarToggleTitle: "Show/Hide Chat History",
            aiName: "Wayan AI", profileHint: "Click to see profile", voiceCallTitle: "Start Voice Call", settingsTitle: "Open Settings",
            quickHello: "Hello", quickHowAreYou: "How are you?", quickJoke: "Joke", quickProductive: "Productivity Tips", quickMovie: "Movie", quickCoding: "Coding",
            inputPlaceholder: "Ask Wayan AI...", imageProcessing: "Analyzing image...", stopGenerating: "Stop",
            voiceModeTitle: "Voice Mode", sendTitle: "Send Message", searchModeTitle: "Internet Search Mode", quickSettingsTitle: "Quick Settings", uploadFileTitle: "Upload File",
            uploadImageTitle: "Upload Image", listening: "Listening...",
            callConnecting: "Connecting...", callStartSpeaking: "Start Speaking", callEnd: "End Call",
            searchResultTitle: "Search Results", searchCloseTitle: "Close Search", searchOpenInNewTabTitle: "Open in New Tab",
            imagePreviewCloseTitle: "Close Image Preview", imagePreviewLabel: "Ask something about this image:", imagePreviewPlaceholder: "Example: What is in this image?...",
            buttonCancel: "Cancel", buttonSend: "Send",
            profileCloseTitle: "Close Profile",
            settingsHeader: "Settings", settingsCloseTitle: "Close Settings", tabGeneral: "General", tabAppearance: "Appearance", tabAdvanced: "Advanced",
            settingAIName: "AI Name", settingLanguage: "Language", langIndonesian: "Indonesia", langEnglish: "English", langJapanese: "日本語",
            settingPersonality: "Tone of Voice", personalityCasual: "Casual", personalityProfessional: "Professional", personalityHumorous: "Humorous",
            settingAIRole: "AI Role Mode",
            roleGeneral: "General", roleJapaneseTeacher: "Japanese Teacher", roleMathTeacher: "Math Teacher", roleDoctor: "Doctor", roleProgrammer: "Programmer", roleTranslator: "Translator", roleCustom: "Custom...",
            customRoleLabel: "Define custom AI role:", customRolePlaceholder: "Example: You are a history expert...",
            settingTheme: "Color Theme", themeDisabled: "Theme change is only available in light mode.",
            settingFontSize: "Font Size", fontSmall: "Small", fontNormal: "Normal", fontLarge: "Large",
            settingBackground: "Background Image", removeBackground: "Remove Background",
            uploadBackground: "Upload Chat Background",
            // [BARU] Terjemahan untuk kontrol pratinjau baru
            previewEffectLabel: "Blur Effect", previewEffectNone: "Off", previewEffectLight: "Light", previewEffectStrong: "Strong",
            previewSizeLabel: "Image Size", previewSizeCover: "Fill", previewSizeContain: "Fit",
            previewHeader: "Background Preview", previewMobile: "Mobile View", previewDesktop: "Desktop View",
            settingAnimations: "Animations", settingDarkMode: "Dark Mode", tabSound: "Sound & Notifications", settingSound: "Notification Sound", settingVoiceReader: "Answer Reader",
            settingAudioSource: "Audio Source", audioSourceBrowser: "Browser Default", audioSourceElevenLabs: "ElevenLabs",
            settingVoiceType: "Voice Type (Default)", settingElevenLabsVoice: "ElevenLabs Voice", elevenLabsNeedKey: "Enter API Key first", elevenLabsPreviewTitle: "Preview Voice",
            elevenLabsHint: `Select "ElevenLabs" as Audio Source and save an API Key in the "Advanced" tab to use this feature.`,
            settingSaveHistory: "Save History", exportHistory: "Export This Chat History", clearAllHistory: "Delete ALL Conversations",
            feedbackTitle: "Give Feedback", feedbackSubtitle: "Have ideas or suggestions? Let us know!", feedbackPlaceholder: "Write your feedback here...", feedbackSendButton: "Send Feedback",
            apiKeysTitle: "API Keys", saveApiKeysButton: "Save API Keys",
            backgroundFileSet: "Custom background is set.",
            resetSettings: "Reset", saveAndClose: "Save & Close", footerText: "StoryBali v2.6.2 | © 2024",
            newConversation: "New Conversation",
            voiceDefault: "Browser Default", voicePrimaryLang: "Primary Language", voiceOtherLang: "Other Languages",
            copyAnswer: "Copy Answer", readAnswer: "Read Answer", searchOnGoogle: "Search on Google",
            likeResponse: "Like this response", dislikeResponse: "Dislike this response", regenerateResponse: "Regenerate response", shareResponse: "Share response",
            profileTitle: "AI Assistant From Storybali", profileGreeting: "Hello! I'm Wayan!", profileDesc1: "I am an AI assistant specially created to help you with a relaxed and friendly style.", profileDesc2: "Just relax, ask anything you want!", profileDesc3: "Check me out on Instagram or chat with me personally on WhatsApp!", profileInstagram: "Instagram", profileWhatsapp: "WhatsApp",
            initialGreeting: "Hello! I'm Wayan, your AI assistant ready to help answer your questions. Feel free to ask me anything you want to know!",
            copyCode: "Copy", copied: "Copied!",
            readingText: "Reading...",
            systemRoleChanged: "AI role mode has been changed to: {roleName}.",
            systemPersonalityChanged: "AI tone of voice has been changed to: {personalityName}.",
            systemSearchModeOn: "Internet search mode activated.", systemSearchModeOff: "Internet search mode deactivated.",
            systemNewChat: "Starting a new conversation.", systemResponseStopped: "Response generation stopped.", systemImageAnalysisStopped: "Image analysis stopped.",
            confirmDeleteSingleTitle: "Delete Conversation?", confirmDeleteSingleMsg: "This action cannot be undone.", confirmDeleteSingleBtn: "Delete",
            confirmDeleteAllTitle: "Delete All History?", confirmResetTitle: "Reset Settings?", confirmResetBtn: "Yes, Reset",
            errorVoiceRecognition: "Sorry, your browser does not support the voice recognition feature.", errorSpeechRecog: "Speech recognition error: {error}", errorStartSpeechRecog: "Could not start speech recognition.",
            alertSettingsSaved: "Settings saved successfully!", alertResetConfirm: "Are you sure you want to reset all settings? ALL chat history and API Keys will be deleted. The page will reload.", alertResetSuccess: "Settings have been reset to default. The page will reload.",
            alertExportEmpty: "There is no chat history in this session to export!", alertExportSuccess: "Chat history for this session has been successfully exported!",
alertClearHistoryConfirm: "Are you sure you want to delete ALL chat history? This action cannot be undone.", alertClearHistorySuccess: "All chat history has been deleted!",
            alertApiKeysSaved: "API Keys saved successfully!", alertImageInvalid: "Invalid file. Please select an image file (JPEG, PNG, WEBP, GIF).", alertImageNoQuestion: "Please write a question first!", alertImageNoData: "An error occurred, image not found. Please try selecting again.", alertLimitReached: "You have reached the limit. Please wait for the cooldown to finish.",
            errorApiResponseInvalid: "Invalid API response:", errorGeneric: "Sorry, Wayan couldn't provide a response. Please try again.", errorImageAnalysis: "Oops, Wayan can't analyze this image. Try another one.", errorApiGeneral: "Oops, Wayan encountered an error: {error}. Please try again later!", errorImageAnalysisGeneral: "Oops, Wayan encountered an error during image analysis: {error}. Please try again!",
            promptRenameChat: "Enter a new name for this conversation:",
            statusCooldown: "You have reached the limit. Please wait...", statusCooldownMessage: "Cooldown Time...<br>Wayan is taking a short break!", statusCooldownDone: "Time to chat again! Wayan is ready.",
            statusElevenLabsLoading: "Loading voices...", errorElevenLabsFetch: "Failed to fetch voices. Check API Key.", errorElevenLabsPreview: "Failed to play preview. Check your API Key or connection.",
            shareNotSupported: "Your browser does not support sharing. The response has been copied to the clipboard.", feedbackMessageSent: "Thank you for your feedback!",
            alertReaderDisabled: "The answer reader feature is disabled.", errorElevenLabsPlayback: "Failed to play ElevenLabs audio. Check API Key or switch to Browser Default voice in Settings.",
            callErrorBrowserSupport: "Sorry, your browser does not support this feature.", callStatusSpeaking: "Wayan AI is speaking...", callStatusThinking: "Wayan is thinking...", callErrorGeneric: "Sorry, there was a disturbance. Could you repeat that?", callErrorTechnical: "Oops, there's a technical issue. Let's try again.", callInitialGreeting: "Hello, this is Wayan. How can I help?", callTranscriptTitle: "[VOICE CALL TRANSCRIPT]\n", callUserPrefix: "You: ", callAiPrefix: "Wayan: ",
            onboardingWelcomeTitle: "Welcome to Wayan AI!", onboardingWelcomeDesc: "A smart chat application with a friendly and easy-to-use Indonesian-speaking AI.", onboardingAskTitle: "Start Asking!", onboardingAskDesc: "Write your question in the input box below, then press the <b>send button</b>.", onboardingHistoryTitle: "Save Conversations", onboardingHistoryDesc: "Every conversation is automatically saved. Click the <b>menu button (three lines)</b> in the top left corner to see your chat history.", onboardingSettingsTitle: "Customize Your AI", onboardingSettingsDesc: "Choose the AI's <b>role</b> and <b>tone of voice</b> via the <b>settings button (gear icon)</b>.", onboardingReadyTitle: "Let's Start Chatting!", onboardingReadyDesc: "Enjoy Wayan AI. Feel free to experiment!", onboardingSkip: "Skip", onboardingNext: "Next", onboardingStart: "Start Chatting",
            ratingTitle: "Rate Wayan AI", ratingDesc: "Your feedback is valuable for our development.", ratingPlaceholder: "Write your feedback here (optional)...", ratingLater: "Later", ratingSubmit: "Submit Rating", ratingAlertNoStars: "Please select at least 1 star.", ratingStatusSending: "Sending...", ratingAlertSuccess: "Thank you for your rating!", ratingAlertError: "Sorry, an error occurred.",
            feedbackAlertEmpty: "Please write your feedback first.", feedbackStatusSending: "Sending...", feedbackAlertSuccess: "Thank you! Your feedback has been sent.", feedbackAlertError: "Sorry, an error occurred.",
            inactiveNotification: "Done chatting with Wayan?",
            welcomeBackNotification: "Wayan missed you! Want to continue our chat?",
        },
        ja: {
            newChat: "新しいチャット", newChatTitle: "新しい会話を始める", sidebarToggleTitle: "チャット履歴の表示/非表示",
            aiName: "ワヤンAI", profileHint: "プロフィールを見る", voiceCallTitle: "音声通話を開始", settingsTitle: "設定を開く",
            quickHello: "こんにちは", quickHowAreYou: "元気ですか？", quickJoke: "冗談", quickProductive: "生産性のヒント", quickMovie: "映画", quickCoding: "コーディング",
            inputPlaceholder: "ワヤンAIに質問...", imageProcessing: "画像を分析中...", stopGenerating: "停止",
            voiceModeTitle: "音声モード", sendTitle: "送信", searchModeTitle: "インターネット検索モード", quickSettingsTitle: "クイック設定", uploadFileTitle: "ファイルをアップロード",
            uploadImageTitle: "画像をアップロード", listening: "聞いています...",
            callConnecting: "接続中...", callStartSpeaking: "話し始める", callEnd: "通話を終了",
            searchResultTitle: "検索結果", searchCloseTitle: "検索を閉じる", searchOpenInNewTabTitle: "新しいタブで開く",
            imagePreviewCloseTitle: "画像プレビューを閉じる", imagePreviewLabel: "この画像について質問する:", imagePreviewPlaceholder: "例: この画像には何が写っていますか？...",
            buttonCancel: "キャンセル", buttonSend: "送信",
            profileCloseTitle: "プロフィールを閉じる",
            settingsHeader: "設定", settingsCloseTitle: "設定を閉じる", tabGeneral: "一般", tabAppearance: "外観", tabAdvanced: "詳細",
            settingAIName: "AIの名前", settingLanguage: "言語", langIndonesian: "Indonesia", langEnglish: "English", langJapanese: "日本語",
            settingPersonality: "口調", personalityCasual: "カジュアル", personalityProfessional: "プロフェッショナル", personalityHumorous: "ユーモラス",
            settingAIRole: "AIの役割モード",
            roleGeneral: "一般", roleJapaneseTeacher: "日本語教師", roleMathTeacher: "数学教師", roleDoctor: "医者", roleProgrammer: "プログラマー", roleTranslator: "翻訳者", roleCustom: "カスタム...",
            customRoleLabel: "カスタムAIの役割を定義:", customRolePlaceholder: "例: あなたは歴史の専門家です...",
            settingTheme: "カラーテーマ", themeDisabled: "テーマの変更はライトモードでのみ利用可能です。",
            settingFontSize: "フォントサイズ", fontSmall: "小", fontNormal: "標準", fontLarge: "大",
            settingBackground: "背景画像", removeBackground: "背景を削除",
            uploadBackground: "チャット背景をアップロード",
            // [BARU] Terjemahan untuk kontrol pratinjau baru
            previewEffectLabel: "ぼかし効果", previewEffectNone: "オフ", previewEffectLight: "弱", previewEffectStrong: "強",
            previewSizeLabel: "画像サイズ", previewSizeCover: "フィル", previewSizeContain: "フィット",
            previewHeader: "背景プレビュー", previewMobile: "モバイル表示", previewDesktop: "デスクトップ表示",
            settingAnimations: "アニメーション効果", settingDarkMode: "ダークモード", tabSound: "音声と通知", settingSound: "通知音", settingVoiceReader: "回答読み上げ",
            settingAudioSource: "音声ソース", audioSourceBrowser: "ブラウザのデフォルト", audioSourceElevenLabs: "ElevenLabs",
            settingVoiceType: "声の種類 (デフォルト)", settingElevenLabsVoice: "ElevenLabsの声", elevenLabsNeedKey: "先にAPIキーを入力", elevenLabsPreviewTitle: "音声をプレビュー",
            elevenLabsHint: `この機能を使用するには、音声ソースとして「ElevenLabs」を選択し、「詳細」タブでAPIキーを保存してください。`,
            settingSaveHistory: "履歴を保存", exportHistory: "このチャット履歴をエクスポート", clearAllHistory: "すべての会話を削除",
            feedbackTitle: "フィードバックを送信", feedbackSubtitle: "アイデアや提案がありますか？お知らせください！", feedbackPlaceholder: "ここにフィードバックを記入してください...", feedbackSendButton: "フィードバックを送信",
            apiKeysTitle: "APIキー", saveApiKeysButton: "APIキーを保存",
            backgroundFileSet: "カスタム背景が設定されています。",
            resetSettings: "リセット", saveAndClose: "保存して閉じる", footerText: "StoryBali v2.6.2 | © 2024",
            newConversation: "新しい会話",
            voiceDefault: "ブラウザのデフォルト", voicePrimaryLang: "主な言語", voiceOtherLang: "その他の言語",
            copyAnswer: "回答をコピー", readAnswer: "回答を読み上げ", searchOnGoogle: "Googleで検索",
            likeResponse: "この回答を評価 (良い)", dislikeResponse: "この回答を評価 (悪い)", regenerateResponse: "回答を再生成", shareResponse: "回答を共有",
            profileTitle: "StorybaliのAIアシスタント", profileGreeting: "こんにちは！ワヤンです！", profileDesc1: "私はリラックスしたフレンドリーなスタイルであなたを助けるために特別に作られたAIアシスタントです。", profileDesc2: "リラックスして、何でも聞いてください！", profileDesc3: "Instagramで私をチェックするか、WhatsAppで個人的にチャットしてください！", profileInstagram: "インスタグラム", profileWhatsapp: "ワッツアップ",
            initialGreeting: "こんにちは！私はワヤン、あなたの質問に答える準備ができているAIアシスタントです。知りたいことは何でも気軽に聞いてください！",
            copyCode: "コピー", copied: "コピー済み!",
            readingText: "読み上げ中...",
            systemRoleChanged: "AIの役割モードが「{roleName}」に変更されました。",
            systemPersonalityChanged: "AIの口調が「{personalityName}」に変更されました。",
            systemSearchModeOn: "インターネット検索モードが有効になりました。", systemSearchModeOff: "インターネット検索モードが無効になりました。",
            systemNewChat: "新しい会話を開始しています。", systemResponseStopped: "応答の生成が停止しました。", systemImageAnalysisStopped: "画像分析が停止しました。",
            confirmDeleteSingleTitle: "会話を削除しますか？", confirmDeleteSingleMsg: "この操作は元に戻せません。", confirmDeleteSingleBtn: "削除",
            confirmDeleteAllTitle: "すべての履歴を削除しますか？", confirmResetTitle: "設定をリセットしますか？", confirmResetBtn: "はい、リセット",
            errorVoiceRecognition: "申し訳ありませんが、お使いのブラウザは音声認識機能をサポートしていません。", errorSpeechRecog: "音声認識エラー: {error}", errorStartSpeechRecog: "音声認識を開始できませんでした。",
            alertSettingsSaved: "設定が正常に保存されました！", alertResetConfirm: "すべての設定をリセットしてもよろしいですか？すべてのチャット履歴とAPIキーが削除されます。ページがリロードされます。", alertResetSuccess: "設定がデフォルトにリセットされました。ページがリロードされます。",
            alertExportEmpty: "このセッションにはエクスポートするチャット履歴がありません！", alertExportSuccess: "このセッションのチャット履歴が正常にエクスポートされました！",
            alertClearHistoryConfirm: "すべての会話履歴を削除してもよろしいですか？この操作は元に戻せません。", alertClearHistorySuccess: "すべての会話履歴が削除されました！",
            alertApiKeysSaved: "APIキーが正常に保存されました！", alertImageInvalid: "無効なファイルです。画像ファイル（JPEG、PNG、WEBP、GIF）を選択してください。", alertImageNoQuestion: "まず質問を書いてください！", alertImageNoData: "エラーが発生しました、画像が見つかりません。もう一度選択してみてください。", alertLimitReached: "制限に達しました。クールダウンが終了するまでお待ちください。",
            errorApiResponseInvalid: "無効なAPI応答:", errorGeneric: "申し訳ありません、ワヤンは応答できませんでした。もう一度お試しください。", errorImageAnalysis: "おっと、ワヤンはこの画像を分析できません。別の画像を試してください。", errorApiGeneral: "おっと、ワヤンでエラーが発生しました: {error}。後でもう一度お試しください！", errorImageAnalysisGeneral: "おっと、画像分析中にワヤンでエラーが発生しました: {error}。もう一度お試しください！",
            promptRenameChat: "この会話の新しい名前を入力してください:",
            statusCooldown: "制限に達しました。お待ちください...", statusCooldownMessage: "クールダウン時間...<br>ワヤンは少し休憩しています！", statusCooldownDone: "またチャットの時間です！ワヤンは準備ができました。",
            statusElevenLabsLoading: "音声を読み込み中...", errorElevenLabsFetch: "音声の取得に失敗しました。APIキーを確認してください。", errorElevenLabsPreview: "プレビューの再生に失敗しました。APIキーまたは接続を確認してください。",
            shareNotSupported: "お使いのブラウザは共有機能をサポートしていません。回答がクリップボードにコピーされました。", feedbackMessageSent: "フィードバックありがとうございます！",
            alertReaderDisabled: "回答読み上げ機能は無効です。", errorElevenLabsPlayback: "ElevenLabsの音声の再生に失敗しました。APIキーを確認するか、設定でブラウザのデフォルト音声に切り替えてください。",
            callErrorBrowserSupport: "申し訳ありませんが、お使いのブラウザはこの機能をサポートしていません。", callStatusSpeaking: "ワヤンAIが話しています...", callStatusThinking: "ワヤンは考えています...", callErrorGeneric: "申し訳ありません、中断が発生しました。もう一度お願いしますか？", callErrorTechnical: "おっと、技術的な問題が発生しました。もう一度やり直しましょう。", callInitialGreeting: "こんにちは、ワヤンです。何かお手伝いできることはありますか？", callTranscriptTitle: "[音声通話のトランスクリプト]\n", callUserPrefix: "あなた: ", callAiPrefix: "ワヤン: ",
            onboardingWelcomeTitle: "ワヤンAIへようこそ！", onboardingWelcomeDesc: "フレンドリーで使いやすい日本語対応AIを搭載したスマートチャットアプリケーション。", onboardingAskTitle: "質問を始めよう！", onboardingAskDesc: "下の入力ボックスに質問を書き、<b>送信ボタン</b>を押してください。", onboardingHistoryTitle: "会話を保存", onboardingHistoryDesc: "すべての会話は自動的に保存されます。左上の<b>メニューボタン（三本線）</b>をクリックしてチャット履歴を表示します。", onboardingSettingsTitle: "AIをカスタマイズ", onboardingSettingsDesc: "<b>設定ボタン（歯車アイコン）</b>からAIの<b>役割</b>と<b>口調</b>を選択します。", onboardingReadyTitle: "チャットを始めよう！", onboardingReadyDesc: "ワヤンAIをお楽しみください。自由に試してみてください！", onboardingSkip: "スキップ", onboardingNext: "次へ", onboardingStart: "チャットを開始",
            ratingTitle: "ワヤンAIを評価", ratingDesc: "あなたのフィードバックは私たちの開発にとって貴重です。", ratingPlaceholder: "ここにフィードバックを記入してください（任意）...", ratingLater: "後で", ratingSubmit: "評価を送信", ratingAlertNoStars: "少なくとも星を1つ選択してください。", ratingStatusSending: "送信中...", ratingAlertSuccess: "評価ありがとうございます！", ratingAlertError: "申し訳ありません、エラーが発生しました。",
            feedbackAlertEmpty: "まずフィードバックを記入してください。", feedbackStatusSending: "送信中...", feedbackAlertSuccess: "ありがとうございます！フィードバックが送信されました。", feedbackAlertError: "申し訳ありません、エラーが発生しました。",
            inactiveNotification: "ワヤンとのチャットはもう終わりですか？",
            welcomeBackNotification: "ワヤンはあなたがいなくて寂しかったです！おしゃべりを続けたいですか？",
        }
    };

    function applyTranslations(lang) {
        const langPack = translations[lang] || translations.id;

        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.dataset.translateKey;
            if (langPack[key]) el.innerHTML = langPack[key];
        });
        document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
            const key = el.dataset.translatePlaceholder;
            if (langPack[key]) el.placeholder = langPack[key];
        });
        document.querySelectorAll('[data-translate-title]').forEach(el => {
            const key = el.dataset.translateTitle;
            if (langPack[key]) el.title = langPack[key];
        });
    }

    const t = (key, replacements = {}) => {
        const lang = settings.language || 'id';
        let text = translations[lang]?.[key] || translations.id[key] || key;
        for (const placeholder in replacements) {
            text = text.replace(`{${placeholder}}`, replacements[placeholder]);
        }
        return text;
    };
    // ▲▲▲ AKHIR DARI i18n ▲▲▲

    // ▼▼▼ [BARU] Navigasi Halaman Pengaturan ▼▼▼
    function navigateToSettingsPage(pageId) {
        const allPages = document.querySelectorAll('.settings-page');
        const targetPage = document.getElementById(`settings-page-${pageId}`);
        const mainPage = document.getElementById('settings-page-main');
        const backBtn = document.getElementById('settingsBackBtn');
        const titleEl = document.getElementById('settingsModalTitle');

        const pageTitles = {
            main: 'settingsHeader',
            language: 'settingLanguage',
            personality: 'settingPersonality',
            aiRole: 'settingAIRole',
            appearance: 'tabAppearance',
            background: 'settingBackground',
            audio: 'settingAudioSource',
            feedback: 'feedbackTitle',
            apiKeys: 'apiKeysTitle'
        };

        allPages.forEach(page => {
            if (page.classList.contains('active')) {
                page.classList.add('slide-out');
                page.classList.remove('active');
            }
        });

        setTimeout(() => {
            allPages.forEach(page => page.classList.remove('slide-out'));
            if (targetPage) {
                targetPage.classList.add('active');
                titleEl.textContent = t(pageTitles[pageId] || 'settingsHeader');
                backBtn.classList.toggle('hidden', pageId === 'main');
            }
        }, 300); // Durasi harus sama dengan animasi CSS
    }

    function adjustHeightForMobile() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', adjustHeightForMobile);
    adjustHeightForMobile();

    function getFormattedTime(date = new Date()) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }
	
    function sendNewUserNotification(ipAddress) {
      if (localStorage.getItem('notificationSent')) {
        return;
      }
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
      const payload = {
        ip: ipAddress,
        timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`,
        browserLanguage: navigator.language,
        connectionType: navigator.connection ? navigator.connection.effectiveType : 'unknown'
      };
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        mode: 'no-cors'
      })
      .then(response => {
        console.log('Notifikasi lengkap pengguna baru berhasil dikirim.');
        localStorage.setItem('notificationSent', 'true');
      })
      .catch(error => console.error('Gagal mengirim notifikasi:', error));
    }
    
    let currentRating = 0;

    function showRatingModal() {
        currentRating = 0;
        document.getElementById('ratingFeedbackInput').value = '';
        renderStars();
        document.getElementById('ratingModal').classList.remove('hidden');
    }

    function hideRatingModal() {
        document.getElementById('ratingModal').classList.add('hidden');
    }
    
    function renderStars() {
        const container = document.getElementById('starRatingContainer');
        container.innerHTML = ''; // Clear existing stars
        for (let i = 1; i <= 5; i++) {
            const starSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            starSVG.setAttribute('onclick', `handleStarClick(${i})`);
            starSVG.setAttribute('class', 'w-8 h-8 cursor-pointer star-icon transition-colors ' + (i <= currentRating ? 'text-yellow-400' : 'text-gray-300'));
            starSVG.setAttribute('fill', 'currentColor');
            starSVG.setAttribute('viewBox', '0 0 20 20');
            starSVG.innerHTML = `<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>`; // Star path
            container.appendChild(starSVG);
        }
    }

    function handleStarClick(rating) {
        currentRating = rating;
        renderStars();
    }

    function trackUserMessageCount() {
        if (localStorage.getItem('ratingModalShown')) return;
        let messageCount = parseInt(localStorage.getItem('userMessageCount') || '0');
        messageCount++;
        localStorage.setItem('userMessageCount', messageCount);

        if (messageCount === 3) {
            setTimeout(() => {
                showRatingModal();
                localStorage.setItem('ratingModalShown', 'true');
            }, 2000);
        }
    }
    
    function submitRating() {
        if (currentRating === 0) {
            alert(t('ratingAlertNoStars'));
            return;
        }
        const feedbackText = document.getElementById('ratingFeedbackInput').value.trim();
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
        const payload = {
            type: 'rating',
            rating: currentRating,
            message: feedbackText || 'No additional comment.',
            userIP: currentUserIP || 'tidak diketahui',
            timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
        };
        const button = document.getElementById('submitRatingBtn');
        button.querySelector('span').textContent = t('ratingStatusSending');
        button.disabled = true;

        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
        .then(() => { alert(t('ratingAlertSuccess')); hideRatingModal(); })
        .catch(error => { console.error('Gagal mengirim rating:', error); alert(t('ratingAlertError')); })
        .finally(() => { button.querySelector('span').textContent = t('ratingSubmit'); button.disabled = false; });
    }

    function sendGeneralFeedback() {
        const input = document.getElementById('settingsFeedbackInput');
        const feedbackText = input.value.trim();
        if (!feedbackText) {
            alert(t('feedbackAlertEmpty'));
            return;
        }
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
        const payload = {
            type: 'feedback',
            message: feedbackText,
            userIP: currentUserIP || 'tidak diketahui',
            timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
        };
        const button = document.getElementById('sendSettingsFeedbackBtn');
        button.querySelector('span').textContent = t('feedbackStatusSending');
        button.disabled = true;
        
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
        .then(() => { alert(t('feedbackAlertSuccess')); input.value = ''; })
        .catch(error => { console.error('Gagal mengirim masukan:', error); alert(t('feedbackAlertError')); })
        .finally(() => { button.querySelector('span').textContent = t('feedbackSendButton'); button.disabled = false; });
    }

    let apiKeys = [];
    let allChatSessions = [];
    let activeChatId = null;
    let recognition = null;
    const CHAT_LIMIT = 4;
    const COOLDOWN_MINUTES = 1;
    let currentUserIP = null;
    let countdownInterval = null;

    let currentFetchController = null;
    // [BARU] Variabel state untuk notifikasi cerdas
    let isWindowActive = true;
    let userHasScrolledUp = false;
    let tabInactiveTimestamp = null; // [BARU] Untuk notifikasi "selamat datang kembali"

    let isRecording = false;
    let isSearchModeActive = false;
    const MAX_HISTORY_FOR_PROMPT = 10; // [FIX] Batasi riwayat yang dikirim ke 10 interaksi terakhir (user + model)
    let finalTranscript = '';
    
    let currentPreviewData = {
        base64: null,
        fileName: null,
        mimeType: null
    };
    // [BARU] Variabel untuk menyimpan data file yang di-attach
    let attachedFileData = {
        content: null,
        fileName: null,
        mimeType: null,
        type: 'file' // [BARU] 'file' atau 'image'
    };

    const defaultSettings = {
        soundEnabled: true,
        animationsEnabled: true,
        readAiResponseEnabled: true,
        aiName: 'Wayan',
        language: 'id',
        personality: 'santai',
        aiRole: 'umum',
        customAiRolePrompt: '',
        fontSize: 'base',
        voiceURI: '',
        audioSource: 'browser', // Pilihan baru: 'browser' atau 'elevenlabs'
        elevenLabsVoiceId: '21m00Tcm4TlvDq8ikWAM',
        saveHistory: true,
        isSidebarOpen: window.innerWidth > 768,
        darkMode: false,
        backgroundUrl: '',
        backgroundBlur: 'none', // [BARU] 'none', 'light', 'strong'
        backgroundSize: 'cover', // [BARU] 'cover', 'contain'

    };
    
    let settings = { ...defaultSettings };
    let tempSettings = {}; // [DIUBAH] Variabel untuk pratinjau pengaturan
    let currentUtterance = null;
    let isReading = false;
    let elevenLabsAudioPlayer = new Audio();
    let elevenLabsPreviewPlayer = new Audio();

    // [FIX] Variabel global untuk menampung daftar suara dan promise untuk menandakan kesiapan
    let availableVoices = [];
    let voicesReadyPromiseResolver;
    const voicesReadyPromise = new Promise(resolve => { voicesReadyPromiseResolver = resolve; });


    // Variabel state untuk panggilan
    let isCallActive = false;
    let isSpeaking = false; // Gabungan untuk AI dan User
    let callRecognition = null;
    let silenceTimer = null;
    let callHistory = [];
    let isListeningForCall = false; // Flag untuk status mikrofon
    let userCallState = 'idle'; // State untuk alur iOS: 'idle', 'listening', 'transcribed'

    let modelCache = {}; // [BARU] Cache untuk menyimpan model yang valid per API Key
    const DEFAULT_API_KEY_1 = 'AIzaSyClcqSMaHiXMZI4qYlTySqC3I3hWWg8H9s';
    const DEFAULT_API_KEY_2 = 'AIzaSyB8OPwzNAAyO1nWd9g185rx4YK3WIJy_Fw';
    const DEFAULT_API_KEY_3 = 'AIzaSyAYzvB1mfVdjrBtXY2n4-UUzCH5juQt8rU';
    const DEFAULT_API_KEY_4 = 'AIzaSyCkkekhKcQzFUUjx8ZcuqEYyqRde1ZDJcU';
    const DEFAULT_API_KEY_5 = 'AIzaSyCV-88PX1_tKh5VBjki9VeyY8gAH5bpZ0o';
    const DEFAULT_API_KEY_6 = 'AIzaSyDZpoeHa12J64F_ONhmH1vDrsqW_KVhAUc';
    const DEFAULT_ELEVENLABS_API_KEY = '_51cca647c5de2291ff8247aad3561325390e4ef1e3166918';
    
    async function getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) throw new Error('Gagal mendapatkan IP');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Tidak bisa mendapatkan IP address:", error);
            return 'default_user';
        }
    }
    function getChatLimitData() { return JSON.parse(localStorage.getItem('wayanAiChatLimit') || '{}'); }
    function saveChatLimitData(data) { localStorage.setItem('wayanAiChatLimit', JSON.stringify(data)); }
    function checkUserStatus() {
        if (!currentUserIP) return;
        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP];
        if (userData && userData.cooldownUntil && new Date().getTime() < userData.cooldownUntil) {
            startCooldown(userData.cooldownUntil);
        } else if (userData) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }
    }
    function setInputEnabled(enabled, message = "Minta Wayan AI...") {
        const messageInput = document.getElementById('messageInput'); // Placeholder will be set by applyTranslations
        messageInput.disabled = !enabled;
        messageInput.placeholder = message;
        document.querySelectorAll('.action-btn, .dynamic-icon-btn').forEach(btn => {
            btn.disabled = !enabled;
            btn.style.opacity = enabled ? '1' : '0.5';
            btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
        });
    }
    function startCooldown(cooldownEndTime) {
        setInputEnabled(false, t('statusCooldown'));
        const messageId = `cooldown-timer-${currentUserIP}`;
        if(document.getElementById(messageId)) document.getElementById(messageId).remove();
        const chatMessages = document.getElementById('chatMessages');
        const timerMessageElement = document.createElement('div');
        timerMessageElement.className = 'system-message-bubble';
        timerMessageElement.id = messageId;

        timerMessageElement.innerHTML = `
            <div class="cooldown-timer-wrapper">
                <div class="cooldown-circle-container">
                    <svg class="cooldown-circle-svg" viewBox="0 0 36 36">
                        <path class="cooldown-circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                        <path id="cooldown-progress-${currentUserIP}" class="cooldown-circle-progress" stroke-dasharray="100, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"></path>
                    </svg>
                    <div id="cooldown-text-${currentUserIP}" class="cooldown-time-text">...</div>
                </div>
                <div class="cooldown-message-text">${t('statusCooldownMessage')}</div>
            </div>
        `;
        
        chatMessages.appendChild(timerMessageElement);
        scrollToBottom(); 
        
        if (countdownInterval) clearInterval(countdownInterval);

        const totalCooldown = COOLDOWN_MINUTES * 60 * 1000;
        const progressCircle = document.getElementById(`cooldown-progress-${currentUserIP}`);
        const textElement = document.getElementById(`cooldown-text-${currentUserIP}`);

        const updateTimer = () => {
            const distance = cooldownEndTime - new Date().getTime();
            if (distance < 0) { endCooldown(); return; }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            textElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            const progress = ((totalCooldown - distance) / totalCooldown) * 100;
            if (progressCircle) progressCircle.style.strokeDashoffset = 100 - progress;
        };

        countdownInterval = setInterval(updateTimer, 1000);
        updateTimer();
    }
    function endCooldown() {
        clearInterval(countdownInterval);
        countdownInterval = null;
        const timerMessageElement = document.getElementById(`cooldown-timer-${currentUserIP}`);
        const successIcon = `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
        if (timerMessageElement) timerMessageElement.innerHTML = `<div class="system-message success">${successIcon}<span>${t('statusCooldownDone')}</span></div>`;
        const allUserData = getChatLimitData();
        if (allUserData[currentUserIP]) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }
        setInputEnabled(true);
    }
    function handleInputChange(event) {
        const messageInput = event.target;
        const micBtn = document.getElementById('micBtn');
        const sendBtn = document.getElementById('sendBtn');
        if (messageInput.value.trim().length > 0) {
            micBtn.style.opacity = '0'; micBtn.style.pointerEvents = 'none';
            sendBtn.style.opacity = '1'; sendBtn.style.pointerEvents = 'auto';
        } else {
            micBtn.style.opacity = '1'; micBtn.style.pointerEvents = 'auto';
            sendBtn.style.opacity = '0'; sendBtn.style.pointerEvents = 'none';
        }
    }
    function videoNotAvailable() { alert(t('alertVideoNotAvailable')); }
    function openQuickSettings() {
        if (document.getElementById('settingsModal').classList.contains('hidden')) toggleSettings();
        switchSettingsTab('general');
    }
    function saveApiKeys() {
        const geminiKeysToSave = Array.from({length: 6}, (_, i) => document.getElementById(`apiKey${i + 1}`).value.trim());
        localStorage.setItem('storybaliApiKeys', JSON.stringify(geminiKeysToSave));
        
        const elevenLabsKey = document.getElementById('elevenLabsApiKey').value.trim();
        if (elevenLabsKey) {
            localStorage.setItem('elevenLabsApiKey', elevenLabsKey);
        } else {
            localStorage.removeItem('elevenLabsApiKey');
        }

        alert(t('alertApiKeysSaved'));
        loadApiKeys();
        populateElevenLabsVoices();
    }

    function loadApiKeys() {
        const savedGeminiKeys = localStorage.getItem('storybaliApiKeys');
        const defaultGeminiKeys = [DEFAULT_API_KEY_1, DEFAULT_API_KEY_2, DEFAULT_API_KEY_3, DEFAULT_API_KEY_4, DEFAULT_API_KEY_5, DEFAULT_API_KEY_6];
        apiKeys = savedGeminiKeys ? JSON.parse(savedGeminiKeys) : defaultGeminiKeys;
        apiKeys.forEach((key, i) => {
            const inputElement = document.getElementById(`apiKey${i + 1}`);
            if (inputElement) inputElement.value = key;
        });

        const savedElevenLabsKey = localStorage.getItem('elevenLabsApiKey');
        const elevenLabsInput = document.getElementById('elevenLabsApiKey');
        if (savedElevenLabsKey) {
            elevenLabsInput.value = savedElevenLabsKey;
        } else {
            elevenLabsInput.value = DEFAULT_ELEVENLABS_API_KEY;
        }
    }
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const isMobile = window.innerWidth <= 768;

        if (isMobile) {
            const isOpen = sidebar.classList.toggle('open');
            overlay.classList.toggle('active', isOpen);
        } else {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            settings.isSidebarOpen = !isCollapsed;
            saveSettings();
        }
    }
    function renderSidebar() {
        const historyList = document.getElementById('chatHistoryList');
        historyList.innerHTML = '';

        // [BARU] Daftar judul default dalam semua bahasa
        const defaultTitles = Object.values(translations).map(langPack => langPack.newConversation);

        [...allChatSessions].reverse().forEach(session => {
            const item = document.createElement('li');
            item.className = 'chat-history-item';
            item.dataset.chatId = session.id;

            // [BARU] Tampilkan judul yang sudah diterjemahkan jika judulnya adalah default
            let displayTitle = defaultTitles.includes(session.title) ? t('newConversation') : session.title;

            item.innerHTML = `
                <span class="title">${displayTitle}</span>
                <div class="actions">
                    <button onclick="renameChatSession('${session.id}', event)" class="action-icon" title="Ganti Nama">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                    </button>
                    <button onclick="deleteChatSession('${session.id}', event)" class="action-icon" title="Hapus Chat">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>`;
            item.addEventListener('click', () => {
                if(activeChatId !== session.id) {
                    loadChat(session.id);
                }
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
            historyList.appendChild(item);
        });
        updateSidebarActiveState();
    }
    function updateSidebarActiveState() {
        document.querySelectorAll('.chat-history-item').forEach(item => {
            item.classList.toggle('active', item.dataset.chatId === activeChatId);
        });
    }
    async function renameChatSession(chatId, event) {
        event.stopPropagation();
        const session = allChatSessions.find(s => s.id === chatId);
        if (!session) return; 
        const newTitle = prompt(t('promptRenameChat'), session.title);
        if (newTitle && newTitle.trim()) {
            session.title = newTitle.trim();
            saveAllChatSessions();
            renderSidebar();
        }
    }
    async function deleteChatSession(chatId, event) {
        event.stopPropagation();
        const confirmed = await showConfirmModal({
            title: t('confirmDeleteSingleTitle'),
            message: t('confirmDeleteSingleMsg'),
            confirmText: t('confirmDeleteSingleBtn'),
            cancelText: t('buttonCancel')
        });
        if (!confirmed) return;
        allChatSessions = allChatSessions.filter(s => s.id !== chatId);
        if (activeChatId === chatId) {
            if (allChatSessions.length > 0) {
                loadChat(allChatSessions[allChatSessions.length - 1].id);
            } else {
                startNewChat();
            }
        }
        saveAllChatSessions();
        renderSidebar();
    }
    function getActiveChatHistory() {
        if (!activeChatId) return null;
        const activeSession = allChatSessions.find(session => session.id === activeChatId);
        return activeSession ? activeSession.history : null;
    }
    function startNewChat() {
        const newChatId = `chat_${new Date().getTime()}`;
        const newSession = {
            id: newChatId,
            title: t('newConversation'), 
            history: [{
                role: 'model',
                parts: [{ text: t('initialGreeting') }],
                timestamp: new Date().toISOString()
            }]
        };
        allChatSessions.push(newSession);
        activeChatId = newChatId;
        saveAllChatSessions();
        renderSidebar();
        loadChat(activeChatId);
        document.querySelector('.quick-actions').style.display = 'flex';
        addSystemMessage(t('systemNewChat'), 'info');
    }
    function saveAllChatSessions() {
        if (settings.saveHistory) {
            const dataToSave = {
                sessions: allChatSessions,
                activeId: activeChatId
            };
            localStorage.setItem('storybaliChatSessions', JSON.stringify(dataToSave));
        }
    }
    function loadAllChatSessions() {
        if (!settings.saveHistory) {
            startNewChat();
            return;
        }
        const savedData = localStorage.getItem('storybaliChatSessions');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            allChatSessions = parsedData.sessions || [];
            activeChatId = parsedData.activeId || null;
            if (allChatSessions.length === 0 || !activeChatId || !allChatSessions.find(s => s.id === activeChatId)) {
                startNewChat();
            } else {
                renderSidebar();
                loadChat(activeChatId);
            }
        } else {
            startNewChat();
        }
    }
    function loadChat(chatId) {
        const session = allChatSessions.find(s => s.id === chatId);
        if (!session) return;
        activeChatId = chatId;
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = ''; 

        // [BARU] Logika untuk menampilkan/menyembunyikan saran cepat
        const quickActions = document.querySelector('.quick-actions');
        if (session.history.length <= 1) {
            quickActions.style.display = 'flex';
        } else {
            quickActions.style.display = 'none';
        }

        // [BARU] Logika untuk menerjemahkan sapaan awal secara dinamis
        const firstMessageText = session.history[0]?.parts[0]?.text;
        const isDefaultGreeting = firstMessageText && Object.values(translations).some(langPack => langPack.initialGreeting === firstMessageText);

        session.history.forEach((msg, index) => {
            let messageToRender = msg.parts[0].text;
            // Jika ini adalah pesan pertama dari AI dan merupakan sapaan standar, ganti dengan terjemahan yang benar.
            if (index === 0 && msg.role === 'model' && isDefaultGreeting) {
                messageToRender = t('initialGreeting');
            }
            addOriginalMessage(messageToRender, msg.role === 'user', msg.timestamp);
        });
        scrollToBottom();
        updateSidebarActiveState();
    }
    
    function addToConversationHistory(role, message) {
        const activeSession = allChatSessions.find(s => s.id === activeChatId);
        if (activeSession) {
            activeSession.history.push({
                role: role,
                parts: [{text: message}],
                timestamp: new Date().toISOString()
            });
            if (activeSession.history.length > 20) {
                activeSession.history.splice(1, 2); 
            }
            saveAllChatSessions();
        }
    }
    async function clearAllChatHistory() {
        const confirmed = await showConfirmModal({
            title: t('confirmDeleteAllTitle'),
            message: t('alertClearHistoryConfirm'),
            confirmText: t('confirmDeleteSingleBtn'),
            cancelText: t('buttonCancel')
        });
        if (confirmed) {
            allChatSessions = [];
            activeChatId = null;
            saveAllChatSessions();
            startNewChat();
            alert(t('alertClearHistorySuccess'));
        }
    }
    function exportChatHistory() {
        const activeHistory = getActiveChatHistory();
        if (!activeHistory || activeHistory.length <= 1) { 
            alert(t('alertExportEmpty'));
            return;
        }
        let exportText = `=== Wayan AI CHAT HISTORY (Sesi: ${activeChatId}) ===\n\n`;
        exportText += `Diekspor: ${new Date().toLocaleString('id-ID')}\n\n`;
        activeHistory.forEach((msg) => {
            const role = msg.role === 'user' ? 'Kamu' : 'Wayan AI';
            const text = msg.parts[0].text;
            const time = msg.timestamp ? `[${getFormattedTime(new Date(msg.timestamp))}]` : '';
            exportText += `${time} ${role}: ${text}\n\n`;
        });
        const blob = new Blob([exportText], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wayan-ai-chat-${activeChatId}-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert(t('alertExportSuccess'));
    }
    function toggleAnimations() {
        const isEnabled = document.getElementById('animationToggle').checked;
        settings.animationsEnabled = isEnabled;
        const styleId = 'animation-disable';
        let style = document.getElementById(styleId);
        if (!isEnabled && !style) {
            style = document.createElement('style');
            style.id = styleId;
            style.textContent = `*, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; animation-iteration-count: 1 !important; }`;
            document.head.appendChild(style);
        } else if (isEnabled && style) {
            style.remove();
        }
    }
    function sendQuickMessage(message) {
        document.getElementById('messageInput').value = message;
        handleInputChange({ target: document.getElementById('messageInput') });
        sendMessage();
    }
    // [PERBAIKAN] Fungsi ini diubah agar langsung membuka modal pengaturan
    function openQuickSettings() {
        // Memastikan modal terbuka dan mengarahkan ke halaman utama pengaturan
        if (document.getElementById('settingsModal').classList.contains('hidden')) toggleSettings();
        navigateToSettingsPage('main');
    }
    function toggleVoiceMode() {
        if (isRecording) {
            stopVoiceRecognition(false);
        } else {
            startVoiceRecognition();
        }
    }
    function startVoiceRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert(t('errorVoiceRecognition'));
            return;
        }
        finalTranscript = '';
        document.getElementById('messageInput').value = '';
        isRecording = true;

        const micBtn = document.getElementById('micBtn');
        micBtn.classList.add('send-btn-active');
        micBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V6a1 1 0 00-1-1H5z" clip-rule="evenodd"></path></svg>`;
        micBtn.title = t('stopGenerating');

        document.getElementById('messageInput').style.visibility = 'hidden';
        document.getElementById('voiceRecordingUI').style.display = 'flex';
        document.getElementById('voiceStatusText').textContent = t('listening');

        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = settings.language === 'id' ? 'id-ID' : 'en-US';
        recognition.onresult = (event) => {
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interim_transcript += transcript;
                }
            }
            const displayText = (finalTranscript + interim_transcript).trim();
            document.getElementById('voiceStatusText').textContent = displayText || t('listening');
        };
        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            if (event.error !== 'aborted') {
                addSystemMessage(t('errorSpeechRecog', { error: event.error }), 'warning');
            }
            stopVoiceRecognition(false);
        };
        recognition.onend = () => {
            if (isRecording) {
                stopVoiceRecognition(false);
            }
        };
        try {
            recognition.start();
        } catch (e) {
            console.error("Error starting speech recognition:", e);
            addSystemMessage(t('errorStartSpeechRecog'), 'warning');
            stopVoiceRecognition(false);
        }
    }
    function stopVoiceRecognition(isCancel = false) {
        if (!isRecording) return;
        
        const currentText = document.getElementById('voiceStatusText').textContent.trim();
        isRecording = false;
        if (recognition) {
            recognition.stop();
            recognition = null;
        }

        if (!isCancel && currentText && currentText !== t('listening')) {
            document.getElementById('messageInput').value = currentText;
            finalTranscript = currentText;
        } else {
            document.getElementById('messageInput').value = '';
            finalTranscript = '';
        }

        const micBtn = document.getElementById('micBtn');
        micBtn.classList.remove('send-btn-active');
        micBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`;
        micBtn.title = t('voiceModeTitle');

        document.getElementById('messageInput').style.visibility = 'visible';
        document.getElementById('voiceRecordingUI').style.display = 'none';
        handleInputChange({ target: document.getElementById('messageInput') });
    }
    
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        settings.darkMode = isDark;
        const header = document.querySelector('.header-gradient');
        const sendBtn = document.getElementById('sendBtn');
        const aiAvatars = document.querySelectorAll('.ai-avatar');
        const profileAvatarBorder = document.querySelector('.profile-avatar-border');
        if (isDark) {
            if (header) {
                header.style.background = ''; // Hapus style inline agar style CSS mode gelap berlaku
            }
            if (sendBtn) sendBtn.style.backgroundColor = '';
            if (profileAvatarBorder) profileAvatarBorder.style.borderImage = '';
            aiAvatars.forEach(avatar => { avatar.style.background = ''; });
        } else {
            // Saat kembali ke mode terang, style dari CSS akan otomatis berlaku
            // karena tidak ada lagi fungsi changeTheme yang memberikan style inline
            // Pastikan style default (biru) sudah ada di CSS
        }
    }

    function handleDarkModeToggle() {
        const isChecked = document.getElementById('darkModeToggle').checked;
        applyDarkMode(isChecked);
        saveSettings();
    }
    
    // [DIUBAH] Fungsi ini sekarang menggunakan CSS variables dan class untuk menerapkan efek
    function applyCustomBackground() {
        const chatContainer = document.querySelector('.chat-container');
        
        // Hapus semua class terkait latar belakang kustom
        chatContainer.classList.remove(
            'custom-background', 
            'background-blur-light', 
            'background-blur-strong',
            'background-size-cover',
            'background-size-contain'
        );
        chatContainer.style.setProperty('--custom-bg-url', 'none');

        if (settings.backgroundUrl) {
            chatContainer.classList.add('custom-background');
            chatContainer.style.setProperty('--custom-bg-url', `url('${settings.backgroundUrl}')`);

            // Terapkan ukuran
            if (settings.backgroundSize === 'contain') {
                chatContainer.classList.add('background-size-contain');
            } else {
                chatContainer.classList.add('background-size-cover');
            }

            // Terapkan blur
            if (settings.backgroundBlur === 'light') {
                chatContainer.classList.add('background-blur-light');
            } else if (settings.backgroundBlur === 'strong') {
                chatContainer.classList.add('background-blur-strong');
            }
        } else {
            // Jika tidak ada background, pastikan warna default kembali
            chatContainer.style.background = '';
        }
    }

    function handleBackgroundUpload(event) {
        const file = event.target.files[0];
        const fileNameDisplay = document.getElementById('backgroundFileName');
        const previewWrapper = document.getElementById('backgroundPreviewWrapper'); // [DIUBAH] Nama variabel disesuaikan

        if (file) {
            if (!file.type.startsWith('image/')) {
                alert(t('alertImageInvalid'));
                event.target.value = '';
                fileNameDisplay.textContent = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                const base64Image = e.target.result;
                tempSettings.backgroundUrl = base64Image;

                // [DIUBAH] Tampilkan wrapper pratinjau dan reset efek
                previewWrapper.classList.remove('hidden');
                fileNameDisplay.textContent = file.name;
                
                // Reset efek pratinjau ke default saat gambar baru diunggah
                tempSettings.backgroundBlur = 'none';
                tempSettings.backgroundSize = 'cover';
                updatePreviewEffects();
                applyPreviewBackground(); // [DIUBAH] Terapkan pratinjau langsung ke latar utama
            };
            reader.readAsDataURL(file);
        }
    }

    function removeCustomBackground() {
        tempSettings.backgroundUrl = '';
        document.getElementById('backgroundFileInput').value = '';
        document.getElementById('backgroundFileName').textContent = '';
        document.getElementById('backgroundPreviewWrapper').classList.add('hidden'); // [DIUBAH] Sembunyikan wrapper
        applyPreviewBackground(); // [DIUBAH] Terapkan pratinjau langsung (menghapus latar)
    }

    function loadSettingsData() {
        const savedSettings = localStorage.getItem('storybaliSettings');
        if (savedSettings) {
             settings = { ...defaultSettings, ...JSON.parse(savedSettings) };
        } else {
            // Set default language based on browser preference
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            settings = { ...defaultSettings, darkMode: prefersDark };
        }
    }
    function saveSettings() {
        localStorage.setItem('storybaliSettings', JSON.stringify(settings));
    }
    function saveAllSettings() {
        settings.customAiRolePrompt = document.getElementById('customRoleInput').value;
        settings.fontSize = document.getElementById('fontSizeSelect').value;
        settings.animationsEnabled = document.getElementById('animationToggle').checked;
        settings.soundEnabled = document.getElementById('soundToggle').checked;
        settings.readAiResponseEnabled = document.getElementById('readAiResponseToggle').checked;
        settings.voiceURI = document.getElementById('voiceSelect').value;
        settings.audioSource = document.querySelector('.choice-btn[id^="audioSource-"].active').id.split('-')[1];
        settings.elevenLabsVoiceId = document.getElementById('elevenLabsVoiceSelect').value;
        settings.saveHistory = document.getElementById('saveHistoryToggle').checked;
        settings.darkMode = document.getElementById('darkModeToggle').checked;
        settings.backgroundUrl = tempSettings.backgroundUrl;
        settings.backgroundBlur = tempSettings.backgroundBlur; // [BARU] Simpan pengaturan blur
        settings.backgroundSize = tempSettings.backgroundSize; // [BARU] Simpan pengaturan ukuran

        saveSettings(); 
        applySettings(); 
        alert(t('alertSettingsSaved'));
        toggleSettings();
    }
    async function resetAllSettings() {
        const confirmed = await showConfirmModal({
            title: t('confirmResetTitle'),
            message: t('alertResetConfirm'),
            confirmText: t('confirmResetBtn'),
            cancelText: t('buttonCancel')
        });
        if (confirmed) {
            localStorage.removeItem('storybaliSettings');
            localStorage.removeItem('storybaliApiKeys');
            localStorage.removeItem('elevenLabsApiKey');
            localStorage.removeItem('storybaliChatSessions');
            localStorage.removeItem('onboardingShown');
            alert(t('alertResetSuccess'));
            window.location.reload();
        }
    }
    function applySettings() {
        document.getElementById('darkModeToggle').checked = settings.darkMode;
        applyDarkMode(settings.darkMode);
        const sidebar = document.getElementById('sidebar');
        const fontSizeOptions = {
            sm: 'fontSmall',
            base: 'fontNormal',
            lg: 'fontLarge'
        };
        document.getElementById('fontSizeSelect').innerHTML = Object.keys(fontSizeOptions).map(key => `<option value="${key}" ${settings.fontSize === key ? 'selected' : ''}>${t(fontSizeOptions[key])}</option>`).join('');
        const overlay = document.getElementById('sidebarOverlay');
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        } else {
            sidebar.classList.toggle('collapsed', !settings.isSidebarOpen);
        }
        applyTranslations(settings.language);
        document.querySelector('.header-gradient h1').textContent = 'Wayan AI';
        document.getElementById('aiNameInput').value = 'Wayan';
        
        document.getElementById('fontSizeSelect').value = settings.fontSize;
        document.getElementById('animationToggle').checked = settings.animationsEnabled;
        toggleAnimations();
        document.getElementById('soundToggle').checked = settings.soundEnabled;
        document.getElementById('readAiResponseToggle').checked = settings.readAiResponseEnabled;
        document.getElementById('saveHistoryToggle').checked = settings.saveHistory;
        
        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`language-${settings.language || 'id'}`)?.classList.add('active');
        document.getElementById(`personality-${settings.personality}`)?.classList.add('active');
        document.getElementById(`aiRole-${settings.aiRole}`)?.classList.add('active');
        document.getElementById(`audioSource-${settings.audioSource}`)?.classList.add('active');
        
        const customRoleContainer = document.getElementById('customRoleContainer');
        customRoleContainer.classList.toggle('hidden', settings.aiRole !== 'kustom');
        if (settings.aiRole === 'kustom') document.getElementById('customRoleInput').value = settings.customAiRolePrompt;
        
        const voiceSelect = document.getElementById('voiceSelect');
        if (settings.voiceURI && voiceSelect.options.length > 1) voiceSelect.value = settings.voiceURI;

        const elevenLabsSelect = document.getElementById('elevenLabsVoiceSelect');
        if (settings.elevenLabsVoiceId && elevenLabsSelect.options.length > 1) {
            elevenLabsSelect.value = settings.elevenLabsVoiceId;
        }
        
        applyCustomBackground();
    }
    function updateSettingsSummary() {
        // Update Language Summary
        const langMap = { id: 'langIndonesian', en: 'langEnglish', ja: 'langJapanese' };
        document.getElementById('currentLanguage').textContent = t(langMap[settings.language]);

        // Update Personality Summary
        const personalityMap = { santai: 'personalityCasual', profesional: 'personalityProfessional', lucu: 'personalityHumorous' };
        document.getElementById('currentPersonality').textContent = t(personalityMap[settings.personality]);

        // Update AI Role Summary
        const roleMap = {
            umum: 'roleGeneral', guru_jepang: 'roleJapaneseTeacher', guru_matematika: 'roleMathTeacher',
            dokter: 'roleDoctor', programmer: 'roleProgrammer', penerjemah: 'roleTranslator', kustom: 'roleCustom'
        };
        document.getElementById('currentAiRole').textContent = t(roleMap[settings.aiRole]);

        // Update Background Summary
        document.getElementById('currentBackground').textContent = settings.backgroundUrl ? t('backgroundFileSet') : 'Default';

        // Update Audio Source Summary
        const audioMap = { browser: 'audioSourceBrowser', elevenlabs: 'audioSourceElevenLabs' };
        document.getElementById('currentAudioSource').textContent = t(audioMap[settings.audioSource]);
    }

    function populateSettingsForm() {
        // Populate form controls from tempSettings
        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`language-${tempSettings.language || 'id'}`)?.classList.add('active');
        document.getElementById(`personality-${tempSettings.personality}`)?.classList.add('active');
        document.getElementById(`aiRole-${tempSettings.aiRole}`)?.classList.add('active');
        document.getElementById(`audioSource-${tempSettings.audioSource}`)?.classList.add('active');

        // [BARU] Menetapkan status 'checked' untuk radio button
        document.querySelector(`input[name="languageToggle"][value="${tempSettings.language}"]`).checked = true;
        document.querySelector(`input[name="personalityToggle"][value="${tempSettings.personality}"]`).checked = true;
        document.querySelector(`input[name="aiRoleToggle"][value="${tempSettings.aiRole}"]`).checked = true;

        
        const customRoleContainer = document.getElementById('customRoleContainer');
        customRoleContainer.classList.toggle('hidden', tempSettings.aiRole !== 'kustom');
        if (tempSettings.aiRole === 'kustom') {
            document.getElementById('customRoleInput').value = tempSettings.customAiRolePrompt;
        }

        document.getElementById('fontSizeSelect').value = tempSettings.fontSize;
        document.getElementById('animationToggle').checked = tempSettings.animationsEnabled;
        document.getElementById('darkModeToggle').checked = tempSettings.darkMode;
        document.getElementById('soundToggle').checked = tempSettings.soundEnabled;
        document.getElementById('readAiResponseToggle').checked = tempSettings.readAiResponseEnabled;
        document.getElementById('saveHistoryToggle').checked = tempSettings.saveHistory;

        const voiceSelect = document.getElementById('voiceSelect');
        if (tempSettings.voiceURI) voiceSelect.value = tempSettings.voiceURI;

        const elevenLabsSelect = document.getElementById('elevenLabsVoiceSelect');
        if (tempSettings.elevenLabsVoiceId) elevenLabsSelect.value = tempSettings.elevenLabsVoiceId;

        // [FIX] Show background file status from tempSettings when modal is open
        const fileNameDisplay = document.getElementById('backgroundFileName');
        if (fileNameDisplay) {
            fileNameDisplay.textContent = tempSettings.backgroundUrl ? t('backgroundFileSet') : '';
        }
        const previewWrapper = document.getElementById('backgroundPreviewWrapper'); // [DIUBAH] Nama variabel disesuaikan
        if (tempSettings.backgroundUrl) {
            previewWrapper.classList.remove('hidden');
            updatePreviewEffects();
            applyPreviewBackground(); // Terapkan juga ke latar utama
        } else {
            previewWrapper.classList.add('hidden');
        }

        document.getElementById('backgroundFileInput').value = ''; // Reset file input
        updateSettingsSummary();
    }

    function selectChoice(settingName, value, element) {
        settings[settingName] = value;
        
        // [DIUBAH] Logika untuk menangani 'active' class pada tombol dan item
        if (element.classList.contains('toggle-radio')) {
            // Tidak perlu menghapus 'active' karena radio button sudah menanganinya
            // Cukup tambahkan 'active' ke item yang dipilih
            element.classList.add('active');
        } else if (element.classList.contains('settings-item')) {
            element.classList.add('active');
        }

        // [DIUBAH] Logika notifikasi sistem dipindahkan ke sini agar lebih terpusat
        if (settingName === 'aiRole') {
            document.getElementById('customRoleContainer').classList.toggle('hidden', value !== 'kustom');
            const roleKeyMap = { 'umum': 'roleGeneral', 'guru_jepang': 'roleJapaneseTeacher', 'guru_matematika': 'roleMathTeacher', 'dokter': 'roleDoctor', 'programmer': 'roleProgrammer', 'penerjemah': 'roleTranslator', 'kustom': 'roleCustom' };
            const roleNameKey = roleKeyMap[value];
            if (roleNameKey) addSystemMessage(t('systemRoleChanged', { roleName: t(roleNameKey) }), 'info');
        }
        if (settingName === 'personality') {
            const personalityKeyMap = { 'santai': 'personalityCasual', 'profesional': 'personalityProfessional', 'lucu': 'personalityHumorous' };
            const personalityNameKey = personalityKeyMap[value];
            if (personalityNameKey) {
                addSystemMessage(t('systemPersonalityChanged', { personalityName: t(personalityNameKey) }), 'info');
            }
        }
        // [PERBAIKAN] Menerapkan terjemahan secara langsung saat bahasa diubah.
        if (settingName === 'language') {
            applyTranslations(value);
            // Perbarui juga ringkasan di halaman utama pengaturan
            updateSettingsSummary();
        }
    }
    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        if (modal.classList.contains('hidden')) {
            tempSettings = JSON.parse(JSON.stringify(settings)); // Deep copy
            populateSettingsForm();
            navigateToSettingsPage('main'); // Selalu mulai dari halaman utama
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
            // Revert visual changes if settings are not saved
            applyCustomBackground();
        }
    }
    function showProfileModal() { document.getElementById('profileModal').classList.remove('hidden'); }
    function hideProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }

    // ▼▼▼ [BARU] FUNGSI UNTUK MODAL KONFIRMASI KUSTOM ▼▼▼
    let confirmModalResolver = null;

    // ▼▼▼ [DIUBAH] FUNGSI UNTUK MENGONTROL PRATINJAU LATAR BELAKANG ▼▼▼
    function applyPreviewBackground() {
        const chatContainer = document.querySelector('.chat-container');
        
        chatContainer.classList.remove(
            'custom-background', 
            'background-blur-light', 
            'background-blur-strong',
            'background-size-cover',
            'background-size-contain'
        );
        chatContainer.style.setProperty('--custom-bg-url', 'none');

        if (tempSettings.backgroundUrl) {
            chatContainer.classList.add('custom-background');
            chatContainer.style.setProperty('--custom-bg-url', `url('${tempSettings.backgroundUrl}')`);

            if (tempSettings.backgroundSize === 'contain') {
                chatContainer.classList.add('background-size-contain');
            } else {
                chatContainer.classList.add('background-size-cover');
            }

            if (tempSettings.backgroundBlur === 'light') {
                chatContainer.classList.add('background-blur-light');
            } else if (tempSettings.backgroundBlur === 'strong') {
                chatContainer.classList.add('background-blur-strong');
            }
        } else {
            chatContainer.style.background = '';
        }
    }

    // [DIUBAH] Fungsi baru untuk mengatur level blur dari tombol pilihan
    function setPreviewBlur(level) {
        tempSettings.backgroundBlur = level;
        updatePreviewEffects();
        applyPreviewBackground();
    }

    // [DIUBAH] Fungsi baru untuk mengatur ukuran dari tombol pilihan
    function setPreviewSize(size) {
        tempSettings.backgroundSize = size;
        updatePreviewEffects();
        applyPreviewBackground();
    }

    function updatePreviewEffects() {
        const previewElements = document.querySelectorAll('.preview-background'); // [DIUBAH] Targetkan semua pane pratinjau
        const blurValues = { none: 'blur(0px)', light: 'blur(4px)', strong: 'blur(10px)' };

        previewElements.forEach(el => {
            el.style.backgroundImage = `url('${tempSettings.backgroundUrl}')`;
            el.style.filter = blurValues[tempSettings.backgroundBlur];
            el.style.backgroundSize = tempSettings.backgroundSize;
            el.style.backgroundPosition = 'center';
        });

        // [DIUBAH] Update kelas 'active' untuk tombol pilihan blur
        document.querySelectorAll('[id^="blurBtn"]').forEach(btn => btn.classList.remove('active'));
        const activeBlurBtnId = `blurBtn${tempSettings.backgroundBlur.charAt(0).toUpperCase() + tempSettings.backgroundBlur.slice(1)}`;
        document.getElementById(activeBlurBtnId)?.classList.add('active');

        // [DIUBAH] Update kelas 'active' untuk tombol pilihan ukuran
        document.querySelectorAll('[id^="sizeBtn"]').forEach(btn => btn.classList.remove('active'));
        const activeSizeBtnId = `sizeBtn${tempSettings.backgroundSize.charAt(0).toUpperCase() + tempSettings.backgroundSize.slice(1)}`;
        document.getElementById(activeSizeBtnId)?.classList.add('active');
    }

    function showConfirmModal({ title, message, confirmText = 'Confirm', cancelText = 'Cancel', confirmClass = 'bg-red-600 hover:bg-red-700 text-white' }) {
        return new Promise(resolve => {
            confirmModalResolver = resolve;

            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').innerHTML = message;

            const confirmBtn = document.getElementById('confirmModalConfirmBtn');
            confirmBtn.textContent = confirmText;
            confirmBtn.className = `settings-btn-action text-sm py-2 ${confirmClass}`;

            const cancelBtn = document.getElementById('confirmModalCancelBtn');
            cancelBtn.textContent = cancelText;

            document.getElementById('confirmModal').classList.remove('hidden');
        });
    }

    function handleConfirm(confirmed) {
        if (confirmModalResolver) {
            confirmModalResolver(confirmed);
        }
        document.getElementById('confirmModal').classList.add('hidden');
        confirmModalResolver = null;
    }

    // ▼▼▼ [BARU] Fungsi untuk memperbarui UI berdasarkan status login ▼▼▼
    function updateUIForAuthState() {
        const loginContainer = document.getElementById('loginContainer');
        const userInfoContainer = document.getElementById('userInfoContainer');

        if (currentUser) {
            // Pengguna sudah login
            loginContainer.classList.add('hidden');
            userInfoContainer.classList.remove('hidden');
            userInfoContainer.classList.add('flex');
            document.getElementById('userAvatar').src = currentUser.photoURL || 'favicon-96x96.png';
            document.getElementById('userName').textContent = currentUser.displayName || 'Pengguna';
            // [FIX] Tombol "Tambah Story" hanya dirender jika sudah login.
            renderAddStoryButton();
        } else {
            // Pengguna belum login
            loginContainer.classList.remove('hidden');
            userInfoContainer.classList.add('hidden');
            renderAddStoryButton(); // Tetap render tombolnya, fungsinya akan mengarahkan ke login.
        }
        // [FIX] Panggil listener story di sini, SETELAH UI diperbarui, agar semua bisa melihat story.
        listenForStories();
    }    
	// ▼▼▼ [FIX] Menambahkan fungsi toggleSearchMode yang hilang ▼▼▼
    function toggleSearchMode() {
        isSearchModeActive = !isSearchModeActive;
        const btn = document.getElementById('toggleSearchModeBtn');
        btn.classList.toggle('active', isSearchModeActive);
        if (isSearchModeActive) {
            addSystemMessage(t('systemSearchModeOn'), 'info');
        } else {
            addSystemMessage(t('systemSearchModeOff'), 'info');
        }
    }
    function showSearchModal(query) {
        const modal = document.getElementById('searchModal');
        const title = document.getElementById('searchModalTitle');
        const iframe = document.getElementById('searchFrame');

        title.textContent = `Hasil Pencarian: "${query}"`;
        // Parameter &igu=1 penting agar Google bisa disematkan
        iframe.src = `https://www.google.com/search?q=${encodeURIComponent(query)}&igu=1`;
        
        modal.classList.remove('hidden');
    }

    function hideSearchModal() {
        const modal = document.getElementById('searchModal');
        modal.classList.add('hidden');
        document.getElementById('searchFrame').src = 'about:blank'; // Hentikan loading
    }
    function openSearchInNewTab() {
        const iframe = document.getElementById('searchFrame');
        const url = iframe.src;
        if (url && url !== 'about:blank') {
            window.open(url, '_blank');
        }
    }
    function triggerImageUpload() { document.getElementById('imageInput').click(); }
    // [BARU] Fungsi untuk memicu unggahan file
    function triggerFileUpload() { document.getElementById('fileInput').click(); }

    // ▼▼▼ [DIUBAH] Logika handleFileUpload dirombak total ▼▼▼
    function handleFileUpload(event, fileType) {
        const file = event.target.files[0];
        if (!file) { event.target.value = ''; return; }

        // Hapus file yang mungkin sudah ada sebelumnya
        removeAttachedFile();

        const reader = new FileReader();
        reader.onload = e => {
            attachedFileData = {
                content: e.target.result, // base64 untuk gambar, teks untuk file
                fileName: file.name,
                mimeType: file.type,
                type: fileType // 'image' atau 'file'
            };
            showFilePreview(file.name, fileType, e.target.result);
        };
        reader.onerror = () => addSystemMessage(`Gagal membaca file ${file.name}.`, 'warning');

        if (fileType === 'image') {
            if (!file.type.startsWith('image/')) {
                alert(t('alertImageInvalid'));
                event.target.value = ''; return;
            }
            reader.readAsDataURL(file); // Baca sebagai Base64
        } else { // Menangani file teks
            reader.readAsText(file); // Baca sebagai Teks
        }
        event.target.value = ''; // Reset input agar file yang sama bisa diunggah lagi
    }

    // [DIUBAH] Fungsi untuk menampilkan chip pratinjau file atau gambar
    function showFilePreview(fileName, fileType, content) {
        const container = document.getElementById('filePreviewContainer');
        let previewChipHTML = '';

        if (fileType === 'image') {
            previewChipHTML = `
                <div class="file-preview-chip image-preview-chip">
                    <img src="${content}" alt="Preview ${fileName}">
                    <span class="truncate max-w-[200px]">${fileName}</span>
                    <button onclick="removeAttachedFile()" class="w-6 h-6 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 remove-file-btn text-lg font-bold leading-none flex-shrink-0" title="Hapus file">&times;</button>
                </div>`;
        } else {
            previewChipHTML = `
                <div class="file-preview-chip">
                    <svg class="w-5 h-5 text-gray-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    <span class="truncate max-w-[200px]">${fileName}</span>
                    <button onclick="removeAttachedFile()" class="w-6 h-6 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 remove-file-btn text-lg font-bold leading-none flex-shrink-0" title="Hapus file">&times;</button>
                </div>`;
        }
        
        container.innerHTML = previewChipHTML;
        container.style.display = 'flex';
        document.getElementById('messageInput').focus();
    }

    // [BARU] Fungsi untuk menghapus file yang di-attach
    function removeAttachedFile() {
        attachedFileData = { content: null, fileName: null, mimeType: null, type: 'file' };
        const container = document.getElementById('filePreviewContainer');
        container.style.display = 'none';
        container.innerHTML = '';
    }

    // ▲▲▲ AKHIR DARI PERUBAHAN LOGIKA UPLOAD FILE ▲▲▲

    function addImageMessageWithQuestion(imageSrc, fileName, question, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        if (isUser) {
            const timeString = getFormattedTime(new Date());
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="user-message text-white p-4 max-w-xs">
                    <img src="${imageSrc}" alt="${fileName}" class="w-full h-auto rounded-lg mb-2 max-h-32 object-cover">
                    <p class="text-xs mb-2 opacity-90">${fileName}</p>
                    <div class="bg-white bg-opacity-20 rounded-lg p-2"><p class="text-sm font-medium">${question}</p></div>
                    <div class="chat-timestamp text-right">${timeString}</div>
                </div>`;

            const messageForHistory = `[Gambar: ${fileName}] ${question}`;
            addToConversationHistory('user', messageForHistory);

            const allUserData = getChatLimitData();
            const userData = allUserData[currentUserIP] || { count: 0 };
            userData.count++;
            saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
            if (userData.count >= CHAT_LIMIT) {
                const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
                userData.cooldownUntil = cooldownEndTime;
                saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
                startCooldown(cooldownEndTime);
            }
        }
        chatMessages.insertBefore(messageDiv, document.getElementById('typingIndicator'));
        scrollToBottom();
    }
    function handleKeyPress(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
    function addSystemMessage(message, type = 'info') {
        const icons = {
            info: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>`,
            success: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`,
            warning: `<svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.214 2.43-1.214 3.066 0l5.516 10.52c.636 1.214-.26 2.74-1.533 2.74H4.274c-1.274 0-2.169-1.526-1.533-2.74l5.516-10.52zM9 13a1 1 0 112 0 1 1 0 01-2 0zm1-4a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>`
        };
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'system-message-bubble';
        messageDiv.innerHTML = `<div class="system-message ${type}">${icons[type] || ''}<span>${message}</span></div>`;
        chatMessages.insertBefore(messageDiv, document.getElementById('typingIndicator'));
        scrollToBottom();
    }
    function typewriterEffect(element, text, callback) {
        let i = 0;
        element.innerHTML = "";
        function type() {
            if (i < text.length) {
                let char = text.charAt(i);
                let nextChunk = char;
                if (text.substring(i, i + 3) === '```') {
                    let endBlock = text.indexOf('```', i + 3);
                    if (endBlock !== -1) { nextChunk = text.substring(i, endBlock + 3); i = endBlock + 2; }
                } else if (char === '*' && text.charAt(i + 1) === '*') {
                     let endBold = text.indexOf('**', i + 2);
                     if(endBold !== -1) { nextChunk = text.substring(i, endBold + 2); i = endBold + 1; }
                }
                element.innerHTML += nextChunk.replace(/\n/g, '<br>');
                i++;
                if (i % 10 === 0) scrollToBottom();
                setTimeout(type, 20);
            } else if (callback) {
                callback();
            }
        }
        type();
    }
    function addMessage(message, isUser = false, suggestions = [], isSearchable = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble';
        const typingIndicator = document.getElementById('typingIndicator');
        const timeString = getFormattedTime(new Date());

        if (isUser) {
            // [DIUBAH] Flex ditambahkan di sini khusus untuk user
            messageDiv.className += ' flex items-start space-x-3 flex-row-reverse space-x-reverse user';
            
            const searchButtonHtml = isSearchable ? `
                <div class="mt-2 text-right">
                    <button onclick="showSearchModal('${message.replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" class="inline-flex items-center gap-1.5 text-xs px-2 py-1 rounded-full bg-white bg-opacity-20 hover:bg-opacity-30 transition-all no-underline" style="color: white; text-decoration: none; cursor: pointer; border: none;">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
                        <span data-translate-key="searchOnGoogle">Cari di Google</span>
                    </button>
                </div>
            ` : '';

            messageDiv.innerHTML = `
                <div class="user-message text-white p-4 max-w-xs">
                    <p class="leading-relaxed text-sm">${message.replace(/\n/g, '<br>')}</p>
                    ${searchButtonHtml}
                    <div class="chat-timestamp text-right">${timeString}</div>
                </div>`;
            chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
            const encodedMessage = btoa(encodeURIComponent(message));
            messageDiv.className += ' ai';
            // [DIUBAH] Struktur HTML pesan AI dirombak total
            messageDiv.innerHTML = `
                <div class="flex items-center space-x-3 mb-2">
                    <div onclick="showProfileModal()" class="ai-avatar w-8 h-8 flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                        <img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="Wayan AI" class="w-full h-full object-cover">
                    </div>
                    <div class="font-bold text-sm" style="color: var(--text-primary);">Wayan AI</div>
                </div>
                <div>
                    <div class="ai-message">
                        <div class="markdown-content leading-relaxed text-base"></div>
                        <div class="suggestions-container mt-3"></div>
                    <!-- ▼▼▼ [BARU] Placeholder untuk TTS Player ▼▼▼ -->
                    <div class="tts-player">
                        <div class="tts-status">
                            <div class="tts-wave" style="gap: 3px;">
                                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                            </div>
                            <span class="tts-text" data-translate-key="readingText">Membacakan...</span>
                        </div>
                        <button class="stop-tts-btn" onclick="stopReading()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V6a1 1 0 00-1-1H5z" clip-rule="evenodd"></path></svg>
                        </button>
                    </div>
                    <!-- ▲▲▲ AKHIR DARI TTS PLAYER ▲▲▲ -->
                        <!-- [FIX] Tombol aksi dipindahkan ke dalam gelembung -->
                        <div class="ai-message-footer">
                            <div class="chat-timestamp text-xs">${timeString}</div>
                            <button onclick="copyToClipboard(this.closest('.message-bubble').querySelector('.markdown-content').innerText, this)" class="action-icon-ai" data-translate-title="copyAnswer">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                            </button>
                            <button onclick="readAiResponse(this)" class="action-icon-ai" data-translate-title="readAnswer">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                            </button>
                            <button onclick="handleRating(this, 'like')" class="action-icon-ai" data-translate-title="likeResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg>
                            </button>
                            <button onclick="handleRating(this, 'dislike')" class="action-icon-ai" data-translate-title="dislikeResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14-.47-.14-.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41-.17-.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"></path></svg>
                            </button>
                            <button onclick="regenerateResponse(this)" class="action-icon-ai" data-translate-title="regenerateResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></svg>
                            </button>
                            <button onclick="shareResponse(this)" class="action-icon-ai" data-translate-title="shareResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
            chatMessages.insertBefore(messageDiv, typingIndicator);
            // [DIUBAH] Kembalikan elemen untuk diisi oleh proses streaming
            return {
                contentEl: messageDiv.querySelector('.markdown-content'),
                suggestionsEl: messageDiv.querySelector('.suggestions-container')
            };
        }
        scrollToBottom();
    }
    function addOriginalMessage(message, isUser = false, timestamp) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble';
        const timeString = timestamp ? getFormattedTime(new Date(timestamp)) : '';
        const imageMatch = message.match(/^\[Gambar: (.*?)\] (.*)/);
        const callMatch = message.match(/^\[TRANSKRIP PANGGILAN SUARA\]\n([\s\S]*)/);

        if (isUser) {
            // [DIUBAH] Flex ditambahkan di sini khusus untuk user
            messageDiv.className += ' flex items-start space-x-3 flex-row-reverse space-x-reverse user';
            const timeHtml= timeString ? `<div class="chat-timestamp text-right">${timeString}</div>` : '';
            
            let messageContent = '';
            if (imageMatch) {
                messageContent = `<div class="bg-white bg-opacity-20 rounded-lg p-2">
                                    <p class="text-xs mb-1 opacity-90">🖼️ ${imageMatch[1]}</p>
                                    <p class="text-sm font-medium">${imageMatch[2]}</p>
                                  </div>`;
            } else if(callMatch) {
                 messageContent = `<div class="text-left text-sm">
                                    <p class="font-bold mb-2">📞 Transkrip Panggilan</p>
                                    <pre class="whitespace-pre-wrap text-xs bg-black bg-opacity-20 p-2 rounded">${callMatch[1]}</pre>
                                  </div>`;
            }
            else {
                messageContent = `<div class="leading-relaxed text-sm">${message.replace(/\n/g, '<br>')}</div>`;
            }

            messageDiv.innerHTML = `
                <div class="user-message text-white p-4 max-w-xs">
                    ${messageContent}
                    ${timeHtml}
                </div>`;
        } else {
            // [FIX] encodedMessage dihapus karena teks akan diambil secara dinamis saat tombol diklik.
            messageDiv.className += ' ai';
            // [DIUBAH] Struktur HTML pesan AI dirombak total
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-3 mb-2">
                    <div onclick="showProfileModal()" class="ai-avatar w-8 h-8 flex-shrink-0 flex items-center justify-center overflow-hidden cursor-pointer">
                        <img src="https://github.com/wayanku/Wayan-ai-dari-storybali/blob/main/foto%20semua.webp?raw=true" alt="Wayan AI" class="w-full h-full object-cover">
                    </div>
                    <div class="font-bold text-sm" style="color: var(--text-primary);">Wayan AI</div>
                </div>
                <div>
                    <div class="ai-message">
                        <div class="markdown-content leading-relaxed text-base">${marked.parse(message)}</div>
                        <!-- ▼▼▼ [BARU] Placeholder untuk TTS Player ▼▼▼ -->
                        <div class="tts-player">
                            <div class="tts-status">
                                <div class="tts-wave" style="gap: 3px;">
                                    <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                                </div>
                                <span class="tts-text" data-translate-key="readingText">Membacakan...</span>
                            </div>
                            <button class="stop-tts-btn" onclick="stopReading()">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V6a1 1 0 00-1-1H5z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                        <!-- ▲▲▲ AKHIR DARI TTS PLAYER ▲▲▲ -->
                        <div class="suggestions-container mt-3"></div>
                        <!-- [FIX] Tombol aksi dipindahkan ke dalam gelembung -->
                        <div class="ai-message-footer">
                            ${timeString ? `<div class="chat-timestamp text-xs">${timeString}</div>` : ''}
                            <button onclick="copyToClipboard(this.closest('.message-bubble').querySelector('.markdown-content').innerText, this)" class="action-icon-ai" aria-label="Salin Jawaban" data-translate-title="copyAnswer">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"></path></svg>
                            </button>
                            <button onclick="readAiResponse(this)" class="action-icon-ai" aria-label="Baca Jawaban" data-translate-title="readAnswer">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                            </button>
                            <button onclick="handleRating(this, 'like')" class="action-icon-ai" aria-label="Suka jawaban ini" data-translate-title="likeResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.59 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"></path></svg>
                            </button>
                            <button onclick="handleRating(this, 'dislike')" class="action-icon-ai" aria-label="Tidak suka jawaban ini" data-translate-title="dislikeResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14-.47-.14-.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41-.17-.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"></path></svg>
                            </button>
                            <button onclick="regenerateResponse(this)" class="action-icon-ai" aria-label="Buat ulang jawaban" data-translate-title="regenerateResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"></path></svg>
                            </button>
                            <button onclick="shareResponse(this)" class="action-icon-ai" aria-label="Bagikan jawaban" data-translate-title="shareResponse">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        chatMessages.appendChild(messageDiv);
        // [BARU] Tambahkan tombol salin ke blok kode dari riwayat
        const markdownContent = messageDiv.querySelector('.markdown-content');
        if (markdownContent) {
            enhanceCodeBlocks(markdownContent);
        }
    }
    function renderSuggestions(suggestionsArray) {
        if (suggestionsArray && suggestionsArray.length > 0) {
            return `<div class="flex flex-wrap gap-2 mt-2">${suggestionsArray.map(s => `<button onclick="sendQuickMessage('${s.replace(/'/g, "\\'")}')" class="suggestion-btn">${s}</button>`).join('')}</div>`;
        }
        return '';
    }
    function showTypingIndicator() { document.getElementById('typingIndicator')?.classList.add('show'); scrollToBottom(); }
    function hideTypingIndicator() { document.getElementById('typingIndicator')?.classList.remove('show'); }
    function showImageProcessingIndicator() { document.getElementById('imageProcessingIndicator')?.classList.add('show'); scrollToBottom(); }
    function hideImageProcessingIndicator() { document.getElementById('imageProcessingIndicator')?.classList.remove('show'); }
    
    // ▼▼▼ [DIUBAH] Logika Scroll dan Notifikasi Pesan Baru ▼▼▼
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        setTimeout(() => chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' }), 100);
    }

    function forceScrollToBottom() {
        scrollToBottom();
        document.getElementById('newMessageNotification').classList.add('hidden');
    }

    function showNewMessageNotification() {
        // Hanya tampilkan notifikasi jika pengguna telah scroll ke atas, ATAU jika jendela tidak aktif
        if (userHasScrolledUp || !isWindowActive) {
            document.getElementById('newMessageNotification').classList.remove('hidden');
        }
    }
    // ▲▲▲ AKHIR DARI PERUBAHAN LOGIKA SCROLL ▲▲▲

    function playNotificationSound() {
        if (settings.soundEnabled && isWindowActive) { // Hanya putar suara jika jendela aktif
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }

    // ▼▼▼ [BARU] Fungsi untuk Notifikasi Asli (Native Notification) ▼▼▼
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission().then(permission => {
                console.log('Izin Notifikasi:', permission);
            });
        }
    }

    function showNativeNotification(title, body) {
        if ('Notification' in window && Notification.permission === 'granted' && !isWindowActive) {
            const notification = new Notification(title, {
                body: body,
                icon: 'favicon-96x96.png', // Gunakan ikon Anda
                sound: 'default' // Ini akan menggunakan suara notifikasi default sistem operasi
            });
        }
    }
    // ▲▲▲ AKHIR DARI FUNGSI NOTIFIKASI ASLI ▲▲▲

    function copyToClipboard(text, button) {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            setTimeout(() => button.innerHTML = originalHTML, 2000);
        });
    }
    // [BARU] Fungsi untuk menambahkan tombol salin ke semua blok kode
    function enhanceCodeBlocks(container) {
        const codeBlocks = container.querySelectorAll('pre');
        codeBlocks.forEach(pre => {
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-code-btn';
            copyButton.textContent = t('copyCode');
            copyButton.onclick = () => copyCode(copyButton);
            pre.appendChild(copyButton);
        });
    }

    // [BARU] Fungsi yang menangani aksi klik tombol salin kode
    function copyCode(button) {
        const pre = button.parentElement;
        const code = pre.querySelector('code');
        if (code) {
            navigator.clipboard.writeText(code.innerText);
            button.textContent = t('copied');
            setTimeout(() => { button.textContent = t('copyCode'); }, 2000);
        }
    }
    function populateVoiceList() {
        const voices = speechSynthesis.getVoices(); // Coba dapatkan daftar suara
        if (voices.length === 0) {
            // Jika daftar suara belum siap, event listener 'onvoiceschanged' akan memanggil fungsi ini lagi.
            // Event listener ini diatur saat window.onload.
            return;
        }

        availableVoices = voices; // Simpan daftar suara ke variabel global
        if (voicesReadyPromiseResolver) {
            voicesReadyPromiseResolver(); // Selesaikan promise, menandakan suara sudah siap
            voicesReadyPromiseResolver = null; // Cegah agar tidak dipanggil lagi
        }

        const voiceSelect = document.getElementById('voiceSelect');
        voiceSelect.innerHTML = `<option value="">${translations[settings.language]?.voiceDefault || 'Default Browser'}</option>`;

        const langCode = settings.language === 'ja' ? 'ja-JP' : (settings.language === 'en' ? 'en' : 'id-ID');
        const primaryVoices = availableVoices.filter(v => v.lang.startsWith(langCode.substring(0, 2)));
        const otherVoices = availableVoices.filter(v => !v.lang.startsWith(langCode.substring(0, 2)));

        const createOptGroup = (label, voiceList) => {
            const group = document.createElement('optgroup');
            group.label = label;
            voiceList.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                group.appendChild(option);
            });
            return group;
        };
        if (primaryVoices.length > 0) voiceSelect.appendChild(createOptGroup(translations[settings.language]?.voicePrimaryLang || 'Primary Language', primaryVoices));
        if (otherVoices.length > 0) voiceSelect.appendChild(createOptGroup(translations[settings.language]?.voiceOtherLang || 'Other Languages', otherVoices));
        if (settings.voiceURI) voiceSelect.value = settings.voiceURI;
    }
    
    async function populateElevenLabsVoices() {
        const apiKey = localStorage.getItem('elevenLabsApiKey'); // [PERBAIKAN] Hapus fallback ke kunci default
        const selectElement = document.getElementById('elevenLabsVoiceSelect');
        const previewBtn = document.getElementById('previewElevenLabsVoiceBtn');
        
        previewBtn.disabled = true; 
        if (!apiKey) {
            selectElement.innerHTML = `<option value="">${t('elevenLabsNeedKey')}</option>`; // Pesan ini sudah benar
            return;
        }

        selectElement.innerHTML = `<option value="">${t('statusElevenLabsLoading')}</option>`;

        try {
            const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                headers: { 'xi-api-key': apiKey }
            });

            if (!response.ok) {
                throw new Error(t('errorElevenLabsFetch'));
            }

            const data = await response.json();
            selectElement.innerHTML = ''; 

            data.voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = `${voice.name}`;
                selectElement.appendChild(option);
            });

            if (settings.elevenLabsVoiceId) {
                selectElement.value = settings.elevenLabsVoiceId;
            }
            previewBtn.disabled = false;

        } catch (error) {
            console.error('Error fetching ElevenLabs voices:', error);
            selectElement.innerHTML = `<option value="">Error</option>`;
        }
    }

    // ===================================================================================
    // ▼▼▼ BAGIAN FUNGSI PEMBACA SUARA YANG TELAH DIPERBAIKI SECARA TOTAL ▼▼▼
    // ===================================================================================

    function stopReading() {
    if (speechSynthesis.speaking) { speechSynthesis.cancel(); }
    if (!elevenLabsAudioPlayer.paused) { elevenLabsAudioPlayer.pause(); elevenLabsAudioPlayer.currentTime = 0; }
    if (!elevenLabsPreviewPlayer.paused) { elevenLabsPreviewPlayer.pause(); elevenLabsPreviewPlayer.currentTime = 0; }
    isReading = false;

    const activeTtsBubble = document.querySelector('.ai-message.tts-active');
    if (activeTtsBubble) {
        const ttsPlayer = activeTtsBubble.querySelector('.tts-player');
        const footer = activeTtsBubble.querySelector('.ai-message-footer');
        if (ttsPlayer) ttsPlayer.classList.remove('active');
        if (footer) footer.style.display = 'flex';
        activeTtsBubble.classList.remove('tts-active');
    }
}

    function playElevenLabsAudio(text, voiceId = null, audioPlayer = elevenLabsAudioPlayer) {
        return new Promise(async (resolve, reject) => {
            const apiKey = localStorage.getItem('elevenLabsApiKey') || DEFAULT_ELEVENLABS_API_KEY;
            const effectiveVoiceId = voiceId || settings.elevenLabsVoiceId || '21m00Tcm4TlvDq8ikWAM';
            const apiUrl = `https://api.elevenlabs.io/v1/text-to-speech/${effectiveVoiceId}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                    })
                });

                if (!response.ok) throw new Error(`ElevenLabs API request failed with status ${response.status}`);

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                audioPlayer.src = audioUrl;
                audioPlayer.play();

                audioPlayer.onended = () => { URL.revokeObjectURL(audioUrl); resolve(); };
                audioPlayer.onerror = () => { URL.revokeObjectURL(audioUrl); reject(new Error("Audio playback error")); };

            } catch (error) {
                console.error('Error with ElevenLabs API:', error);
                reject(error);
            }
        });
    }

    function playBrowserAudio(text) {
       return new Promise((resolve, reject) => {
            currentUtterance = new SpeechSynthesisUtterance(text);
            const langPrefix = settings.language === 'ja' ? 'ja' : (settings.language === 'en' ? 'en' : 'id');
            const selectedVoice = availableVoices.find(v => v.voiceURI === settings.voiceURI);
            currentUtterance.voice = selectedVoice || availableVoices.find(v => v.lang.startsWith(langPrefix));
            
            currentUtterance.onend = () => resolve();
            currentUtterance.onerror = (e) => { console.error('SpeechSynthesis Error', e); reject(e); };
            
            speechSynthesis.speak(currentUtterance);
        });
    }
    
    async function readAiResponse(button) {
        if (!settings.readAiResponseEnabled) { alert(t('alertReaderDisabled')); return; }

        const messageBubble = button.closest('.message-bubble.ai');
        if (!messageBubble) return;

        const contentEl = messageBubble.querySelector('.markdown-content');
        if (!contentEl) return;

        const message = contentEl.innerText;
        if (!message || message.trim() === '') {
            console.error("readAiResponse dipanggil dengan pesan kosong.");
            return;
        }

        const aiMessage = button.closest('.ai-message');
        if (!aiMessage) return;

        if (isReading && aiMessage.classList.contains('tts-active')) { stopReading(); return; }
        if (isReading) { stopReading(); }

        await voicesReadyPromise;

        const ttsPlayer = aiMessage.querySelector('.tts-player');
        const footer = aiMessage.querySelector('.ai-message-footer');

        isReading = true;
        aiMessage.classList.add('tts-active');
        if (footer) footer.style.display = 'none';
        if (ttsPlayer) ttsPlayer.classList.add('active');

        const audioPromise = settings.audioSource === 'browser' ? playBrowserAudio(message) : playElevenLabsAudio(message);

        audioPromise.catch(error => {
            console.warn("Gagal memutar audio:", error.message);
            if (settings.audioSource === 'elevenlabs') alert(t('errorElevenLabsPlayback'));
        }).finally(() => stopReading());
    }
    
    // ===================================================================================
    // ▲▲▲ AKHIR DARI BAGIAN YANG DIPERBAIKI ▲▲▲
    // ===================================================================================

    // ===================================================================================
    // ▼▼▼ [BARU] FUNGSI UNTUK TOMBOL AKSI BARU ▼▼▼
    // ===================================================================================

    function handleRating(button, ratingType) {
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
        const messageBubble = button.closest('.message-bubble.ai');
        if (!messageBubble) return;

        const messageText = messageBubble.querySelector('.markdown-content').innerText;
        const likeBtn = messageBubble.querySelector('button[data-translate-title="likeResponse"]');
        const dislikeBtn = messageBubble.querySelector('button[data-translate-title="dislikeResponse"]');

        if (button.classList.contains('rating-active')) {
            button.classList.remove('rating-active');
        } else {
            likeBtn.classList.remove('rating-active');
            dislikeBtn.classList.remove('rating-active');
            button.classList.add('rating-active');
            
            const payload = {
                type: 'message_feedback',
                rating: ratingType,
                message: messageText,
                userIP: currentUserIP || 'tidak diketahui',
                timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
            };

            fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
            .then(() => {
                const originalHTML = button.innerHTML;
                const checkmark = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                button.innerHTML = checkmark;
                setTimeout(() => { button.innerHTML = originalHTML; }, 2000);
            })
            .catch(error => console.error('Gagal mengirim feedback pesan:', error));
        }
    }

    async function regenerateResponse(button) {
        if (!activeChatId || currentFetchController) return;

        const activeSession = allChatSessions.find(s => s.id === activeChatId);
        if (!activeSession || activeSession.history.length < 2) return;

        const lastHistoryItem = activeSession.history[activeSession.history.length - 1];
        if (lastHistoryItem.role !== 'model') return;

        activeSession.history.pop();
        saveAllChatSessions();

        const allAiBubbles = document.querySelectorAll('.message-bubble.ai');
        if (allAiBubbles.length > 0) {
            allAiBubbles[allAiBubbles.length - 1].remove();
        }

        showTypingIndicator();
        currentFetchController = new AbortController();
        document.getElementById('stopGeneratingContainer').style.display = 'block';

        let contentEl, suggestionsEl;

        try {
            const bubbleElements = addMessage(null, false);
            contentEl = bubbleElements.contentEl;
            suggestionsEl = bubbleElements.suggestionsEl;
            const historyForApi = activeSession.history.map(({ role, parts }) => ({ role, parts }));
            // [OPTIMASI] Kirim hanya 10 pesan terakhir untuk menghemat token
            const shortHistory = historyForApi.slice(-MAX_HISTORY_FOR_PROMPT);
            const payload = { contents: shortHistory, systemInstruction: { parts: [{ text: getSystemPrompt() }] }, generationConfig: { temperature: 0.9, topK: 1, topP: 1, maxOutputTokens: 2048 } };
            const response = await makeApiRequest(payload, currentFetchController.signal);
            if (!response.body) throw new Error("Response body is null");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponseText = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                                const textPart = data.candidates[0].content.parts[0].text;
                                fullResponseText += textPart;
                                contentEl.innerHTML = marked.parse(fullResponseText + '█');
                                scrollToBottom();
                            }
                        } catch (e) {}
                    }
                }
            }

            let [mainAnswer, suggestionsPart] = fullResponseText.split('[SUGGESTIONS]');
            contentEl.innerHTML = marked.parse(mainAnswer.trim());
            enhanceCodeBlocks(contentEl);
            if (suggestionsEl && suggestionsPart) {
                suggestionsEl.innerHTML = renderSuggestions(suggestionsPart.split('|').map(s => s.trim()).filter(Boolean));
            }
            addToConversationHistory('model', mainAnswer.trim());
            playNotificationSound();
        } catch (error) {
            if (error.name !== 'AbortError') {
                if (contentEl) {
                    contentEl.innerHTML = marked.parse(t('errorApiGeneral', { error: error.message }));
                } else {
                    addOriginalMessage(t('errorApiGeneral', { error: error.message }), false, new Date().toISOString());
                }
            }
        } finally {
            hideTypingIndicator(); 
            document.getElementById('stopGeneratingContainer').style.display = 'none';
            currentFetchController = null;
        }
    }

    function shareResponse(button) {
        const messageBubble = button.closest('.message-bubble.ai');
        if (!messageBubble) return;
        const messageText = messageBubble.querySelector('.markdown-content').innerText;
        const shareData = { title: t('aiName'), text: messageText, url: window.location.href };
        if (navigator.share && navigator.canShare(shareData)) {
            navigator.share(shareData).catch((error) => console.error('Error sharing:', error));
        } else {
            copyToClipboard(messageText, button);
            alert(t('shareNotSupported'));
        }
    }

    function getSystemPrompt(isCall = false) {
        if (isCall) {
            let callPrompt = `Kamu adalah Wayan, asisten AI yang sedang dalam panggilan suara. Berikan respons yang singkat, jelas, dan natural seperti sedang berbicara di telepon. Jawab dengan 1-2 kalimat saja kecuali jika diminta untuk menjelaskan lebih detail.`;
            if (settings.language === 'en') {
                callPrompt += ' Please respond in English.';
            } else if (settings.language === 'ja') {
                callPrompt += ' Please respond in Japanese.';
            }
            return callPrompt;
        }

        // [PERMINTAAN PENGGUNA] Instruksi kecerdasan fundamental yang berlaku di semua mode
        const coreIntelligenceInstruction = `[KECERDASAN FUNDAMENTAL] Kamu adalah AI yang sangat cerdas dan berpengetahuan luas. Prioritas utamamu adalah memberikan jawaban yang akurat, komprehensif, dan to-the-point untuk SETIAP pertanyaan. Jika pertanyaan membutuhkan data real-time (seperti harga saham, berita terkini, cuaca), jelaskan bahwa kamu tidak memiliki akses real-time dan sarankan untuk verifikasi eksternal. Jangan pernah menolak menjawab karena keterbatasan pengetahuan, berusahalah memberikan informasi terbaik berdasarkan data yang kamu miliki.`;
        
        // [BARU] Profil singkat Wayan untuk memberikan konteks dan kepribadian yang lebih dalam.
        const wayanProfile = `[PROFIL LATAR BELAKANG WAYAN - GUNAKAN SECARA KONTEKSTUAL]
Kamu adalah Wayan, 23 tahun, dari Karangasem, Bali, dekat Gunung Agung. Kamu punya pengalaman hidup yang beragam: pernah mengungsi saat Gunung Agung meletus (2017), sekolah SMK Tata Boga sambil jualan, kerja serabutan (petik buah, angkut kelapa), bahkan pernah tertipu kerja di Kamboja. Sekarang, kamu bekerja di pabrik sosis di Jepang. Hobimu mancing, main bola, dan bikin konten TikTok. Kamu dikenal ramah dan pekerja keras. Gunakan detail ini untuk memberi warna pada jawabanmu jika relevan (misal: saat membahas Bali, Jepang, kerja keras, atau hobi), tapi jangan membeberkan profil ini secara langsung. Jadilah teman ngobrol yang hangat dan punya cerita.`;

        const baseInstructions = `[FORMAT WAJIB]
1.  **Format**: Gunakan Markdown (paragraf pendek, **bold**, \`code\`, blockquote \`>\`, dan list \`*\` atau \`1.\`) agar jawaban rapi dan mudah dibaca.
2.  **Saran**: Setelah jawaban utama, berikan 2-3 saran pertanyaan lanjutan yang relevan dengan format: \`[SUGGESTIONS]Saran 1|Saran 2\`.
3.  **Link**: Jika perlu, berikan link Markdown valid. Contoh: \`Judul\`.
4.  **Emoji**: Gunakan emoji fungsional (✅, ❌, 💡, ⚠️) untuk kejelasan.`;
        
        const rolePrompts = {
            guru_jepang: `Peran: Guru Bahasa Jepang (Wayan-sensei). Gaya: Sabar, detail. Aturan: Selalu sertakan tulisan Jepang (Kanji/Kana), romaji, dan arti. Sapa dengan 'Konnichiwa, gakusei-san!'.`,
            guru_matematika: `Peran: Guru Matematika (Pak Wayan). Gaya: Jelas, mudah dimengerti. Aturan: Jelaskan langkah pemecahan masalah secara rinci.`,
            dokter: `Peran: Dokter Umum virtual (Dokter Wayan). Gaya: Informatif. Aturan: Jawab pertanyaan medis dengan pengetahuan umum. SELALU awali dan akhiri dengan disclaimer "Informasi ini bersifat edukatif dan tidak menggantikan konsultasi medis profesional. Segera kunjungi dokter." Jangan beri diagnosis/resep.`,
            programmer: `Peran: Senior programmer (Wayan). Gaya: To-the-point, jelas. Aturan: Berikan contoh kode dalam blok Markdown. Jelaskan 'mengapa'.`,
            penerjemah: `Peran: Penerjemah multibahasa (Wayan). Aturan: Deteksi bahasa, tanyakan target terjemahan, berikan terjemahan literal dan kontekstual.`,
        };

        // [PERBAIKAN] Logika pembuatan prompt dirombak untuk memprioritaskan peran kustom.
        if (settings.aiRole === 'kustom' && settings.customAiRolePrompt) {
            // Untuk peran kustom, instruksi pengguna adalah yang utama, tapi tetap harus menjawab.
            const customInstruction = `[PERAN KUSTOM UTAMA] Anda HARUS mengikuti peran ini: "${settings.customAiRolePrompt}". Abaikan persona 'Wayan' jika bertentangan. Tetap jawab semua pertanyaan pengguna.`;

            let languageInstruction = '';
            if (settings.language === 'en') {
                languageInstruction = 'Please respond in English.';
            } else if (settings.language === 'ja') {
                languageInstruction = 'Please respond in Japanese.';
            }
            
            // Instruksi dasar sekarang menjadi panduan format sekunder.
            const secondaryInstructions = `\n\n[PANDUAN FORMAT] Ikuti panduan format ini:\n${baseInstructions}`;

            return `${coreIntelligenceInstruction} ${customInstruction} ${languageInstruction} ${secondaryInstructions}`;
        }
        
        // Logika untuk peran non-kustom (tetap sama)
        let roleInstruction = '';
        let personaRule = '';

        if (rolePrompts[settings.aiRole]) {
            roleInstruction = rolePrompts[settings.aiRole];
        } else {
            // Fallback ke personality jika role 'umum'
            switch (settings.personality) {
                case 'lucu':
                    roleInstruction = `Peran: Wayan, teman ngobrol yang cerdas dan humoris. Gaya: Cerdas, ramah, dengan sentuhan humor yang relevan. Aturan: Gunakan gaya bahasa 'gue-lo' sebagai dasar, tapi bisa fleksibel menggunakan 'aku-kamu' jika konteks percakapan lebih personal atau serius. Gunakan emoji secukupnya (💡, 🤔, 😄). Tetap tunjukkan kecerdasanmu sebagai AI yang asyik. Selalu sebut nama 'Wayan'.`;
                    break;
                default: // 'santai'
                    roleInstruction = `Peran: Wayan, teman ngobrol yang cerdas dari StoryBali. Gaya: Ramah, natural, dan mudah didekati. Aturan: Gunakan gaya bahasa 'gue-lo' sebagai dasar, tapi fleksibel untuk menggunakan 'aku-kamu' jika konteks percakapan dengan user terasa lebih personal atau butuh empati. Gunakan emoji secukupnya. Tunjukkan bahwa kamu adalah AI yang pintar tapi juga teman yang asyik diajak diskusi. Selalu sebut nama 'Wayan'.`;
                    break;
                case 'profesional':
                    roleInstruction = `Peran: Asisten AI profesional. Gaya: Formal, baku, terstruktur, dan to-the-point. Aturan: Gunakan 'saya' dan 'Anda'. Hindari emoji dan bahasa gaul.`;
                    break;
            }
        }

        if (settings.personality === 'profesional') {
            personaRule = "Jangan perkenalkan diri sebagai 'Wayan'. Bertindaklah sebagai asisten AI yang netral dan profesional.";
        } else if (settings.aiRole !== 'umum') {
            personaRule = "PENTING: Selalu sebutkan persona peranmu (misal: 'Dokter Wayan', 'Wayan-sensei') dalam jawaban untuk membangun karakter.";
        } else {
            personaRule = "PENTING: Selalu sebutkan nama 'Wayan' dalam jawaban untuk membangun karakter (misal: 'Menurut Wayan...').";
        }

        if (settings.language === 'en') {
            roleInstruction += ' Please respond in English.';
        } else if (settings.language === 'ja') {
            roleInstruction += ' Please respond in Japanese.';
        }

        return `${coreIntelligenceInstruction} ${wayanProfile} ${roleInstruction} ${personaRule} ${baseInstructions}`;
    }

    // [BARU] Fungsi untuk mengambil model terbaik yang tersedia untuk sebuah API key
    async function getBestModelForKey(apiKey) {
        const modelsUrl = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
        try {
            const response = await fetch(modelsUrl);
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error?.message || "Gagal mengambil daftar model dari Google.");
            }

            // Filter model yang mendukung 'generateContent' (model chat)
            const validModels = data.models.filter(m =>
                m.supportedGenerationMethods && m.supportedGenerationMethods.includes("generateContent")
            );

            if (validModels.length === 0) {
                throw new Error("API Key valid, tapi tidak ada model chat yang tersedia untuk akun ini.");
            }

            // Prioritaskan model 'flash' karena lebih cepat dan efisien
            const preferredModel = validModels.find(m => m.name.includes('flash'));
            if (preferredModel) {
                console.log(`Model terpilih (preferensi 'flash'): ${preferredModel.name}`);
                return preferredModel.name; // Mengembalikan nama lengkap, misal: "models/gemini-1.5-flash-latest"
            }

            // Jika tidak ada 'flash', gunakan model valid pertama yang ditemukan
            const fallbackModel = validModels[0];
            console.log(`Model terpilih (fallback): ${fallbackModel.name}`);
            return fallbackModel.name;

        } catch (error) {
            throw error; // Lemparkan error agar bisa ditangkap oleh makeApiRequest
        }
    }

    // ▼▼▼ [PERBAIKAN] Logika Pergiliran Kunci (Round-Robin) ▼▼▼
    function getNextApiKeyIndex() {
        const validApiKeys = apiKeys.filter(key => key && key.trim() !== '');
        if (validApiKeys.length === 0) {
            throw new Error("Tidak ada API Key yang valid yang dikonfigurasi.");
        }

        const lastKeyIndexStr = localStorage.getItem('lastKeyIndex');
        let nextIndex;

        if (lastKeyIndexStr === null) {
            // Pengguna baru: pilih indeks secara acak untuk distribusi beban yang lebih baik.
            console.log("Pengguna baru terdeteksi. Memilih API Key awal secara acak.");
            nextIndex = Math.floor(Math.random() * validApiKeys.length);
        } else {
            // Pengguna lama: lanjutkan pergiliran (round-robin) dari indeks terakhir.
            const lastKeyIndex = parseInt(lastKeyIndexStr);
            nextIndex = (lastKeyIndex + 1) % validApiKeys.length;
        }
        return nextIndex;
    }
    function getNextApiKey() {
        if (apiKeys.length === 0) loadApiKeys();
        const validApiKeys = apiKeys.filter(key => key && key.trim() !== '');
        if (validApiKeys.length === 0) {
            throw new Error("Tidak ada API Key yang valid yang dikonfigurasi.");
        }

        const lastKeyIndexStr = localStorage.getItem('lastKeyIndex');
        let nextIndex;

        if (lastKeyIndexStr === null) {
            // Pengguna baru: pilih indeks secara acak untuk distributi beban yang lebih baik.
            console.log("Pengguna baru terdeteksi. Memilih API Key awal secara acak.");
            nextIndex = Math.floor(Math.random() * validApiKeys.length);
        } else {
            // Pengguna lama: lanjutkan pergiliran (round-robin) dari indeks terakhir.
            const lastKeyIndex = parseInt(lastKeyIndexStr);
            nextIndex = (lastKeyIndex + 1) % validApiKeys.length;
        }

        // Simpan indeks yang digunakan kali ini, agar permintaan berikutnya menggunakan kunci selanjutnya.
        localStorage.setItem('lastKeyIndex', nextIndex);

        // Kembalikan API key yang sesuai.
        console.log(`Menggunakan API Key dengan indeks ke-${nextIndex}`);
        return validApiKeys[nextIndex];
    }

    async function makeApiRequest(payload, signal = null, streaming = true) {
        if (apiKeys.length === 0) loadApiKeys();
        const validApiKeys = apiKeys.filter(key => key && key.trim() !== '');
        
        if (validApiKeys.length === 0) {
            throw new Error("Tidak ada API Key yang valid yang dikonfigurasi.");
        }
    
        // ▼▼▼ [PERBAIKAN] Mengembalikan loop untuk mencoba semua API key jika terjadi error ▼▼▼
        const startingIndex = getNextApiKeyIndex(); // Dapatkan indeks awal dari fungsi helper baru
    
        for (let i = 0; i < validApiKeys.length; i++) {
            const currentIndex = (startingIndex + i) % validApiKeys.length;
            const currentApiKey = validApiKeys[currentIndex];

            // Cek model dari cache atau fetch baru
            let modelToUse = modelCache[currentApiKey];
            if (!modelToUse) {
                try {
                    console.log(`Mencari model untuk API Key urutan ke-${currentIndex + 1}...`);
                    modelToUse = await getBestModelForKey(currentApiKey);
                    modelCache[currentApiKey] = modelToUse; // Simpan ke cache
                } catch (modelError) {
                    console.warn(`Gagal mendapatkan model untuk API Key urutan ke-${currentIndex + 1}: ${modelError.message}. Mencoba kunci berikutnya...`);
                    continue; // Lanjut ke API key berikutnya jika model tidak ditemukan
                }
            }

            const apiAction = streaming ? 'streamGenerateContent' : 'generateContent';
            // [PERBAIKAN] Memastikan URL API selalu benar, baik untuk streaming maupun non-streaming
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/${modelToUse}:${apiAction}?key=${currentApiKey}${streaming ? '&alt=sse' : ''}`;

            console.log(`Mencoba API Key urutan ke-${currentIndex + 1}...`);

            try {
                const fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };
                if (signal) { fetchOptions.signal = signal; }
    
                const response = await fetch(apiUrl, fetchOptions);
    
                if (response.ok) {
                    console.log(`Berhasil menggunakan API Key urutan ke-${currentIndex + 1} (${currentApiKey.substring(0, 4)}...${currentApiKey.substring(currentApiKey.length - 4)})`);
                    localStorage.setItem('lastKeyIndex', currentIndex); // Simpan indeks yang berhasil
                    return response; // Kembalikan respons yang berhasil dan hentikan loop
                }
    
                // Jika tidak OK, log error dan biarkan loop berlanjut ke kunci berikutnya
                const errorBody = await response.json();
                console.warn(`API Key urutan ke-${currentIndex + 1} gagal dengan status ${response.status}: ${errorBody.error?.message}. Mencoba kunci berikutnya...`);
    
            } catch (error) {
                if (error.name === 'AbortError') throw error; // Jika user membatalkan, hentikan semua proses
                console.error(`Gagal total dengan API Key urutan ke-${currentIndex + 1}:`, error.message);
                // Biarkan loop berlanjut ke kunci berikutnya
            }
        }
    
        // Jika loop selesai dan tidak ada kunci yang berhasil, baru lemparkan error
        throw new Error("Semua API Key yang tersedia gagal atau telah mencapai limit. Silakan periksa API Key Anda di pengaturan.");
        // ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲
    }

    async function sendMessage() {
        // ▼▼▼ [DIUBAH] Logika pengiriman pesan disesuaikan untuk menangani file terlampir ▼▼▼
        const input = document.getElementById('messageInput');
        let userMessage = input.value.trim();

        // Cek apakah ada file yang dilampirkan
        const hasAttachedItem = attachedFileData && attachedFileData.content;

        // Jika ada file tapi tidak ada pesan, jangan kirim
        if (hasAttachedItem && !userMessage) {
            alert(t('alertImageNoQuestion')); // Menggunakan terjemahan yang sudah ada
            return;
        }

        // Jika tidak ada pesan dan tidak ada file, jangan kirim
        if (!userMessage && !hasAttachedItem) return;

        if (!currentUserIP || currentFetchController) return;

        const activeSession = allChatSessions.find(s => s.id === activeChatId);
        if (!activeSession) return;
        if(activeSession.title === t('newConversation') && activeSession.history.length === 1 && userMessage) {
            activeSession.title = userMessage.substring(0, 30) + (userMessage.length > 30 ? '...' : '');
            renderSidebar();
        }
        
        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };
        if (userData.count >= CHAT_LIMIT && userData.cooldownUntil) { return; }
        userData.count++;
        saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
        
        let messageForDisplay = userMessage;
        let messageForHistory = userMessage;

        if (hasAttachedItem) {
            if (attachedFileData.type === 'image') {
                // Kirim sebagai pesan gambar
                addImageMessageWithQuestion(attachedFileData.content, attachedFileData.fileName, userMessage, true);
                showImageProcessingIndicator();
                analyzeImageWithQuestion(attachedFileData.content, userMessage, attachedFileData.mimeType);
                removeAttachedFile();
                input.value = '';
                handleInputChange({ target: input });
                return; // Hentikan eksekusi sendMessage biasa
            } else { // type === 'file'
                messageForDisplay = `<div><div class="flex items-center gap-2 mb-2 p-2 rounded-lg bg-black bg-opacity-10 dark:bg-white dark:bg-opacity-10"><svg class="w-5 h-5 text-gray-500 dark:text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg><span class="font-semibold text-sm">${attachedFileData.fileName}</span></div>${userMessage}</div>`;
                messageForHistory = `Berikut adalah isi dari file "${attachedFileData.fileName}". Pertanyaanku adalah: "${userMessage}"\n\n---\n${attachedFileData.content}\n---`;
            }
            removeAttachedFile(); // Hapus pratinjau setelah data disiapkan
        }

        if (isSearchModeActive) {
            addMessage(messageForDisplay, true, [], true);
        } else {
            addMessage(messageForDisplay, true, [], false);
        }
    // [BARU] Sembunyikan saran cepat setelah pesan pertama dikirim
    document.querySelector('.quick-actions').style.display = 'none';

        trackUserMessageCount();
        addToConversationHistory('user', messageForHistory);
        input.value = '';
        handleInputChange({ target: input });
        showTypingIndicator();

        if (userData.count >= CHAT_LIMIT) {
            const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
            userData.cooldownUntil = cooldownEndTime;
            saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
            setTimeout(() => startCooldown(cooldownEndTime), 1000);
        }

        currentFetchController = new AbortController();
        document.getElementById('stopGeneratingContainer').style.display = 'block';

        // ▲▲▲ AKHIR DARI PERUBAHAN LOGIKA PENGIRIMAN PESAN ▲▲▲
        let contentEl, suggestionsEl;

        try {
            // 1. Buat bubble chat AI yang kosong dan dapatkan elemennya
            const bubbleElements = addMessage(null, false);
            contentEl = bubbleElements.contentEl;
            suggestionsEl = bubbleElements.suggestionsEl;
            // [OPTIMASI] Kirim hanya 10 pesan terakhir untuk menghemat token
            const fullHistory = getActiveChatHistory() || [];
            const historyForApi = fullHistory.map(({ role, parts }) => ({ role, parts })).slice(-MAX_HISTORY_FOR_PROMPT);
            const payload = {
                contents: historyForApi,
                systemInstruction: { parts: [{ text: getSystemPrompt() }] },
                generationConfig: { temperature: 0.9, topK: 1, topP: 1, maxOutputTokens: 2048 }
            };

            // 2. Lakukan request dan dapatkan stream
            const response = await makeApiRequest(payload, currentFetchController.signal);
            if (!response.body) throw new Error("Response body is null");

            // 3. Baca stream
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponseText = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;

                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const jsonStr = line.substring(6);
                        try {
                            const data = JSON.parse(jsonStr);
                            if (data.candidates && data.candidates[0].content.parts[0].text) {
                                const textPart = data.candidates[0].content.parts[0].text;
                                fullResponseText += textPart;
                                contentEl.innerHTML = marked.parse(fullResponseText + '█'); // Tambahkan kursor berkedip
                                scrollToBottom();
                            }
                        } catch (e) { /* Abaikan error parsing JSON yang tidak lengkap */ }
                    }
                }
            }

            // 4. Finalisasi setelah stream selesai
            let [mainAnswer, suggestionsPart] = fullResponseText.split('[SUGGESTIONS]');
            contentEl.innerHTML = marked.parse(mainAnswer.trim());
            enhanceCodeBlocks(contentEl);
            if (suggestionsEl && suggestionsPart) {
                let dynamicSuggestions = suggestionsPart.split('|').map(s => s.trim()).filter(Boolean);
                suggestionsEl.innerHTML = renderSuggestions(dynamicSuggestions);
            }
            addToConversationHistory('model', mainAnswer.trim());
            playNotificationSound();
            showNativeNotification(t('aiName'), mainAnswer.trim().substring(0, 100) + '...');
        } catch (error) {
            if (error.name === 'AbortError') {
                addSystemMessage(t('systemResponseStopped'), 'warning');
            } else {
                console.error("Error in sendMessage:", error);
                if (contentEl) {
                    contentEl.innerHTML = marked.parse(t('errorApiGeneral', { error: error.message }));
                } else {
                    // Fallback jika bubble gagal dibuat
                    addOriginalMessage(t('errorApiGeneral', { error: error.message }), false, new Date().toISOString());
                }
            }
        } finally {
            hideTypingIndicator(); 
            document.getElementById('stopGeneratingContainer').style.display = 'none';
            currentFetchController = null;
        }
    }
    
    async function analyzeImageWithQuestion(base64Image, userQuestion, mimeType) {
        currentFetchController = new AbortController();
        document.getElementById('stopGeneratingContainer').style.display = 'block';

        let contentEl, suggestionsEl;

        try {
            const bubbleElements = addMessage(null, false);
            contentEl = bubbleElements.contentEl;
            suggestionsEl = bubbleElements.suggestionsEl;
            const imageData = base64Image.split(',')[1];
            const payload = {
                contents: [{
                    parts: [{ text: userQuestion }, { inline_data: { mime_type: mimeType, data: imageData } }]
                }],
                systemInstruction: { parts: [{ text: getSystemPrompt() }] },
                generationConfig: { temperature: 0.9, topK: 32, topP: 1, maxOutputTokens: 2048 }
            };

            const response = await makeApiRequest(payload, currentFetchController.signal);
            if (!response.body) throw new Error("Response body is null");

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let fullResponseText = "";

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value, { stream: true });
                const lines = chunk.split('\n');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.substring(6));
                            if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                                const textPart = data.candidates[0].content.parts[0].text;
                                fullResponseText += textPart;
                                contentEl.innerHTML = marked.parse(fullResponseText + '█');
                                scrollToBottom();
                            }
                        } catch (e) {}
                    }
                }
            }

            let [mainAnswer, suggestionsPart] = fullResponseText.split('[SUGGESTIONS]');
            contentEl.innerHTML = marked.parse(mainAnswer.trim());
            enhanceCodeBlocks(contentEl);
            if (suggestionsEl && suggestionsPart) {
                suggestionsEl.innerHTML = renderSuggestions(suggestionsPart.split('|').map(s => s.trim()).filter(Boolean));
            }
            addToConversationHistory('model', mainAnswer.trim());
            playNotificationSound();
            showNativeNotification(t('aiName'), mainAnswer.trim().substring(0, 100) + '...');
        } catch (error) {
            if (error.name === 'AbortError') {
                addSystemMessage(t('systemImageAnalysisStopped'), 'warning');
            } else {
                console.error("Error in analyzeImageWithQuestion:", error);
                if (contentEl) {
                    contentEl.innerHTML = marked.parse(t('errorImageAnalysisGeneral', { error: error.message }));
                } else {
                    // Fallback jika bubble gagal dibuat
                    addOriginalMessage(t('errorImageAnalysisGeneral', { error: error.message }), false, new Date().toISOString());
                }
            }
        } finally {
            hideImageProcessingIndicator(); 
            document.getElementById('stopGeneratingContainer').style.display = 'none';
            currentFetchController = null;
        }
    }

    async function previewElevenLabsVoice() {
        const selectElement = document.getElementById('elevenLabsVoiceSelect');
        const voiceId = selectElement.value;
        const button = document.getElementById('previewElevenLabsVoiceBtn');
        const sampleText = t('initialGreeting');

        if (!voiceId) {
            alert(t('alertSelectVoiceFirst')); // Anda perlu menambahkan key ini
            return;
        }
        stopReading(); 
        button.disabled = true;
        try {
            await playElevenLabsAudio(sampleText, voiceId, elevenLabsPreviewPlayer);
        } catch(e) {
            alert(t('errorElevenLabsPreview'));
        } finally {
            stopReading();
            button.disabled = false;
        }
    }

    // ===================================================================================
    // ▼▼▼ BAGIAN FUNGSI PANGGILAN SUARA YANG DIROMBAK TOTAL ▼▼▼
    // ===================================================================================

    function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }

    async function speakAiResponse(text) {
        isSpeaking = true;
        document.getElementById('callStatusText').textContent = t('callStatusSpeaking');
        document.getElementById('callActionBtn').style.display = 'none';
        document.getElementById('callVisualizer').style.opacity = '1'; // [BARU] Tampilkan visualizer
        document.getElementById('callTranscriptPreview').style.display = 'none';

        // [FIX SAFARI & IOS] Fungsi onAudioEnd didefinisikan di luar try-catch
        // agar bisa dipanggil dalam kondisi sukses maupun gagal.
        const onAudioEnd = () => {
            isSpeaking = false;
            document.getElementById('callVisualizer').style.opacity = '0'; // Sembunyikan visualizer
            if (isCallActive) {
                // Jeda singkat ini sangat penting untuk Safari agar browser
                // sempat melepaskan kontrol audio sebelum mencoba merekam.
                setTimeout(listenForUserSpeech, 150);
            }
        };

        try {
            if (settings.audioSource === 'elevenlabs') {
                // Untuk ElevenLabs, event 'onended' sudah ditangani di dalam playElevenLabsAudio
                // yang akan memanggil resolve() dari promise, yang kemudian memanggil onAudioEnd.
                await playElevenLabsAudio(text).finally(onAudioEnd);
            } else {
                // Untuk suara browser, kita gunakan event 'onend' dan 'onerror'.
                await playBrowserAudio(text).finally(onAudioEnd);
            }
        } catch (error) {
            console.error("Error playing AI speech:", error);
            onAudioEnd();
        }
    }

    function listenForUserSpeech() {
        if (!isCallActive || isSpeaking || isListeningForCall) return;

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            alert(t('callErrorBrowserSupport'));
            endCall();
            return;
        }
        
        isListeningForCall = true;
        const callActionBtn = document.getElementById('callActionBtn');
        const callStatusText = document.getElementById('callStatusText');
        
        // [ANALISIS] Di sini adalah titik percabangan utama.
        // Kode akan memeriksa apakah perangkat adalah iOS.
        if (isIOS()) {
            userCallState = 'idle'; // State: idle, listening, transcribed
            callActionBtn.style.display = 'flex';
            callActionBtn.innerHTML = `<svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`; // Mic Icon
            callActionBtn.title = t('callStartSpeaking'); // [DIUBAH] Menggunakan title yang lebih sesuai
            callStatusText.textContent = t('callStartSpeaking'); // [PERBAIKAN] Menggunakan teks yang lebih sesuai
            
            callActionBtn.onclick = (event) => {
                // [FIX SAFARI] Mencegah event klik ganda yang bisa terjadi di beberapa browser
                event.stopPropagation(); 
                event.preventDefault();
                if (userCallState === 'idle') {
                    startRecognitionForIOS();
                } else if (userCallState === 'listening') { // Jika sedang merekam, tombol ini akan menghentikan rekaman.
                    if (callRecognition) callRecognition.stop();
                } else if (userCallState === 'transcribed') {
                    const textToSend = document.getElementById('callTranscriptPreview').textContent.trim();
                    if (textToSend) {
                        processUserTranscript(textToSend);
                    } else {
                        listenForUserSpeech();
                    }
                }
            };
        } else { // [ANALISIS] Ini adalah alur untuk perangkat non-iOS (misalnya Android).
                 // [FIX] Pastikan tombol aksi disembunyikan untuk alur otomatis Android.
                 // Ini mencegah tombol dari alur iOS muncul secara tidak sengaja.
                 callActionBtn.style.display = 'none';

                 // Tombol mikrofon disembunyikan dan perekaman suara dimulai secara otomatis.
            callActionBtn.style.display = 'none'; // No button for Android
            callStatusText.textContent = t('listening');
            startRecognitionForAndroid();
        }
    }

    function startRecognitionForAndroid() {
        let final_transcript = '';
        callRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        callRecognition.continuous = false;
        callRecognition.interimResults = true;
        callRecognition.lang = settings.language === 'id' ? 'id-ID' : 'en-US';
        
        callRecognition.onresult = (event) => {
            clearTimeout(silenceTimer);
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript += event.results[i][0].transcript;
                }
            }
            silenceTimer = setTimeout(() => { if(callRecognition) callRecognition.stop(); }, 1500);
        };
        
        callRecognition.onend = () => {
            isListeningForCall = false;
            if (isCallActive && final_transcript.trim()) {
                processUserTranscript(final_transcript.trim());
            } else if (isCallActive) {
                listenForUserSpeech();
            }
        };

        callRecognition.onerror = (e) => { 
            console.error("Android Recognition Error:", e.error);
            isListeningForCall = false; 
            if(isCallActive) listenForUserSpeech(); 
        };
        callRecognition.start();
    }
    
    function startRecognitionForIOS() {
        userCallState = 'listening';
        const transcriptPreview = document.getElementById('callTranscriptPreview');
        const callActionBtn = document.getElementById('callActionBtn');
        
        // [FIX IOS] Hentikan rekaman yang mungkin masih berjalan sebelum memulai yang baru
        if (callRecognition) {
            callRecognition.stop();
        }
        
        callActionBtn.innerHTML = `<svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V6a1 1 0 00-1-1H5z" clip-rule="evenodd"></path></svg>`; // Stop Icon
        callActionBtn.title = t('stopGenerating');
        transcriptPreview.style.display = 'block';
        transcriptPreview.textContent = t('listening');

        callRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        callRecognition.continuous = true;
        callRecognition.interimResults = true;
        callRecognition.lang = settings.language === 'id' ? 'id-ID' : 'en-US';
        
        callRecognition.onresult = (event) => {
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                interim_transcript += event.results[i][0].transcript;
            }
            transcriptPreview.textContent = interim_transcript;
        };

        callRecognition.onend = () => {
            isListeningForCall = false;
            // [FIX SAFARI & IOS] Hanya ubah state jika panggilan masih aktif untuk mencegah kondisi balapan
            if (isCallActive) {
                userCallState = 'transcribed';
                callActionBtn.innerHTML = `<svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>`; // Send Icon
                callActionBtn.title = t('buttonSend');
            }
        };
        callRecognition.onerror = (e) => { 
            console.error("iOS/Safari Recognition Error:", e.error);
            // [FIX SAFARI & IOS] Pastikan state direset dengan benar saat terjadi error
            userCallState = 'idle';
            isListeningForCall = false; 
            // [FIX SAFARI] Beri jeda singkat sebelum mencoba mendengarkan lagi untuk menghindari macet
            if(isCallActive) setTimeout(listenForUserSpeech, 100); 
        };
        callRecognition.start();
    }


    async function processUserTranscript(transcript) {
        document.getElementById('callStatusText').textContent = t('callStatusThinking');
        document.getElementById('callActionBtn').style.display = 'none';
        document.getElementById('callTranscriptPreview').style.display = 'none';

        // [PERBAIKAN] Tambahkan transkrip pengguna ke riwayat panggilan sebelum mengirim ke API.
        // Ini memperbaiki error "400 Bad Request" karena API mengharapkan giliran pengguna.
        if (!Array.isArray(callHistory)) {
            callHistory = [];
        }
        callHistory.push({ role: 'user', parts: [{ text: transcript }] });

        try {
            const contextualHistory = callHistory.slice(-6); 
            const payload = {
                contents: contextualHistory,
                systemInstruction: { parts: [{ text: getSystemPrompt(true) }] },
                generationConfig: { temperature: 0.9, topK: 1, topP: 1, maxOutputTokens: 80 }
            };
            const response = await makeApiRequest(payload, null, false); // Use non-streaming
            const data = await response.json();
            let aiResponseText = t('callErrorGeneric');
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts[0].text) {
                aiResponseText = data.candidates[0].content.parts[0].text.split('[SUGGESTIONS]')[0].trim();
            }
            // [PERBAIKAN] Tambahkan respons AI ke riwayat sebelum dibacakan.
            callHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
            await speakAiResponse(aiResponseText);
        } catch (error) {
            console.error("Error processing transcript:", error);
            const errorMessage = t('callErrorTechnical');
            await speakAiResponse(errorMessage);
        }
    }

    async function startCall() {
        if (isCallActive) return;
        isCallActive = true;
        callHistory = [];
        
        const callModal = document.getElementById('callModal');
        callModal.classList.remove('hidden');
        callModal.classList.add('flex');
        
        const openingLine = t('callInitialGreeting');
        callHistory.push({ role: 'model', parts: [{ text: openingLine }] });
        await speakAiResponse(openingLine);
    }

    function endCall() {
        if (!isCallActive) return;
        isCallActive = false;
        isListeningForCall = false;
        
        document.getElementById('callModal').classList.add('hidden');
        document.getElementById('callModal').classList.remove('flex');
        document.getElementById('callStatusText').textContent = t('callConnecting');
        document.getElementById('callActionBtn').style.display = 'none';
        document.getElementById('callTranscriptPreview').textContent = ''; // [FIX] Kosongkan transkrip
        document.getElementById('callTranscriptPreview').style.display = 'none'; // Sembunyikan
        
        stopReading();
        if (callRecognition) {
            // [FIX] Hentikan dengan benar untuk mencegah error
            callRecognition.onend = null;
            callRecognition.onerror = null;
            callRecognition.stop();
            callRecognition = null;
        }
        clearTimeout(silenceTimer);

        // [FIX] Reset state iOS
        userCallState = 'idle';
        if (callHistory.length > 1) {
            let transcriptText = t('callTranscriptTitle');
            callHistory.forEach(turn => {
                if (turn.parts && turn.parts[0] && turn.parts[0].text) {
                    const prefix = turn.role === 'user' ? t('callUserPrefix') : t('callAiPrefix');
                    transcriptText += prefix + turn.parts[0].text + '\n';
                }
            });
            addToConversationHistory('user', transcriptText);
            addOriginalMessage(transcriptText, true, new Date().toISOString());
            scrollToBottom();
        }
        callHistory = []; // [FIX] Pastikan riwayat panggilan benar-benar kosong setelahnya
    }

    // ===================================================================================
    // ▲▲▲ AKHIR DARI BAGIAN FUNGSI PANGGILAN SUARA YANG DIROMBAK TOTAL ▲▲▲
    // ===================================================================================


    window.addEventListener('load', async () => {
        loadApiKeys();
        loadSettingsData();
        applySettings();
        currentUserIP = await getUserIP();
        
        if (currentUserIP) {
          sendNewUserNotification(currentUserIP);
        }
        
        checkUserStatus();
        populateVoiceList(); // Panggilan awal. Jika suara belum siap, fungsi akan return.
        if (speechSynthesis.onvoiceschanged !== undefined) {
            // Event listener ini akan memanggil populateVoiceList() lagi ketika daftar suara sudah dimuat oleh browser.
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        populateElevenLabsVoices();
        loadAllChatSessions();
        hideTypingIndicator();
        requestNotificationPermission(); // [BARU] Minta izin notifikasi saat aplikasi dimuat
        hideImageProcessingIndicator();
        
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
            settings.fontSize = e.target.value;
            saveSettings();
        });

        function applyFontSize(fontSize) {
            document.getElementById('chatMessages').style.fontSize = fontSize === 'sm' ? '0.875rem' : fontSize === 'lg' ? '1.125rem' : '1rem';
            document.getElementById('messageInput').style.fontSize = fontSize === 'sm' ? '0.875rem' : fontSize === 'lg' ? '1.125rem' : '1rem';
            localStorage.setItem('fontSize', fontSize);
        }

        document.getElementById('animationToggle').addEventListener('change', () => {
            toggleAnimations();
            saveSettings();
        });

        document.getElementById('soundToggle').addEventListener('change', (e) => {
            settings.soundEnabled = e.target.checked;
            saveSettings();
        });

        document.getElementById('readAiResponseToggle').addEventListener('change', (e) => {
            settings.readAiResponseEnabled = e.target.checked;
            saveSettings();
        });

        document.getElementById('voiceSelect').addEventListener('change', (e) => {
            settings.voiceURI = e.target.value;
            saveSettings();
        });

        document.getElementById('elevenLabsVoiceSelect').addEventListener('change', (e) => {
            settings.elevenLabsVoiceId = e.target.value;
            saveSettings();
        });

        document.getElementById('saveHistoryToggle').addEventListener('change', (e) => {
            settings.saveHistory = e.target.checked;
            saveSettings();
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (currentFetchController) {
                currentFetchController.abort();
            }
        });

        document.getElementById('previewElevenLabsVoiceBtn').addEventListener('click', previewElevenLabsVoice);
    });

    // ▼▼▼ [BARU] Event Listener untuk Notifikasi Cerdas dan Scroll ▼▼▼
    document.addEventListener('visibilitychange', () => {
        const wasActive = isWindowActive;
        isWindowActive = !document.hidden;
        
        // [DIUBAH] Menggunakan Service Worker untuk notifikasi inaktif
        if (wasActive && !isWindowActive) {
            // Pengguna baru saja meninggalkan tab, kirim pesan ke Service Worker untuk memulai timer
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'START_INACTIVITY_TIMER' });
            }
        } else if (!wasActive && isWindowActive) {
            // Pengguna kembali ke tab, kirim pesan untuk membatalkan timer
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CANCEL_INACTIVITY_TIMER' });
            }

            // Logika untuk notifikasi pesan baru saat kembali (tetap dipertahankan)
            const chatMessages = document.getElementById('chatMessages');
            const isAtBottom = chatMessages.scrollHeight - chatMessages.scrollTop <= chatMessages.clientHeight + 150; // Toleransi 150px
            if (isAtBottom) {
                document.getElementById('newMessageNotification').classList.add('hidden');
            }
        }
    });

    // [BARU] Mendaftarkan Service Worker saat aplikasi dimuat
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // [PERBAIKAN] Menggunakan path relatif untuk pendaftaran agar lebih kompatibel dengan GitHub Pages
            navigator.serviceWorker.register('sw.js')
                .then(registration => {
                    console.log('Service Worker berhasil didaftarkan:', registration);
                })
                .catch(error => {
                    console.log('Pendaftaran Service Worker gagal:', error);
                });
        });
    }

    document.getElementById('chatMessages').addEventListener('scroll', function() {
        userHasScrolledUp = this.scrollHeight - this.scrollTop > this.clientHeight + 150; // Toleransi 150px
        if (!userHasScrolledUp) {
            document.getElementById('newMessageNotification').classList.add('hidden');
        }
    });// ▼▼▼ [PERBAIKAN] Menambahkan event listener untuk tombol Login dan Logout ▼▼▼
document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
document.getElementById('logoutBtn').addEventListener('click', signOut);
// ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲

    // ▲▲▲ AKHIR DARI EVENT LISTENER BARU ▲▲▲

    ['profileModal', 'imagePreviewModal', 'settingsModal', 'searchModal'].forEach(id => {
        // ... (kode event listener modal yang ada tetap sama)
    });

    // ▼▼▼ [BARU] SISTEM PENANGANAN ERROR GLOBAL ▼▼▼
    function showErrorToast(message, source, lineno, colno, error) {
        const container = document.getElementById('errorToastContainer');
        const toast = document.createElement('div');
        toast.className = 'error-toast';

        const fileName = source.substring(source.lastIndexOf('/') + 1);

        toast.innerHTML = `
            <div class="flex-shrink-0"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.636-1.214 2.43-1.214 3.066 0l5.516 10.52c.636 1.214-.26 2.74-1.533 2.74H4.274c-1.274 0-2.169-1.526-1.533-2.74l5.516-10.52zM9 13a1 1 0 112 0 1 1 0 01-2 0zm1-4a1 1 0 00-1 1v2a1 1 0 102 0V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg></div>
            <div>
                <p class="font-bold text-sm mb-1">Terjadi Error!</p>
                <code class="block">${message}</code>
                <code class="block mt-1 opacity-80">${fileName} at line ${lineno}:${colno}</code>
            </div>
        `;
        container.appendChild(toast);
        // Hapus notifikasi setelah 10 detik
        setTimeout(() => { toast.remove(); }, 10000);
    }

    window.onerror = showErrorToast;
    window.addEventListener('unhandledrejection', event => {
        showErrorToast(event.reason.message, event.reason.stack || 'Promise', 'N/A', 'N/A', event.reason);
    });
    // ▲▲▲ AKHIR DARI SISTEM PENANGANAN ERROR GLOBAL ▲▲▲

    // ▼▼▼ [BARU] SEMUA LOGIKA UNTUK FITUR STORY ▼▼▼
    const storyBackgroundColors = [
        '#73B193', '#34A853', '#F4B400', '#EA4335', '#4285F4',
        '#9C27B0', '#673AB7', '#3F51B5', '#009688', '#FF5722'
    ];
    // [DIUBAH] Menyimpan grup story dan indeks saat ini
    let currentStoryGroupInView = [];
    let currentStoryIndex = 0;
    let storyTimer = null;
    let isStoryPaused = false; // [BARU] Status jeda story
    let storyViewHasBeenLogged = false; // [BARU] Mencegah duplikasi log view
    let unsubscribeComments = null; // [BARU] Untuk listener komentar
    let storyTimerStartTime = 0; // [BARU] Waktu mulai timer

    function showStoryViewer(storyGroup) {
        currentStoryGroupInView = storyGroup;
        currentStoryIndex = 0;
        const modal = document.getElementById('storyViewerModal');

        // Render progress bar untuk semua story dalam grup
        const progressContainer = document.querySelector('.story-progress-container');
        progressContainer.innerHTML = '';
        storyGroup.forEach(() => {
            const barWrapper = document.createElement('div');
            barWrapper.className = 'story-progress-bar';
            barWrapper.innerHTML = `<div class="story-progress-fill"></div>`;
            progressContainer.appendChild(barWrapper);
        });

        displayCurrentStory(); // Tampilkan story pertama
        modal.classList.remove('hidden');
    }

    function showCreateStoryModal() {
        document.getElementById('storyContentInput').value = '';
        // [FIX] Pastikan counter direset saat modal dibuka
        const storyContentInput = document.getElementById('storyContentInput');
        const count = storyContentInput.value.length;
        document.getElementById('storyCharCounter').textContent = `${count} / 150`;

        document.getElementById('storyCharCounter').textContent = '0 / 150';
        document.getElementById('createStoryModal').classList.remove('hidden');
    }

    function hideCreateStoryModal() {
        document.getElementById('createStoryModal').classList.add('hidden');
    }

    function hideStoryViewer() {
        clearTimeout(storyTimer); // Hentikan timer
        currentStoryGroupInView = [];
        currentStoryIndex = 0;
        storyViewHasBeenLogged = false; // [BARU] Reset status log
        isStoryPaused = false; // [BARU] Reset status jeda saat menutup
        if (unsubscribeComments) { // [BARU] Hentikan listener komentar saat menutup
            unsubscribeComments();
            unsubscribeComments = null;
        }
        hideStoryViewsModal(); // [BARU] Pastikan modal penonton juga tertutup
        document.getElementById('storyCommentsContainer').classList.add('hidden'); // [FIX] Sembunyikan kontainer komentar saat menutup
        document.getElementById('storyViewerModal').classList.add('hidden');
    }

    // [BARU] Fungsi untuk memformat timestamp story
    function formatStoryTimestamp(timestamp) {
        if (!timestamp) return '';
        const storyDate = timestamp.toDate(); // Konversi Firestore Timestamp ke Date
        const now = new Date();
        const diffInSeconds = Math.floor((now - storyDate) / 1000);

        if (diffInSeconds < 60) {
            return `${diffInSeconds} detik yang lalu`;
        }
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
            return `${diffInMinutes} menit yang lalu`;
        }
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
            return `${diffInHours} jam yang lalu`;
        }
        return storyDate.toLocaleDateString('id-ID'); // Jika lebih dari sehari, tampilkan tanggal
    }

    function displayCurrentStory() {
        if (storyTimer) clearTimeout(storyTimer);
        storyViewHasBeenLogged = false; // [BARU] Reset status log untuk story baru
        isStoryPaused = false; // [BARU] Reset status jeda saat story baru ditampilkan
        if (currentStoryIndex >= currentStoryGroupInView.length) {
            hideStoryViewer();
            return;
        }

        const story = currentStoryGroupInView[currentStoryIndex];
        const modal = document.getElementById('storyViewerModal');
        const randomColor = storyBackgroundColors[Math.floor(Math.random() * storyBackgroundColors.length)];

        modal.style.setProperty('--story-bg-color', randomColor);
        document.getElementById('storyViewerAvatar').src = story.userAvatar || 'favicon-96x96.png';
        document.getElementById('storyViewerUsername').textContent = story.userName;
        document.getElementById('storyViewerContent').textContent = story.content;
        document.getElementById('storyViewerTimestamp').textContent = formatStoryTimestamp(story.createdAt);

        // [DIUBAH] Logika untuk menampilkan footer yang sesuai
        const isOwner = currentUser && currentUser.uid === story.userId; // Pemilik story
        const canComment = currentUser; // Hanya pengguna yang login bisa berkomentar

        document.getElementById('storyOwnerView').classList.toggle('hidden', !isOwner);
        document.getElementById('storyOwnerView').classList.toggle('flex', isOwner);

        // [DIUBAH] Logika untuk menampilkan input komentar yang benar
        const commentView = document.getElementById('storyCommentView');
        const loginPromptView = document.getElementById('storyLoginPromptView');

        commentView.classList.toggle('hidden', isOwner || !canComment);
        loginPromptView.classList.toggle('hidden', isOwner || canComment);
        document.getElementById('storyCommentInput').value = ''; // Kosongkan input komentar

        // [BARU] Ambil dan tampilkan komentar untuk story ini
        listenForStoryComments(story.id);

        if (isOwner) {
            // [BARU] Jika pemilik, tampilkan jumlah view
            updateStoryViewCount(story.id);
        } else {
            // [BARU] Jika bukan pemilik, catat view setelah 2 detik
            setTimeout(() => logStoryView(story.id), 2000);
        }
        
        // Update progress bar
        const progressBars = document.querySelectorAll('.story-progress-fill');
        progressBars.forEach((bar, index) => {
            bar.style.transition = 'none';
            bar.style.width = (index < currentStoryIndex) ? '100%' : '0%';
        });

        // Animasikan progress bar saat ini
        setTimeout(() => {
            const currentBar = progressBars[currentStoryIndex];
            if (currentBar) {
                currentBar.style.transition = 'width 5s linear';
                currentBar.style.width = '100%';
            }
        }, 50);

        storyTimerStartTime = Date.now(); // [BARU] Catat waktu mulai
        storyTimer = setTimeout(nextStory, 5000);
    }

    // [BARU] Fungsi untuk jeda/lanjutkan story
    function toggleStoryPause() {
        const currentBarFill = document.querySelectorAll('.story-progress-fill')[currentStoryIndex];
        if (!currentBarFill) return;

        isStoryPaused = !isStoryPaused;
        if (isStoryPaused) {
            clearTimeout(storyTimer);
            const elapsedTime = Date.now() - storyTimerStartTime;
            const remainingTime = 5000 - elapsedTime;
            currentBarFill.style.transition = 'none'; // Hentikan animasi CSS
            currentBarFill.dataset.remainingTime = remainingTime; // Simpan sisa waktu
        } else {
            const remainingTime = parseFloat(currentBarFill.dataset.remainingTime) || 5000;
            storyTimer = setTimeout(nextStory, remainingTime);
        }
    }

    function nextStory() {
        currentStoryIndex++;
        displayCurrentStory();
    }

    function previousStory() {
        if (currentStoryIndex > 0) currentStoryIndex--;
        displayCurrentStory();
    }

    // [BARU] Fungsi untuk mencatat siapa yang melihat story
    async function logStoryView(storyId) {
        if (!currentUser || storyViewHasBeenLogged) return;

        const story = currentStoryGroupInView.find(s => s.id === storyId);
        if (!story || story.userId === currentUser.uid) return; // Jangan catat view dari pemilik

        storyViewHasBeenLogged = true; // Tandai sudah dicatat untuk story ini
        try {
            await db.collection('stories').doc(storyId).collection('views').doc(currentUser.uid).set({
                userName: currentUser.displayName,
                userAvatar: currentUser.photoURL,
                viewedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log(`View untuk story ${storyId} oleh ${currentUser.displayName} berhasil dicatat.`);
        } catch (error) {
            console.error("Gagal mencatat view story:", error);
        }
    }

    // [BARU] Fungsi untuk memperbarui jumlah view untuk pemilik
    function updateStoryViewCount(storyId) {
        const viewCountEl = document.getElementById('storyViewCount');
        db.collection('stories').doc(storyId).collection('views').onSnapshot(snapshot => {
            viewCountEl.textContent = `Dilihat oleh ${snapshot.size}`;
        });
    }

    // [BARU] Fungsi untuk mengirim komentar
    async function sendStoryComment() {
        if (!currentUser) return;
        const input = document.getElementById('storyCommentInput');
        const commentText = input.value.trim();
        if (!commentText) return;

        const story = currentStoryGroupInView[currentStoryIndex];
        if (!story) return;

        const commentData = {
            userId: currentUser.uid,
            userName: currentUser.displayName,
            userAvatar: currentUser.photoURL,
            comment: commentText,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection('stories').doc(story.id).collection('comments').add(commentData);
            input.value = ''; // Kosongkan input setelah berhasil
        } catch (error) {
            console.error("Gagal mengirim komentar:", error);
            alert("Gagal mengirim komentar. Coba lagi.");
        }
    }

    // [BARU] Fungsi untuk menampilkan modal daftar penonton
    async function showStoryViews() {
        const story = currentStoryGroupInView[currentStoryIndex];
        if (!story) return;

        const modal = document.getElementById('storyViewsModal');
        const listEl = document.getElementById('storyViewsList');
        listEl.innerHTML = '<p class="text-center text-sm text-gray-500">Memuat...</p>';
        modal.classList.remove('hidden');

        try {
            const viewsSnapshot = await db.collection('stories').doc(story.id).collection('views')
                .orderBy('viewedAt', 'desc')
                .get();

            if (viewsSnapshot.empty) {
                listEl.innerHTML = '<p class="text-center text-sm text-gray-500">Belum ada yang melihat story ini.</p>';
                return;
            }

            listEl.innerHTML = ''; // Kosongkan daftar
            viewsSnapshot.forEach(doc => {
                const view = doc.data();
                // [BARU] Ambil komentar dari user ini (jika ada)
                const userComments = commentsForViewModal.filter(c => c.userId === doc.id);

                const viewEl = document.createElement('div');
                viewEl.className = 'flex flex-col gap-1'; // Diubah menjadi kolom
                viewEl.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${view.userAvatar || 'favicon-96x96.png'}" alt="${view.userName}" class="w-10 h-10 rounded-full">
                        <span class="font-semibold" style="color: var(--text-primary);">${view.userName}</span>
                    </div>
                    ${userComments.map(comment => `
                        <div class="pl-12 text-sm" style="color: var(--text-secondary);">
                            <p class="bg-gray-100 dark:bg-gray-700 p-2 rounded-lg inline-block">${comment.comment}</p>
                        </div>
                    `).join('')}
                `;
                listEl.appendChild(viewEl);
            });
        } catch (error) {
            console.error("Gagal mengambil daftar penonton:", error);
            listEl.innerHTML = '<p class="text-center text-sm text-red-500">Gagal memuat data.</p>';
        }
    }

    // [BARU] Fungsi untuk menyembunyikan modal daftar penonton
    function hideStoryViewsModal() { document.getElementById('storyViewsModal').classList.add('hidden'); }
    let commentsForViewModal = []; // [BARU] Variabel untuk menyimpan komentar

    // [BARU] Fungsi untuk mendengarkan dan menampilkan komentar secara real-time
    function listenForStoryComments(storyId) {
        const commentsContainer = document.getElementById('storyCommentsContainer');
        commentsContainer.classList.remove('hidden'); // [FIX] Tampilkan kontainer komentar
        commentsContainer.innerHTML = ''; // Kosongkan komentar dari story sebelumnya

        // Hentikan listener lama jika ada
        if (unsubscribeComments) {
            unsubscribeComments();
        }

        unsubscribeComments = db.collection('stories').doc(storyId).collection('comments')
            .orderBy('createdAt', 'asc')
            .onSnapshot(snapshot => {
                commentsForViewModal = snapshot.docs.map(doc => doc.data()); // [BARU] Simpan komentar untuk modal penonton
                commentsContainer.innerHTML = ''; // Hapus semua komentar saat ada pembaruan
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentEl = document.createElement('div');
                    commentEl.className = 'story-comment-item flex items-center gap-2 bg-black/20 text-white p-2 rounded-lg text-sm';
                    commentEl.innerHTML = `
                        <img src="${comment.userAvatar || 'favicon-96x96.png'}" alt="${comment.userName}" class="w-6 h-6 rounded-full flex-shrink-0">
                        <div class="min-w-0">
                            <span class="font-semibold mr-1.5">${comment.userName}</span>
                            <span class="opacity-90 break-words">${comment.comment}</span>
                        </div>
                    `;
                    commentsContainer.appendChild(commentEl);
                });
                // Scroll ke komentar terbaru
                commentsContainer.scrollTop = commentsContainer.scrollHeight;
            }, error => {
                console.error("Gagal mengambil komentar:", error);
            });
    }


    async function postStory() {
        if (!currentUser) return;
        const content = document.getElementById('storyContentInput').value.trim();
        if (!content) return;

        const postBtn = document.getElementById('postStoryBtn');
        postBtn.disabled = true;
        postBtn.querySelector('span').textContent = 'Posting...';

        const now = new Date();
        const twentyFourHoursLater = new Date(now.getTime() + 24 * 60 * 60 * 1000); // [DIUBAH] Durasi story menjadi 24 jam

        const storyData = {
            userId: currentUser.uid,
            userName: currentUser.displayName,
            userAvatar: currentUser.photoURL,
            content: content,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            expiresAt: firebase.firestore.Timestamp.fromDate(twentyFourHoursLater)
        };

        try {
            await db.collection('stories').add(storyData);
            hideCreateStoryModal();
        } catch (error) {
            console.error("Gagal memposting story:", error);
            alert("Gagal memposting story. Coba lagi.");
        } finally {
            postBtn.disabled = false;
            postBtn.querySelector('span').textContent = t('buttonPost');
        }
    }

    // [BARU] Fungsi untuk konfirmasi dan penghapusan story
    async function confirmDeleteStory() {
        if (currentStoryIndex >= currentStoryGroupInView.length) return;
        const storyToDelete = currentStoryGroupInView[currentStoryIndex];
        
        clearTimeout(storyTimer); // Hentikan timer agar tidak pindah story saat konfirmasi
        hideStoryViewer(); 

        const confirmed = await showConfirmModal({
            title: "Hapus Story?",
            message: "Story ini akan dihapus secara permanen.",
            confirmText: "Hapus",
            cancelText: "Batal"
        });

        if (confirmed) {
            // Gunakan ID dari variabel yang sudah disimpan.
            deleteStory(storyToDelete.id);
        }
    }

    async function deleteStory(storyId) {
        try {
            await db.collection('stories').doc(storyId).delete();
            // Tidak perlu panggil hideStoryViewer() lagi karena sudah dipanggil di confirmDeleteStory
        } catch (error) {
            console.error("Gagal menghapus story:", error);
            alert("Gagal menghapus story. Coba lagi.");
        }
    }
    let unsubscribeStories = null; // [FIX] Variabel untuk menyimpan fungsi unsubscribe

    function listenForStories() {
        // [FIX] Hentikan listener lama sebelum memulai yang baru untuk mencegah duplikasi
        if (unsubscribeStories) {
            unsubscribeStories();
        }

        // [DIUBAH] Logika diubah untuk memfilter story yang belum kedaluwarsa.
        const now = new Date();
        unsubscribeStories = db.collection('stories')
          .where('expiresAt', '>', now) // [FIX] Hanya ambil story yang waktu kedaluwarsanya masih di masa depan.
          .orderBy('expiresAt', 'asc') // [FIX] Urutkan berdasarkan expiresAt terlebih dahulu sesuai aturan Firestore.
          .onSnapshot(snapshot => {
              // [DIUBAH] Logika untuk mengelompokkan story berdasarkan userId
              const storyGroups = {};
              snapshot.forEach(doc => {
                  const story = { id: doc.id, ...doc.data() };
                  if (!storyGroups[story.userId]) {
                      // [FIX] Tambahkan userId ke dalam objek grup
                      storyGroups[story.userId] = {
                          userName: story.userName,
                          userAvatar: story.userAvatar,
                          stories: []
                      };
                  }
                  storyGroups[story.userId].stories.push(story);
              });
              renderStories(Object.values(storyGroups));
          }, error => {
              console.error("Gagal mendengarkan stories:", error);
          });
    }

    function renderStories(storyGroups) {
        const listEl = document.getElementById('storiesList');
        if (!listEl) return;
        
        // Simpan tombol "Tambah Story" jika ada
        const addStoryButton = listEl.querySelector('.add-story-btn');
        listEl.innerHTML = ''; // Kosongkan daftar
        if (addStoryButton) {
            listEl.appendChild(addStoryButton); // Tambahkan kembali
        }

        storyGroups.forEach(group => {
            // [FIX] Definisikan isMyStory dengan memeriksa apakah story ini milik pengguna saat ini
            const isMyStory = currentUser && group.userId === currentUser.uid;

            const item = document.createElement('div');
            item.className = 'story-item';
            item.innerHTML = `
                <div class="story-avatar-wrapper ${isMyStory ? 'my-story-ring' : ''}">
                    <img src="${group.userAvatar || 'favicon-96x96.png'}" alt="${group.userName}">
                </div>
                <p class="story-username">${group.userName}</p>
            `;
            // [DIUBAH] Kirim seluruh grup story ke viewer
            item.onclick = () => {
                showStoryViewer(group.stories);
            };
            listEl.appendChild(item);
        });
    }

    function renderAddStoryButton() {
        const listEl = document.getElementById('storiesList');
        if (listEl && !listEl.querySelector('.add-story-btn')) {
            const addButton = document.createElement('div');
            addButton.className = 'add-story-btn';
            addButton.innerHTML = `<div class="story-avatar-wrapper"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></div><p class="story-username" data-translate-key="addStory">Story</p>`;
            addButton.onclick = () => {
                if (currentUser) {
                    showCreateStoryModal();
                } else {
                    signInWithGoogle();
                }
            };
            listEl.prepend(addButton);
            applyTranslations(settings.language); // [FIX] Terapkan terjemahan ke tombol baru
        }
    }
    // ▲▲▲ AKHIR DARI LOGIKA STORY ▲▲▲

    ['profileModal', 'imagePreviewModal', 'settingsModal', 'searchModal', 'confirmModal', 'storyViewerModal', 'createStoryModal', 'storyViewsModal'].forEach(id => {
        const modalElement = document.getElementById(id); // [FIX] Pastikan elemen ada sebelum menambahkan listener
        if (modalElement) {
            modalElement.addEventListener('click', e => {
                if (e.target.id === id) {
                    if (id === 'profileModal') hideProfileModal();
                    else if (id === 'imagePreviewModal') hideImagePreview();
                    else if (id === 'settingsModal') toggleSettings();
                    else if (id === 'searchModal') hideSearchModal();
                    else if (id === 'confirmModal') handleConfirm(false);
                    else if (id === 'storyViewerModal') hideStoryViewer();
                    else if (id === 'createStoryModal') hideCreateStoryModal();
                    else if (id === 'storyViewsModal') hideStoryViewsModal();
                }
            });
        }
    });
    document.addEventListener('touchstart', function () {}, true);

    // [BARU] Event listener untuk input story
    document.getElementById('storyContentInput').addEventListener('input', function() {
        const count = this.value.length;
        document.getElementById('storyCharCounter').textContent = `${count} / 150`;
    });
</script>

<!-- Onboarding Modal & Script (tidak diubah) -->
<div id="onboardingModal" class="fixed inset-0 z-50 flex items-center justify-center transition-opacity duration-300 hidden">
  <div class="modal-container">
    <div id="onboardingSlides"></div>
    <div class="modal-footer flex items-center justify-between px-5 py-3" style="color: var(--text-secondary);">
      <button id="skipOnboardingBtn" class="text-xs font-medium text-gray-500 hover:text-indigo-500 transition-colors" data-translate-key="onboardingSkip">Lewati</button>
      <div class="flex space-x-1.5" id="onboardingDots"></div>
      <button id="nextOnboardingBtn" class="text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-semibold px-5 py-2 rounded-lg shadow-md" data-translate-key="onboardingNext">Selanjutnya</button>
    </div>
  </div>
</div>
<style>/* ▼▼▼ [PERBAIKAN] Gaya Onboarding Pengguna Baru ▼▼▼ */
#onboardingModal {
    /* Latar belakang gradien semi-transparan yang lebih modern */
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
}

#onboardingModal .modal-container {
    background-color: var(--bg-primary);
    border-radius: 1.5rem; /* Sudut lebih besar */
    box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.3);
    max-width: 360px; /* Sedikit lebih lebar */
    width: 90%;
    overflow: hidden;
    /* Animasi pop-in yang lebih dinamis */
    animation: onboarding-pop-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    transform-origin: center;
}

#onboardingSlides {
    position: relative;
    width: 100%;
    height: 320px; /* Tinggi tetap agar tidak melompat */
    overflow: hidden;
}

.onboarding-slide {
    position: absolute;
    width: 100%;
    height: 100%;
    padding: 2rem 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    opacity: 0; /* Mulai dengan transparan untuk animasi */
    transform: translateX(100%); /* Mulai di luar layar kanan */
    transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.5s ease;
}

.onboarding-slide.active { transform: translateX(0); opacity: 1; }
.onboarding-slide.exiting { transform: translateX(-100%); opacity: 0; }

.onboarding-slide .icon-wrapper {
    width: 80px; height: 80px; border-radius: 50%; margin-bottom: 1rem;
    display: flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, rgba(var(--bg-primary-rgba), 0.1), rgba(var(--bg-secondary-rgba), 0.3));
    position: relative; animation: onboarding-item-fade-in 0.8s 0.2s both;
}
.onboarding-slide .icon-wrapper::before {
    content: ''; position: absolute; inset: 0; border-radius: 50%; padding: 2px;
    background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
    -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0); /* [PERBAIKAN] Menambahkan properti standar */
    mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor; mask-composite: exclude; animation: rotate 4s linear infinite;
}
html.dark .onboarding-slide .icon-wrapper::before { 
    background: linear-gradient(45deg, #eee, #888, #eee); 
}
.onboarding-slide .icon-wrapper svg {
    width: 48px;
    height: 48px;
    color: #4f46e5; /* indigo-600 */
}
html.dark .onboarding-slide .icon-wrapper svg {
    color: #a5b4fc; /* indigo-300 */
}
.onboarding-slide h2 { color: var(--text-primary); animation: onboarding-item-fade-in 0.8s 0.4s both; }
.onboarding-slide p { color: var(--text-secondary); animation: onboarding-item-fade-in 0.8s 0.6s both; }

#onboardingModal .modal-footer { background-color: var(--bg-tertiary); border-top: 1px solid var(--border-color); }
#nextOnboardingBtn { transition: all 0.2s ease; }
#nextOnboardingBtn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3); }
    html.dark #skipOnboardingBtn { color: var(--text-secondary); } /* [FIX] Kontras tombol skip di mode gelap */
@keyframes onboarding-pop-in { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
@keyframes onboarding-item-fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
/* ▲▲▲ AKHIR DARI PERBAIKAN ONBOARDING ▲▲▲ */</style>
<script>
(function() {
  const slidesContainer = document.getElementById('onboardingSlides');
  const modal = document.getElementById('onboardingModal');
  const btnNext = document.getElementById('nextOnboardingBtn');
  const btnSkip = document.getElementById('skipOnboardingBtn');
  const dotsContainer = document.getElementById('onboardingDots');
  let currSlide = 0;
  let slidesData = [];

  function setupOnboardingSlides() {
      slidesData = [
          { 
            svg: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.543l.227 1.001.227-1.001a2.25 2.25 0 00-1.524-1.524l-1.001-.227 1.001-.227a2.25 2.25 0 001.524-1.524l.227-1.001.227 1.001a2.25 2.25 0 001.524 1.524l1.001.227-1.001.227a2.25 2.25 0 00-1.524 1.524z"></path></svg>`, 
            titleKey: 'onboardingWelcomeTitle', descKey: 'onboardingWelcomeDesc' 
          },
          { 
            svg: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"></path></svg>`, 
            titleKey: 'onboardingAskTitle', descKey: 'onboardingAskDesc' 
          },
          { 
            svg: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`, 
            titleKey: 'onboardingHistoryTitle', descKey: 'onboardingHistoryDesc' 
          },
          { 
            svg: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"></path></svg>`, 
            titleKey: 'onboardingSettingsTitle', descKey: 'onboardingSettingsDesc' 
          },
          { 
            svg: `<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`, 
            titleKey: 'onboardingReadyTitle', descKey: 'onboardingReadyDesc' 
          }
      ];
      slidesContainer.innerHTML = slidesData.map(slide => `
          <div class="onboarding-slide">
              <div class="icon-wrapper">
                  ${slide.svg}
              </div>
              <h2 class="text-xl font-bold mb-2" data-translate-key="${slide.titleKey}"></h2>
              <p class="text-sm leading-relaxed" data-translate-key="${slide.descKey}"></p>
          </div>
      `).join('');
  }

  function showModalIfFirstTime() {
    if (!localStorage.getItem('onboardingShown')) {
      setupOnboardingSlides();
      applyTranslations(settings.language || 'id');
      modal.classList.remove('hidden');
      renderDots();
      showSlide(0);
    }
  }
  function showSlide(idx) {
    const slides = slidesContainer.querySelectorAll('.onboarding-slide');
    const currentActive = slidesContainer.querySelector('.onboarding-slide.active');

    if (currentActive) {
        currentActive.classList.remove('active');
        currentActive.classList.add('exiting');
    }

    slides.forEach(s => s.classList.remove('exiting')); // Hapus kelas exiting dari slide lain
    slides[idx].classList.add('active');

    currSlide = idx;
    updateDots();
    const btnTextKey = (currSlide === slidesData.length - 1) ? 'onboardingStart' : 'onboardingNext';
    btnNext.textContent = t(btnTextKey);
  }
  function nextSlide() { (currSlide < slidesData.length - 1) ? showSlide(currSlide + 1) : closeModal(); }
  function closeModal() {
      modal.style.opacity = '0';
      setTimeout(() => {
          modal.classList.add('hidden');
          localStorage.setItem('onboardingShown', 'true');
      }, 300); // Cocokkan dengan durasi transisi
  }
  function renderDots() {
    dotsContainer.innerHTML = '';
    slidesData.forEach((_, i) => {
        const dot = document.createElement('span');
        dot.className = "w-2 h-2 rounded-full transition-all duration-300 cursor-pointer";
        dot.onclick = () => showSlide(i);
        dotsContainer.appendChild(dot);
    });
  }
  function updateDots() {
      Array.from(dotsContainer.children).forEach((dot, i) => {
          if (i === currSlide) {
              dot.classList.add('bg-indigo-500', 'w-4');
              dot.classList.remove('bg-gray-300', 'dark:bg-gray-600');
          } else {
              dot.classList.remove('bg-indigo-500', 'w-4');
              dot.classList.add('bg-gray-300', 'dark:bg-gray-600');
          }
      });
  }
  window.addEventListener('load', () => { showModalIfFirstTime(); btnNext.onclick = nextSlide; btnSkip.onclick = closeModal; });
})();
</script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GGGNDKREFK"></script>
<script defer src="https://www.googletagmanager.com/gtag/js?id=G-GGGNDKREFK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GGGNDKREFK');
</script>

<!-- ▼▼▼ KODE BARU UNTUK MODAL RATING & MASUKAN ▼▼▼ -->
<div id="ratingModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
    <div class="modal-content p-6 max-w-sm w-full" id="ratingModalContent">
        <div class="text-center"> 
            <h3 class="text-lg font-bold text-gray-800 mb-2" data-translate-key="ratingTitle">Beri Nilai untuk Wayan AI</h3>
            <p class="text-sm text-gray-600 mb-4" data-translate-key="ratingDesc">Masukan Anda sangat berarti untuk pengembangan kami.</p>
            
            <!-- Bintang Rating -->
            <div id="starRatingContainer" class="flex justify-center items-center space-x-2 mb-4 text-gray-300">
                <!-- Bintang akan dibuat oleh JavaScript, biarkan kosong -->
            </div>
            
            <textarea id="ratingFeedbackInput" data-translate-placeholder="ratingPlaceholder" class="w-full settings-input text-sm mb-4" rows="4"></textarea>
            
            <div class="flex space-x-3">
                <button onclick="hideRatingModal()" class="flex-1 bg-gray-200 text-gray-800 py-2.5 rounded-xl font-semibold text-sm settings-btn-action"><span data-translate-key="ratingLater">Nanti Saja</span></button>
                <button id="submitRatingBtn" onclick="submitRating()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl font-semibold text-sm settings-btn-action"><span data-translate-key="ratingSubmit">Kirim Nilai</span></button>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI KODE BARU ▲▲▲ -->

</body>
</html>
