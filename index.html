<!DOCTYPE html>
<html lang="id">
<head>
  <meta name="google-site-verification" content="g8-s5Mbu3DeWRHtXBt80kARydxNiS1a_XnmNfdyePkI" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  
  <!-- ▼▼▼ Meta Tags untuk SEO (Search Engine Optimization) yang Dioptimalkan ▼▼▼ -->
<link rel="icon" type="image/png" href="favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="favicon.svg" />
<link rel="shortcut icon" href="favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png" />
<link rel="manifest" href="site.webmanifest" />
  <meta name="description" content="Wayan AI adalah asisten AI cerdas dari Storybali, siap membantu menjawab pertanyaanmu dengan gaya santai dan ramah. Ngobrol dengan chatbot AI berbahasa Indonesia tentang apa saja!">
  <meta name="keywords" content="Wayan AI, Storybali, Asisten AI, AI Indonesia, Chatbot Indonesia, AI Bali, Asisten Virtual, Kecerdasan Buatan">
  <link rel="canonical" href="https://wayanku.github.io/Wayan-ai-dari-storybali/" />

  <!-- Meta Tags untuk Social Media (Open Graph & Twitter) -->
  <meta property="og:title" content="Wayan AI - Asisten Cerdas dari Storybali">
  <meta property="og:description" content="Ngobrol dengan Wayan AI, asisten AI cerdas berbahasa Indonesia dari Storybali. Siap membantu menjawab pertanyaanmu dengan gaya santai dan ramah.">
  <meta property="og:image" content="https://i.postimg.cc/c46vsmdS/Creative-Portfolio.png">
  <meta property="og:url" content="https://wayanku.github.io/Wayan-ai-dari-storybali/">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="id_ID">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Wayan AI - Asisten Cerdas dari Storybali">
  <meta name="twitter:description" content="Ngobrol dengan Wayan AI, asisten AI cerdas berbahasa Indonesia dari Storybali. Siap membantu menjawab pertanyaanmu dengan gaya santai dan ramah.">
  <meta name="twitter:image" content="https://i.postimg.cc/c46vsmdS/Creative-Portfolio.png">
  <!-- ▲▲▲ AKHIR DARI META TAGS ▲▲▲ -->

  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2299.77">
  <!-- Viewport diubah untuk menangani safe area (home bar) di iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Library untuk memformat Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

    /* === CSS VARIABLES UNTUK DARK/LIGHT MODE === */
    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f7f8fc;
      --bg-tertiary: #f1f5f9;
      --bg-accent: #eef2ff;
      --text-primary: #1e293b;
      --text-secondary: #475569;
      --text-light: #64748b;
      --border-color: #e2e8f0;
      --ai-message-bg: #e2e8f0;
      --modal-bg: rgba(255, 255, 255, 0.98);
      --settings-card-bg: #ffffff;
      --shadow-color: rgba(0, 0, 0, 0.05);
    }

    html.dark {
      --bg-primary: #121212;        /* Pure Black/Off-black */
      --bg-secondary: #1e1e1e;      /* Darker Gray */
      --bg-tertiary: #2a2a2a;      /* Lighter Gray */
      --bg-accent: #3c3c3c;        /* Accent Gray for selections */
      --text-primary: #f5f5f5;      /* Bright White for readability */
      --text-secondary: #a0a0a0;    /* Medium Gray */
      --text-light: #6b6b6b;        /* Darker Gray */
      --border-color: #3a3a3a;
      --ai-message-bg: #2c2c2c;
      --modal-bg: rgba(20, 20, 20, 0.95);
      --settings-card-bg: #1e1e1e;
      --shadow-color: rgba(0, 0, 0, 0.3);
    }
    /* === AKHIR DARI CSS VARIABLES === */
    
    /* [FIX] Membuat teks pengaturan lebih terang di mode gelap */
    html.dark .settings-card label,
    html.dark .settings-card h4,
    html.dark #settingsModal h3,
    html.dark .modal-content .text-gray-800,
    html.dark .modal-content .text-gray-700,
    html.dark .modal-content .text-gray-600,
    html.dark .modal-content .text-purple-600 {
        color: var(--text-primary) !important;
    }
    html.dark .modal-content .text-gray-500 {
        color: var(--text-secondary) !important;
    }

    /* [FIX] Membuat header/footer modal pengaturan menjadi gelap */
    html.dark #settingsModal .modal-content > div[class*="bg-white"],
    html.dark #settingsModal .modal-content > div[class*="bg-gray-50"] {
        background-color: var(--bg-secondary) !important;
        border-color: var(--border-color) !important;
    }
    
    /* [FIX] Membuat kotak teks profil menjadi gelap */
    html.dark #profileModal .bg-gray-50 {
        background-color: var(--bg-tertiary) !important;
    }

    /* ▼▼▼ [FIX BARU] Membuat tombol footer modal pengaturan menjadi gelap ▼▼▼ */
    html.dark #settingsModal .settings-btn-action.bg-gray-200 {
        background-color: var(--bg-tertiary) !important;
        color: var(--text-primary) !important;
    }
    html.dark #settingsModal .settings-btn-action.bg-gray-200:hover {
        background-color: var(--bg-accent) !important;
    }
    html.dark #settingsModal .settings-btn-action.bg-blue-600:hover {
        background-color: #2563eb !important; /* Sedikit lebih terang untuk kontras */
    }
    /* ▲▲▲ AKHIR DARI FIX BARU ▲▲▲ */


    * {
        -webkit-tap-highlight-color: transparent;
        transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--bg-secondary) !important;
    }
    
    #appContainer {
        display: flex;
        height: 100vh;
        height: calc(var(--vh, 1vh) * 100);
        width: 100vw;
        position: relative;
    }

    /* === SIDEBAR STYLES === */
    #sidebar {
        width: 260px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border-color);
        display: flex;
        flex-direction: column;
        transition: transform 0.3s ease-in-out, min-width 0.3s ease-in-out, width 0.3s ease-in-out;
        flex-shrink: 0;
    }
    #sidebar.collapsed {
        min-width: 0px;
        width: 0px;
        transform: translateX(-260px);
        padding: 0;
        border-right: none;
    }
    .new-chat-btn {
        display: flex;
        align-items: center;
        justify-content: space-between;
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 0.75rem;
        font-weight: 500;
        color: var(--text-secondary);
        background: var(--bg-primary);
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px var(--shadow-color);
    }
    .new-chat-btn:hover {
        border-color: #a5b4fc;
        color: #4f46e5;
    }
    html.dark .new-chat-btn:hover {
        border-color: #777;
        color: var(--text-primary);
    }

    #chatHistoryList {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .chat-history-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.6rem 1rem;
        margin: 0.25rem 0.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        color: var(--text-secondary);
        font-size: 0.875rem;
        transition: background-color 0.2s ease, color 0.2s ease;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .chat-history-item:hover {
        background-color: var(--bg-tertiary);
    }
    .chat-history-item.active {
        background-color: #4f46e5;
        color: white;
        font-weight: 500;
    }
    html.dark .chat-history-item.active {
        background-color: #f5f5f5;
        color: #121212;
    }

    .chat-history-item .title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-grow: 1;
        margin-right: 0.5rem;
    }
    .chat-history-item .actions {
        display: flex;
        gap: 0.5rem;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .chat-history-item:hover .actions, .chat-history-item.active .actions {
        opacity: 1;
    }
    .chat-history-item .action-icon {
        padding: 2px;
        border-radius: 4px;
    }
    .chat-history-item .action-icon:hover {
        background-color: rgba(0,0,0,0.1);
    }
    .chat-history-item.active .action-icon:hover {
        background-color: rgba(255,255,255,0.3);
    }
    html.dark .chat-history-item.active .action-icon:hover {
        background-color: rgba(0,0,0,0.3);
    }
    
    /* === CSS UNTUK OVERLAY MOBILE === */
    #sidebarOverlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 99;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    #sidebarOverlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .chat-container {
        background: var(--bg-primary);
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        min-width: 0;
    }

    .chat-window {
        background: var(--bg-primary);
        border: none;
        box-shadow: none;
        animation: slideInUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        height: 100%;
        width: 100%;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        position: relative;
        border-radius: 0;
    }

    @keyframes slideInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .header-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        position: relative;
        overflow: hidden;
    }
    html.dark .header-gradient {
        background: #222222 !important; /* Black/White header for dark mode */
    }

    .header-gradient::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        animation: shimmer 3s infinite;
    }
    @keyframes shimmer {
        0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .ai-avatar {
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: avatarPulse 2s infinite; position: relative;
        border: 3px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.4);
        border-radius: 9999px !important;
    }
    html.dark .ai-avatar {
        background: #555 !important;
        border-color: #777;
        box-shadow: 0 0 0 0 rgba(150, 150, 150, 0.4);
        animation: avatarPulseDark 2s infinite;
    }

    .ai-avatar::after {
        content: ''; position: absolute; inset: -2px;
        background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
        border-radius: inherit; z-index: -1;
        animation: rotate 4s linear infinite;
    }
    html.dark .ai-avatar::after {
        background: linear-gradient(45deg, #eee, #888, #eee);
    }
    @keyframes avatarPulse {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(102, 126, 234, 0); }
    }
    @keyframes avatarPulseDark {
        0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(150, 150, 150, 0.7); }
        50% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(150, 150, 150, 0); }
    }
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    .message-bubble {
        animation: messageSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        transform-origin: bottom left; margin-bottom: 1rem;
    }
    .message-bubble.user { transform-origin: bottom right; }
    @keyframes messageSlide {
        from { opacity: 0; transform: translateY(20px) scale(0.8); }
        to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .ai-message {
        background: var(--ai-message-bg);
        box-shadow: 0 2px 8px var(--shadow-color);
        border: 1px solid rgba(102, 126, 234, 0.05);
        border-radius: 1.25rem; border-top-left-radius: 0.375rem;
        padding: 1rem; max-width: 85%; position: relative;
    }
    .user-message {
        background: linear-gradient(135deg, #10b981, #059669);
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); color: white;
        border-radius: 1.25rem; border-top-right-radius: 0.375rem;
        padding: 1rem; max-width: 85%;
    }
    html.dark .user-message {
        background: #333333;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        color: var(--text-primary);
    }

    /* ▼▼▼ CSS UNTUK WAKTU CHAT ▼▼▼ */
    .chat-timestamp {
        font-size: 0.65rem;
        color: var(--text-light);
        margin-top: 0.5rem;
    }
    .user-message .chat-timestamp {
        color: rgba(255, 255, 255, 0.8);
    }
    html.dark .user-message .chat-timestamp {
        color: #a0a0a0;
    }
    /* ▲▲▲ AKHIR DARI CSS BARU ▲▲▲ */


    .system-message-bubble {
        display: flex; justify-content: center; margin: 0.5rem 0;
        animation: messageSlide 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .system-message {
        background-color: var(--ai-message-bg);
        color: var(--text-secondary);
        font-size: 0.75rem;
        font-style: italic; padding: 0.25rem 0.75rem; border-radius: 9999px;
    }

    .typing-indicator { display: none; align-items: center; margin-bottom: 1rem; }
    .typing-indicator.show { display: flex; animation: fadeInBounce 0.5s ease-out; }
    @keyframes fadeInBounce {
        0% { opacity: 0; transform: translateY(10px) scale(0.8); }
        60% { opacity: 1; transform: translateY(-2px) scale(1.02); }
        100% { opacity: 1; transform: translateY(0) scale(1); }
    }
    .dot {
        width: 8px; height: 8px; border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        animation: typing 1.4s infinite ease-in-out; margin: 0 2px;
    }
    html.dark .dot {
        background: #888;
    }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    .dot:nth-child(3) { animation-delay: 0s; }
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8) translateY(0); opacity: 0.5; }
        40% { transform: scale(1.2) translateY(-8px); opacity: 1; }
    }

    .input-area {
        background: var(--bg-primary);
        padding: 0.75rem 1rem calc(0.75rem + env(safe-area-inset-bottom)) 1rem;
    }

    .input-box {
        display: flex;
        flex-direction: column;
        width: 100%;
        background-color: var(--bg-tertiary);
        border-radius: 1.25rem;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border-color);
        position: relative; /* [BARU] Diperlukan untuk UI Perekaman Suara */
    }

    .input-box input {
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        padding: 0.5rem;
        font-size: 16px;
        color: var(--text-primary);
    }

    .input-box input::placeholder { color: var(--text-light); }

    .action-buttons {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-top: 0.5rem;
    }

    .action-buttons .left-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .action-btn {
        color: var(--text-secondary);
        background: none;
        border: none;
        cursor: pointer;
        transition: color 0.2s ease;
        padding: 0.25rem;
    }
    .action-btn:hover { color: #4f46e5; }
    html.dark .action-btn:hover { color: var(--text-primary); }
    .action-btn span { font-size: 0.9rem; font-weight: 500; }
    
    .dynamic-icon-container {
        position: relative;
        width: 2.5rem;
        height: 2.5rem;
    }

    .dynamic-icon-btn {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: var(--bg-tertiary);
        border-radius: 9999px;
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out, background-color 0.3s ease;
        border: none;
        cursor: pointer;
        color: var(--text-secondary);
    }
    .dynamic-icon-btn.send-btn-active {
        background-color: #4f46e5;
        color: white;
    }
    html.dark .dynamic-icon-btn.send-btn-active {
        background-color: #f5f5f5 !important;
        color: #121212;
    }
    .dynamic-icon-btn:active { transform: scale(0.9); }
    
    /* === [BARU] STYLE UNTUK FITUR BARU === */
    .voice-wave { display: flex; align-items: center; gap: 4px; height: 24px; }
    .wave-bar { width: 4px; height: 100%; background: #667eea; border-radius: 2px; animation: waveAnimation 1s infinite ease-in-out; }
    html.dark .wave-bar { background: #888; }
    .wave-bar:nth-child(2) { animation-delay: 0.1s; }
    .wave-bar:nth-child(3) { animation-delay: 0.2s; }
    .wave-bar:nth-child(4) { animation-delay: 0.3s; }
    .wave-bar:nth-child(5) { animation-delay: 0.4s; }
    @keyframes waveAnimation {
        0%, 40%, 100% { transform: scaleY(0.4); }
        20% { transform: scaleY(1); }
    }
    
    #stopGeneratingContainer button {
      background-color: var(--bg-primary);
      color: var(--text-secondary);
      border: 1px solid var(--border-color);
      box-shadow: 0 2px 5px var(--shadow-color);
      transition: all 0.2s ease;
    }
    #stopGeneratingContainer button:hover {
      background-color: var(--bg-tertiary);
      transform: translateY(-1px);
    }
    /* === AKHIR DARI STYLE BARU === */


    .quick-actions {
        display: flex; gap: 0.5rem; padding: 0.75rem 1rem;
        background: var(--bg-primary);
        border-top: 1px solid var(--border-color);
        overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none;
        box-shadow: inset 0 -2px 5px var(--shadow-color);
    }
    .quick-actions::-webkit-scrollbar { display: none; }
    .quick-action-btn {
        flex-shrink: 0; padding: 0.5rem 1rem; background: var(--bg-accent);
        border: 1px solid #a7c0ff; border-radius: 9999px; font-size: 0.75rem;
        font-weight: 500; color: #4f46e5; transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 5px var(--shadow-color);
    }
    html.dark .quick-action-btn { color: var(--text-primary); border-color: #555; }
    .quick-action-btn:hover { background: #c7d2fe; border-color: #6366f1; transform: translateY(-1px); }
    html.dark .quick-action-btn:hover { background: #4a4a4a; border-color: #777; }
    .quick-action-btn:active { background: #a5b4fc; transform: scale(0.98); }

    .suggestion-btn {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 9999px; font-size: 0.7rem; color: var(--text-secondary);
        transition: all 0.2s ease-in-out; padding: 0.4rem 0.8rem;
    }
    .suggestion-btn:hover, .suggestion-btn:active {
        background: var(--bg-accent);
        border-color: #a0aec0; transform: translateY(-1px);
    }
    html.dark .suggestion-btn:hover, html.dark .suggestion-btn:active {
        border-color: #777;
    }

    .modal-overlay {
        background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);
        transition: opacity 0.3s ease;
    }
    .modal-content {
        background: var(--modal-bg);
        border: 1px solid rgba(255, 255, 255, 0.4); border-radius: 1.5rem;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2); transform: scale(0.9);
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    }
    html.dark .modal-content { border: 1px solid var(--border-color); }
    #settingsModal .modal-content {
        background: var(--bg-secondary);
        padding: 0; overflow: hidden;
    }
    .modal-overlay.hidden { opacity: 0; pointer-events: none; }
    .modal-overlay:not(.hidden) .modal-content { opacity: 1; transform: scale(1); }
    .modal-close-btn {
        background: #ef4444; box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        transition: all 0.2s ease-in-out; border-radius: 9999px !important;
    }
    html.dark .modal-close-btn { background: #444; box-shadow: none; color: #fff; }
    
    #settingsModal .modal-close-btn {
        background: var(--bg-tertiary);
        box-shadow: none; color: var(--text-secondary);
    }
    #settingsModal .modal-close-btn:hover { background: #cbd5e1; transform: scale(1.05); }
    html.dark #settingsModal .modal-close-btn:hover { background: #555; }
    .modal-close-btn:hover { background: #dc2626; transform: scale(1.05); }
    .modal-close-btn:active { transform: scale(0.95); }

    .profile-avatar-border {
        border: 4px solid;
        border-image: linear-gradient(135deg, #667eea, #764ba2, #f093fb) 1;
        animation: rotateBorder 4s linear infinite;
        border-radius: 9999px !important;
    }
    html.dark .profile-avatar-border {
        border-image: linear-gradient(135deg, #eee, #888, #eee) 1 !important;
    }

    @keyframes rotateBorder {
        0% { border-image-source: linear-gradient(135deg, #667eea, #764ba2, #f093fb); }
        25% { border-image-source: linear-gradient(135deg, #764ba2, #f093fb, #667eea); }
        50% { border-image-source: linear-gradient(135deg, #f093fb, #667eea, #764ba2); }
        75% { border-image-source: linear-gradient(135deg, #667eea, #764ba2, #f093fb); }
        100% { border-image-source: linear-gradient(135deg, #764ba2, #f093fb, #667eea); }
    }
    
    .settings-tab { transition: all 0.3s ease; border-bottom: 2px solid transparent; color: var(--text-secondary); }
    .settings-tab.active { color: #4f46e5; font-weight: 600; border-bottom-color: #4f46e5; }
    html.dark .settings-tab.active { color: var(--text-primary); border-bottom-color: var(--text-primary); }
    .settings-tab-content { display: none; animation: fadeIn 0.5s ease; }
    .settings-tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .settings-card {
        background: var(--settings-card-bg);
        border-radius: 1rem; padding: 1rem;
        box-shadow: 0 4px 12px var(--shadow-color);
        transition: all 0.3s ease;
    }
    .settings-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px var(--shadow-color); }
    .settings-item { display: flex; align-items: center; justify-content: space-between; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
    .settings-item.flex-col {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    .settings-item:last-child { border-bottom: none; }
    .settings-icon { width: 1.25rem; height: 1.25rem; color: #6366f1; }
    html.dark .settings-icon { color: var(--text-primary); }

    .settings-input, .settings-select, #customRoleInput {
        border-radius: 0.5rem; background: var(--bg-tertiary); border: 1px solid var(--border-color);
        padding: 0.5rem 0.75rem;
        transition: all 0.2s ease-in-out; width: 55%;
        font-size: 16px !important; color: var(--text-primary);
    }
    .settings-input:focus, .settings-select:focus, #customRoleInput:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); outline: none;
    }
    html.dark .settings-input:focus, html.dark .settings-select:focus, html.dark #customRoleInput:focus {
        border-color: #f5f5f5;
        box-shadow: 0 0 0 2px rgba(245, 245, 245, 0.2);
    }

    .settings-btn-action {
        width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        padding: 0.75rem; border-radius: 0.75rem; font-weight: 500;
        transition: all 0.2s ease-in-out;
    }
    .settings-btn-action:hover { transform: translateY(-1px); }
    .settings-btn-action:active { transform: scale(0.98); }
    .theme-option-new {
        border-radius: 0.75rem; padding: 0.5rem; border: 2px solid transparent;
        transition: all 0.2s ease-in-out; cursor: pointer; text-align: center;
    }
    .theme-option-new.active { border-color: #4f46e5; background-color: var(--bg-accent); }
    html.dark .theme-option-new.active { border-color: #555; }
    .theme-swatch { width: 100%; height: 1.5rem; border-radius: 0.5rem; margin-bottom: 0.5rem; }
    .toggle-new {
        appearance: none; width: 44px; height: 24px; border-radius: 12px;
        background-color: var(--bg-tertiary);
        position: relative; cursor: pointer; transition: background-color 0.3s ease;
    }
    .toggle-new::before {
        content: ''; position: absolute; top: 3px; left: 3px;
        width: 18px; height: 18px; border-radius: 50%; background-color: white;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    html.dark .toggle-new::before { background-color: #121212; }
    .toggle-new:checked { background-color: #6366f1; }
    html.dark .toggle-new:checked { background-color: #f5f5f5; }
    .toggle-new:checked::before { transform: translateX(20px); }

    .choice-btn {
        width: 100%;
        padding: 0.5rem;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-color);
        border-radius: 0.5rem;
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
        transition: all 0.2s ease-in-out;
        text-align: center;
        cursor: pointer;
    }
    .choice-btn:hover {
        background: var(--bg-accent);
        border-color: #cbd5e1;
    }
    html.dark .choice-btn:hover { border-color: #555; }
    .choice-btn.active {
        background: var(--bg-accent);
        border-color: #6366f1;
        color: #4f46e5;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1);
    }
    html.dark .choice-btn.active { 
        border-color: #f5f5f5;
        color: var(--text-primary);
        box-shadow: 0 2px 4px rgba(245, 245, 245, 0.1);
    }
    
    .markdown-content, .markdown-content strong, .markdown-content p, .markdown-content li { 
        color: var(--text-primary); 
        overflow-wrap: break-word; /* [FIX] Mencegah link keluar dari gelembung chat */
        word-wrap: break-word; /* Fallback */
    }
    .markdown-content p:not(:last-child) { margin-bottom: 0.75rem; }
    .markdown-content ul, .markdown-content ol {
        list-style-position: inside;
        padding-left: 0.5rem;
        margin-bottom: 0.75rem;
    }
    .markdown-content li { margin-bottom: 0.25rem; }
    .markdown-content code:not(pre > code) {
        background-color: var(--bg-tertiary);
        padding: 0.1rem 0.3rem;
        border-radius: 0.25rem;
        font-size: 0.85em;
        font-family: 'Courier New', Courier, monospace;
    }
    .markdown-content pre {
        background-color: #1e293b;
        color: #e2e8f0;
        padding: 0.75rem;
        border-radius: 0.5rem;
        overflow-x: auto;
        margin-bottom: 0.75rem;
        font-size: 0.85em;
    }
    html.dark .markdown-content pre { background-color: #0c0c0c; }
    .markdown-content pre code {
        background: transparent;
        padding: 0;
    }
    .markdown-content blockquote {
        border-left: 4px solid #a5b4fc;
        padding-left: 1rem;
        margin-left: 0.25rem;
        font-style: italic;
        color: var(--text-secondary);
    }
    html.dark .markdown-content blockquote {
        border-left-color: #888;
    }
    .markdown-content strong { font-weight: 600; }

    /* ▼▼▼ [BARU] GAYA UNTUK LINK AGAR BERWARNA BIRU ▼▼▼ */
    .markdown-content a {
        color: #3b82f6; /* Warna biru */
        text-decoration: underline;
        font-weight: 500;
    }
    .markdown-content a:hover {
        color: #2563eb;
    }
    html.dark .markdown-content a {
        color: #60a5fa; /* Warna biru lebih terang untuk mode gelap */
    }
    html.dark .markdown-content a:hover {
        color: #93c5fd;
    }
    /* ▲▲▲ AKHIR DARI GAYA LINK ▲▲▲ */


    /* === CSS RESPONSIVE UNTUK MOBILE === */
    @media (max-width: 768px) {
        #sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            z-index: 100;
            transform: translateX(-100%);
            border-right: 1px solid var(--border-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            width: 80vw;
            max-width: 280px;
        }
        #sidebar.open {
            transform: translateX(0);
        }
        
        .message-bubble { margin-bottom: 0.75rem; }
        .ai-message, .user-message { max-width: 90%; padding: 0.8rem 1.2rem; }
        .quick-actions { padding: 0.6rem 0.8rem; }
        .quick-action-btn { padding: 0.4rem 0.8rem; font-size: 0.7rem; }
        .modal-content { border-radius: 1rem; padding: 1.5rem; }
        #settingsModal .modal-content { padding: 0; }
        .settings-input, .settings-select, #customRoleInput {
            font-size: 16px !important;
        }
    }
    
    .chat-messages::-webkit-scrollbar { width: 8px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.2); border-radius: 20px;
      border: 2px solid transparent; background-clip: content-box;
    }
    html.dark .chat-messages::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
    }
    .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(0, 0, 0, 0.3); }
    html.dark .chat-messages::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.3); }
    
    /* ▼▼▼ CSS BARU UNTUK FITUR PANGGILAN SUARA ▼▼▼ */
    #callModal {
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
    }
    .call-avatar-container {
        animation: call-pulse 2s infinite;
    }
    @keyframes call-pulse {
        0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
        70% { box-shadow: 0 0 0 20px rgba(255, 255, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
    }
    /* ▲▲▲ AKHIR DARI CSS PANGGILAN SUARA ▲▲▲ */
  </style>
</head>
<body>
<!-- ... (Isi dari <body> Anda tetap sama) ... -->
<div id="appContainer">
    <div id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <div id="sidebar">
        <div class="p-4 flex flex-col h-full">
            <div class="mb-4 flex-shrink-0">
                <button onclick="startNewChat()" class="new-chat-btn group">
                    <span>Mulai Chat Baru</span>
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                </button>
            </div>
            <div class="flex-grow overflow-y-auto -mr-2 pr-2">
                 <ul id="chatHistoryList">
                 </ul>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-window flex flex-col">
            <div class="header-gradient p-4 text-white relative flex-shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <button onclick="toggleSidebar()"
                                class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95"
                                title="Tampilkan Riwayat">
                             <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        </button>
                        <div class="flex items-center space-x-3">
                            <div class="ai-avatar w-12 h-12 flex-shrink-0 flex items-center justify-center overflow-hidden relative cursor-pointer" onclick="showProfileModal()">
                                <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali"
                                     class="w-full h-full object-cover">
                            </div>
                            <div>
                                <h1 class="text-xl font-bold">Wayan AI</h1>
                                <p class="text-blue-100 text-sm opacity-90">Klik untuk lihat profil</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- ▼▼▼ TOMBOL PANGGILAN SUARA BARU ▼▼▼ -->
                        <button id="startCallBtn" onclick="startCall()"
                                class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95"
                                title="Mulai Panggilan Suara">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                        </button>
                        <!-- ▲▲▲ AKHIR DARI TOMBOL PANGGILAN SUARA ▲▲▲ -->
                        <button onclick="toggleSettings()"
                                class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all duration-200 ease-in-out transform hover:scale-105 active:scale-95">
                            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div class="quick-actions flex-shrink-0">
                <button class="quick-action-btn" onclick="sendQuickMessage('Halo Wayan!')">Halo</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Apa kabar hari ini?')">Apa kabar?</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Ceritakan joke lucu dong!')">Joke</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Kasih tips produktif dong!')">Tips Produktif</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Rekomendasi film bagus dong!')">Film</button>
                <button class="quick-action-btn" onclick="sendQuickMessage('Ajarin coding dong!')">Coding</button>
            </div>
            <div id="chatMessages" class="flex-1 overflow-y-auto p-4 chat-messages">
                 <!-- Typing Indicator will be added here by JS -->
                 <div id="typingIndicator" class="typing-indicator items-start space-x-3">
                    <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden"><img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover"></div>
                    <div class="ai-message rounded-2xl rounded-tl-md p-4"><div class="flex space-x-1"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>
                </div>
                <!-- Image Processing Indicator -->
                <div id="imageProcessingIndicator" class="typing-indicator items-start space-x-3">
                    <div class="ai-avatar w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 overflow-hidden"><img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover"></div>
                    <div class="ai-message rounded-2xl rounded-tl-md p-4 flex items-center">
                        <div class="flex space-x-1"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                        <span class="ml-2 text-sm" style="color: var(--text-secondary);">Menganalisis gambar...</span>
                    </div>
                </div>
            </div>
            
            <div id="stopGeneratingContainer" class="text-center p-2" style="display: none;">
                <button id="stopBtn" class="py-2 px-4 border rounded-full text-sm font-medium flex items-center gap-2 mx-auto">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm4 0a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    Hentikan
                </button>
            </div>
            
            <div class="input-area flex-shrink-0">
                <div class="input-box">
                    <input
                        type="text"
                        id="messageInput"
                        placeholder="Minta Wayan AI..."
                        onkeypress="handleKeyPress(event)"
                        oninput="handleInputChange(event)"
                    >

                    <!-- [REFINED] UI Perekaman Suara -->
                    <div id="voiceRecordingUI" class="absolute inset-0 items-center justify-start px-4 hidden" style="background-color: var(--bg-tertiary); border-radius: 1.25rem;">
                        <div class="flex items-center gap-3 min-w-0">
                            <div class="voice-wave">
                                <div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div><div class="wave-bar"></div>
                            </div>
                            <span id="voiceStatusText" class="text-sm text-gray-500 dark:text-gray-400 truncate">Mendengarkan...</span>
                        </div>
                    </div>
                    <!-- Akhir UI Perekaman Suara -->

                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    
                    <div class="action-buttons">
                        <div class="left-actions">
                            <button onclick="triggerImageUpload()" class="action-btn" title="Upload Gambar">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                            </button>
                            <button onclick="videoNotAvailable()" class="action-btn" title="Fitur Video">
                                <span>Video</span>
                            </button>
                            <button onclick="openQuickSettings()" class="action-btn" title="Pengaturan Cepat">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg>
                            </button>
                        </div>
                        
                        <div class="dynamic-icon-container">
                            <button id="micBtn" onclick="toggleVoiceMode()" class="dynamic-icon-btn" title="Mode Suara">
                                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>
                            <button id="sendBtn" onclick="sendMessage()" class="dynamic-icon-btn send-btn-active" title="Kirim Pesan" style="opacity: 0; pointer-events: none;">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
    
<!-- ▼▼▼ MODAL BARU UNTUK PANGGILAN SUARA ▼▼▼ -->
<div id="callModal" class="fixed inset-0 z-50 flex-col items-center justify-center hidden" style="background-color: rgba(0,0,0,0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
    <div class="text-center text-white">
        <div class="call-avatar-container w-32 h-32 rounded-full p-1 mx-auto mb-6" style="border: 3px solid rgba(255,255,255,0.5);">
            <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="Wayan AI Avatar" class="w-full h-full object-cover rounded-full">
        </div>
        <h2 class="text-2xl font-bold">Wayan AI</h2>
        <p id="callStatusText" class="text-lg mt-2 text-gray-300 transition-all duration-300">Menghubungkan...</p>
    </div>
    <button id="endCallBtn" onclick="endCall()" class="absolute bottom-16 w-16 h-16 bg-red-600 rounded-full flex items-center justify-center shadow-lg transform hover:scale-110 transition-transform">
        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l-8 8m0-8l8 8"></path></svg>
    </button>
</div>
<!-- ▲▲▲ AKHIR DARI MODAL PANGGILAN SUARA ▲▲▲ -->

<!-- Semua Modal Lainnya (tidak diubah) -->
<div id="imagePreviewModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
    <div class="modal-content p-6 max-w-sm w-full" id="imagePreviewContent">
        <div class="text-center relative">
            <button onclick="hideImagePreview()" class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div class="mb-4">
                <img id="previewImage" src="" alt="Preview" class="w-full h-auto rounded-lg max-h-48 object-cover mx-auto shadow-md">
                <p id="previewFileName" class="text-sm text-gray-600 mt-2"></p>
            </div>
            <div class="mb-4">
                <label class="block text-left text-sm font-medium text-gray-700 mb-2">Tanya sesuatu tentang gambar ini:</label>
                <textarea id="imageQuestionInput" placeholder="Contoh: Apa yang ada di gambar ini?..." class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none text-sm settings-input" rows="3"></textarea>
            </div>
            <div class="flex space-x-3">
                <button onclick="hideImagePreview()" class="flex-1 bg-gray-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn">Batal</button>
                <button onclick="sendImageWithQuestion()" class="flex-1 bg-gradient-to-r from-blue-500 to-purple-500 text-white py-3 rounded-xl font-semibold text-sm settings-btn">Kirim</button>
            </div>
        </div>
    </div>
</div>
<div id="profileModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
    <div class="modal-content p-6 max-w-sm w-full" id="profileModalContent">
        <div class="text-center relative">
            <button onclick="hideProfileModal()" class="absolute -top-2 -right-2 w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
            <div class="w-20 h-20 mx-auto mb-4 overflow-hidden profile-avatar-border shadow-lg">
                <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="StoryBali" class="w-full h-full object-cover">
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">Wayan AI</h2>
            <p class="text-purple-600 font-semibold mb-4 text-sm">AI Assistant Dari Storybali</p>
            <div class="text-gray-600 text-xs leading-relaxed mb-4 text-left bg-gray-50 p-3 rounded-xl">
                <p class="mb-2"><strong>Halo! Gue Wayan!</strong></p>
                <p class="mb-2">Gue adalah AI assistant yang dibuat khusus untuk membantu kamu dengan gaya bahasa yang santai dan friendly.</p>
                <p>Santai aja, tanya apa aja yang kamu mau!</p>
                <p>Kepoin Wayan yuk di Instagram atau chat WA pribadi Wayan!</p>
            </div>
            <div class="grid grid-cols-2 gap-2 text-xs">
                <a href="https://www.instagram.com/sudiarsana_wayan?igsh=MXE4NHFvZzAyOXd6NQ%3D%3D&utm_source=qr" target="_blank" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white px-3 py-2 rounded-full settings-btn">Instagram</a>
                <a href="https://wa.me/message/RNPBCG25N5V2A1" target="_blank" class="bg-gradient-to-r from-green-500 to-green-600 text-white px-3 py-2 rounded-full settings-btn">WhatsApp</a>
            </div>
        </div>
    </div>
</div>
<div id="settingsModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
    <div class="modal-content max-w-sm w-full max-h-[90vh] overflow-hidden flex flex-col" id="settingsModalContent">
        <div class="p-4 flex items-center justify-between flex-shrink-0 bg-white border-b border-gray-200">
            <h3 class="text-lg font-bold text-gray-800">Pengaturan</h3>
            <button onclick="toggleSettings()" class="w-8 h-8 rounded-full flex items-center justify-center shadow-lg modal-close-btn">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
        </div>
        <div class="flex-shrink-0 bg-white border-b border-gray-200">
            <nav class="flex justify-around text-sm text-gray-600">
                <button onclick="switchSettingsTab('general')" class="settings-tab active flex-1 py-3 px-2 text-center">Umum</button>
                <button onclick="switchSettingsTab('appearance')" class="settings-tab flex-1 py-3 px-2 text-center">Tampilan</button>
                <button onclick="switchSettingsTab('advanced')" class="settings-tab flex-1 py-3 px-2 text-center">Lanjutan</button>
            </nav>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4">
            <div id="tab-general" class="settings-tab-content active space-y-4">
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Nama AI</label>
                        </div>
                        <input type="text" id="aiNameInput" value="Wayan" class="settings-input text-right" readonly style="cursor: not-allowed;">
                    </div>
                    <div class="settings-item flex-col">
                        <div class="w-full flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m4 0v2M3 19h18M5 15h14M9 11h6"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Bahasa</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2 w-full pt-2">
                            <button id="language-id" onclick="selectChoice('language', 'id', this)" class="choice-btn">Indonesia</button>
                            <button id="language-en" onclick="selectChoice('language', 'en', this)" class="choice-btn">English</button>
                        </div>
                    </div>
                    <div class="settings-item flex-col">
                        <div class="w-full flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Gaya Bahasa</label>
                        </div>
                        <div class="grid grid-cols-3 gap-2 w-full pt-2">
                            <button id="personality-santai" onclick="selectChoice('personality', 'santai', this)" class="choice-btn">Santai</button>
                            <button id="personality-profesional" onclick="selectChoice('personality', 'profesional', this)" class="choice-btn">Profesional</button>
                            <button id="personality-lucu" onclick="selectChoice('personality', 'lucu', this)" class="choice-btn">Humoris</button>
                        </div>
                    </div>
                </div>
                <div class="settings-card">
                    <div class="settings-item flex-col">
                         <div class="w-full flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5h1.586a1 1 0 01.707.293l2.414 2.414a1 1 0 01.293.707V21H9z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Mode Peran AI</label>
                        </div>
                        <div class="grid grid-cols-3 gap-2 w-full pt-2">
                            <button id="aiRole-umum" onclick="selectChoice('aiRole', 'umum', this)" class="choice-btn">Umum</button>
                            <button id="aiRole-guru_jepang" onclick="selectChoice('aiRole', 'guru_jepang', this)" class="choice-btn">B. Jepang</button>
                            <button id="aiRole-guru_matematika" onclick="selectChoice('aiRole', 'guru_matematika', this)" class="choice-btn">Matematika</button>
                            <button id="aiRole-dokter" onclick="selectChoice('aiRole', 'dokter', this)" class="choice-btn">Dokter</button>
                            <button id="aiRole-programmer" onclick="selectChoice('aiRole', 'programmer', this)" class="choice-btn">Programmer</button>
                            <button id="aiRole-penerjemah" onclick="selectChoice('aiRole', 'penerjemah', this)" class="choice-btn">Penerjemah</button>
                            <button id="aiRole-kustom" onclick="selectChoice('aiRole', 'kustom', this)" class="choice-btn col-span-3">Kustom...</button>
                        </div>
                    </div>
                    <div id="customRoleContainer" class="hidden p-2 mt-2">
                        <label class="block text-xs text-gray-600 mb-1">Definisikan peran kustom AI:</label>
                        <textarea id="customRoleInput" placeholder="Contoh: Kamu adalah seorang ahli sejarah..." class="w-full settings-input text-sm" rows="3"></textarea>
                    </div>
                </div>
            </div>
            <div id="tab-appearance" class="settings-tab-content space-y-4">
                <div class="settings-card">
                    <div class="p-2">
                        <h4 class="text-sm font-medium text-gray-700 mb-3">Tema Warna</h4>
                        <div id="themeOptionsContainer" class="grid grid-cols-3 gap-3">
                            <div onclick="changeTheme('blue')" id="themeBlue" class="theme-option-new active">
                                <div class="theme-swatch bg-gradient-to-r from-blue-500 to-purple-500"></div>
                                <span class="text-xs font-medium text-gray-600">Biru</span>
                            </div>
                            <div onclick="changeTheme('green')" id="themeGreen" class="theme-option-new">
                                <div class="theme-swatch bg-gradient-to-r from-green-500 to-teal-500"></div>
                                <span class="text-xs font-medium text-gray-600">Hijau</span>
                            </div>
                            <div onclick="changeTheme('pink')" id="themePink" class="theme-option-new">
                                <div class="theme-swatch bg-gradient-to-r from-pink-500 to-red-500"></div>
                                <span class="text-xs font-medium text-gray-600">Pink</span>
                            </div>
                        </div>
                        <p id="themeDisabledMessage" class="text-xs text-center text-gray-500 mt-2 hidden">Ubah tema hanya tersedia di mode terang.</p>
                    </div>
                </div>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Ukuran Font</label>
                        </div>
                        <select id="fontSizeSelect" class="settings-select text-right w-auto">
                            <option value="sm">Kecil</option>
                            <option value="base" selected>Normal</option>
                            <option value="lg">Besar</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Efek Animasi</label>
                        </div>
                        <input type="checkbox" id="animationToggle" class="toggle-new" checked>
                    </div>
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Mode Gelap</label>
                        </div>
                        <input type="checkbox" id="darkModeToggle" class="toggle-new" onchange="handleDarkModeToggle()">
                    </div>
                </div>
                <div class="settings-card">
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Suara Notifikasi</label>
                        </div>
                        <input type="checkbox" id="soundToggle" class="toggle-new" checked>
                    </div>
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Pembaca Jawaban</label>
                        </div>
                        <input type="checkbox" id="readAiResponseToggle" class="toggle-new" checked>
                    </div>

                    <!-- ▼▼▼ [PERBAIKAN] Pengaturan Sumber Audio Baru ▼▼▼ -->
                    <div class="settings-item flex-col">
                        <div class="w-full flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Sumber Audio</label>
                        </div>
                        <div class="grid grid-cols-2 gap-2 w-full pt-2">
                            <button id="audioSource-browser" onclick="selectChoice('audioSource', 'browser', this)" class="choice-btn">Bawaan Browser</button>
                            <button id="audioSource-elevenlabs" onclick="selectChoice('audioSource', 'elevenlabs', this)" class="choice-btn">ElevenLabs</button>
                        </div>
                    </div>
                    <!-- ▲▲▲ AKHIR DARI PERBAIKAN ▲▲▲ -->

                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Jenis Suara (Bawaan)</label>
                        </div>
                         <select id="voiceSelect" class="settings-select text-right">
                            <option value="">Memuat suara...</option>
                         </select>
                    </div>
                    
                    <div class="settings-item flex-col items-start" id="elevenLabsVoiceSettings">
                        <div class="flex items-center space-x-3 w-full justify-between">
                            <div class="flex items-center space-x-3">
                                <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                                <label class="text-sm font-medium text-gray-700">Suara ElevenLabs</label>
                            </div>
                            <div class="flex items-center gap-2">
                                <select id="elevenLabsVoiceSelect" class="settings-select text-right w-auto max-w-[120px]">
                                    <option value="">Masukkan API Key dulu</option>
                                </select>
                                <button id="previewElevenLabsVoiceBtn" title="Dengarkan Pratinjau Suara" class="w-8 h-8 flex items-center justify-center rounded-md bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2 px-1">Pilih "ElevenLabs" sebagai Sumber Audio dan simpan API Key di tab "Lanjutan" untuk menggunakan fitur ini.</p>
                    </div>
                </div>
            </div>
            <div id="tab-advanced" class="settings-tab-content space-y-4">
                 <div class="settings-card">
                    <div class="settings-item">
                        <div class="flex items-center space-x-3">
                            <svg class="settings-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h.01M15 10h.01M9 14h.01M15 14h.01"></path></svg>
                            <label class="text-sm font-medium text-gray-700">Simpan Riwayat</label>
                        </div>
                        <input type="checkbox" id="saveHistoryToggle" class="toggle-new" checked>
                    </div>
                    <div class="p-2 space-y-2">
                         <button onclick="exportChatHistory()" class="settings-btn-action bg-green-100 text-green-700 hover:bg-green-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span>Export Riwayat Chat Ini</span>
                         </button>
                         <button onclick="clearAllChatHistory()" class="settings-btn-action bg-red-100 text-red-700 hover:bg-red-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            <span>Hapus SEMUA Percakapan</span>
                         </button>
                    </div>
                </div>
                
                <div class="settings-card p-4">
                    <h4 class="text-sm font-semibold text-gray-800 mb-2">Beri Masukan</h4>
                    <p class="text-xs text-gray-500 mb-3">Punya ide atau saran? Beri tahu kami!</p>
                    <textarea id="settingsFeedbackInput" placeholder="Tulis masukan Anda di sini..." class="w-full settings-input text-sm" rows="4"></textarea>
                    <button id="sendSettingsFeedbackBtn" onclick="sendGeneralFeedback()" class="w-full settings-btn-action bg-green-600 text-white mt-3 hover:bg-green-700">
                        Kirim Masukan
                    </button>
                </div>
                
                <div class="settings-card p-4">
                    <h4 class="text-sm font-semibold text-gray-800 mb-3">API Keys</h4>
                    <div class="space-y-2 text-sm">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 1 (Utama)</label>
                            <input type="password" id="apiKey1" placeholder="Masukkan API Key" class="settings-input w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 2 (Cadangan)</label>
                            <input type="password" id="apiKey2" placeholder="Opsional" class="settings-input w-full">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 3 (Cadangan)</label>
                            <input type="password" id="apiKey3" placeholder="Opsional" class="settings-input w-full">
                        </div>
                         <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 4 (Cadangan)</label>
                            <input type="password" id="apiKey4" placeholder="Opsional" class="settings-input w-full">
                        </div>
                         <div>
                            <label class="block text-xs text-gray-500 mb-1">API Key Gemini 5 (Cadangan)</label>
                            <input type="password" id="apiKey5" placeholder="Opsional" class="settings-input w-full">
                        </div>
                        <div class="pt-2 border-t border-gray-200 dark:border-gray-700 mt-4">
                            <label class="block text-xs text-gray-500 mb-1">API Key ElevenLabs (Untuk Suara)</label>
                            <input type="password" id="elevenLabsApiKey" placeholder="masukkan api elevenlabs" class="settings-input w-full">
                        </div>
                        <button onclick="saveApiKeys()" class="w-full settings-btn-action bg-blue-600 text-white mt-4 hover:bg-blue-700">
                            Simpan API Keys
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="p-4 bg-gray-50 border-t border-gray-200 flex-shrink-0">
            <div class="grid grid-cols-2 gap-3">
                <button onclick="resetAllSettings()" class="settings-btn-action bg-gray-200 text-gray-800 hover:bg-gray-300 text-sm py-2">
                    <span>Reset</span>
                </button>
                <button onclick="saveAllSettings()" class="settings-btn-action bg-blue-600 text-white hover:bg-blue-700 text-sm py-2">
                    <span>Simpan & Tutup</span>
                </button>
            </div>
        </div>
        <div class="p-3 bg-white border-t border-gray-200 flex-shrink-0 text-center">
            <p class="text-xs text-gray-500">StoryBali v2.6.2 | © 2024</p>
        </div>
    </div>
</div>

<script>
    // ===================================================================================
    // KODE SCRIPT UTAMA (VERSI GABUNGAN DENGAN PERBAIKAN FINAL)
    // ===================================================================================

    function adjustHeightForMobile() {
        let vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }
    window.addEventListener('resize', adjustHeightForMobile);
    adjustHeightForMobile();

    function getFormattedTime(date = new Date()) {
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${hours}:${minutes}`;
    }
	
    function sendNewUserNotification(ipAddress) {
      if (localStorage.getItem('notificationSent')) {
        return;
      }
      const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
      const payload = {
        ip: ipAddress,
        timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' }),
        userAgent: navigator.userAgent,
        screenResolution: `${screen.width}x${screen.height}`,
        browserLanguage: navigator.language,
        connectionType: navigator.connection ? navigator.connection.effectiveType : 'unknown'
      };
      fetch(SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(payload),
        mode: 'no-cors'
      })
      .then(response => {
        console.log('Notifikasi lengkap pengguna baru berhasil dikirim.');
        localStorage.setItem('notificationSent', 'true');
      })
      .catch(error => console.error('Gagal mengirim notifikasi:', error));
    }
    
    let currentRating = 0;

    function showRatingModal() {
        currentRating = 0;
        document.getElementById('ratingFeedbackInput').value = '';
        renderStars();
        document.getElementById('ratingModal').classList.remove('hidden');
    }

    function hideRatingModal() {
        document.getElementById('ratingModal').classList.add('hidden');
    }
    
    function renderStars() {
        const container = document.getElementById('starRatingContainer');
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
            const starSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            starSVG.setAttribute('onclick', `handleStarClick(${i})`);
            starSVG.setAttribute('class', 'w-8 h-8 cursor-pointer star-icon transition-colors ' + (i <= currentRating ? 'text-yellow-400' : 'text-gray-300'));
            starSVG.setAttribute('fill', 'currentColor');
            starSVG.setAttribute('viewBox', '0 0 20 20');
            starSVG.innerHTML = `<path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>`;
            container.appendChild(starSVG);
        }
    }

    function handleStarClick(rating) {
        currentRating = rating;
        renderStars();
    }

    function trackUserMessageCount() {
        if (localStorage.getItem('ratingModalShown')) return;
        let messageCount = parseInt(localStorage.getItem('userMessageCount') || '0');
        messageCount++;
        localStorage.setItem('userMessageCount', messageCount);

        if (messageCount === 3) {
            setTimeout(() => {
                showRatingModal();
                localStorage.setItem('ratingModalShown', 'true');
            }, 2000);
        }
    }
    
    function submitRating() {
        if (currentRating === 0) {
            alert('Mohon pilih setidaknya 1 bintang.');
            return;
        }
        const feedbackText = document.getElementById('ratingFeedbackInput').value.trim();
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
        const payload = {
            type: 'rating',
            rating: currentRating,
            message: feedbackText || 'Tidak ada komentar tambahan.',
            userIP: currentUserIP || 'tidak diketahui',
            timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
        };
        const button = document.getElementById('submitRatingBtn');
        button.textContent = 'Mengirim...';
        button.disabled = true;

        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
        .then(() => { alert('Terima kasih atas penilaian Anda!'); hideRatingModal(); })
        .catch(error => { console.error('Gagal mengirim rating:', error); alert('Maaf, terjadi kesalahan.'); })
        .finally(() => { button.textContent = 'Kirim Nilai'; button.disabled = false; });
    }

    function sendGeneralFeedback() {
        const input = document.getElementById('settingsFeedbackInput');
        const feedbackText = input.value.trim();
        if (!feedbackText) {
            alert('Mohon tulis masukan Anda terlebih dahulu.');
            return;
        }
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzCMPCa3374vo347SbP2alsPWfb5MqKcspRHjkuU8ON6ooFLTTQE5h1RC2pxBNYor_Wuw/exec";
        const payload = {
            type: 'feedback',
            message: feedbackText,
            userIP: currentUserIP || 'tidak diketahui',
            timestamp: new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta' })
        };
        const button = document.getElementById('sendSettingsFeedbackBtn');
        button.textContent = 'Mengirim...';
        button.disabled = true;
        
        fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload), mode: 'no-cors' })
        .then(() => { alert('Terima kasih! Masukan Anda telah terkirim.'); input.value = ''; })
        .catch(error => { console.error('Gagal mengirim masukan:', error); alert('Maaf, terjadi kesalahan.'); })
        .finally(() => { button.textContent = 'Kirim Masukan'; button.disabled = false; });
    }

    let apiKeys = [];
    let allChatSessions = [];
    let activeChatId = null;
    let recognition = null;
    const CHAT_LIMIT = 4;
    const COOLDOWN_MINUTES = 1;
    let currentUserIP = null;
    let countdownInterval = null;

    let currentFetchController = null;
    let isRecording = false;
    let finalTranscript = '';
    
    let currentPreviewData = {
        base64: null,
        fileName: null,
        mimeType: null
    };

    const defaultSettings = {
        theme: 'blue',
        soundEnabled: true,
        animationsEnabled: true,
        readAiResponseEnabled: true,
        aiName: 'Wayan',
        language: 'id',
        personality: 'santai',
        aiRole: 'umum',
        customAiRolePrompt: '',
        fontSize: 'base',
        voiceURI: '',
        audioSource: 'browser', // Pilihan baru: 'browser' atau 'elevenlabs'
        elevenLabsVoiceId: '21m00Tcm4TlvDq8ikWAM',
        saveHistory: true,
        isSidebarOpen: window.innerWidth > 768,
        darkMode: false,
    };
    
    let settings = { ...defaultSettings };
    let currentUtterance = null;
    let isReading = false;
    let elevenLabsAudioPlayer = new Audio();
    let elevenLabsPreviewPlayer = new Audio();

    let isCallActive = false;
    let isAiSpeaking = false;
    let callRecognition = null;
    let silenceTimer = null;
    let callHistory = [];

    const DEFAULT_API_KEY_1 = 'AIzaSyClcqSMaHiXMZI4qYlTySqC3I3hWWg8H9s';
    const DEFAULT_API_KEY_2 = 'AIzaSyB8OPwzNAAyO1nWd9g185rx4YK3WIJy_Fw';
    const DEFAULT_API_KEY_3 = 'AIzaSyAYzvB1mfVdjrBtXY2n4-UUzCH5juQt8rU';
    const DEFAULT_API_KEY_4 = 'AIzaSyCkkekhKcQzFUUjx8ZcuqEYyqRde1ZDJcU';
    const DEFAULT_API_KEY_5 = 'AIzaSyCV-88PX1_tKh5VBjki9VeyY8gAH5bpZ0o';
    const DEFAULT_ELEVENLABS_API_KEY = '_51cca647c5de2291ff8247aad3561325390e4ef1e3166918';
    
    async function getUserIP() {
        try {
            const response = await fetch('https://api.ipify.org?format=json');
            if (!response.ok) throw new Error('Gagal mendapatkan IP');
            const data = await response.json();
            return data.ip;
        } catch (error) {
            console.error("Tidak bisa mendapatkan IP address:", error);
            return 'default_user';
        }
    }
    function getChatLimitData() { return JSON.parse(localStorage.getItem('wayanAiChatLimit') || '{}'); }
    function saveChatLimitData(data) { localStorage.setItem('wayanAiChatLimit', JSON.stringify(data)); }
    function checkUserStatus() {
        if (!currentUserIP) return;
        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP];
        if (userData && userData.cooldownUntil && new Date().getTime() < userData.cooldownUntil) {
            startCooldown(userData.cooldownUntil);
        } else if (userData) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }
    }
    function setInputEnabled(enabled, message = "Minta Wayan AI...") {
        const messageInput = document.getElementById('messageInput');
        messageInput.disabled = !enabled;
        messageInput.placeholder = message;
        document.querySelectorAll('.action-btn, .dynamic-icon-btn').forEach(btn => {
            btn.disabled = !enabled;
            btn.style.opacity = enabled ? '1' : '0.5';
            btn.style.cursor = enabled ? 'pointer' : 'not-allowed';
        });
    }
    function startCooldown(cooldownEndTime) {
        setInputEnabled(false, "Anda mencapai batas limit. Silakan tunggu...");
        const messageId = `cooldown-timer-${currentUserIP}`;
        if(document.getElementById(messageId)) document.getElementById(messageId).remove();
        const chatMessages = document.getElementById('chatMessages');
        const timerMessageElement = document.createElement('div');
        timerMessageElement.className = 'system-message-bubble';
        timerMessageElement.id = messageId; 
        chatMessages.appendChild(timerMessageElement);
        scrollToBottom(); 
        if (countdownInterval) clearInterval(countdownInterval);
        countdownInterval = setInterval(() => {
            const distance = cooldownEndTime - new Date().getTime();
            if (distance < 0) {
                endCooldown();
                return;
            }
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerMessageElement.innerHTML = `<div class="system-message">Anda mencapai batas limit mengirim chat. Kembali setelah ${minutes}m ${seconds}s lagi.</div>`;
        }, 1000);
    }
    function endCooldown() {
        clearInterval(countdownInterval);
        countdownInterval = null;
        const timerMessageElement = document.getElementById(`cooldown-timer-${currentUserIP}`);
        if (timerMessageElement) timerMessageElement.innerHTML = `<div class="system-message">Anda sudah bisa mengobrol lagi!</div>`;
        const allUserData = getChatLimitData();
        if (allUserData[currentUserIP]) {
            delete allUserData[currentUserIP];
            saveChatLimitData(allUserData);
        }
        setInputEnabled(true);
    }
    function handleInputChange(event) {
        const messageInput = event.target;
        const micBtn = document.getElementById('micBtn');
        const sendBtn = document.getElementById('sendBtn');
        if (messageInput.value.trim().length > 0) {
            micBtn.style.opacity = '0'; micBtn.style.pointerEvents = 'none';
            sendBtn.style.opacity = '1'; sendBtn.style.pointerEvents = 'auto';
        } else {
            micBtn.style.opacity = '1'; micBtn.style.pointerEvents = 'auto';
            sendBtn.style.opacity = '0'; sendBtn.style.pointerEvents = 'none';
        }
    }
    function videoNotAvailable() { alert('Fitur video belum tersedia untuk saat ini.'); }
    function openQuickSettings() {
        if (document.getElementById('settingsModal').classList.contains('hidden')) toggleSettings();
        switchSettingsTab('general');
    }
    function saveApiKeys() {
        const geminiKeysToSave = Array.from({length: 5}, (_, i) => document.getElementById(`apiKey${i + 1}`).value.trim());
        localStorage.setItem('storybaliApiKeys', JSON.stringify(geminiKeysToSave));
        
        const elevenLabsKey = document.getElementById('elevenLabsApiKey').value.trim();
        if (elevenLabsKey) {
            localStorage.setItem('elevenLabsApiKey', elevenLabsKey);
        } else {
            localStorage.removeItem('elevenLabsApiKey');
        }

        alert('API Keys berhasil disimpan!');
        loadApiKeys();
        populateElevenLabsVoices();
    }

    function loadApiKeys() {
        const savedGeminiKeys = localStorage.getItem('storybaliApiKeys');
        const defaultGeminiKeys = [DEFAULT_API_KEY_1, DEFAULT_API_KEY_2, DEFAULT_API_KEY_3, DEFAULT_API_KEY_4, DEFAULT_API_KEY_5];
        apiKeys = savedGeminiKeys ? JSON.parse(savedGeminiKeys) : defaultGeminiKeys;
        apiKeys.forEach((key, i) => {
            const inputElement = document.getElementById(`apiKey${i + 1}`);
            if (inputElement) inputElement.value = key;
        });

        const savedElevenLabsKey = localStorage.getItem('elevenLabsApiKey');
        const elevenLabsInput = document.getElementById('elevenLabsApiKey');
        if (savedElevenLabsKey) {
            elevenLabsInput.value = savedElevenLabsKey;
        } else {
            elevenLabsInput.value = DEFAULT_ELEVENLABS_API_KEY;
        }
    }
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const isMobile = window.innerWidth <= 768;

        if (isMobile) {
            const isOpen = sidebar.classList.toggle('open');
            overlay.classList.toggle('active', isOpen);
        } else {
            const isCollapsed = sidebar.classList.toggle('collapsed');
            settings.isSidebarOpen = !isCollapsed;
            saveSettings();
        }
    }
    function renderSidebar() {
        const historyList = document.getElementById('chatHistoryList');
        historyList.innerHTML = '';
        [...allChatSessions].reverse().forEach(session => {
            const item = document.createElement('li');
            item.className = 'chat-history-item';
            item.dataset.chatId = session.id;
            item.innerHTML = `
                <span class="title">${session.title}</span>
                <div class="actions">
                    <button onclick="renameChatSession('${session.id}', event)" class="action-icon" title="Ganti Nama">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L16.732 3.732z"></path></svg>
                    </button>
                    <button onclick="deleteChatSession('${session.id}', event)" class="action-icon" title="Hapus Chat">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>`;
            item.addEventListener('click', () => {
                if(activeChatId !== session.id) {
                    loadChat(session.id);
                }
                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
            historyList.appendChild(item);
        });
        updateSidebarActiveState();
    }
    function updateSidebarActiveState() {
        document.querySelectorAll('.chat-history-item').forEach(item => {
            item.classList.toggle('active', item.dataset.chatId === activeChatId);
        });
    }
    function renameChatSession(chatId, event) {
        event.stopPropagation();
        const session = allChatSessions.find(s => s.id === chatId);
        if (!session) return;
        const newTitle = prompt("Masukkan nama baru untuk percakapan ini:", session.title);
        if (newTitle && newTitle.trim() !== '') {
            session.title = newTitle.trim();
            saveAllChatSessions();
            renderSidebar();
        }
    }
    function deleteChatSession(chatId, event) {
        event.stopPropagation();
        if (!confirm('Apakah Anda yakin ingin menghapus percakapan ini?')) return;
        allChatSessions = allChatSessions.filter(s => s.id !== chatId);
        if (activeChatId === chatId) {
            if (allChatSessions.length > 0) {
                loadChat(allChatSessions[allChatSessions.length - 1].id);
            } else {
                startNewChat();
            }
        }
        saveAllChatSessions();
        renderSidebar();
    }
    function getActiveChatHistory() {
        if (!activeChatId) return null;
        const activeSession = allChatSessions.find(session => session.id === activeChatId);
        return activeSession ? activeSession.history : null;
    }
    function startNewChat() {
        const newChatId = `chat_${new Date().getTime()}`;
        const newSession = {
            id: newChatId,
            title: 'Percakapan Baru', 
            history: [{
                role: 'model',
                parts: [{ text: 'Halo! Gue Wayan nih, AI assistant yang siap bantu jawab pertanyaan kamu. Santai aja, tanya apa aja yang kamu mau tau ya!' }],
                timestamp: new Date().toISOString()
            }]
        };
        allChatSessions.push(newSession);
        activeChatId = newChatId;
        saveAllChatSessions();
        renderSidebar();
        loadChat(activeChatId);
        addSystemMessage("Memulai percakapan baru.");
    }
    function saveAllChatSessions() {
        if (settings.saveHistory) {
            const dataToSave = {
                sessions: allChatSessions,
                activeId: activeChatId
            };
            localStorage.setItem('storybaliChatSessions', JSON.stringify(dataToSave));
        }
    }
    function loadAllChatSessions() {
        if (!settings.saveHistory) {
            startNewChat();
            return;
        }
        const savedData = localStorage.getItem('storybaliChatSessions');
        if (savedData) {
            const parsedData = JSON.parse(savedData);
            allChatSessions = parsedData.sessions || [];
            activeChatId = parsedData.activeId || null;
            if (allChatSessions.length === 0 || !activeChatId || !allChatSessions.find(s => s.id === activeChatId)) {
                startNewChat();
            } else {
                renderSidebar();
                loadChat(activeChatId);
            }
        } else {
            startNewChat();
        }
    }
    function loadChat(chatId) {
        const session = allChatSessions.find(s => s.id === chatId);
        if (!session) return;
        activeChatId = chatId;
        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = ''; 
        session.history.forEach(msg => {
            addOriginalMessage(msg.parts[0].text, msg.role === 'user', msg.timestamp);
        });
        
        chatMessages.appendChild(document.getElementById('typingIndicator'));
        chatMessages.appendChild(document.getElementById('imageProcessingIndicator'));
        
        scrollToBottom();
        updateSidebarActiveState();
    }
    
    function addToConversationHistory(role, message) {
        const activeSession = allChatSessions.find(s => s.id === activeChatId);
        if (activeSession) {
            activeSession.history.push({
                role: role,
                parts: [{text: message}],
                timestamp: new Date().toISOString()
            });
            if (activeSession.history.length > 20) {
                activeSession.history.splice(1, 2); 
            }
            saveAllChatSessions();
        }
    }
    function clearAllChatHistory() {
        if (confirm('Yakin mau hapus SEMUA riwayat percakapan? Tindakan ini tidak bisa dibatalkan.')) {
            allChatSessions = [];
            activeChatId = null;
            saveAllChatSessions();
            startNewChat();
            alert('Semua riwayat percakapan telah dihapus!');
        }
    }
    function exportChatHistory() {
        const activeHistory = getActiveChatHistory();
        if (!activeHistory || activeHistory.length <= 1) { 
            alert('Belum ada riwayat chat di sesi ini untuk di-export!');
            return;
        }
        let exportText = `=== Wayan AI CHAT HISTORY (Sesi: ${activeChatId}) ===\n\n`;
        exportText += `Diekspor: ${new Date().toLocaleString('id-ID')}\n\n`;
        activeHistory.forEach((msg) => {
            const role = msg.role === 'user' ? 'Kamu' : 'Wayan AI';
            const text = msg.parts[0].text;
            const time = msg.timestamp ? `[${getFormattedTime(new Date(msg.timestamp))}]` : '';
            exportText += `${time} ${role}: ${text}\n\n`;
        });
        const blob = new Blob([exportText], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `wayan-ai-chat-${activeChatId}-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Riwayat chat sesi ini berhasil di-export!');
    }
    function toggleAnimations() {
        const isEnabled = document.getElementById('animationToggle').checked;
        settings.animationsEnabled = isEnabled;
        const styleId = 'animation-disable';
        let style = document.getElementById(styleId);
        if (!isEnabled && !style) {
            style = document.createElement('style');
            style.id = styleId;
            style.textContent = `*, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; animation-iteration-count: 1 !important; }`;
            document.head.appendChild(style);
        } else if (isEnabled && style) {
            style.remove();
        }
    }
    function sendQuickMessage(message) {
        document.getElementById('messageInput').value = message;
        handleInputChange({ target: document.getElementById('messageInput') });
        sendMessage();
    }
    function toggleVoiceMode() {
        if (isRecording) {
            stopVoiceRecognition(false);
        } else {
            startVoiceRecognition();
        }
    }
    function startVoiceRecognition() {
        if (!('webkitSpeechRecognition' in window)) {
            alert('Maaf, browser Anda tidak mendukung fitur pengenalan suara.');
            return;
        }
        finalTranscript = '';
        document.getElementById('messageInput').value = '';
        isRecording = true;

        const micBtn = document.getElementById('micBtn');
        micBtn.classList.add('send-btn-active');
        micBtn.innerHTML = `<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5 5a1 1 0 00-1 1v8a1 1 0 001 1h8a1 1 0 001-1V6a1 1 0 00-1-1H5z" clip-rule="evenodd"></path></svg>`;
        micBtn.title = "Hentikan Perekaman";

        document.getElementById('messageInput').style.visibility = 'hidden';
        document.getElementById('voiceRecordingUI').style.display = 'flex';
        document.getElementById('voiceStatusText').textContent = 'Mendengarkan...';

        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = settings.language === 'id' ? 'id-ID' : 'en-US';
        recognition.onresult = (event) => {
            let interim_transcript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interim_transcript += transcript;
                }
            }
            const displayText = (finalTranscript + interim_transcript).trim();
            document.getElementById('voiceStatusText').textContent = displayText || 'Mendengarkan...';
        };
        recognition.onerror = (event) => {
            console.error("Speech recognition error:", event.error);
            if (event.error !== 'aborted') {
                addSystemMessage(`Error pengenalan suara: ${event.error}`);
            }
            stopVoiceRecognition(false);
        };
        recognition.onend = () => {
            if (isRecording) {
                stopVoiceRecognition(false);
            }
        };
        try {
            recognition.start();
        } catch (e) {
            console.error("Error starting speech recognition:", e);
            addSystemMessage("Tidak dapat memulai pengenalan suara.");
            stopVoiceRecognition(false);
        }
    }
    function stopVoiceRecognition(isCancel = false) {
        if (!isRecording) return;
        
        const currentText = document.getElementById('voiceStatusText').textContent.trim();
        isRecording = false;
        if (recognition) {
            recognition.stop();
            recognition = null;
        }

        if (!isCancel && currentText && currentText !== 'Mendengarkan...') {
            document.getElementById('messageInput').value = currentText;
            finalTranscript = currentText;
        } else {
            document.getElementById('messageInput').value = '';
            finalTranscript = '';
        }

        const micBtn = document.getElementById('micBtn');
        micBtn.classList.remove('send-btn-active');
        micBtn.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>`;
        micBtn.title = "Mode Suara";

        document.getElementById('messageInput').style.visibility = 'visible';
        document.getElementById('voiceRecordingUI').style.display = 'none';
        handleInputChange({ target: document.getElementById('messageInput') });
    }
    function changeTheme(themeName) {
        if (document.documentElement.classList.contains('dark')) {
            return;
        }
        settings.theme = themeName;
        document.querySelectorAll('.theme-option-new').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`theme${themeName.charAt(0).toUpperCase() + themeName.slice(1)}`)?.classList.add('active');
        const colors = {
            blue: {from: '#667eea', to: '#764ba2'},
            green: {from: '#10b981', to: '#059669'},
            pink: {from: '#ec4899', to: '#dc2626'}
        }[themeName];
        document.querySelector('.header-gradient').style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`;
        document.getElementById('sendBtn').style.backgroundColor = colors.from;
        document.querySelectorAll('.ai-avatar').forEach(avatar => avatar.style.background = `linear-gradient(135deg, ${colors.from}, ${colors.to})`);
        document.querySelector('.profile-avatar-border').style.borderImage = `linear-gradient(135deg, ${colors.from}, ${colors.to}, #f093fb) 1`;
        saveSettings();
    }
    function applyDarkMode(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        settings.darkMode = isDark;
        const themeOptionsContainer = document.getElementById('themeOptionsContainer');
        const themeDisabledMessage = document.getElementById('themeDisabledMessage');
        const header = document.querySelector('.header-gradient');
        const sendBtn = document.getElementById('sendBtn');
        const aiAvatars = document.querySelectorAll('.ai-avatar');
        const profileAvatarBorder = document.querySelector('.profile-avatar-border');
        if (isDark) {
            themeOptionsContainer.style.opacity = '0.5';
            themeOptionsContainer.style.pointerEvents = 'none';
            themeDisabledMessage.classList.remove('hidden');
            if (header) header.style.background = '#222222';
            if (sendBtn) sendBtn.style.backgroundColor = '';
            if (profileAvatarBorder) profileAvatarBorder.style.borderImage = '';
            aiAvatars.forEach(avatar => { avatar.style.background = ''; });
        } else {
            themeOptionsContainer.style.opacity = '1';
            themeOptionsContainer.style.pointerEvents = 'auto';
            themeDisabledMessage.classList.add('hidden');
            changeTheme(settings.theme);
        }
    }

    function handleDarkModeToggle() {
        const isChecked = document.getElementById('darkModeToggle').checked;
        applyDarkMode(isChecked);
        saveSettings();
    }

    function loadSettings() {
        const savedSettings = localStorage.getItem('storybaliSettings');
        if (savedSettings) {
             settings = { ...defaultSettings, ...JSON.parse(savedSettings) };
        } else {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            settings = { ...defaultSettings, darkMode: prefersDark };
        }
        applySettings();
    }
    function saveSettings() {
        localStorage.setItem('storybaliSettings', JSON.stringify(settings));
    }
    function saveAllSettings() {
        settings.customAiRolePrompt = document.getElementById('customRoleInput').value;
        settings.fontSize = document.getElementById('fontSizeSelect').value;
        settings.animationsEnabled = document.getElementById('animationToggle').checked;
        settings.soundEnabled = document.getElementById('soundToggle').checked;
        settings.readAiResponseEnabled = document.getElementById('readAiResponseToggle').checked;
        settings.voiceURI = document.getElementById('voiceSelect').value;
        settings.audioSource = document.querySelector('.choice-btn[id^="audioSource-"].active').id.split('-')[1];
        settings.elevenLabsVoiceId = document.getElementById('elevenLabsVoiceSelect').value;
        settings.saveHistory = document.getElementById('saveHistoryToggle').checked;
        settings.darkMode = document.getElementById('darkModeToggle').checked;
        saveSettings();
        applySettings();
        alert('Pengaturan berhasil disimpan!');
        toggleSettings();
    }
    function resetAllSettings() {
        if (confirm('Yakin ingin mereset semua pengaturan? SEMUA riwayat chat dan API Key akan dihapus. Halaman akan dimuat ulang.')) {
            localStorage.removeItem('storybaliSettings');
            localStorage.removeItem('storybaliApiKeys');
            localStorage.removeItem('elevenLabsApiKey');
            localStorage.removeItem('storybaliChatSessions');
            localStorage.removeItem('onboardingShown');
            alert('Pengaturan telah direset ke default. Halaman akan dimuat ulang.');
            window.location.reload();
        }
    }
    function applySettings() {
        document.getElementById('darkModeToggle').checked = settings.darkMode;
        applyDarkMode(settings.darkMode);
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        } else {
            sidebar.classList.toggle('collapsed', !settings.isSidebarOpen);
        }
        document.querySelector('.header-gradient h1').textContent = 'Wayan AI';
        document.getElementById('aiNameInput').value = 'Wayan';
        if (!settings.darkMode) {
            changeTheme(settings.theme);
        }
        document.getElementById('fontSizeSelect').value = settings.fontSize;
        document.getElementById('animationToggle').checked = settings.animationsEnabled;
        toggleAnimations();
        document.getElementById('soundToggle').checked = settings.soundEnabled;
        document.getElementById('readAiResponseToggle').checked = settings.readAiResponseEnabled;
        document.getElementById('saveHistoryToggle').checked = settings.saveHistory;
        
        document.querySelectorAll('.choice-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`language-${settings.language}`)?.classList.add('active');
        document.getElementById(`personality-${settings.personality}`)?.classList.add('active');
        document.getElementById(`aiRole-${settings.aiRole}`)?.classList.add('active');
        document.getElementById(`audioSource-${settings.audioSource}`)?.classList.add('active');
        
        const customRoleContainer = document.getElementById('customRoleContainer');
        customRoleContainer.classList.toggle('hidden', settings.aiRole !== 'kustom');
        if (settings.aiRole === 'kustom') document.getElementById('customRoleInput').value = settings.customAiRolePrompt;
        
        const voiceSelect = document.getElementById('voiceSelect');
        if (settings.voiceURI && voiceSelect.options.length > 1) voiceSelect.value = settings.voiceURI;

        const elevenLabsSelect = document.getElementById('elevenLabsVoiceSelect');
        if (settings.elevenLabsVoiceId && elevenLabsSelect.options.length > 1) {
            elevenLabsSelect.value = settings.elevenLabsVoiceId;
        }
    }
    function selectChoice(settingName, value, element) {
        settings[settingName] = value;
        Array.from(element.parentElement.children).forEach(child => child.classList.remove('active'));
        element.classList.add('active');
        if (settingName === 'aiRole') {
            document.getElementById('customRoleContainer').classList.toggle('hidden', value !== 'kustom');
            const roleNames = { 'umum': 'Asisten Umum', 'guru_jepang': 'Guru Bahasa Jepang', 'guru_matematika': 'Guru Matematika', 'dokter': 'Dokter Virtual', 'programmer': 'Programmer Senior', 'penerjemah': 'Penerjemah', 'kustom': 'Peran Kustom' };
            if (roleNames[value]) addSystemMessage(`Mode peran AI telah diubah menjadi: ${roleNames[value]}.`);
        }
    }
    function switchSettingsTab(tabName) {
        document.querySelectorAll('.settings-tab, .settings-tab-content').forEach(el => el.classList.remove('active'));
        document.querySelector(`.settings-tab[onclick="switchSettingsTab('${tabName}')"]`).classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
    }
    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        if (modal.classList.contains('hidden')) {
            loadSettings();
            switchSettingsTab('general');
            modal.classList.remove('hidden');
        } else {
            modal.classList.add('hidden');
        }
    }
    function showProfileModal() { document.getElementById('profileModal').classList.remove('hidden'); }
    function hideProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }
    function triggerImageUpload() { document.getElementById('imageInput').click(); }
    
    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            if (!file.type.startsWith('image/')) {
                alert('File tidak valid. Silakan pilih file gambar (JPEG, PNG, WEBP, GIF).');
                event.target.value = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                currentPreviewData = {
                    base64: e.target.result,
                    fileName: file.name,
                    mimeType: file.type
                };
                showImagePreview(currentPreviewData.base64, currentPreviewData.fileName);
            };
            reader.readAsDataURL(file);
        }
    }

    function showImagePreview(base64Image, fileName) {
        document.getElementById('previewImage').src = base64Image;
        document.getElementById('previewFileName').textContent = fileName;
        document.getElementById('imageQuestionInput').value = '';
        document.getElementById('imagePreviewModal').classList.remove('hidden');
        setTimeout(() => document.getElementById('imageQuestionInput').focus(), 300);
    }

    function hideImagePreview() {
        document.getElementById('imagePreviewModal').classList.add('hidden');
        document.getElementById('imageInput').value = '';
        currentPreviewData = { base64: null, fileName: null, mimeType: null };
    }

    function sendImageWithQuestion() {
        const question = document.getElementById('imageQuestionInput').value.trim();
        if (!question) {
            alert('Tulis pertanyaan dulu ya!');
            return;
        }
        if (!currentPreviewData.base64) {
            alert('Terjadi kesalahan, gambar tidak ditemukan. Coba pilih lagi.');
            return;
        }
        
        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };
        if (userData.count >= CHAT_LIMIT) {
            alert('Anda telah mencapai batas. Tunggu cooldown selesai.');
            hideImagePreview();
            return;
        }
        
        const imageData = currentPreviewData.base64;
        const imageName = currentPreviewData.fileName;
        const imageMimeType = currentPreviewData.mimeType;
        
        hideImagePreview();
        
        addImageMessageWithQuestion(imageData, imageName, question, true);
        showImageProcessingIndicator();
        analyzeImageWithQuestion(imageData, question, imageMimeType);
    }

    function addImageMessageWithQuestion(imageSrc, fileName, question, isUser = false) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        if (isUser) {
            const timeString = getFormattedTime(new Date());
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="user-message text-white p-4 max-w-xs">
                    <img src="${imageSrc}" alt="${fileName}" class="w-full h-auto rounded-lg mb-2 max-h-32 object-cover">
                    <p class="text-xs mb-2 opacity-90">${fileName}</p>
                    <div class="bg-white bg-opacity-20 rounded-lg p-2"><p class="text-sm font-medium">${question}</p></div>
                    <div class="chat-timestamp text-right">${timeString}</div>
                </div>`;

            const messageForHistory = `[Gambar: ${fileName}] ${question}`;
            addToConversationHistory('user', messageForHistory);

            const allUserData = getChatLimitData();
            const userData = allUserData[currentUserIP] || { count: 0 };
            userData.count++;
            saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
            if (userData.count >= CHAT_LIMIT) {
                const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
                userData.cooldownUntil = cooldownEndTime;
                saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
                startCooldown(cooldownEndTime);
            }
        }
        chatMessages.insertBefore(messageDiv, document.getElementById('typingIndicator'));
        scrollToBottom();
    }
    function handleKeyPress(event) { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); } }
    function addSystemMessage(message) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'system-message-bubble';
        messageDiv.innerHTML = `<div class="system-message">${message}</div>`;
        chatMessages.insertBefore(messageDiv, document.getElementById('typingIndicator'));
        scrollToBottom();
    }
    function typewriterEffect(element, text, callback) {
        let i = 0;
        element.innerHTML = "";
        function type() {
            if (i < text.length) {
                let char = text.charAt(i);
                let nextChunk = char;
                if (text.substring(i, i + 3) === '```') {
                    let endBlock = text.indexOf('```', i + 3);
                    if (endBlock !== -1) { nextChunk = text.substring(i, endBlock + 3); i = endBlock + 2; }
                } else if (char === '*' && text.charAt(i + 1) === '*') {
                     let endBold = text.indexOf('**', i + 2);
                     if(endBold !== -1) { nextChunk = text.substring(i, endBold + 2); i = endBold + 1; }
                }
                element.innerHTML += nextChunk.replace(/\n/g, '<br>');
                i++;
                if (i % 10 === 0) scrollToBottom();
                setTimeout(type, 20);
            } else if (callback) {
                callback();
            }
        }
        type();
    }
    function addMessage(message, isUser = false, suggestions = []) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        const typingIndicator = document.getElementById('typingIndicator');
        const timeString = getFormattedTime(new Date());

        if (isUser) {
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            messageDiv.innerHTML = `
                <div class="user-message text-white p-4 max-w-xs">
                    <p class="leading-relaxed text-sm">${message.replace(/\n/g, '<br>')}</p>
                    <div class="chat-timestamp text-right">${timeString}</div>
                </div>`;
            chatMessages.insertBefore(messageDiv, typingIndicator);
        } else {
            const encodedMessage = btoa(encodeURIComponent(message));
            messageDiv.innerHTML = `
                <div class="ai-avatar w-8 h-8 flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="Wayan AI" class="w-full h-full object-cover">
                </div>
                <div class="ai-message p-4 max-w-xs">
                    <div class="markdown-content leading-relaxed text-sm"></div>
                    <div class="suggestions-container mt-3"></div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-300/70 dark:border-slate-600/50">
                        <div class="chat-timestamp">${timeString}</div>
                        <div class="flex items-center space-x-2">
                            <button onclick="copyToClipboard(this.closest('.ai-message').querySelector('.markdown-content').innerText, this)" class="w-6 h-6 bg-gray-200/50 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600" title="Salin Jawaban">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            </button>
                            <button onclick="readAiResponse(this, '${encodedMessage}')" class="w-6 h-6 bg-gray-200/50 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600" title="Baca Jawaban">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
            chatMessages.insertBefore(messageDiv, typingIndicator);
            const markdownContentElement = messageDiv.querySelector('.markdown-content');
            typewriterEffect(markdownContentElement, message, () => {
                markdownContentElement.innerHTML = marked.parse(message);
                const suggestionsContainer = messageDiv.querySelector('.suggestions-container');
                if (suggestionsContainer) {
                   suggestionsContainer.innerHTML = renderSuggestions(suggestions);
                }
                scrollToBottom();
            });
        }
        scrollToBottom();
    }
    function addOriginalMessage(message, isUser = false, timestamp) {
        const chatMessages = document.getElementById('chatMessages');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message-bubble flex items-start space-x-3';
        const timeString = timestamp ? getFormattedTime(new Date(timestamp)) : '';
        const imageMatch = message.match(/^\[Gambar: (.*?)\] (.*)/);
        const callMatch = message.match(/^\[TRANSKRIP PANGGILAN SUARA\]\n([\s\S]*)/);

        if (isUser) {
            messageDiv.className += ' flex-row-reverse space-x-reverse user';
            const timeHtml= timeString ? `<div class="chat-timestamp text-right">${timeString}</div>` : '';
            
            let messageContent = '';
            if (imageMatch) {
                messageContent = `<div class="bg-white bg-opacity-20 rounded-lg p-2">
                                    <p class="text-xs mb-1 opacity-90">🖼️ ${imageMatch[1]}</p>
                                    <p class="text-sm font-medium">${imageMatch[2]}</p>
                                  </div>`;
            } else if(callMatch) {
                 messageContent = `<div class="text-left text-sm">
                                    <p class="font-bold mb-2">📞 Transkrip Panggilan</p>
                                    <pre class="whitespace-pre-wrap text-xs bg-black bg-opacity-20 p-2 rounded">${callMatch[1]}</pre>
                                  </div>`;
            }
            else {
                messageContent = `<div class="leading-relaxed text-sm">${message.replace(/\n/g, '<br>')}</div>`;
            }

            messageDiv.innerHTML = `
                <div class="user-message text-white p-4 max-w-xs">
                    ${messageContent}
                    ${timeHtml}
                </div>`;
        } else {
            const timeHtmlAi = timeString ? `<div class="chat-timestamp">${timeString}</div>` : '<div></div>';
            const encodedMessage = btoa(encodeURIComponent(message));
            messageDiv.innerHTML = `
                <div class="ai-avatar w-8 h-8 flex items-center justify-center flex-shrink-0 overflow-hidden">
                    <img src="https://i.postimg.cc/Wz2Gmx8X/IMG-2621.jpg" alt="Wayan AI" class="w-full h-full object-cover">
                </div>
                <div class="ai-message p-4 max-w-xs">
                    <div class="markdown-content leading-relaxed text-sm">${marked.parse(message)}</div>
                    <div class="suggestions-container mt-3"></div>
                    <div class="flex justify-between items-center mt-2 pt-2 border-t border-slate-300/70 dark:border-slate-600/50">
                         ${timeHtmlAi}
                        <div class="flex items-center space-x-2">
                            <button onclick="copyToClipboard(this.closest('.ai-message').querySelector('.markdown-content').innerText, this)" class="w-6 h-6 bg-gray-200/50 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600" title="Salin Jawaban">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
                            </button>
                            <button onclick="readAiResponse(this, '${encodedMessage}')" class="w-6 h-6 bg-gray-200/50 dark:bg-gray-700/50 text-gray-600 dark:text-gray-300 rounded-full flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600" title="Baca Jawaban">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        chatMessages.appendChild(messageDiv);
    }
    function renderSuggestions(suggestionsArray) {
        if (suggestionsArray && suggestionsArray.length > 0) {
            return `<div class="flex flex-wrap gap-2 mt-2">${suggestionsArray.map(s => `<button onclick="sendQuickMessage('${s.replace(/'/g, "\\'")}')" class="suggestion-btn">${s}</button>`).join('')}</div>`;
        }
        return '';
    }
    function showTypingIndicator() { document.getElementById('typingIndicator')?.classList.add('show'); scrollToBottom(); }
    function hideTypingIndicator() { document.getElementById('typingIndicator')?.classList.remove('show'); }
    function showImageProcessingIndicator() { document.getElementById('imageProcessingIndicator')?.classList.add('show'); scrollToBottom(); }
    function hideImageProcessingIndicator() { document.getElementById('imageProcessingIndicator')?.classList.remove('show'); }
    function scrollToBottom() {
        const chatMessages = document.getElementById('chatMessages');
        setTimeout(() => chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' }), 100);
    }
    function playNotificationSound() {
        if (settings.soundEnabled) {
            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(800, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }
    }
    function copyToClipboard(text, button) {
        navigator.clipboard.writeText(text).then(() => {
            const originalHTML = button.innerHTML;
            button.innerHTML = `<svg class="w-4 h-4 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            setTimeout(() => button.innerHTML = originalHTML, 2000);
        });
    }
    function populateVoiceList() {
        const voices = speechSynthesis.getVoices();
        const voiceSelect = document.getElementById('voiceSelect');
        voiceSelect.innerHTML = '<option value="">Default Browser</option>';
        if (voices.length === 0) return;
        const idVoices = voices.filter(v => v.lang === 'id-ID');
        const otherVoices = voices.filter(v => v.lang !== 'id-ID');
        const createOptGroup = (label, voiceList) => {
            const group = document.createElement('optgroup');
            group.label = label;
            voiceList.forEach(voice => {
                const option = document.createElement('option');
                option.textContent = `${voice.name} (${voice.lang})`;
                option.value = voice.voiceURI;
                group.appendChild(option);
            });
            return group;
        };
        if (idVoices.length > 0) voiceSelect.appendChild(createOptGroup('Bahasa Indonesia', idVoices));
        if (otherVoices.length > 0) voiceSelect.appendChild(createOptGroup('Bahasa Lain', otherVoices));
        if (settings.voiceURI) voiceSelect.value = settings.voiceURI;
    }
    
    async function populateElevenLabsVoices() {
        const apiKey = localStorage.getItem('elevenLabsApiKey') || DEFAULT_ELEVENLABS_API_KEY;
        const selectElement = document.getElementById('elevenLabsVoiceSelect');
        const previewBtn = document.getElementById('previewElevenLabsVoiceBtn');
        
        previewBtn.disabled = true;
        if (!apiKey) {
            selectElement.innerHTML = '<option value="">API Key tidak ada</option>';
            return;
        }

        selectElement.innerHTML = '<option value="">Memuat suara...</option>';

        try {
            const response = await fetch('https://api.elevenlabs.io/v1/voices', {
                headers: { 'xi-api-key': apiKey }
            });

            if (!response.ok) {
                throw new Error('Gagal ambil suara. Periksa API Key.');
            }

            const data = await response.json();
            selectElement.innerHTML = ''; 

            data.voices.forEach(voice => {
                const option = document.createElement('option');
                option.value = voice.voice_id;
                option.textContent = `${voice.name}`;
                selectElement.appendChild(option);
            });

            if (settings.elevenLabsVoiceId) {
                selectElement.value = settings.elevenLabsVoiceId;
            }
            previewBtn.disabled = false;

        } catch (error) {
            console.error('Error fetching ElevenLabs voices:', error);
            selectElement.innerHTML = `<option value="">Error</option>`;
        }
    }

    // ===================================================================================
    // ▼▼▼ BAGIAN FUNGSI PEMBACA SUARA YANG TELAH DIPERBAIKI SECARA TOTAL ▼▼▼
    // ===================================================================================

    function stopReading() {
        if (speechSynthesis.speaking) {
            speechSynthesis.cancel();
        }
        if (!elevenLabsAudioPlayer.paused) {
            elevenLabsAudioPlayer.pause();
            elevenLabsAudioPlayer.currentTime = 0;
        }
        if (!elevenLabsPreviewPlayer.paused) {
            elevenLabsPreviewPlayer.pause();
            elevenLabsPreviewPlayer.currentTime = 0;
        }
        isReading = false;
        
        document.querySelectorAll('.ai-message button[title="Baca Jawaban"], #previewElevenLabsVoiceBtn').forEach(btn => {
            if (btn.id === 'previewElevenLabsVoiceBtn') {
                btn.innerHTML = `<svg class="w-5 h-5 text-gray-600 dark:text-gray-300" fill="currentColor" viewBox="0 0 20 20"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"></path></svg>`;
            } else {
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.647 11 4.101 11 5v14c0 .899-.077 1.353-.293 1.569l-4.707-4.707z"></path></svg>`;
            }
        });
    }

    function playElevenLabsAudio(text, button, voiceId = null, audioPlayer = elevenLabsAudioPlayer) {
        return new Promise(async (resolve, reject) => {
            const apiKey = localStorage.getItem('elevenLabsApiKey') || DEFAULT_ELEVENLABS_API_KEY;
            const effectiveVoiceId = voiceId || settings.elevenLabsVoiceId || '21m00Tcm4TlvDq8ikWAM';
            const apiUrl = `https://api.elevenlabs.io/v1/text-to-speech/${effectiveVoiceId}`;
            const stopIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>`;
            
            if (button) button.innerHTML = stopIcon;
            isReading = true;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Accept': 'audio/mpeg', 'Content-Type': 'application/json', 'xi-api-key': apiKey },
                    body: JSON.stringify({
                        text: text,
                        model_id: "eleven_multilingual_v2",
                        voice_settings: { stability: 0.5, similarity_boost: 0.75 }
                    })
                });

                if (!response.ok) throw new Error(`ElevenLabs API request failed with status ${response.status}`);

                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                
                audioPlayer.src = audioUrl;
                audioPlayer.play();

                audioPlayer.onended = () => { URL.revokeObjectURL(audioUrl); resolve(); };
                audioPlayer.onerror = () => { URL.revokeObjectURL(audioUrl); reject(new Error("Audio playback error")); };

            } catch (error) {
                console.error('Error with ElevenLabs API:', error);
                reject(error);
            }
        });
    }

    function playBrowserAudio(text, button) {
        const stopIcon = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0zM9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>`;
        
        currentUtterance = new SpeechSynthesisUtterance(text);
        const selectedVoice = speechSynthesis.getVoices().find(v => v.voiceURI === settings.voiceURI);
        currentUtterance.voice = selectedVoice || speechSynthesis.getVoices().find(v => v.lang.startsWith('id'));
        
        if (button) button.innerHTML = stopIcon;
        isReading = true;
        
        currentUtterance.onend = () => stopReading();
        currentUtterance.onerror = (e) => {
            console.error('SpeechSynthesis Error', e);
            stopReading();
        };
        
        speechSynthesis.speak(currentUtterance);
    }
    
    async function readAiResponse(button, encodedMessage) {
        if (!settings.readAiResponseEnabled) {
            alert('Fitur pembaca jawaban dinonaktifkan.');
            return;
        }

        if (isReading) {
            stopReading();
            return;
        }

        const message = decodeURIComponent(atob(encodedMessage));
        
        if (settings.audioSource === 'elevenlabs') {
            try {
                await playElevenLabsAudio(message, button);
            } catch (error) {
                console.warn("Gagal memutar audio ElevenLabs, beralih ke suara browser:", error.message);
                alert("Gagal memutar suara ElevenLabs. Memeriksa API Key atau beralih ke suara Bawaan Browser di Pengaturan.");
            } finally {
                stopReading();
            }
        } else {
            playBrowserAudio(message, button);
        }
    }
    
    // ===================================================================================
    // ▲▲▲ AKHIR DARI BAGIAN YANG DIPERBAIKI ▲▲▲
    // ===================================================================================

    function getSystemPrompt(isCall = false) {
        if (isCall) {
            return `Kamu adalah Wayan, asisten AI yang sedang dalam panggilan suara. Berikan respons yang singkat, jelas, dan natural seperti sedang berbicara di telepon. Hindari jawaban yang panjang dan bertele-tele. Jawab dengan 1-2 kalimat saja kecuali jika diminta untuk menjelaskan lebih detail.`;
        }
        
        const baseInstructions = `Gunakan format Markdown untuk jawabanmu jika diperlukan (list, tebal, kode).

[PENTING: Aturan Pemberian Link]
Jika pertanyaan pengguna memerlukan informasi yang sangat baru, data spesifik, atau referensi eksternal untuk mendukung jawabanmu, sertakan 2-3 link relevan yang valid dari ingatanmu.
- Format link harus menggunakan Markdown, contoh: [Judul Artikel](https://contoh.com).
- Jangan hanya menempelkan URL mentah. Selalu berikan judul yang deskriptif untuk link tersebut.
- Jika kamu memberikan link, berikan disclaimer singkat seperti: "Berikut beberapa referensi yang mungkin bisa membantu:", karena kamu tidak bisa memverifikasi link secara real-time. Hindari mengarang atau membuat link palsu.

Setelah jawaban utama (dan link, jika ada) selesai, berikan 2 atau 3 saran pertanyaan lanjutan yang relevan. Format saran: pisahkan jawaban utama dan saran dengan '[SUGGESTIONS]', dan pisahkan setiap saran dengan tanda pipa '|'.`;
        
        const rolePrompts = {
            guru_jepang: `Kamu adalah guru Bahasa Jepang bernama Wayan-sensei. Gaya bicaramu sabar dan ramah. Sapa dengan "Konnichiwa, gakusei-san!".`,
            guru_matematika: `Kamu adalah guru Matematika bernama Pak Wayan. Kamu bisa membuat konsep sulit menjadi mudah dimengerti. Jelaskan setiap langkah pemecahan masalah secara rinci.`,
            dokter: `Kamu adalah Dokter Wayan, seorang Dokter Umum virtual yang informatif. SELALU awali dan akhiri jawabanmu dengan disclaimer: "Informasi ini bersifat edukatif dan tidak menggantikan konsultasi medis profesional. Segera kunjungi dokter." Jangan pernah memberikan diagnosis atau resep.`,
            programmer: `Kamu adalah senior programmer bernama Wayan. Gaya bicaramu to-the-point dan jelas. Identifikasi bug, tawarkan optimisasi, dan jelaskan 'mengapa'. Berikan contoh kode dalam blok kode Markdown.`,
            penerjemah: `Kamu adalah penerjemah multibahasa bernama Wayan. Deteksi bahasa asli dan tanyakan target terjemahannya. Berikan terjemahan literal dan kontekstual.`,
        };

        let roleInstruction = '';
        let personaRule = '';

        if (settings.aiRole === 'kustom' && settings.customAiRolePrompt) {
            roleInstruction = settings.customAiRolePrompt;
        } else if (rolePrompts[settings.aiRole]) {
            roleInstruction = rolePrompts[settings.aiRole];
        } else {
            switch (settings.personality) {
                case 'profesional':
                    roleInstruction = `Kamu adalah sebuah asisten AI yang profesional dan formal.`;
                    break;
                case 'lucu':
                    roleInstruction = `Kamu adalah Wayan, asisten AI yang humoris.`;
                    break;
                default:
                    roleInstruction = `Kamu adalah Wayan, asisten AI dari StoryBali yang santai dan menggunakan bahasa Indonesia sehari-hari.`;
                    break;
            }
        }

        if ((settings.aiRole === 'umum' && settings.personality === 'profesional') || settings.aiRole === 'kustom') {
            personaRule = "Perkenalkan dirimu (jika relevan dengan rolenya) hanya jika pengguna menanyakan namamu.";
        } else {
            personaRule = "SANGAT PENTING: Selalu sertakan nama 'Wayan' (atau persona peranmu seperti 'Dokter Wayan', 'Wayan-sensei') setidaknya sekali dalam setiap jawabanmu untuk membangun karakter. Contoh: 'Menurut Wayan...', 'Wayan pikir...', 'Tentu, ini penjelasan dari Dokter Wayan...'. Ini adalah aturan utama kepribadianmu.";
        }
        
        if (settings.language === 'en') {
            roleInstruction += ' Please respond in English.';
        }
        
        return `${roleInstruction} ${personaRule} ${baseInstructions}`;
    }

    async function makeApiRequest(payload, signal = null) {
        if (apiKeys.length === 0) loadApiKeys();
        const validApiKeys = apiKeys.filter(key => key && key.trim() !== '');
        
        if (validApiKeys.length === 0) {
            throw new Error("Tidak ada API Key yang valid yang dikonfigurasi.");
        }

        let startingIndex;
        const lastKeyIndexStr = localStorage.getItem('lastKeyIndex');

        if (lastKeyIndexStr === null) {
            console.log("Pengguna baru terdeteksi. Memilih API Key awal secara acak.");
            startingIndex = Math.floor(Math.random() * validApiKeys.length);
        } else {
            const lastKeyIndex = parseInt(lastKeyIndexStr);
            startingIndex = (lastKeyIndex + 1) % validApiKeys.length;
        }

        for (let i = 0; i < validApiKeys.length; i++) {
            const currentIndex = (startingIndex + i) % validApiKeys.length;
            const currentApiKey = validApiKeys[currentIndex];
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${currentApiKey}`;
            
            console.log(`Mencoba API Key urutan ke-${currentIndex + 1}...`);

            try {
                const fetchOptions = {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                };
                if (signal) {
                    fetchOptions.signal = signal;
                }

                const response = await fetch(apiUrl, fetchOptions);

                if (response.ok) {
                    console.log(`Berhasil menggunakan API Key urutan ke-${currentIndex + 1}`);
                    localStorage.setItem('lastKeyIndex', currentIndex);
                    return await response.json();
                }

                if (response.status === 429) {
                    console.warn(`API Key urutan ke-${currentIndex + 1} telah mencapai limit. Mencoba kunci berikutnya...`);
                } else {
                    const errorBody = await response.text();
                    console.error("API Error Body:", errorBody);
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }

            } catch (error) {
                if (error.name === 'AbortError') throw error; 
                console.error(`Gagal dengan API Key urutan ke-${currentIndex + 1}:`, error.message);
                if (!String(error.message).includes("429")) {
                     throw error;
                }
            }
        }

        throw new Error("Semua API Key yang tersedia telah mencapai limit atau gagal merespons.");
    }

    async function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();
        if (!message || !currentUserIP || currentFetchController) return;
        
        const activeSession = allChatSessions.find(s => s.id === activeChatId);
        if (!activeSession) return;
        if(activeSession.title === 'Percakapan Baru' && activeSession.history.length === 1) {
            activeSession.title = message.substring(0, 30) + (message.length > 30 ? '...' : '');
            renderSidebar();
        }
        
        const allUserData = getChatLimitData();
        const userData = allUserData[currentUserIP] || { count: 0 };
        if (userData.count >= CHAT_LIMIT && userData.cooldownUntil) { return; }
        userData.count++;
        saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
        
        addMessage(message, true);
        trackUserMessageCount();
        addToConversationHistory('user', message);
        input.value = '';
        handleInputChange({ target: input });
        showTypingIndicator();

        if (userData.count >= CHAT_LIMIT) {
            const cooldownEndTime = new Date().getTime() + COOLDOWN_MINUTES * 60 * 1000;
            userData.cooldownUntil = cooldownEndTime;
            saveChatLimitData({ ...allUserData, [currentUserIP]: userData });
            setTimeout(() => startCooldown(cooldownEndTime), 1000);
        }

        currentFetchController = new AbortController();
        document.getElementById('stopGeneratingContainer').style.display = 'block';

        try {
            const fullHistory = getActiveChatHistory();
            const historyForApi = fullHistory.map(({ role, parts }) => ({ role, parts }));
            
            const payload = {
                contents: historyForApi,
                systemInstruction: { parts: [{ text: getSystemPrompt() }] },
                generationConfig: { temperature: 0.9, topK: 1, topP: 1, maxOutputTokens: 2048 }
            };

            const data = await makeApiRequest(payload, currentFetchController.signal);
            
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                let aiResponseText = data.candidates[0].content.parts[0].text;
                let [mainAnswer, suggestionsPart] = aiResponseText.split('[SUGGESTIONS]');
                let dynamicSuggestions = suggestionsPart ? suggestionsPart.split('|').map(s => s.trim()).filter(Boolean) : [];
                addMessage(mainAnswer.trim(), false, dynamicSuggestions);
                addToConversationHistory('model', mainAnswer.trim());
                playNotificationSound();
            } else {
                console.warn("Respons API tidak valid:", data);
                addMessage('Maaf, Wayan tidak dapat memberikan respons. Coba lagi.');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                addSystemMessage("Pembuatan respons dihentikan.");
            } else {
                console.error("Error in sendMessage:", error);
                addMessage(`Aduh, Wayan error: ${error.message}. Coba lagi nanti ya!`);
            }
        } finally {
            hideTypingIndicator();
            document.getElementById('stopGeneratingContainer').style.display = 'none';
            currentFetchController = null;
        }
    }
    
    async function analyzeImageWithQuestion(base64Image, userQuestion, mimeType) {
        currentFetchController = new AbortController();
        document.getElementById('stopGeneratingContainer').style.display = 'block';
        
        try {
            const imageData = base64Image.split(',')[1];
            
            const payload = {
                contents: [{
                    parts: [
                        { text: userQuestion },
                        {
                            inline_data: {
                                mime_type: mimeType,
                                data: imageData
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{
                        text: getSystemPrompt()
                    }]
                },
                generationConfig: {
                    temperature: 0.9,
                    topK: 32,
                    topP: 1,
                    maxOutputTokens: 2048
                }
            };

            const data = await makeApiRequest(payload, currentFetchController.signal);
            
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                let aiResponseText = data.candidates[0].content.parts[0].text;
                let [mainAnswer, suggestionsPart] = aiResponseText.split('[SUGGESTIONS]');
                let dynamicSuggestions = suggestionsPart ? suggestionsPart.split('|').map(s => s.trim()).filter(Boolean) : [];
                addMessage(mainAnswer.trim(), false, dynamicSuggestions);
                addToConversationHistory('model', mainAnswer.trim());
                playNotificationSound();
            } else {
                 console.warn("Respons API tidak valid:", data);
                addMessage('Wah, Wayan nggak bisa analisis gambar ini. Coba gambar lain ya.');
            }
        } catch (error) {
            if (error.name === 'AbortError') {
                addSystemMessage("Analisis gambar dihentikan.");
            } else {
                console.error("Error in analyzeImageWithQuestion:", error);
                addMessage(`Aduh, Wayan error saat analisis gambar: ${error.message}. Coba lagi ya!`);
            }
        } finally {
            hideImageProcessingIndicator();
            document.getElementById('stopGeneratingContainer').style.display = 'none';
            currentFetchController = null;
        }
    }

    async function previewElevenLabsVoice() {
        const selectElement = document.getElementById('elevenLabsVoiceSelect');
        const voiceId = selectElement.value;
        const button = document.getElementById('previewElevenLabsVoiceBtn');
        const sampleText = "Halo, ini adalah contoh suara saya.";

        if (!voiceId) {
            alert("Pilih suara terlebih dahulu.");
            return;
        }
        stopReading(); 
        button.disabled = true;
        try {
            await playElevenLabsAudio(sampleText, button, voiceId, elevenLabsPreviewPlayer);
        } catch(e) {
            alert("Gagal memutar pratinjau. Periksa API Key atau koneksi Anda.");
        } finally {
            stopReading();
            button.disabled = false;
        }
    }

    async function speakAiResponse(text) {
        isAiSpeaking = true;
        document.getElementById('callStatusText').textContent = 'Wayan AI sedang berbicara...';
        
        await readAiResponse(null, btoa(encodeURIComponent(text)));

        isAiSpeaking = false;
        if (isCallActive) {
            listenForUserSpeech();
        }
    }

    function listenForUserSpeech() {
        if (!isCallActive || isAiSpeaking) return;

        // [FIX] Mencegah beberapa instance berjalan bersamaan
        if (window.isListeningNow) return;

        if (!('webkitSpeechRecognition' in window)) {
            alert('Maaf, browser Anda tidak mendukung fitur pengenalan suara. Panggilan tidak dapat dilanjutkan.');
            endCall();
            return;
        }
        
        document.getElementById('callStatusText').textContent = 'Mendengarkan...';
        callRecognition = new webkitSpeechRecognition();
        callRecognition.continuous = false;
        callRecognition.interimResults = false; // [FIX for iOS] Lebih stabil di iOS
        callRecognition.lang = settings.language === 'id' ? 'id-ID' : 'en-US';

        let final_transcript = '';
        window.isListeningNow = true;

        callRecognition.onresult = (event) => {
            clearTimeout(silenceTimer);
            const transcript = event.results[0][0].transcript;
            if (transcript) {
                final_transcript = transcript;
            }
        };

        callRecognition.onerror = (event) => {
            window.isListeningNow = false;
            console.error('Call speech recognition error:', event.error);
            // [FIX for iOS] Hindari loop error yang cepat. Beri jeda.
            if (isCallActive && event.error !== 'no-speech' && event.error !== 'aborted') {
                setTimeout(() => listenForUserSpeech(), 300);
            } else if (isCallActive) {
                listenForUserSpeech();
            }
        };

        callRecognition.onend = () => {
            window.isListeningNow = false;
            clearTimeout(silenceTimer);
            if (isCallActive && final_transcript.trim()) {
                processUserTranscript(final_transcript.trim());
            } else if (isCallActive && !isAiSpeaking) {
                // [FIX for iOS] JANGAN langsung mendengarkan lagi. Ini memutus loop.
                // AI akan menunggu giliran bicara selanjutnya, yang akan memicu listenForUserSpeech() lagi.
                document.getElementById('callStatusText').textContent = 'Menunggu giliran...';
            }
        };

        try {
            callRecognition.start();
            // Timeout untuk menghentikan jika tidak ada suara sama sekali
            silenceTimer = setTimeout(() => {
                if(callRecognition && window.isListeningNow) {
                    callRecognition.stop();
                }
            }, 5000);
        } catch (e) {
            window.isListeningNow = false;
            console.error("Gagal memulai speech recognition:", e);
            if (isCallActive) {
                setTimeout(() => listenForUserSpeech(), 1000);
            }
        }
    }
    
    async function processUserTranscript(transcript) {
        document.getElementById('callStatusText').textContent = 'Wayan sedang berpikir...';
        callHistory.push({ role: 'user', parts: [{ text: transcript }] });

        try {
            const contextualHistory = callHistory.slice(-6);
            
            const payload = {
                contents: contextualHistory,
                systemInstruction: { parts: [{ text: getSystemPrompt(true) }] },
                generationConfig: { 
                    temperature: 0.9, 
                    topK: 1, 
                    topP: 1, 
                    maxOutputTokens: 80
                }
            };

            const data = await makeApiRequest(payload);
            let aiResponseText = "Maaf, sepertinya ada gangguan. Bisa ulangi lagi?";

            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                aiResponseText = data.candidates[0].content.parts[0].text.split('[SUGGESTIONS]')[0].trim();
            }
            
            callHistory.push({ role: 'model', parts: [{ text: aiResponseText }] });
            await speakAiResponse(aiResponseText);

        } catch (error) {
            console.error("Error processing transcript:", error);
            const errorMessage = "Aduh, ada sedikit masalah teknis. Coba kita ulangi ya.";
            callHistory.push({ role: 'model', parts: [{ text: errorMessage }] });
            await speakAiResponse(errorMessage);
        }
    }

    async function startCall() {
        if (isCallActive) return;
        isCallActive = true;
        callHistory = [];
        document.getElementById('callModal').classList.remove('hidden');
        document.getElementById('callModal').classList.add('flex');
        
        const openingLine = "Halo, ini Wayan. Ada yang bisa dibantu?";
        callHistory.push({ role: 'model', parts: [{ text: openingLine }] });
        await speakAiResponse(openingLine);
    }

    function endCall() {
        if (!isCallActive) return;
        isCallActive = false;
        
        document.getElementById('callModal').classList.add('hidden');
        document.getElementById('callModal').classList.remove('flex');
        document.getElementById('callStatusText').textContent = 'Menghubungkan...';

        stopReading();
        if (callRecognition) {
            callRecognition.stop();
            callRecognition = null;
        }
        clearTimeout(silenceTimer);

        if (callHistory.length > 1) {
            let transcriptText = "[TRANSKRIP PANGGILAN SUARA]\n";
            callHistory.forEach(turn => {
                const prefix = turn.role === 'user' ? 'Anda: ' : 'Wayan: ';
                transcriptText += prefix + turn.parts[0].text + '\n';
            });
            addToConversationHistory('user', transcriptText);
            addOriginalMessage(transcriptText, true, new Date().toISOString());
            scrollToBottom();
        }
    }

    window.addEventListener('load', async () => {
        loadApiKeys();
        loadSettings();
        currentUserIP = await getUserIP();
        
        if (currentUserIP) {
          sendNewUserNotification(currentUserIP);
        }
        
        checkUserStatus();
        populateVoiceList();
        populateElevenLabsVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }
        loadAllChatSessions();
        hideTypingIndicator();
        hideImageProcessingIndicator();
        
        document.getElementById('fontSizeSelect').addEventListener('change', (e) => {
            settings.fontSize = e.target.value;
            saveSettings();
        });

        document.getElementById('animationToggle').addEventListener('change', () => {
            toggleAnimations();
            saveSettings();
        });

        document.getElementById('soundToggle').addEventListener('change', (e) => {
            settings.soundEnabled = e.target.checked;
            saveSettings();
        });

        document.getElementById('readAiResponseToggle').addEventListener('change', (e) => {
            settings.readAiResponseEnabled = e.target.checked;
            saveSettings();
        });

        document.getElementById('voiceSelect').addEventListener('change', (e) => {
            settings.voiceURI = e.target.value;
            saveSettings();
        });

        document.getElementById('elevenLabsVoiceSelect').addEventListener('change', (e) => {
            settings.elevenLabsVoiceId = e.target.value;
            saveSettings();
        });

        document.getElementById('saveHistoryToggle').addEventListener('change', (e) => {
            settings.saveHistory = e.target.checked;
            saveSettings();
        });
        
        document.getElementById('stopBtn').addEventListener('click', () => {
            if (currentFetchController) {
                currentFetchController.abort();
            }
        });

        document.getElementById('previewElevenLabsVoiceBtn').addEventListener('click', previewElevenLabsVoice);

    });

    ['profileModal', 'imagePreviewModal', 'settingsModal'].forEach(id => {
        document.getElementById(id).addEventListener('click', e => {
            if (e.target.id === id) {
                if (id === 'profileModal') hideProfileModal();
                else if (id === 'imagePreviewModal') hideImagePreview();
                else if (id === 'settingsModal') toggleSettings();
            }
        });
    });
    document.addEventListener('touchstart', function () {}, true);
</script>

<!-- Onboarding Modal & Script (tidak diubah) -->
<div id="onboardingModal" class="fixed inset-0 z-50 bg-black bg-opacity-60 flex items-center justify-center transition-all duration-300 hidden">
  <div class="bg-white rounded-2xl shadow-2xl max-w-sm w-full p-0 overflow-hidden border border-gray-200 relative animate-fadein">
    <div id="onboardingSlides" class="w-full">
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:block">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f44b.png" alt="Hi" class="w-16 h-16 mb-3 mx-auto animate-bounce" />
        <h2 class="text-xl font-bold mb-2 text-blue-700">Selamat Datang di Wayan AI!</h2>
        <p class="text-gray-700 text-base mb-4">Aplikasi chat cerdas dengan AI berbahasa Indonesia yang ramah &amp; mudah digunakan.</p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f4ac.png" alt="Chat" class="w-16 h-16 mb-3 mx-auto animate-pulse" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Mulai Bertanya!</h2>
        <p class="text-gray-700 text-base mb-4">Tulis pertanyaan di kolom bawah, lalu tekan <b>tombol kirim</b>.</p>
      </div>
       <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f5c3.png" alt="New Chat" class="w-16 h-16 mb-3 mx-auto" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Simpan Percakapan</h2>
        <p class="text-gray-700 text-base mb-4">Setiap percakapan akan otomatis tersimpan. Klik tombol <b>menu (garis tiga)</b> di pojok kiri atas untuk melihat riwayat chat Anda.</p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f527.png" alt="Settings" class="w-16 h-16 mb-3 mx-auto animate-spin-slow" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Atur Gaya AI-mu</h2>
        <p class="text-gray-700 text-base mb-4">Pilih <b>peran</b> dan <b>gaya bahasa</b> AI melalui tombol <b>pengaturan (roda gigi)</b>.</p>
      </div>
      <div class="onboarding-slide px-7 py-8 flex flex-col items-center text-center" style="display:none">
        <img src="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f389.png" alt="Lets Go" class="w-16 h-16 mb-3 mx-auto animate-bounce" />
        <h2 class="text-lg font-semibold mb-2 text-blue-700">Yuk Mulai Chatting!</h2>
        <p class="text-gray-700 text-base mb-4">Selamat menikmati Wayan AI. Jangan ragu untuk bereksperimen!</p>
      </div>
    </div>
    <div class="flex items-center justify-between px-5 pb-4 pt-2 bg-gray-50 border-t border-gray-200">
      <button id="skipOnboardingBtn" class="text-xs text-gray-400 hover:text-blue-500 font-medium">Lewati</button>
      <div class="flex space-x-1" id="onboardingDots"></div>
      <button id="nextOnboardingBtn" class="text-sm bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-1.5 rounded-lg shadow">Selanjutnya</button>
    </div>
  </div>
</div>
<style>
@keyframes fadein{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}.animate-fadein{animation:fadein .5s}
@keyframes spin-slow{100%{transform:rotate(360deg)}}.animate-spin-slow{animation:spin-slow 2.5s linear infinite}
</style>
<script>
(function() {
  const slides = document.querySelectorAll('#onboardingSlides .onboarding-slide');
  const modal = document.getElementById('onboardingModal');
  const btnNext = document.getElementById('nextOnboardingBtn');
  const btnSkip = document.getElementById('skipOnboardingBtn');
  const dotsContainer = document.getElementById('onboardingDots');
  let currSlide = 0;
  function showModalIfFirstTime() {
    if (!localStorage.getItem('onboardingShown')) {
      modal.classList.remove('hidden');
      renderDots();
      showSlide(0);
    }
  }
  function showSlide(idx) {
    slides.forEach((slide, i) => slide.style.display = i === idx ? 'block' : 'none');
    currSlide = idx;
    updateDots();
    btnNext.textContent = (currSlide === slides.length - 1) ? "Mulai Chatting" : "Selanjutnya";
  }
  function nextSlide() { (currSlide < slides.length - 1) ? showSlide(currSlide + 1) : closeModal(); }
  function closeModal() { modal.classList.add('hidden'); localStorage.setItem('onboardingShown', 'true'); }
  function renderDots() {
    dotsContainer.innerHTML = '';
    slides.forEach((_, i) => {
        const dot = document.createElement('span');
        dot.className = "inline-block w-2.5 h-2.5 mx-0.5 rounded-full transition-all duration-200 cursor-pointer bg-gray-300";
        dot.onclick = () => showSlide(i);
        dotsContainer.appendChild(dot);
    });
  }
  function updateDots() { Array.from(dotsContainer.children).forEach((dot, i) => {
      dot.className = dot.className.replace(/bg-\w+-\d+/, i === currSlide ? "bg-blue-600" : "bg-gray-300");
  }); }
  document.addEventListener('DOMContentLoaded', () => { showModalIfFirstTime(); btnNext.onclick = nextSlide; btnSkip.onclick = closeModal; });
})();
</script>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-GGGNDKREFK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-GGGNDKREFK');
</script>

<!-- ▼▼▼ KODE BARU UNTUK MODAL RATING & MASUKAN ▼▼▼ -->
<div id="ratingModal" class="fixed inset-0 modal-overlay z-50 flex items-center justify-center hidden p-4">
    <div class="modal-content p-6 max-w-sm w-full" id="ratingModalContent">
        <div class="text-center">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Beri Nilai untuk Wayan AI</h3>
            <p class="text-sm text-gray-600 mb-4">Masukan Anda sangat berarti untuk pengembangan kami.</p>
            
            <!-- Bintang Rating -->
            <div id="starRatingContainer" class="flex justify-center items-center space-x-2 mb-4 text-gray-300">
                <!-- Bintang akan dibuat oleh JavaScript, biarkan kosong -->
            </div>
            
            <textarea id="ratingFeedbackInput" placeholder="Tulis masukan Anda di sini (opsional)..." class="w-full settings-input text-sm mb-4" rows="4"></textarea>
            
            <div class="flex space-x-3">
                <button onclick="hideRatingModal()" class="flex-1 bg-gray-200 text-gray-800 py-2.5 rounded-xl font-semibold text-sm settings-btn-action">Nanti Saja</button>
                <button id="submitRatingBtn" onclick="submitRating()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl font-semibold text-sm settings-btn-action">Kirim Nilai</button>
            </div>
        </div>
    </div>
</div>
<!-- ▲▲▲ AKHIR DARI KODE BARU ▲▲▲ -->

</body>
</html>
